import{x as P,r as m,j as z,W as F,y as p,A as r,G as T,J as y,ag as j,u as _,H as L,L as N,M as $,D as k,P as G,O as J,a6 as Y,aA as K,n as Q,z as h}from"./vendor-CcmhhHhJ.js";import{m as A,f as X,n as Z,E as w,o as ee}from"./elementPlus-Be5V1zcU.js";import{m as D}from"./index-BaMLHsVY.js";import{b as te}from"./index-UMOi9Opk.js";const ne={class:"word-viewer-container"},se={class:"viewer-header"},oe={class:"header-left"},le={class:"file-title"},ae={class:"header-right"},re={class:"viewer-content"},ce={class:"sidebar-header"},ie={key:0},de={class:"sidebar-actions"},ue={key:0,class:"sidebar-content"},he={class:"toc-tree"},fe=["onClick"],me={class:"main-content"},pe={class:"content-wrapper"},ve={class:"view-mode"},ge=["innerHTML"],ye=P({__name:"WordDocumentViewer",props:{documentUrl:{},title:{default:"文档查看器"},showBackButton:{type:Boolean,default:!0},showDownloadButton:{type:Boolean,default:!0}},setup(q){const v=q,V=K(),l=m(),C=m(""),f=m(!1),b=m(""),g=m([]),W=()=>{l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=ee.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),setTimeout(()=>{l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=null},1e4)},E=m(),M=async()=>{W();try{console.log("开始加载Word文档:",v.documentUrl);const e=await fetch(v.documentUrl);if(!e.ok)throw new Error("文件下载失败");const t=await e.arrayBuffer(),c=await D.convertToHtml({arrayBuffer:t,convertImage:D.images.imgElement(function(s){return s.read("base64").then(function(n){return{src:"data:"+s.contentType+";base64,"+n}})}),styleMap:["p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='Heading 4'] => h4:fresh","p[style-name='Heading 5'] => h5:fresh","p[style-name='Heading 6'] => h6:fresh","p[style-name='Title'] => h1.title:fresh","p[style-name='Subtitle'] => h2.subtitle:fresh","p[style-name='标题 1'] => h1:fresh","p[style-name='标题 2'] => h2:fresh","p[style-name='标题 3'] => h3:fresh","p[style-name='标题 4'] => h4:fresh","p[style-name='标题 5'] => h5:fresh","p[style-name='标题 6'] => h6:fresh","p[style-name='标题1'] => h1:fresh","p[style-name='标题2'] => h2:fresh","p[style-name='标题3'] => h3:fresh","p[style-name='标题4'] => h4:fresh","p[style-name='标题5'] => h5:fresh","p[style-name='标题6'] => h6:fresh","r[style-name='Strong'] => strong","r[style-name='Emphasis'] => em","r[style-name='Hyperlink'] => a","r[style-name='加粗'] => strong","r[style-name='倾斜'] => em","r[style-name='超链接'] => a","table => table.table:fresh","tr => tr:fresh","td => td:fresh","th => th:fresh"],transformDocument:function(s){return s.children.forEach(function(n){n.children&&n.children.forEach(function(i){i.type==="hyperlink"&&(i.type="hyperlink")})}),s}});C.value=c.value,await Q(),setTimeout(()=>{U()},500),w.success("文档加载成功")}catch(e){console.error("加载文档失败:",e),w.error(`加载文档失败: ${e.message}`)}finally{l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=null}},U=()=>{const e=E.value;if(!e){console.log("wordContentRef.value 为空，无法生成目录");return}const t=[];e.querySelectorAll('a[id^="heading_"]').forEach((s,n)=>{var d,u;const i=s.getAttribute("id")||`heading-${n}`;let a=s.nextElementSibling,o="";if(a&&a.tagName.toLowerCase()==="strong")o=((d=a.textContent)==null?void 0:d.trim())||"";else{const H=s.parentElement;if(H){const S=H.querySelector("strong");S&&(o=((u=S.textContent)==null?void 0:u.trim())||"")}}o||(o=`标题 ${n+1}`),o&&o.length>0&&t.push({id:i,title:o,level:1,element:s})}),t.length===0&&e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((n,i)=>{var d;const a=B(n),o=((d=n.textContent)==null?void 0:d.trim())||"";if(o&&o.length>0){const u=`heading-${i}`;n.id=u,t.push({id:u,title:o,level:a,element:n})}}),t.length===0&&e.querySelectorAll('h1, h2, h3, h4, h5, h6, .title, .subtitle, p[style*="heading"], p[style*="title"], p[style*="Heading"]').forEach((n,i)=>{var d;const a=B(n),o=((d=n.textContent)==null?void 0:d.trim())||"";if(o&&o.length>0){const u=`heading-${i}`;n.id=u,t.push({id:u,title:o,level:a,element:n})}}),t.length===0&&e.querySelectorAll("p").forEach((n,i)=>{var o;const a=((o=n.textContent)==null?void 0:o.trim())||"";if(a.match(/^[一二三四五六七八九十]+[、．.]/)||a.match(/^\d+[、．.]/)||a.includes("了解")||a.includes("申请")||a.includes("培训")){const d=`heading-${i}`;n.id=d,t.push({id:d,title:a,level:1,element:n})}}),g.value=t,t.length===0?g.value=[{id:"test-1",title:"文档开始",level:1},{id:"test-2",title:"主要内容",level:2}]:console.log("目录生成成功，共",t.length,"个条目")},B=e=>{const t=e.tagName.toLowerCase();if(t.startsWith("h"))return parseInt(t.charAt(1));const c=e.className;if(c.includes("title"))return 1;if(c.includes("subtitle"))return 2;const s=e.textContent||"";return s.length<20&&e.tagName==="P"?2:s.length<50&&e.tagName==="P"?3:4},O=e=>{let t=document.getElementById(e);t||(t=document.querySelector(`a[id="${e}"]`)),t||(t=document.querySelector(`[id="${e}"]`)),t?(t.scrollIntoView({behavior:"smooth",block:"start"}),t.style.backgroundColor="#fff3cd",setTimeout(()=>{t.style.backgroundColor=""},2e3),b.value=e):w.warning("未找到对应的标题位置")},R=()=>{const e=document.createElement("a");e.href=v.documentUrl,e.download=v.title+".docx",document.body.appendChild(e),e.click(),document.body.removeChild(e),w.success("开始下载文档")},I=()=>{V.go(-1)},x=()=>{const e=window.pageYOffset||document.documentElement.scrollTop,t=g.value;for(let c=t.length-1;c>=0;c--){const s=t[c],n=document.getElementById(s.id);if(n&&n.offsetTop<=e+100){b.value=s.id;break}}};return z(()=>{M(),window.addEventListener("scroll",x)}),F(()=>{window.removeEventListener("scroll",x),l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=null}),(e,t)=>{const c=j("el-button");return h(),p("div",ne,[r("div",se,[r("div",oe,[e.showBackButton?(h(),T(c,{key:0,onClick:I,icon:_(A)},{default:L(()=>t[1]||(t[1]=[N("返回")])),_:1},8,["icon"])):y("",!0),r("span",le,$(e.title),1)]),r("div",ae,[e.showDownloadButton?(h(),T(c,{key:0,type:"success",onClick:R,icon:_(X)},{default:L(()=>t[2]||(t[2]=[N(" 下载文档 ")])),_:1},8,["icon"])):y("",!0)])]),r("div",re,[r("div",{class:k(["sidebar",{collapsed:f.value}])},[r("div",ce,[f.value?y("",!0):(h(),p("span",ie,"目录")),r("div",de,[G(c,{class:"sidebar-toggle-btn",onClick:t[0]||(t[0]=s=>f.value=!f.value),icon:f.value?_(Z):_(A)},null,8,["icon"])])]),f.value?y("",!0):(h(),p("div",ue,[r("div",he,[(h(!0),p(J,null,Y(g.value,(s,n)=>(h(),p("div",{key:n,class:k(["toc-item",{active:b.value===s.id}]),onClick:i=>O(s.id)},[r("span",{class:k(["toc-level",`level-${s.level}`])},$(s.title),3)],10,fe))),128))])]))],2),r("div",me,[r("div",pe,[r("div",ve,[r("div",{class:"word-content",innerHTML:C.value,ref_key:"wordContentRef",ref:E},null,8,ge)])])])])])}}}),Ce=te(ye,[["__scopeId","data-v-165c3235"]]);export{Ce as W};
