import{d as he,u as ge,r as v,H as ye,J as we,k as G,o as ke,l as c,a as t,w as a,b as u,P as be,M as g,y as xe,O as Ae,c as B,e as n,t as d,g as h,a2 as M,f as _,q as V,F as Ce,m as Ve,A as ze,a3 as Ue,a4 as Fe,s as K,j as r,_ as Se}from"./index-DCqMzgSt.js";import{a as Q}from"./assignmentService-DXovFKzm.js";const De={class:"personal-assignment-list"},Ee={class:"card-header"},Pe={class:"tooltip-content"},Re={class:"text-truncate"},Le={class:"tooltip-content"},Ne={class:"content-preview"},$e={key:1},Be={key:0,class:"assignment-detail"},Me={class:"assignment-meta"},qe={class:"assignment-content"},Ie={key:0,class:"assignment-attachment"},Te={class:"attachment-box"},We={class:"attachment-name"},je={key:1,class:"assignment-replies"},He={class:"reply-header"},Je={class:"reply-author"},Oe={key:0,class:"reply-role"},Ge={key:0,class:"reply-attachment"},Ke={class:"attachment-name"},Qe={class:"reply-form"},Xe={class:"attachment-preview"},Ye=["src"],Ze=["src"],et={key:2,class:"attachment-download"},tt=he({__name:"PersonalAssignmentList",setup(at){const f=ge(),D=v(!1),E=v([]),P=v(!1),o=v(null),x=v(""),C=v(!1),y=v(""),w=v(""),z=v([]),k=v(null),X=ye();v(X.query.platform||"google");const A=we({page:1,pageSize:10,total:0}),R=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",Y=G(()=>w.value?w.value.startsWith("image/"):!1),Z=G(()=>w.value?w.value==="application/pdf":!1),ee=l=>{l.attachment_url&&(y.value=l.attachment_url,w.value=l.attachment_type||"",C.value=!0)},te=()=>{var l;(l=o.value)!=null&&l.attachment_url&&(y.value=o.value.attachment_url,w.value=o.value.attachment_type||"",C.value=!0)},ae=()=>{y.value&&window.open(y.value,"_blank")},le=l=>l.size/1024/1024<10?!0:(g.error("文件大小不能超过10MB!"),!1),se=async l=>{const{file:e}=l,i=Fe.service({lock:!0,text:"上传中...",background:"rgba(0, 0, 0, 0.7)"});try{const m=e.name.split(".").pop(),b=`assignments/replies/${`reply_${Date.now()}.${m}`}`,{data:I,error:F}=await K.storage.from("attachments").upload(b,e);if(F)throw F;const{data:{publicUrl:L}}=K.storage.from("attachments").getPublicUrl(b);k.value={url:L,name:e.name,type:e.type},g.success("文件上传成功")}catch(m){console.error("文件上传失败:",m),g.error("文件上传失败"),z.value=[]}finally{i.close()}},ne=()=>{k.value=null},oe=l=>{l.attachment_url&&(y.value=l.attachment_url,w.value=l.attachment_type||"",C.value=!0)},U=async()=>{D.value=!0;try{const{data:l,total:e}=await Q.getPersonalAssignments(A.page,A.pageSize,{status:""});E.value=l,A.total=e}catch(l){console.error("获取作业列表失败:",l),g.error("获取作业列表失败")}finally{D.value=!1}},ie=l=>{o.value=l,P.value=!0,x.value="",z.value=[],k.value=null},re=async()=>{var l,e,i,m;if(o.value){if(!x.value.trim()){g.warning("回复内容不能为空");return}try{if(!((l=f.user)!=null&&l.user_id)||!o.value.id){g.error("用户信息或作业ID缺失");return}const p=await Q.addReply({assignment_id:o.value.id,user_id:f.user.user_id,content:x.value,full_name:f.user.full_name||"",attachment_url:((e=k.value)==null?void 0:e.url)||void 0,attachment_name:((i=k.value)==null?void 0:i.name)||void 0,attachment_type:((m=k.value)==null?void 0:m.type)||void 0});o.value.replies||(o.value.replies=[]),o.value.replies.push(p),g.success("提交回复成功"),x.value="",z.value=[],k.value=null,U()}catch(p){console.error("提交回复失败:",p),g.error("提交回复失败")}}},ue=()=>{U()},de=l=>{A.page=l.page,A.pageSize=l.pageSize,U()},q=l=>{if(!l.replies||l.replies.length===0)return{type:"warning",text:"待完成"};const e=l.replies.some(i=>{var m;return i.user_id===((m=f.user)==null?void 0:m.user_id)});return l.replies.some(i=>i.user_id!==l.assigned_to),e?{type:"success",text:"已完成"}:{type:"warning",text:"待完成"}};return ke(()=>{U()}),(l,e)=>{const i=u("el-button"),m=u("el-tooltip"),p=u("el-table-column"),b=u("el-icon"),I=u("el-tag"),F=u("el-button-group"),L=u("el-table"),ce=u("el-empty"),_e=u("el-card"),S=u("el-divider"),me=u("el-input"),N=u("el-form-item"),pe=u("el-upload"),ve=u("el-form"),T=u("el-dialog"),fe=Ae("loading");return r(),c("div",De,[t(_e,{class:"box-card",shadow:"always",style:{"margin-top":"30px","min-height":"400px"}},{header:a(()=>[n("div",Ee,[e[4]||(e[4]=n("span",null,"我的作业列表",-1)),t(i,{type:"primary",onClick:ue},{default:a(()=>e[3]||(e[3]=[_("刷新")])),_:1})])]),default:a(()=>[xe((r(),c("div",null,[E.value.length>0?(r(),B(L,{key:0,data:E.value,style:{width:"100%"}},{default:a(()=>[t(p,{prop:"title",label:"标题","min-width":"180"},{default:a(s=>[t(m,{placement:"top","show-after":500,"max-width":300},{content:a(()=>[n("div",Pe,d(s.row.title),1)]),default:a(()=>[n("div",Re,d(s.row.title),1)]),_:2},1024)]),_:1}),t(p,{label:"内容","min-width":"250"},{default:a(s=>[t(m,{placement:"top","show-after":500},{content:a(()=>[n("div",Le,d(s.row.content),1)]),default:a(()=>[n("div",Ne,d(s.row.content),1)]),_:2},1024)]),_:1}),t(p,{label:"附件",width:"80"},{default:a(s=>[s.row.attachment_url?(r(),B(i,{key:0,type:"primary",link:"",onClick:$=>ee(s.row)},{default:a(()=>[t(b,{color:"#409EFF",size:"18"},{default:a(()=>[t(h(M))]),_:1})]),_:2},1032,["onClick"])):(r(),c("span",$e,"-"))]),_:1}),t(p,{prop:"created_at",label:"创建时间",width:"180"},{default:a(s=>[_(d(R(s.row.created_at)),1)]),_:1}),t(p,{label:"状态",width:"100"},{default:a(s=>[t(I,{type:q(s.row).type},{default:a(()=>[_(d(q(s.row).text),1)]),_:2},1032,["type"])]),_:1}),t(p,{label:"操作",width:"200"},{default:a(s=>[t(F,null,{default:a(()=>[t(i,{type:"primary",onClick:$=>ie(s.row)},{default:a(()=>e[5]||(e[5]=[_("查看")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])):(r(),B(ce,{key:1,description:"暂无分配给您的作业"}))])),[[fe,D.value]])]),_:1}),t(be,{pagination:A,"onUpdate:pagination":de},null,8,["pagination"]),t(T,{modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=s=>P.value=s),title:"作业详情",width:"600px"},{default:a(()=>[o.value?(r(),c("div",Be,[n("h3",null,d(o.value.title),1),n("div",Me,[n("p",null,"创建时间: "+d(R(o.value.created_at)),1)]),n("div",qe,[t(S,{"content-position":"left"},{default:a(()=>e[6]||(e[6]=[_("作业内容")])),_:1}),n("p",null,d(o.value.content),1)]),o.value.attachment_url?(r(),c("div",Ie,[t(S,{"content-position":"left"},{default:a(()=>e[7]||(e[7]=[_("附件")])),_:1}),n("div",Te,[t(b,{color:"#409EFF",size:"16"},{default:a(()=>[t(h(M))]),_:1}),n("span",We,d(o.value.attachment_name),1),t(i,{type:"primary",size:"small",onClick:te},{default:a(()=>e[8]||(e[8]=[_("查看附件")])),_:1})])])):V("",!0),o.value.replies&&o.value.replies.length>0?(r(),c("div",je,[t(S,{"content-position":"left"},{default:a(()=>e[9]||(e[9]=[_("回复记录")])),_:1}),(r(!0),c(Ce,null,Ve(o.value.replies,(s,$)=>{var W,j,H,J,O;return r(),c("div",{key:$,class:ze(["reply-item",{"my-reply":s.user_id===((W=h(f).user)==null?void 0:W.user_id),"admin-reply":s.user_id!==o.value.assigned_to&&s.user_id!==((j=h(f).user)==null?void 0:j.user_id),"other-reply":s.user_id!==((H=h(f).user)==null?void 0:H.user_id)&&s.user_id===o.value.assigned_to}])},[n("div",He,[n("span",Je,d(s.user_id===((J=h(f).user)==null?void 0:J.user_id)?"我":s.full_name||"未知用户"),1),s.user_id!==o.value.assigned_to&&s.user_id!==((O=h(f).user)==null?void 0:O.user_id)?(r(),c("span",Oe,"管理员")):V("",!0)]),n("p",null,d(s.content),1),s.attachment_url?(r(),c("div",Ge,[t(b,{color:"#409EFF",size:"14"},{default:a(()=>[t(h(M))]),_:1}),n("span",Ke,d(s.attachment_name),1),t(i,{type:"primary",link:"",size:"small",onClick:lt=>oe(s)},{default:a(()=>e[10]||(e[10]=[_("查看")])),_:2},1032,["onClick"])])):V("",!0),n("small",null,d(R(s.created_at)),1)],2)}),128))])):V("",!0),n("div",Qe,[t(S,{"content-position":"left"},{default:a(()=>e[11]||(e[11]=[_("提交回复")])),_:1}),t(ve,null,{default:a(()=>[t(N,null,{default:a(()=>[t(me,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=s=>x.value=s),type:"textarea",rows:4,placeholder:"请输入您的回复内容"},null,8,["modelValue"])]),_:1}),t(N,{label:"附件"},{default:a(()=>[t(pe,{class:"upload-container",drag:"","auto-upload":!0,"http-request":se,"on-remove":ne,"before-upload":le,limit:1,"file-list":z.value},{tip:a(()=>e[12]||(e[12]=[n("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[t(b,{class:"el-icon--upload"},{default:a(()=>[t(h(Ue))]),_:1}),e[13]||(e[13]=n("div",{class:"el-upload__text"},[_(" 将文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),t(N,null,{default:a(()=>[t(i,{type:"primary",onClick:re},{default:a(()=>e[14]||(e[14]=[_("提交回复")])),_:1})]),_:1})]),_:1})])])):V("",!0)]),_:1},8,["modelValue"]),t(T,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=s=>C.value=s),title:"附件预览",width:"80%","destroy-on-close":""},{default:a(()=>[n("div",Xe,[Y.value?(r(),c("img",{key:0,src:y.value,class:"attachment-image"},null,8,Ye)):Z.value?(r(),c("iframe",{key:1,src:y.value,class:"attachment-frame"},null,8,Ze)):(r(),c("div",et,[e[16]||(e[16]=n("p",null,"无法预览此类型的文件，请下载后查看",-1)),t(i,{type:"primary",onClick:ae},{default:a(()=>e[15]||(e[15]=[_("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])}}}),ot=Se(tt,[["__scopeId","data-v-ac098fbb"]]);export{ot as default};
