import{x as q,r as d,y as P,A as n,P as l,H as o,u as w,ag as c,L as g,az as S,z as $}from"./vendor-COQJj1AX.js";import{v as z,x as F,E as m,y as I}from"./elementPlus-Dv7g5dxn.js";import{s as N,a as D,_ as j}from"./index-BfpeTqGr.js";import"./supabase-Bqqw4QDB.js";const A={class:"study-notes-create"},H=q({__name:"StudyNotesCreate",setup(O){const b=S(),v=d(),y=d(!1),V=d([]),r=d(null),u=d({title:"",content:""}),h={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},C=i=>i.size/1024/1024<10?!0:(m.error("文件大小不能超过 10MB!"),!1),k=async i=>{const{file:e,onSuccess:s,onError:t}=i;if(!e){t==null||t(new Error("文件不存在"));return}const p=I.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const a=e,f=a.name.split(".").pop(),U=`study_notes/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${f}`}`,{data:L,error:x}=await N.storage.from("attachments").upload(U,a,{cacheControl:"3600",upsert:!1});if(x)throw x;const{data:{publicUrl:R}}=N.storage.from("attachments").getPublicUrl(L.path);r.value={url:R,name:a.name,type:a.type},s==null||s(r.value),m.success("文件上传成功")}catch(a){console.error("文件上传错误:",a),t==null||t(new Error(a instanceof Error?a.message:"上传失败")),m.error("文件上传失败，请重试")}finally{p.close()}},E=()=>{r.value=null},B=async()=>{v.value&&await v.value.validate(async i=>{var e,s,t;if(i){y.value=!0;try{await D.createNote({...u.value,attachment_url:(e=r.value)==null?void 0:e.url,attachment_name:(s=r.value)==null?void 0:s.name,attachment_type:(t=r.value)==null?void 0:t.type}),m.success("心得提交成功"),b.push("/system/study-notes/list")}catch{m.error("提交失败")}finally{y.value=!1}}})},M=()=>{b.push("/system/study-notes/list")};return(i,e)=>{const s=c("el-input"),t=c("el-form-item"),p=c("el-icon"),a=c("el-upload"),f=c("el-button");return $(),P("div",A,[e[8]||(e[8]=n("div",{class:"create-header"},[n("h2",null,"添加学习心得")],-1)),l(w(z),{model:u.value,ref_key:"formRef",ref:v,rules:h,"label-width":"100px",class:"create-form"},{default:o(()=>[l(t,{label:"标题",prop:"title"},{default:o(()=>[l(s,{modelValue:u.value.title,"onUpdate:modelValue":e[0]||(e[0]=_=>u.value.title=_),placeholder:"请输入心得标题"},null,8,["modelValue"]),e[2]||(e[2]=n("div",{class:"form-tip"},"请简要描述您的学习心得主题",-1))]),_:1}),l(t,{label:"内容",prop:"content"},{default:o(()=>[l(s,{modelValue:u.value.content,"onUpdate:modelValue":e[1]||(e[1]=_=>u.value.content=_),type:"textarea",rows:8,placeholder:"请输入学习心得内容"},null,8,["modelValue"]),e[3]||(e[3]=n("div",{class:"form-tip"},"详细描述您的学习收获、体会和建议",-1))]),_:1}),l(t,{label:"附件"},{default:o(()=>[l(a,{class:"upload-container",drag:"","auto-upload":!0,"http-request":k,"on-remove":E,"before-upload":C,limit:1,"file-list":V.value},{tip:o(()=>e[4]||(e[4]=[n("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:o(()=>[l(p,{class:"el-icon--upload"},{default:o(()=>[l(w(F))]),_:1}),e[5]||(e[5]=n("div",{class:"el-upload__text"},[g(" 将文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),l(t,null,{default:o(()=>[l(f,{type:"primary",onClick:B,loading:y.value},{default:o(()=>e[6]||(e[6]=[g("提交")])),_:1},8,["loading"]),l(f,{onClick:M},{default:o(()=>e[7]||(e[7]=[g("返回")])),_:1})]),_:1})]),_:1},8,["model"])])}}}),K=j(H,[["__scopeId","data-v-3163f1a8"]]);export{K as default};
