import{d as oe,r as d,k as O,o as ie,l as _,e as s,a,y as ue,t as v,w as t,b as f,O as re,c as x,v as P,M as y,f as m,g as L,a2 as W,q as b,a3 as de,a1 as ce,a4 as ve,s as G,j as r,_ as me}from"./index-w0Vcq8R-.js";const pe={class:"study-notes"},_e={class:"study-body"},fe={class:"study-header"},ye={key:1},ge={class:"attachment-box"},he={class:"attachment-name"},we={key:1,class:"note-view"},be={class:"note-title"},ke={class:"note-meta"},Ve={key:0},Ce={class:"note-content-section"},De={class:"note-content"},xe={key:0,class:"note-attachment-section"},Ne={class:"attachment-box"},Ee={class:"attachment-name"},Se={key:1,class:"note-reply-section"},Le={class:"admin-reply"},Ue={class:"reply-content"},Me={key:0,class:"reply-time"},$e={class:"attachment-preview"},Ae=["src"],Fe=["src"],Be={key:2,class:"attachment-download"},qe=oe({__name:"StudyNotes",setup(ze){const U=d(!1),M=d([]),w=d(!1),g=d(!1),k=d(!1),$=d(""),A=d(),o=d({}),F=d([]);d(!1);const E=d(!1),V=d(""),C=d(""),h=d(null),p=d({title:"",content:""}),H={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},J=O(()=>C.value?C.value.startsWith("image/"):!1),K=O(()=>C.value?C.value==="application/pdf":!1),Q=()=>k.value?"查看笔记":g.value?"编辑笔记":"新建笔记",R=async()=>{U.value=!0;try{M.value=await P.getNotes()}catch{y.error("获取笔记列表失败")}finally{U.value=!1}},X=()=>{g.value=!1,k.value=!1,p.value={title:"",content:""},F.value=[],h.value=null,w.value=!0},Y=l=>{k.value=!0,g.value=!1,$.value=l.id,o.value=l,w.value=!0},Z=l=>{if(l.admin_reply){y.warning("已回复的笔记不能修改");return}g.value=!0,k.value=!1,$.value=l.id,o.value=l,p.value={title:l.title,content:l.content},F.value=[],h.value=null,w.value=!0},ee=l=>{l.attachment_url?(V.value=l.attachment_url,C.value=l.attachment_type||"",E.value=!0):y.warning("该笔记没有附件")},te=()=>{var l;(l=o.value)!=null&&l.attachment_url&&(V.value=o.value.attachment_url,C.value=o.value.attachment_type||"",E.value=!0)},T=()=>{V.value?window.open(V.value,"_blank"):o.value.attachment_url&&window.open(o.value.attachment_url,"_blank")},ae=l=>l.size/1024/1024<10?!0:(y.error("文件大小不能超过 10MB!"),!1),le=async l=>{const{file:e,onSuccess:i,onError:u}=l;if(!e){u==null||u(new Error("文件不存在"));return}const S=ve.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const c=e,B=c.name.split(".").pop(),D=`study_notes/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${B}`}`,{data:z,error:N}=await G.storage.from("attachments").upload(D,c,{cacheControl:"3600",upsert:!1});if(N)throw N;const{data:{publicUrl:I}}=G.storage.from("attachments").getPublicUrl(z.path);h.value={url:I,name:c.name,type:c.type},i==null||i(h.value),y.success("文件上传成功")}catch(c){console.error("文件上传错误:",c),u==null||u(new Error(c instanceof Error?c.message:"上传失败")),y.error("文件上传失败，请重试")}finally{S.close()}},ne=()=>{h.value=null},se=async()=>{A.value&&await A.value.validate(async l=>{var e,i,u;if(l)try{g.value?(await P.updateNote($.value,{title:p.value.title,content:p.value.content}),y.success("修改成功")):(await P.createNote({...p.value,attachment_url:(e=h.value)==null?void 0:e.url,attachment_name:(i=h.value)==null?void 0:i.name,attachment_type:(u=h.value)==null?void 0:u.type}),y.success("创建成功")),w.value=!1,R()}catch{y.error(g.value?"修改失败":"创建失败")}})};return ie(()=>{R()}),(l,e)=>{const i=f("el-button"),u=f("el-table-column"),S=f("el-tag"),c=f("el-icon"),B=f("el-table"),q=f("el-input"),D=f("el-form-item"),z=f("el-upload"),N=f("el-dialog"),I=re("loading");return r(),_("div",pe,[s("div",_e,[s("div",fe,[s("div",null,"共计"+v(M.value.length)+"篇笔记",1),a(i,{type:"primary",onClick:X},{default:t(()=>e[5]||(e[5]=[m("新建笔记")])),_:1})]),ue((r(),x(B,{data:M.value},{default:t(()=>[a(u,{prop:"title",label:"标题"}),a(u,{label:"状态",width:"100"},{default:t(({row:n})=>[a(S,{type:n.admin_reply?"success":"info"},{default:t(()=>[m(v(n.admin_reply?"已回复":"未回复"),1)]),_:2},1032,["type"])]),_:1}),a(u,{label:"附件",width:"80"},{default:t(({row:n})=>[n.attachment_url?(r(),x(i,{key:0,type:"primary",link:"",onClick:j=>ee(n)},{default:t(()=>[a(c,{color:"#409EFF",size:"18"},{default:t(()=>[a(L(W))]),_:1})]),_:2},1032,["onClick"])):(r(),_("span",ye,"-"))]),_:1}),a(u,{prop:"created_at",label:"创建时间",width:"180"},{default:t(({row:n})=>[m(v(new Date(n.created_at).toLocaleString()),1)]),_:1}),a(u,{prop:"updated_at",label:"修改时间",width:"180"},{default:t(({row:n})=>[m(v(n.updated_at?new Date(n.updated_at).toLocaleString():"-"),1)]),_:1}),a(u,{label:"操作",width:"160"},{default:t(({row:n})=>[a(i,{type:"primary",onClick:j=>Y(n)},{default:t(()=>e[6]||(e[6]=[m("查看")])),_:2},1032,["onClick"]),a(i,{type:"warning",onClick:j=>Z(n),disabled:!!n.admin_reply},{default:t(()=>e[7]||(e[7]=[m("编辑")])),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[I,U.value]])]),a(N,{title:Q(),modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=n=>w.value=n),width:"40%",style:{"min-width":"400px"}},{footer:t(()=>[a(i,{onClick:e[2]||(e[2]=n=>w.value=!1)},{default:t(()=>e[16]||(e[16]=[m("关闭")])),_:1}),k.value?b("",!0):(r(),x(i,{key:0,type:"primary",onClick:se},{default:t(()=>e[17]||(e[17]=[m("确定")])),_:1}))]),default:t(()=>[k.value?(r(),_("div",we,[s("h3",be,v(o.value.title),1),s("div",ke,[s("p",null,"提交于: "+v(new Date(o.value.created_at).toLocaleString()),1),o.value.updated_at&&o.value.updated_at!==o.value.created_at?(r(),_("p",Ve," 修改于: "+v(new Date(o.value.updated_at).toLocaleString()),1)):b("",!0)]),s("div",Ce,[e[12]||(e[12]=s("div",{class:"section-title"},"我的内容:",-1)),s("div",De,v(o.value.content),1)]),o.value.attachment_url?(r(),_("div",xe,[e[14]||(e[14]=s("div",{class:"section-title"},"附件:",-1)),s("div",Ne,[a(c,{color:"#409EFF",size:"16"},{default:t(()=>[a(L(W))]),_:1}),s("span",Ee,v(o.value.attachment_name),1),a(i,{type:"primary",size:"small",onClick:te},{default:t(()=>e[13]||(e[13]=[m("查看附件")])),_:1})])])):b("",!0),o.value.admin_reply?(r(),_("div",Se,[e[15]||(e[15]=s("div",{class:"section-title"},"管理员回复:",-1)),s("div",Le,[s("p",Ue,v(o.value.admin_reply),1),o.value.replied_at?(r(),_("p",Me," 回复于: "+v(new Date(o.value.replied_at).toLocaleString()),1)):b("",!0)])])):b("",!0)])):(r(),x(L(ce),{key:0,model:p.value,ref_key:"formRef",ref:A,rules:H},{default:t(()=>[a(D,{label:"标题",prop:"title"},{default:t(()=>[a(q,{modelValue:p.value.title,"onUpdate:modelValue":e[0]||(e[0]=n=>p.value.title=n)},null,8,["modelValue"])]),_:1}),a(D,{label:"内容",prop:"content"},{default:t(()=>[a(q,{modelValue:p.value.content,"onUpdate:modelValue":e[1]||(e[1]=n=>p.value.content=n),type:"textarea",rows:6},null,8,["modelValue"])]),_:1}),g.value?b("",!0):(r(),x(D,{key:0,label:"附件"},{default:t(()=>[a(z,{class:"upload-container",drag:"","auto-upload":!0,"http-request":le,"on-remove":ne,"before-upload":ae,limit:1,"file-list":F.value},{tip:t(()=>e[8]||(e[8]=[s("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:t(()=>[a(c,{class:"el-icon--upload"},{default:t(()=>[a(L(de))]),_:1}),e[9]||(e[9]=s("div",{class:"el-upload__text"},[m(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})),g.value&&o.value.attachment_url?(r(),x(D,{key:1,label:"当前附件"},{default:t(()=>[s("div",ge,[s("span",he,v(o.value.attachment_name),1),a(i,{type:"primary",size:"small",onClick:T},{default:t(()=>e[10]||(e[10]=[m("下载")])),_:1})]),e[11]||(e[11]=s("div",{class:"el-upload__tip",style:{"margin-top":"8px"}}," 注意：编辑模式下暂不支持修改附件 ",-1))]),_:1})):b("",!0)]),_:1},8,["model"]))]),_:1},8,["title","modelValue"]),a(N,{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=n=>E.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{default:t(()=>[s("div",$e,[J.value?(r(),_("img",{key:0,src:V.value,class:"attachment-image"},null,8,Ae)):K.value?(r(),_("iframe",{key:1,src:V.value,class:"attachment-frame"},null,8,Fe)):(r(),_("div",Be,[e[19]||(e[19]=s("p",null,"无法预览此类型的文件，请下载后查看",-1)),a(i,{type:"primary",onClick:T},{default:t(()=>e[18]||(e[18]=[m("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])}}}),Pe=me(qe,[["__scopeId","data-v-641c2e5c"]]);export{Pe as default};
