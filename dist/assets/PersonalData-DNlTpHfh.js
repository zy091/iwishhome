import{x as J,r as U,X as z,j as T,aF as X,y as D,P as a,A as r,H as l,ag as m,G as I,J as N,L as f,M as v,u as h,V as K,z as V}from"./vendor-COQJj1AX.js";import{u as O,B as Q,s as P,_ as Y}from"./index-Lq626ARa.js";import{E as p,m as Z,n as ee,o as ae,p as te,q as le,t as oe,v as re}from"./elementPlus-Dv7g5dxn.js";import"./supabase-Bqqw4QDB.js";const se={class:"layout"},ne={class:"personal-info-container"},ue={class:"profile-container"},ie={class:"profile-header"},de={class:"profile-basic-info"},_e={class:"profile-name"},me={class:"profile-bio"},pe={class:"profile-actions"},ce={class:"profile-details"},fe={class:"profile-detail-item"},ve={class:"profile-detail-item"},be={class:"profile-detail-item"},ye={class:"profile-detail-item"},he={class:"avatar-container"},ge=["src"],we={key:0,class:"avatar-overlay"},Ue=J({__name:"PersonalData",setup(Ve){const w=O(),C=U(),b=U(!0),y=U(!1),d=U(""),B=z([{name:"个人信息",path:"/system/personal-information"}]),t=z({full_name:"",email:"",phone_number:"",bio:"",department:"",role:null,avatar_url:"",organization_path:""}),E=z({phone_number:[{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码",trigger:"blur"}]}),M=async()=>{b.value=!0;try{const o=w.getUser();if(!o){p.error("未登录或无法获取用户信息");return}if(o.avatar_url&&(d.value=o.avatar_url,t.avatar_url=o.avatar_url),o.user_id){const{data:e,error:n}=await w.fetchUserProfile(o.user_id);if(n)throw n;t.full_name=o.full_name||"",t.email=o.email||"",t.phone_number=o.phone_number||"",t.bio=o.bio||"",t.department=o.department||"",t.role=o.role||null,t.organization_path=o.organization_path||""}}catch(o){console.error("获取用户信息失败:",o),p.error("获取用户信息失败")}finally{b.value=!1}},S=o=>{const e=new FileReader;e.onload=n=>{var _;d.value=(_=n.target)==null?void 0:_.result},e.readAsDataURL(o.raw)},H=async o=>{b.value=!0;try{const e=w.getUser();if(!e||!e.user_id)return p.error("未登录或无法获取用户信息"),null;const n=o.name.split(".").pop(),u=`user_avatar/${`${e.user_id}_${Date.now()}.${n}`}`,{data:g,error:i}=await P.storage.from("materials").upload(u,o,{cacheControl:"3600",upsert:!0});if(i)throw i;const{data:c}=P.storage.from("materials").getPublicUrl(u);return c.publicUrl}catch(e){return console.error("上传头像失败:",e),p.error("上传头像失败"),null}finally{b.value=!1}},L=()=>{d.value="",t.avatar_url="",p.success("头像已删除，保存后生效")},W=async()=>{C.value&&await C.value.validate(async o=>{if(o){b.value=!0;try{const e=w.getUser();if(!e){p.error("未登录或无法获取用户信息");return}if(!e.user_id){p.error("无法获取用户ID");return}const n={full_name:t.full_name,phone_number:t.phone_number,bio:t.bio,department:t.department};if(d.value==="")n.avatar_url=null;else if(d.value&&!d.value.startsWith("http"))try{const g=await(await fetch(d.value)).blob(),i=`avatar_${Date.now()}.${g.type.split("/")[1]}`,c=new File([g],i,{type:g.type}),k=await H(c);k&&(n.avatar_url=k)}catch(u){console.error("处理头像文件失败:",u),p.warning("头像处理失败，将使用默认头像")}const{error:_}=await w.updateUserProfile(e.user_id,n);if(_)throw _;p.success("个人信息更新成功"),y.value=!1}catch(e){console.error("更新用户信息失败:",e),p.error("更新用户信息失败,或刷新重试")}finally{b.value=!1}}})},j=X(),F=U("/system/personal-data/study-notes");return T(()=>{F.value=j.path,M()}),(o,e)=>{const n=m("el-avatar"),_=m("el-button"),u=m("el-icon"),g=m("el-upload"),i=m("el-form-item"),c=m("el-input"),k=m("el-skeleton"),R=m("el-card"),x=m("el-menu-item"),q=m("el-menu"),G=m("RouterView");return V(),D("div",se,[a(Q,{breadbcrum:B},null,8,["breadbcrum"]),e[13]||(e[13]=r("div",{class:"layout-title"},[r("h1",{class:"title"},"个人中心")],-1)),r("div",ne,[a(R,{class:"info-card"},{default:l(()=>[a(k,{loading:b.value,animated:""},{default:l(()=>{var $;return[r("div",ue,[r("div",ie,[a(n,{size:100,src:d.value,class:"profile-avatar"},{default:l(()=>{var s,A;return[f(v(((A=(s=t.full_name)==null?void 0:s.charAt(0))==null?void 0:A.toUpperCase())||"U"),1)]}),_:1},8,["src"]),r("div",de,[r("h2",_e,v(t.full_name),1),r("p",me,v(t.bio||"海纳百川，有容乃大"),1),r("div",pe,[a(_,{type:"primary",onClick:e[0]||(e[0]=s=>y.value=!y.value)},{default:l(()=>[f(v(y.value?"取消":"编辑资料"),1)]),_:1})])])]),r("div",ce,[r("div",fe,[a(u,null,{default:l(()=>[a(h(Z))]),_:1}),r("span",null,v((($=t.role)==null?void 0:$.name)||"交互专家"),1)]),r("div",ve,[a(u,null,{default:l(()=>[a(h(ee))]),_:1}),r("span",null,v(t.organization_path||"IWISH - 某某事业群 - 某某平台部 - 某某技术部"),1)]),r("div",be,[a(u,null,{default:l(()=>[a(h(ae))]),_:1}),r("span",null,v(t.email),1)]),r("div",ye,[a(u,null,{default:l(()=>[a(h(te))]),_:1}),r("span",null,v(t.phone_number),1)])])]),y.value?(V(),I(h(re),{key:0,ref_key:"userFormRef",ref:C,model:t,rules:E,"label-width":"120px",class:"edit-form"},{default:l(()=>[a(i,{label:"头像"},{default:l(()=>[r("div",he,[a(g,{class:"avatar-uploader",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":S},{default:l(()=>[d.value?(V(),D("img",{key:0,src:d.value,class:"avatar"},null,8,ge)):(V(),I(u,{key:1,class:"avatar-uploader-icon"},{default:l(()=>[a(h(le))]),_:1}))]),_:1}),d.value?(V(),D("div",we,[a(_,{circle:"",class:"delete-avatar-btn",onClick:K(L,["stop"])},{default:l(()=>[a(u,null,{default:l(()=>[a(h(oe))]),_:1})]),_:1})])):N("",!0)])]),_:1}),a(i,{label:"姓名",prop:"full_name"},{default:l(()=>[a(c,{modelValue:t.full_name,"onUpdate:modelValue":e[1]||(e[1]=s=>t.full_name=s),disabled:""},null,8,["modelValue"])]),_:1}),a(i,{label:"个人简介",prop:"bio"},{default:l(()=>[a(c,{modelValue:t.bio,"onUpdate:modelValue":e[2]||(e[2]=s=>t.bio=s)},null,8,["modelValue"])]),_:1}),a(i,{label:"部门",prop:"department"},{default:l(()=>[a(c,{modelValue:t.organization_path,"onUpdate:modelValue":e[3]||(e[3]=s=>t.organization_path=s),disabled:""},null,8,["modelValue"])]),_:1}),a(i,{label:"邮箱",prop:"email"},{default:l(()=>[a(c,{modelValue:t.email,"onUpdate:modelValue":e[4]||(e[4]=s=>t.email=s),disabled:""},null,8,["modelValue"])]),_:1}),a(i,{label:"手机号码",prop:"phone_number"},{default:l(()=>[a(c,{modelValue:t.phone_number,"onUpdate:modelValue":e[5]||(e[5]=s=>t.phone_number=s)},null,8,["modelValue"])]),_:1}),a(i,null,{default:l(()=>[a(_,{type:"primary",onClick:W},{default:l(()=>e[7]||(e[7]=[f("保存")])),_:1}),a(_,{onClick:e[6]||(e[6]=s=>y.value=!y.value)},{default:l(()=>e[8]||(e[8]=[f(" 取消 ")])),_:1})]),_:1})]),_:1},8,["model","rules"])):N("",!0)]}),_:1},8,["loading"])]),_:1}),a(R,{class:"list-card"},{header:l(()=>[a(q,{"default-active":F.value,class:"el-menu-demo",mode:"horizontal",router:!0},{default:l(()=>[a(x,{index:"/system/personal-data/test-result"},{default:l(()=>e[9]||(e[9]=[f("学习测试")])),_:1}),a(x,{index:"/system/personal-data/study-notes"},{default:l(()=>e[10]||(e[10]=[f("学习心得")])),_:1}),a(x,{index:"/system/personal-data/daily-assignments"},{default:l(()=>e[11]||(e[11]=[f("日常作业")])),_:1}),a(x,{index:"/system/personal-data/change-password"},{default:l(()=>e[12]||(e[12]=[f("修改密码")])),_:1})]),_:1},8,["default-active"])]),default:l(()=>[a(G)]),_:1})])])}}}),De=Y(Ue,[["__scopeId","data-v-496937c4"]]);export{De as default};
