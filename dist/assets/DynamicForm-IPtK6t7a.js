import{x as q,r as U,j as ee,I as B,aq as te,G as x,ag as w,H as _,y as k,P as C,J as L,a6 as N,O as F,C as T,D as G,L as A,M as I,A as se,Q as re,z as p}from"./vendor-CcmhhHhJ.js";import{t as le}from"./testResultService-B56Keqpe.js";import{u as H,s as oe,b as ae}from"./index-BmK0bamU.js";import{E as $}from"./elementPlus-Be5V1zcU.js";const ne={key:2,class:"correct-answer-hint"},ie={class:"reading-lable",style:{"margin-bottom":"20px"}},W=2,ce=q({__name:"DynamicForm",props:{questions:{},testId:{},testName:{},type:{},scoreWeight:{}},emits:["submitAnswers","limitReached"],setup(J,{emit:P}){const o=J,M=P,r=U({}),Q=U({}),b=U(!1),j=U(!1),V=U({}),K=a=>{const n=a.split(";");return n.length>1?n.map((h,f)=>`${f+1}.${h}`).join(";"):a},D=(a,n,h)=>{if(!b.value||!V.value[a.id])return"";const f=`${n}`,i=V.value[a.id],m=a.correct_answer.split(";");if(i.isCorrect)return"";const v=m.includes(f);let g=!1;return a.is_multiple?g=i.userAnswer.split(";").includes(f)&&!v:g=i.userAnswer===f&&!v,g?"wrong-option":v?"correct-option":""},z=(a,n,h)=>{const f=D(a,n);return f==="wrong-option"?{color:"#f56c6c !important",backgroundColor:"#fef0f0 !important",borderColor:"#f56c6c !important"}:f==="correct-option"?{color:"#67c23a !important",backgroundColor:"#f0f9ff !important",borderColor:"#67c23a !important"}:{}},E=async()=>{var a;try{const h=(a=H().user)==null?void 0:a.user_id;if(!h)throw new Error("用户未登录");const{data:f,error:i,count:m}=await oe.from("test_results").select("*",{count:"exact"}).eq("user_id",h).eq("test_id",o.testId);if(i)throw i;return{count:m||0,hasReachedLimit:(m||0)>=W}}catch(n){return console.error("检查尝试次数失败:",n),{count:0,hasReachedLimit:!1}}},X=async()=>{var f;if(!o.questions.every(i=>{if(i.question_type=="select"){const m=r.value[i.id];return i.is_multiple?Array.isArray(m)&&m.length>0:m!==void 0&&m!==""}else return r.value[i.id]!==void 0&&r.value[i.id].trim()!==""})){$.error("请将所有题目作答完毕后再提交");return}const{count:n,hasReachedLimit:h}=await E();if(h){$.error(`您已达到最大尝试次数(${W}次)，不能再次作答`);return}j.value=!0;try{const m=(f=H().user)==null?void 0:f.user_id;if(!m)throw new Error("用户未登录");let v=0;const g=[];for(const t of o.questions){let y,c;if(t.question_type==="select")if(t.is_multiple){const l=r.value[t.id];Array.isArray(l)&&l.length>0?(y=l.map(e=>e.split(".")[1]).join(";"),c=l[0].split("-")[0]):(y="",c=`第${o.questions.indexOf(t)+1}题`)}else{const l=r.value[t.id];l&&typeof l=="string"?(y=l.split(".")[1]||"",c=l.split("-")[0]||`第${o.questions.indexOf(t)+1}题`):(y="",c=`第${o.questions.indexOf(t)+1}题`)}else y=r.value[t.id]||"",c=`第${o.questions.indexOf(t)+1}题`;if(t.question_type==="reading")v+=0,g.push({questionIndex:c,questionId:t.id,userAnswer:y,correctAnswer:"待批改"});else{let l=!1;if(t.is_multiple){const e=y.split(";").sort(),d=t.correct_answer.split(";").sort();l=e.length===d.length&&e.every((s,u)=>s===d[u])}else l=y===t.correct_answer;l?v+=parseFloat((o.scoreWeight/o.questions.length).toFixed(2)):g.push({questionIndex:c,questionId:t.id,userAnswer:y,correctAnswer:t.correct_answer})}}const S={user_id:m,test_id:o.testId,test_title:o.testName,score:Math.min(parseFloat(v.toFixed(2)),o.scoreWeight),is_passed:v>=60,submitted_at:new Date().toISOString(),completion_status:"completed",is_graded:o.type==="select",type:o.type},O=o.questions.map((t,y)=>{let c="",l=!1,e=0;if(t.question_type==="select"){if(t.is_multiple){const d=r.value[t.id];if(Array.isArray(d)&&d.length>0){c=d.map(R=>R.split(".")[1]).join(";");const s=d.map(R=>R.split(".")[1]).sort(),u=t.correct_answer.split(";").sort();l=s.length===u.length&&s.every((R,Z)=>R===u[Z])}}else{const d=r.value[t.id];d&&typeof d=="string"&&(c=d.split(".")[1]||"",l=c===t.correct_answer)}l&&(e=o.type==="select"?parseFloat((o.scoreWeight/o.questions.length).toFixed(2)):5)}else t.question_type==="reading"?(c=r.value[t.id]||"",l=null,e=0):(c=r.value[t.id]||"",l=c===t.correct_answer,e=l?5:0);return t.question_type==="select"&&(V.value[t.id]={userAnswer:c,isCorrect:l}),{test_result_id:"",question_id:String(t.id)||"",question_type:t.question_type||"",question_text:t.text,answer:c,is_correct:l,score:Math.min(parseFloat(e.toFixed(2)),o.scoreWeight),question_order:y+1}});await le.submitTestResult(S,O),o.type==="select"?($.success("测试答案提交成功！"),b.value=!0):($.success("答案已提交，请等待管理员批改！"),b.value=!0),M("submitAnswers",{answers:r.value,score:Math.min(parseFloat(v.toFixed(2)),o.scoreWeight),incorrectAnswers:g})}catch(i){console.error("提交测试结果失败:",i),$.error("提交测试结果失败，请稍后重试")}finally{j.value=!1}},Y=()=>{b.value=!1,r.value={},V.value={}};return ee(async()=>{const{hasReachedLimit:a}=await E();a&&($.warning(`您已达到最大尝试次数(${W}次)，不能再次作答`),M("limitReached"))}),(a,n)=>{const h=w("el-checkbox"),f=w("el-checkbox-group"),i=w("el-radio"),m=w("el-radio-group"),v=w("el-text"),g=w("el-input"),S=w("el-form-item"),O=w("el-button"),t=w("el-tooltip"),y=w("el-empty"),c=w("el-form"),l=te("loading");return B((p(),x(c,{"element-loading-text":"Loading...",model:Q.value,"label-width":"auto",style:{width:"100%","max-width":"800px"},class:"responsive-form"},{default:_(()=>[(p(!0),k(F,null,N(a.questions,(e,d)=>(p(),x(S,{key:e.id,label:e.question_type==="reading"?"":`${d+1}. ${e.text}`,"label-position":"left",style:{"flex-direction":"column"}},{default:_(()=>[e.question_type==="select"?(p(),k(F,{key:0},[e.is_multiple?(p(),x(f,{key:0,modelValue:r.value[e.id],"onUpdate:modelValue":s=>r.value[e.id]=s,disabled:b.value},{default:_(()=>[(p(!0),k(F,null,N(e.options,(s,u)=>(p(),x(h,{key:u,value:`第${d+1}题-${String.fromCharCode(65+u)}.${s}`,class:G(D(e,s,u)),style:T(z(e,s,u))},{default:_(()=>[A(I(`${String.fromCharCode(65+u)}. ${s}`),1)]),_:2},1032,["value","class","style"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])):(p(),x(m,{key:1,modelValue:r.value[e.id],"onUpdate:modelValue":s=>r.value[e.id]=s,disabled:b.value},{default:_(()=>[(p(!0),k(F,null,N(e.options,(s,u)=>(p(),x(i,{key:u,value:`第${d+1}题-${String.fromCharCode(65+u)}.${s}`,class:G(D(e,s,u)),style:T(z(e,s,u))},{default:_(()=>[A(I(`${String.fromCharCode(65+u)}. ${s}`),1)]),_:2},1032,["value","class","style"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])),b.value&&V.value[e.id]&&!V.value[e.id].isCorrect?(p(),k("div",ne,[C(v,{type:"success"},{default:_(()=>[A("正确答案："+I(K(e.correct_answer)),1)]),_:2},1024)])):L("",!0)],64)):e.question_type==="judge"?(p(),x(m,{key:1,modelValue:r.value[e.id],"onUpdate:modelValue":s=>r.value[e.id]=s},{default:_(()=>[C(i,{value:"是"},{default:_(()=>n[0]||(n[0]=[A("对")])),_:1}),C(i,{value:"否"},{default:_(()=>n[1]||(n[1]=[A("错")])),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"])):e.question_type==="fill"?(p(),x(g,{key:2,modelValue:r.value[e.id],"onUpdate:modelValue":s=>r.value[e.id]=s,placeholder:"请填写答案"},null,8,["modelValue","onUpdate:modelValue"])):e.question_type==="question"?(p(),x(g,{key:3,modelValue:r.value[e.id],"onUpdate:modelValue":s=>r.value[e.id]=s,type:"textarea",placeholder:"请简要描述"},null,8,["modelValue","onUpdate:modelValue"])):e.question_type==="reading"?(p(),k(F,{key:4},[se("div",ie,[C(v,{class:"mx-1",size:"large",style:{"line-height":"1"}},{default:_(()=>[A(I(d+1)+". "+I(e.text),1)]),_:2},1024)]),C(g,{modelValue:r.value[e.id],"onUpdate:modelValue":s=>r.value[e.id]=s,type:"textarea",placeholder:"请阅读并回答",autosize:{minRows:6,maxRows:15}},null,8,["modelValue","onUpdate:modelValue"])],64)):L("",!0)]),_:2},1032,["label"]))),128)),C(S,{"label-position":"left"},{default:_(()=>[C(O,{style:{"margin-left":"0","margin-right":"50px"},type:"primary",onClick:X,disabled:b.value},{default:_(()=>n[2]||(n[2]=[A("提交答案")])),_:1},8,["disabled"]),C(t,{class:"box-item",effect:"dark",content:"点击后将清空所有答案",placement:"top-start"},{default:_(()=>[B(C(O,{type:"warning",plain:"",onClick:Y},{default:_(()=>n[3]||(n[3]=[A("重新作答")])),_:1},512),[[re,b.value]])]),_:1})]),_:1}),a.questions.length?L("",!0):(p(),x(y,{key:0,description:"暂无数据"}))]),_:1},8,["model"])),[[l,!a.questions.length]])}}}),_e=ae(ce,[["__scopeId","data-v-737c2496"]]);export{_e as D};
