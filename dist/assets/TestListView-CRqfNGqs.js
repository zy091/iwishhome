import{x as ae,r as c,X as se,j as oe,az as le,c as ne,y as m,P as o,I as re,H as n,ag as u,aq as ie,G as x,J as I,O as ce,a6 as ue,L as d,A as l,M as p,aA as de,z as r}from"./vendor-CcmhhHhJ.js";import{e as pe,b as me}from"./index-UMOi9Opk.js";import{t as _e,P as ve}from"./PersonalTestHistory-DZDUamNi.js";import{t as fe}from"./testResultService-BT_tK6YZ.js";import{E as V,c as ge}from"./elementPlus-Be5V1zcU.js";import"./supabase-fOlwtt9p.js";const ye={class:"test-list-container"},he={class:"test-list"},be={key:1,class:"test-grid"},we={class:"test-card-content"},Te={class:"test-type-tag flex"},ke={class:"test-title"},xe={class:"test-info"},Ve={class:"info-item"},Ce={class:"info-item"},ze={class:"info-item"},Be={class:"test-status"},Re={key:0,class:"status-tag"},Se={class:"score-text"},qe={key:1,class:"status-tag"},Ie={key:2,class:"status-tag"},Le={class:"test-actions"},De={key:2,class:"pagination"},Ee=ae({__name:"TestListView",setup(Ne){const L=de(),y=c(!0),C=c([]),D=c({}),h=c(""),b=c(""),z=c(!1),_=se({page:1,pageSize:10,total:0}),F=e=>{_.page=e.page,_.pageSize=e.pageSize,B()},E=c([]),G=async()=>{try{const{data:e}=await fe.getUserTestResults({page:1,pageSize:100}),t={};e.forEach(s=>{s.test_id&&(!t[s.test_id]||new Date(s.submitted_at)>new Date(t[s.test_id].submitted_at))&&(t[s.test_id]=s)}),E.value=e,D.value=t}catch(e){console.error("加载测试结果失败:",e),V.error("加载测试结果失败，请稍后重试")}};oe(async()=>{await Promise.all([B(),G()])});const N=le(),O=c(N.query.platform||"google"),J=c(N.query.chapter||"base"),B=async()=>{y.value=!0;try{const{data:e,total:t}=await _e.getTests({platform:O.value,chapter:J.value});_.total=t;let s=[...e];h.value&&(s=s.filter(i=>i.title.toLowerCase().includes(h.value.toLowerCase()))),b.value&&(s=s.filter(i=>i.type===b.value)),C.value=s,_.total=s.length}catch(e){console.error("加载测验失败:",e),V.error("加载测验失败，请稍后重试")}finally{y.value=!1}},R=()=>{_.page=1,B()},v=ne(()=>e=>D.value[e]),Q=e=>{var i;if(e.type==="case"&&T(e.id)>=3){V.warning("您已达到最大尝试次数(3次)，不能再次作答");return}const t=e.type;let s="";switch(t){case"case":s="case-study";break;case"select":s="multiple-choice";break;case"comprehensive":s="comprehensive-test";break;default:s="multiple-choice"}((i=v.value(e.id))==null?void 0:i.completion_status)==="completed"?ge.confirm("您已完成此测验，确定要重新开始吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{L.push({name:s,query:{testId:e.id,testName:f(e.platform||"")+"-"+f(e.chapter||"")+"-"+e.title,platform:e.platform,chapter:e.chapter,type:e.type}})}).catch(()=>{V.info("已取消重新开始")}):L.push({name:s,query:{testId:e.id,testName:f(e.platform||"")+"-"+f(e.chapter||"")+"-"+e.title,platform:e.platform,chapter:e.chapter,type:e.type}})},w=c(null),X=e=>{w.value=e,z.value=!0},f=e=>{switch(e){case"select":return"选择题";case"case":return"案例分析";case"comprehensive":return"综合测验";case"google":return"Google";case"facebook":return"FaceBook";case"base":return"基础";case"middle":return"中级";case"advanced":return"高级";default:return"未知类型"}},S=e=>{switch(e){case"select":return"primary";case"case":return"success";case"comprehensive":return"warning";case"google":return"danger";case"facebook":return"primary";case"base":return"primary";case"middle":return"success";case"advanced":return"warning";default:return"info"}},T=e=>{let t=0;return Object.values(E.value).forEach(s=>{s.test_id===e&&t++}),t},K=(e,t)=>{if(T((t==null?void 0:t.id)||"")>=3)return"尝试次数已用完";switch(e){case"completed":return"重新测试";case"in_progress":return"继续测试";default:return"开始测试"}},W=e=>e?e.is_graded?e.type==="case"&&e.grade_level?`评级: ${e.grade_level}`:`${e.score}分`:"待批改":"0分";return(e,t)=>{var $;const s=u("el-input"),i=u("el-option"),U=u("el-select"),q=u("el-button"),Y=u("el-space"),M=u("el-card"),Z=u("el-empty"),g=u("el-tag"),ee=u("el-dialog"),te=ie("loading");return r(),m("div",ye,[o(M,{class:"testing-search",style:{"margin-bottom":"20px"}},{default:n(()=>[o(Y,{wrap:"",alignment:"start",size:30},{default:n(()=>[o(s,{size:"large",style:{width:"240px"},modelValue:h.value,"onUpdate:modelValue":t[0]||(t[0]=a=>h.value=a),placeholder:"搜索测验名称",class:"search-input",clearable:"",onInput:R},null,8,["modelValue"]),o(U,{size:"large",style:{width:"240px"},modelValue:b.value,"onUpdate:modelValue":t[1]||(t[1]=a=>b.value=a),placeholder:"测验类型",onChange:R,class:"filter-select"},{default:n(()=>[o(i,{label:"全部类型",value:""}),o(i,{label:"选择题",value:"select"}),o(i,{label:"案例分析",value:"case"}),o(i,{label:"综合测验",value:"comprehensive"})]),_:1},8,["modelValue"]),o(q,{type:"primary",size:"large",onClick:R},{default:n(()=>t[3]||(t[3]=[d("搜索")])),_:1})]),_:1})]),_:1}),re((r(),m("div",he,[C.value.length===0&&!y.value?(r(),x(Z,{key:0,description:"暂无测验内容"})):(r(),m("div",be,[(r(!0),m(ce,null,ue(C.value,a=>(r(),x(M,{key:a.id,class:"test-card",shadow:"hover"},{default:n(()=>{var A,P,H,j;return[l("div",we,[l("div",Te,[o(g,{type:S(a.type)},{default:n(()=>[d(p(f(a.type)),1)]),_:2},1032,["type"]),o(g,{type:S(a.platform||"")},{default:n(()=>[d(p(f(a.platform||"")),1)]),_:2},1032,["type"]),o(g,{type:S(a.chapter||"")},{default:n(()=>[d(p(f(a.chapter||"")),1)]),_:2},1032,["type"])]),l("h3",ke,p(a.title),1),l("div",xe,[l("div",Ve,[t[4]||(t[4]=l("i",{class:"el-icon-question"},null,-1)),l("span",null,p(a.question_count||0)+"道题目",1)]),l("div",Ce,[t[5]||(t[5]=l("i",{class:"el-icon-medal"},null,-1)),l("span",null,p(a.score_weight||100)+"分值",1)]),l("div",ze,[t[6]||(t[6]=l("i",{class:"el-icon-refresh"},null,-1)),l("span",null,"尝试次数: "+p(T(a.id))+"/3",1)])]),l("div",Be,[((A=v.value(a.id))==null?void 0:A.completion_status)==="completed"?(r(),m("div",Re,[o(g,{type:"success"},{default:n(()=>t[7]||(t[7]=[d("已完成")])),_:1}),l("span",Se,"最新分数: "+p(W(v.value(a.id))),1)])):((P=v.value(a.id))==null?void 0:P.completion_status)==="in_progress"?(r(),m("div",qe,[o(g,{type:"warning"},{default:n(()=>t[8]||(t[8]=[d("进行中")])),_:1})])):(r(),m("div",Ie,[o(g,{type:"info"},{default:n(()=>t[9]||(t[9]=[d("未开始")])),_:1})]))]),l("div",Le,[o(q,{type:"primary",disabled:((H=v.value(a.id))==null?void 0:H.completion_status)==="in_progress"||T(a.id)>=3,onClick:k=>Q(a)},{default:n(()=>{var k;return[d(p(K((k=v.value(a.id))==null?void 0:k.completion_status,a)),1)]}),_:2},1032,["disabled","onClick"]),((j=v.value(a.id))==null?void 0:j.completion_status)==="completed"?(r(),x(q,{key:0,type:"info",plain:"",onClick:k=>X(a)},{default:n(()=>t[10]||(t[10]=[d(" 查看历史 ")])),_:2},1032,["onClick"])):I("",!0)])])]}),_:2},1024))),128))])),_.total>0?(r(),m("div",De,[o(pe,{pagination:_,onUpdate:F},null,8,["pagination"])])):I("",!0)])),[[te,y.value]]),o(ee,{modelValue:z.value,"onUpdate:modelValue":t[2]||(t[2]=a=>z.value=a),title:(($=w.value)==null?void 0:$.title)+" - 测试历史记录",width:"800px"},{default:n(()=>[w.value?(r(),x(ve,{key:0,testId:w.value.id},null,8,["testId"])):I("",!0)]),_:1},8,["modelValue","title"])])}}}),je=me(Ee,[["__scopeId","data-v-ad60db1b"]]);export{je as default};
