import{s as v,d as je,J as ee,u as Ae,k as pe,r as p,o as Oe,p as Ie,l as x,a,e as o,K as Re,w as l,b as c,P as Je,M as h,c as T,q as V,g as N,a5 as Ke,f as _,y as Qe,O as We,t as S,x as Ge,ab as Xe,ac as Ye,ad as Ze,a1 as et,F as tt,m as at,a2 as lt,U as _e,j as m,_ as nt}from"./index-BmUZ9zWv.js";import{m as ot,r as st,u as rt}from"./xlsx-Buy6WJaV.js";const it=s=>s===0,K={async getAllDocuments(s={}){let r=v.from("documents").select("*",{count:"exact"});s.query&&(r=r.ilike("title",`%${s.query}%`)),s.category&&s.category!=="all"&&(r=r.eq("category",s.category)),s.startDate&&s.endDate&&(r=r.gte("created_at",s.startDate).lte("created_at",s.endDate)),s.showStatus!==void 0?r=r.eq("is_show",s.showStatus==="true"):r=r.eq("is_show",!0);const f=((s.page||1)-1)*(s.pageSize||10),u=f+(s.pageSize||10)-1,{data:U,error:y,count:$}=await r.order("created_at",{ascending:!1}).range(f,u);if(y)throw y;return{data:U,total:$||0}},async getDocument(s){const{data:r,error:f}=await v.from("documents").select("*").eq("id",s).single();if(f)throw f;return r},async createDocument(s){const{data:{user:r}}=await v.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:f,error:u}=await v.from("user_profiles").select("full_name").eq("user_id",r.id).single();if(u)throw u;const{data:U,error:y}=await v.from("documents").insert({...s,created_by:r.id,created_by_name:f.full_name||r.email}).select().single();if(y)throw y;return U},async updateDocument(s,r){const{data:f,error:u}=await v.from("documents").update(r).eq("id",s).select().single();if(u)throw u;return f},async deleteDocument(s){const{error:r}=await v.from("documents").delete().eq("id",s);if(r)throw r},async uploadFile(s,r){const f=`${new Date().getTime()}_${s.name}`,u=`${r}/${f}`,{data:U,error:y}=await v.storage.from("documents").upload(u,s);if(y)throw y;const{data:{publicUrl:$}}=v.storage.from("documents").getPublicUrl(u);return{url:$,filename:f}}},ct={class:"layout"},ut={class:"layout-title"},dt={class:"status-tabs"},mt={class:"documents-content"},pt={class:"card-header"},_t={key:0,class:"header-actions"},ft={style:{"font-size":"14px",color:"#909399"}},gt={class:"dialog-content"},vt={class:"document-details"},ht={class:"document-header"},yt={class:"document-title"},wt={class:"document-meta"},bt={class:"meta-item"},xt={class:"meta-item"},kt={class:"meta-item"},Dt={class:"document-section"},Vt=["innerHTML"],St={key:0,class:"document-section"},Ct={key:0,class:"attachment-loading"},Tt={key:1},Ut={key:0,class:"pdf-viewer"},$t=["src"],Et=["innerHTML"],zt=["innerHTML"],Bt={key:4,class:"attachment-link"},qt=["href"],Ft={key:5,class:"editor-container"},Lt={class:"dialog-footer"},Mt={class:"dialog-footer"},Nt=je({__name:"CompanyDocuments",setup(s){const r=ee([{name:"公司文档",path:"/system/company-documents"}]),f=Ae();pe(()=>{var t;return((t=f.user)==null?void 0:t.user_id)||""});const u=pe(()=>it(Number(f.roleId))),U=p(!1),y=p([]),$=p(!1),P=p(!1),g=p(null),X=p(""),E=p([]),Q=p(""),W=p(!1),O=p("all"),q=p([]),Y=p(),F=p(!1),i=ee({id:"",title:"",content:"",category:"",is_show:!0,attachment_url:"",attachment_name:""}),fe={title:[{required:!0,message:"请输入文档标题",trigger:"blur"},{min:2,max:100,message:"标题长度应在2到100个字符之间",trigger:"blur"}],category:[{required:!0,message:"请选择文档类型",trigger:"change"}],content:[{required:!0,message:"请输入文档内容",trigger:"blur"},{min:8,max:1e4,message:"内容长度应在8到10000个字符之间",trigger:"blur"}]},ge=[{label:"假勤",value:"attendance"},{label:"行政",value:"administrative"},{label:"财务",value:"financial"},{label:"人事",value:"hr"},{label:"其他",value:"other"}],z=ee({page:1,pageSize:10,total:0}),ve=p(null),G=p(!1),k=p(""),he=p(!1),te=p([]),H=p(null),ye=[{text:"最近一周",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近一个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近三个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],we=t=>{switch(t){case"attendance":return"primary";case"administrative":return"success";case"financial":return"warning";case"hr":return"danger";case"other":return"info";default:return"info"}},ae=t=>{switch(t){case"attendance":return"假勤";case"administrative":return"行政";case"financial":return"财务";case"hr":return"人事";case"other":return"其他";default:return t||"未知"}},be=t=>{z.page=t.page,z.pageSize=t.pageSize,L()},L=async()=>{U.value=!0;const t=E.value!=null&&E.value[0]!=null?E.value[0].toDateString():"",e=E.value!=null&&E.value[1]!=null?E.value[1].toDateString():"";try{const d=await K.getAllDocuments({query:X.value,startDate:t,endDate:e,page:z.page,pageSize:z.pageSize,category:O.value!=="all"?O.value:void 0,showStatus:u.value&&Q.value!==""?Q.value:void 0});y.value=d.data,z.total=d.total}catch(d){h.error("搜索文档失败"),console.error("搜索文档失败:",d)}finally{U.value=!1}},xe=async t=>{if($.value=!0,g.value=t,k.value="",G.value=!0,t.attachment_url)try{const e=j(t.attachment_name);let d="";if(t.attachment_url&&t.attachment_url.includes("/materials/")&&(d=t.attachment_url.split("/materials/").pop()||""),Se(t.attachment_name))k.value=t.attachment_url;else if(le(t.attachment_name))k.value=t.attachment_url;else if(ne(t.attachment_name))if(d){const{data:C,error:w}=await v.storage.from("materials").download(d);if(w)throw w;const B=await C.arrayBuffer(),D=await ot.convertToHtml({arrayBuffer:B}),A=`
                        <style>
                            .word-content {
                                font-family: Arial, sans-serif;
                                line-height: 1.6;
                                padding: 20px;
                            }
                            .word-content p {
                                margin: 0 0 1em 0;
                            }
                            .word-content h1, .word-content h2, .word-content h3 {
                                margin: 1em 0 0.5em 0;
                            }
                            .word-content table {
                                border-collapse: collapse;
                                margin: 1em 0;
                            }
                            .word-content td, .word-content th {
                                border: 1px solid #ddd;
                                padding: 8px;
                            }
                        </style>
                    `;k.value=A+'<div class="word-content">'+D.value+"</div>"}else throw new Error("无法解析文件路径");else if(oe(t.attachment_name))if(d){const{data:C,error:w}=await v.storage.from("materials").download(d);if(w)throw w;const B=await C.arrayBuffer(),D=st(B,{type:"array"}),A=D.Sheets[D.SheetNames[0]],b=rt.sheet_to_html(A),Z=`
                        <style>
                            .excel-content {
                                font-family: Arial, sans-serif;
                                line-height: 1.6;
                                padding: 20px;
                            }
                            .excel-content table {
                                border-collapse: collapse;
                                width: 100%;
                                margin: 1em 0;
                            }
                            .excel-content td, .excel-content th {
                                border: 1px solid #ddd;
                                padding: 8px;
                                text-align: left;
                            }
                            .excel-content th {
                                background-color: #f5f5f5;
                            }
                            .excel-content tr:nth-child(even) {
                                background-color: #f9f9f9;
                            }
                        </style>
                    `;k.value=Z+'<div class="excel-content">'+b+"</div>"}else throw new Error("无法解析文件路径");else k.value=t.attachment_url}catch(e){console.error("获取附件内容失败:",e),h.error(`获取附件内容失败: ${e.message||"未知错误"}`)}finally{G.value=!1}else G.value=!1},ke=t=>{F.value=!0,P.value=!0,Object.assign(i,{id:t.id,title:t.title,content:t.content,category:t.category,is_show:t.is_show,attachment_url:t.attachment_url,attachment_name:t.attachment_name})},De=()=>{F.value=!1,P.value=!0,Object.assign(i,{id:"",title:"",content:"",category:"",is_show:!0,attachment_url:"",attachment_name:""})},Ve=t=>{q.value=t},j=t=>{if(!t)return"";const e=t.split(".");return e.length>1?e[e.length-1].toLowerCase():""},le=t=>{const e=j(t);return["jpg","jpeg","png","gif","webp"].includes(e)},ne=t=>{const e=j(t);return["doc","docx"].includes(e)},oe=t=>{const e=j(t);return["xls","xlsx"].includes(e)},Se=t=>j(t)==="pdf",Ce=t=>{const e=["application/pdf","application/msword","text/plain","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/jpeg","image/png","image/gif","image/webp"],d=t.raw&&e.includes(t.raw.type),C=t.raw&&t.raw.size/1024/1024<10;if(!d)return h.error("文件类型不支持！"),!1;if(!C)return h.error("文件大小超过 10MB 限制！"),!1;H.value=t.raw,console.log("Selected file:",H.value)},Te=async t=>{if(!t)throw new Error("No file selected");const e=t.name.split(".").pop(),C=`companydocuments/${`${Date.now()}-${Math.random().toString(36).substring(2)}.${e}`}`,{data:w,error:B}=await v.storage.from("materials").upload(C,t);if(B)throw B;const{data:D}=v.storage.from("materials").getPublicUrl(w.path);return D.publicUrl},Ue=async()=>{Y.value&&await Y.value.validate(async t=>{if(t){W.value=!0;try{if(H.value)try{const e=await Te(H.value);i.attachment_url=e,i.attachment_name=H.value.name}catch(e){h.error(`文件上传失败: ${e.message||"未知错误"}`),W.value=!1;return}F.value?(await K.updateDocument(i.id,{title:i.title,content:i.content,category:i.category,is_show:i.is_show,attachment_url:i.attachment_url,attachment_name:i.attachment_name}),h.success("文档已更新")):(await K.createDocument({title:i.title,content:i.content,category:i.category,is_show:i.is_show,attachment_url:i.attachment_url,attachment_name:i.attachment_name}),h.success("文档已创建")),P.value=!1,L(),te.value=[],H.value=null}catch(e){h.error(F.value?"更新文档失败":"创建文档失败"),console.error(F.value?"更新文档失败:":"创建文档失败:",e)}finally{W.value=!1}}})},$e=async t=>{try{await _e.confirm(`确定要删除 "${t.title}" 这份文档吗？`,"提示",{type:"warning"}),await K.deleteDocument(t.id),h.success("删除成功"),L()}catch(e){e!=="cancel"&&(h.error("删除失败"),console.error("删除失败:",e))}},Ee=async()=>{if(q.value.length!==0)try{await _e.confirm(`确定要删除选中的 ${q.value.length} 份文档吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=q.value.map(e=>K.deleteDocument(e.id));await Promise.all(t),h.success(`成功删除 ${q.value.length} 份文档`),q.value=[],L()}catch(t){t!=="cancel"&&(console.error("批量删除文档失败:",t),h.error("批量删除失败"))}},ze=t=>{O.value=t,z.page=1,L()};return Oe(()=>{L()}),Ie(()=>{}),(t,e)=>{const d=c("el-tab-pane"),C=c("el-tabs"),w=c("el-input"),B=c("el-date-picker"),D=c("el-option"),A=c("el-select"),b=c("el-button"),Z=c("el-space"),se=c("el-card"),M=c("el-table-column"),re=c("el-tag"),Be=c("el-button-group"),qe=c("el-empty"),Fe=c("el-table"),I=c("el-icon"),Le=c("el-skeleton"),Me=c("el-image"),ie=c("el-dialog"),R=c("el-form-item"),Ne=c("el-upload"),Pe=c("el-switch"),He=We("loading");return m(),x("div",ct,[a(Re,{breadbcrum:r},null,8,["breadbcrum"]),o("div",ut,[e[12]||(e[12]=o("h1",{class:"title"},"公司文档",-1)),o("div",dt,[a(C,{class:"demo-tabs",modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=n=>O.value=n),onTabChange:ze},{default:l(()=>[a(d,{name:"all",label:"全部文档"}),a(d,{name:"attendance",label:"假勤"}),a(d,{name:"administrative",label:"行政"}),a(d,{name:"financial",label:"财务"}),a(d,{name:"hr",label:"人事"}),a(d,{name:"other",label:"其他"})]),_:1},8,["modelValue"])])]),a(se,{shadow:"always",style:{"margin-bottom":"20px"}},{default:l(()=>[a(Z,{alignment:"start",size:30},{default:l(()=>[a(w,{modelValue:X.value,"onUpdate:modelValue":e[1]||(e[1]=n=>X.value=n),style:{width:"240px"},placeholder:"请输入文档标题","suffix-icon":N(Ke),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),a(B,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=n=>E.value=n),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:ye,size:"large"},null,8,["modelValue"]),u.value?(m(),T(A,{key:0,modelValue:Q.value,"onUpdate:modelValue":e[3]||(e[3]=n=>Q.value=n),placeholder:"选择展示状态",style:{width:"160px"},size:"large",clearable:""},{default:l(()=>[a(D,{label:"显示",value:"true"}),a(D,{label:"隐藏",value:"false"})]),_:1},8,["modelValue"])):V("",!0),a(b,{type:"primary",size:"large",onClick:L},{default:l(()=>e[13]||(e[13]=[_("搜索")])),_:1}),u.value?(m(),T(b,{key:1,type:"success",size:"large",onClick:De},{default:l(()=>e[14]||(e[14]=[_("添加文档")])),_:1})):V("",!0)]),_:1})]),_:1}),o("div",mt,[a(se,{style:{"min-height":"400px"}},{header:l(()=>[o("div",pt,[e[16]||(e[16]=_(" 文档列表 ")),u.value?(m(),x("div",_t,[a(b,{type:"danger",disabled:!q.value.length,onClick:Ee},{default:l(()=>e[15]||(e[15]=[_(" 批量删除 ")])),_:1},8,["disabled"]),o("div",ft,"共计"+S(z.total)+"条数据",1)])):V("",!0)])]),default:l(()=>[Qe((m(),T(Fe,{data:y.value,onSelectionChange:Ve},{default:l(()=>[u.value?(m(),T(M,{key:0,type:"selection",width:"55"})):V("",!0),a(M,{prop:"title",label:"标题","min-width":"200"}),a(M,{prop:"category",label:"类型",width:"130"},{default:l(({row:n})=>[a(re,{type:we(n.category),size:"large"},{default:l(()=>[_(S(ae(n.category)),1)]),_:2},1032,["type"])]),_:1}),u.value?(m(),T(M,{key:1,prop:"is_show",label:"展示状态",width:"100"},{default:l(({row:n})=>[a(re,{type:n.is_show?"success":"danger",size:"large"},{default:l(()=>[_(S(n.is_show?"显示":"隐藏"),1)]),_:2},1032,["type"])]),_:1})):V("",!0),a(M,{prop:"created_at",label:"创建时间",width:"180"},{default:l(({row:n})=>[_(S(new Date(n.created_at).toLocaleString()),1)]),_:1}),u.value?(m(),T(M,{key:2,prop:"created_by_name",label:"创建人",width:"120"})):V("",!0),a(M,{label:"操作",width:"230",fixed:"right"},{default:l(({row:n})=>[a(Be,null,{default:l(()=>[a(b,{type:"primary",onClick:J=>xe(n)},{default:l(()=>e[17]||(e[17]=[_("查看")])),_:2},1032,["onClick"]),u.value?(m(),T(b,{key:0,type:"warning",onClick:J=>ke(n)},{default:l(()=>e[18]||(e[18]=[_("编辑")])),_:2},1032,["onClick"])):V("",!0),u.value?(m(),T(b,{key:1,type:"danger",onClick:J=>$e(n)},{default:l(()=>e[19]||(e[19]=[_("删除")])),_:2},1032,["onClick"])):V("",!0)]),_:2},1024)]),_:1}),a(qe,null,{description:l(()=>e[20]||(e[20]=[_(" 暂无文档数据 ")])),_:1})]),_:1},8,["data"])),[[He,U.value]])]),_:1}),a(Je,{pagination:z,"onUpdate:pagination":be},null,8,["pagination"]),a(ie,{title:"文档详情",modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=n=>$.value=n),width:"60%","close-on-click-modal":!1,top:"5vh",class:"document-detail-dialog"},{footer:l(()=>[o("span",Lt,[a(b,{onClick:e[4]||(e[4]=n=>$.value=!1)},{default:l(()=>e[23]||(e[23]=[_("关闭")])),_:1})])]),default:l(()=>{var n,J,ce,ue,de,me;return[o("div",gt,[o("div",vt,[o("div",ht,[o("h2",yt,S(((n=g.value)==null?void 0:n.title)||"无标题"),1),o("div",wt,[o("span",bt,[a(I,null,{default:l(()=>[a(N(Ge))]),_:1}),o("span",null,S(((J=g.value)==null?void 0:J.created_by_name)||"未知用户"),1)]),o("span",xt,[a(I,null,{default:l(()=>[a(N(Xe))]),_:1}),o("span",null,S(g.value?new Date((ce=g.value)==null?void 0:ce.created_at).toLocaleString():"未知时间"),1)]),o("span",kt,[a(I,null,{default:l(()=>[a(N(Ye))]),_:1}),o("span",null,S(ae(((ue=g.value)==null?void 0:ue.category)||"")),1)])])]),o("div",Dt,[e[21]||(e[21]=o("div",{class:"section-title"},"内容",-1)),o("div",{class:"document-content",style:{padding:"10px"},innerHTML:((de=g.value)==null?void 0:de.content)||"无内容"},null,8,Vt)]),(me=g.value)!=null&&me.attachment_url?(m(),x("div",St,[e[22]||(e[22]=o("div",{class:"section-title"},"附件",-1)),G.value?(m(),x("div",Ct,[a(Le,{rows:3,animated:""})])):(m(),x("div",Tt,[j(g.value.attachment_name)==="pdf"?(m(),x("div",Ut,[o("iframe",{src:k.value,width:"100%",height:"600",frameborder:"0"},null,8,$t)])):le(g.value.attachment_name)?(m(),T(Me,{key:1,src:k.value,fit:"contain",style:{"max-width":"100%"}},null,8,["src"])):ne(g.value.attachment_name)?(m(),x("div",{key:2,class:"document-viewer",innerHTML:k.value},null,8,Et)):oe(g.value.attachment_name)?(m(),x("div",{key:3,class:"document-viewer",innerHTML:k.value},null,8,zt)):(m(),x("div",Bt,[o("a",{href:g.value.attachment_url,target:"_blank",class:"download-link"},[a(I,null,{default:l(()=>[a(N(Ze))]),_:1}),_(" 下载附件 ("+S(g.value.attachment_name)+") ",1)],8,qt)])),he.value?(m(),x("div",Ft,[o("div",{ref_key:"editor",ref:ve},null,512)])):V("",!0)]))])):V("",!0)])])]}),_:1},8,["modelValue"]),a(ie,{title:F.value?"编辑文档":"创建文档",modelValue:P.value,"onUpdate:modelValue":e[11]||(e[11]=n=>P.value=n),width:"50%","close-on-click-modal":!1},{footer:l(()=>[o("span",Mt,[a(b,{onClick:e[10]||(e[10]=n=>P.value=!1)},{default:l(()=>e[26]||(e[26]=[_("取消")])),_:1}),a(b,{type:"primary",onClick:Ue,loading:W.value},{default:l(()=>[_(S(F.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:l(()=>[a(N(et),{model:i,rules:fe,ref_key:"documentForm",ref:Y,"label-width":"80px",style:{"max-width":"800px"}},{default:l(()=>[a(R,{label:"标题",prop:"title"},{default:l(()=>[a(w,{modelValue:i.title,"onUpdate:modelValue":e[6]||(e[6]=n=>i.title=n),placeholder:"请输入文档标题"},null,8,["modelValue"])]),_:1}),a(R,{label:"类型",prop:"category"},{default:l(()=>[a(A,{modelValue:i.category,"onUpdate:modelValue":e[7]||(e[7]=n=>i.category=n),placeholder:"选择文档类型",style:{width:"100%"}},{default:l(()=>[(m(),x(tt,null,at(ge,n=>a(D,{key:n.value,label:n.label,value:n.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(R,{label:"内容",prop:"content"},{default:l(()=>[a(w,{type:"textarea",modelValue:i.content,"onUpdate:modelValue":e[8]||(e[8]=n=>i.content=n),rows:10,placeholder:"请输入文档内容"},null,8,["modelValue"])]),_:1}),a(R,{label:"附件"},{default:l(()=>[a(Ne,{class:"upload-box","auto-upload":!1,"on-change":Ce,"file-list":te.value,limit:1,drag:"",action:"https://run.mocky.io/v3/9d059bf9-4660-45f2-925d-ce80ad6c4d15",multiple:""},{tip:l(()=>e[24]||(e[24]=[o("div",{class:"el-upload__tip"}," 支持 .pdf, .doc, .docx, .xls, .xlsx 格式文件，不超过10MB ",-1)])),default:l(()=>[a(I,{class:"el-icon--upload"},{default:l(()=>[a(N(lt))]),_:1}),e[25]||(e[25]=o("div",{class:"el-upload__text"},[_(" 拖拽文件或"),o("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),a(R,{label:"状态"},{default:l(()=>[a(Pe,{modelValue:i.is_show,"onUpdate:modelValue":e[9]||(e[9]=n=>i.is_show=n),"active-text":"显示","inactive-text":"隐藏"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])])])}}}),jt=nt(Nt,[["__scopeId","data-v-43df603c"]]);export{jt as default};
