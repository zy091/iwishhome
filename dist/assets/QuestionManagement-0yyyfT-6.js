import{E as k,s as Be,C as Fe,c as re}from"./elementPlus-Be5V1zcU.js";import{B as Me,e as Qe,s as D,b as Ee}from"./index-bysYXhlE.js";import{x as Ne,X as P,r as g,j as Te,y as m,P as s,A as r,H as a,ag as d,u as ie,O as w,a6 as q,L as i,I as je,G as f,J as b,aq as Oe,M as v,D as Ge,z as n}from"./vendor-CcmhhHhJ.js";import"./supabase-fOlwtt9p.js";const Ie={class:"layout"},Le={class:"card-header"},Pe={class:"header-actions"},Re={style:{"font-size":"14px",color:"#909399"}},He={class:"tooltip-content"},Je={class:"text-truncate"},Xe={style:{"margin-top":"10px"}},Ke={class:"question-details"},We={class:"detail-row"},Ye={key:0},Ze={class:"question-text"},et={key:0},tt={key:1,class:"question-text question-text-reading"},lt={class:"options-list"},ot=Ne({__name:"QuestionManagement",setup(at){const ue=P([{name:"数据管理",path:"/system/data-management"},{name:"试题管理",path:"/system/question-management"}]),F=g(!1),O=g([]),M=g(""),Q=g(""),E=g(""),C=g([]),h=g(!1),N=g(!1),T=g(!1),c=g(null),G=g(null),I=g([]),t=P({id:null,text:"",options:["",""],correct_answer:"",question_type:"select",platform:"",tests_id:null,tests_title:"",is_multiple:!1}),R=[{label:"选择题",value:"select"},{label:"判断题",value:"judge"},{label:"填空题",value:"fill"},{label:"问答题",value:"question"},{label:"阅读题",value:"reading"}],L=[{value:"google",label:"Google"},{value:"facebook",label:"Facebook"},{value:"microsoft",label:"Microsoft"},{value:"meta",label:"Meta"},{value:"other",label:"Other"}],V=P({page:1,pageSize:10,total:0}),de={question_type:[{required:!0,message:"请选择题型",trigger:"change"}],platform:[{required:!0,message:"请选择平台",trigger:"change"}],text:[{required:!0,message:"请输入问题内容",trigger:"blur"}],correct_answer:[{required:!0,message:"请选择正确答案",trigger:"change"}]},H=l=>{const e=R.find(u=>u.value===l);return e?e.label:l},J=l=>{const e=L.find(u=>u.value===l);return e?e.label:l},X=(l,e)=>!e||!e.correct_answer?!1:e.is_multiple?e.correct_answer.split(";").includes(l):l===e.correct_answer,pe=async()=>{try{const{data:l,error:e}=await D.from("tests").select("id, title").order("created_at",{ascending:!1});if(e)throw e;I.value=l||[]}catch(l){console.error("获取测试列表失败:",l),k.error("获取测试列表失败")}},me=l=>{if(l){const e=I.value.find(u=>u.id===l);t.tests_title=(e==null?void 0:e.title)||""}else t.tests_title=""},ce=l=>{V.page=l.page,V.pageSize=l.pageSize,z()},_e=l=>{C.value=l},z=async()=>{F.value=!0;try{let l=D.from("googlequestions").select("*",{count:"exact"});M.value&&(l=l.ilike("text",`%${M.value}%`)),Q.value&&(l=l.eq("question_type",Q.value)),E.value&&(l=l.eq("platform",E.value));const{data:e,error:u,count:_}=await l.order("id",{ascending:!1}).range((V.page-1)*V.pageSize,V.page*V.pageSize-1);if(u)throw u;O.value=e||[],V.total=_||0}catch(l){k.error("搜索问题失败"),console.error(l)}finally{F.value=!1}},fe=()=>{T.value=!1,K(),h.value=!0},ve=l=>{T.value=!0,K(),t.id=l.id,t.text=l.text,t.question_type=l.question_type,t.platform=l.platform,t.tests_id=l.tests_id,t.tests_title=l.tests_title||"",t.is_multiple=l.is_multiple||!1,l.question_type==="select"?(t.options=[...l.options],l.is_multiple&&l.correct_answer?t.correct_answer=l.correct_answer.split(";"):t.correct_answer=l.correct_answer):t.correct_answer=l.correct_answer,h.value=!0},ge=l=>{c.value=l,N.value=!0},K=()=>{t.id=null,t.text="",t.options=["",""],t.correct_answer="",t.question_type="select",t.platform="",t.tests_id=null,t.tests_title="",t.is_multiple=!1},ye=()=>{t.options.length<6&&t.options.push("")},be=l=>{t.options.length>2&&(t.options.splice(l,1),t.correct_answer===t.options[l]&&(t.correct_answer=""))},we=async()=>{if(G.value)try{await G.value.validate();const l={text:t.text,question_type:t.question_type,platform:t.platform,tests_id:t.tests_id,tests_title:t.tests_title};t.question_type==="select"?(l.options=t.options,l.is_multiple=t.is_multiple,t.is_multiple&&Array.isArray(t.correct_answer)?l.correct_answer=t.correct_answer.join(";"):l.correct_answer=t.correct_answer):(l.options=null,l.correct_answer=null,l.is_multiple=!1);let e;if(T.value&&t.id){const{data:u,error:_}=await D.from("googlequestions").update(l).eq("id",t.id).select();if(_)throw _;e=u,k.success("问题更新成功")}else{const{data:u,error:_}=await D.from("googlequestions").insert(l).select();if(_)throw _;e=u,k.success("问题添加成功")}h.value=!1,z()}catch(l){l!=="cancel"&&(console.error("保存问题失败:",l),k.error("保存失败，请检查表单"))}},Ve=async l=>{try{await re.confirm("确定要删除这个问题吗？此操作不可恢复。","警告",{type:"warning"});const{error:e}=await D.from("googlequestions").delete().eq("id",l.id);if(e)throw e;k.success("删除成功"),z()}catch(e){e!=="cancel"&&(console.error("删除问题失败:",e),k.error("删除失败"))}},ke=async()=>{if(C.value.length!==0)try{await re.confirm(`确定要删除选中的 ${C.value.length} 个问题吗？此操作不可恢复。`,"警告",{type:"warning"});const l=C.value.map(u=>u.id),{error:e}=await D.from("googlequestions").delete().in("id",l);if(e)throw e;k.success(`成功删除 ${C.value.length} 个问题`),C.value=[],z()}catch(l){l!=="cancel"&&(console.error("批量删除问题失败:",l),k.error("批量删除失败"))}};return Te(()=>{pe(),z()}),(l,e)=>{const u=d("el-input"),_=d("el-option"),U=d("el-select"),y=d("el-button"),xe=d("el-space"),W=d("el-card"),$=d("el-table-column"),qe=d("el-tooltip"),j=d("el-tag"),Ce=d("el-button-group"),he=d("el-table"),ze=d("el-empty"),A=d("el-radio"),Ue=d("el-radio-group"),x=d("el-form-item"),$e=d("el-switch"),Se=d("el-icon"),De=d("el-form"),Y=d("el-dialog"),Ae=Oe("loading");return n(),m("div",Ie,[s(Me,{breadbcrum:ue},null,8,["breadbcrum"]),e[42]||(e[42]=r("div",{class:"layout-title"},[r("h1",{class:"title"},"试题管理")],-1)),s(W,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[s(xe,{wrap:"",alignment:"start",size:30},{default:a(()=>[s(u,{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=o=>M.value=o),style:{width:"240px"},placeholder:"请输入试题内容","suffix-icon":ie(Be),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),s(U,{modelValue:Q.value,"onUpdate:modelValue":e[1]||(e[1]=o=>Q.value=o),placeholder:"题型",clearable:"",style:{width:"180px"},size:"large"},{default:a(()=>[(n(),m(w,null,q(R,o=>s(_,{key:o.value,label:o.label,value:o.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),s(U,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=o=>E.value=o),placeholder:"平台",clearable:"",style:{width:"180px"},size:"large"},{default:a(()=>[(n(),m(w,null,q(L,o=>s(_,{key:o.value,label:o.label,value:o.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),s(y,{type:"primary",size:"large",onClick:z},{default:a(()=>e[16]||(e[16]=[i("搜索")])),_:1}),s(y,{type:"primary",size:"large",onClick:fe},{default:a(()=>e[17]||(e[17]=[i("添加试题")])),_:1})]),_:1})]),_:1}),s(W,{style:{"min-height":"400px"}},{header:a(()=>[r("div",Le,[e[19]||(e[19]=r("span",null,"试题列表",-1)),r("div",Pe,[s(y,{type:"danger",disabled:!C.value.length,onClick:ke},{default:a(()=>e[18]||(e[18]=[i(" 批量删除 ")])),_:1},8,["disabled"]),r("div",Re,"共计 "+v(V.total)+" 条数据",1)])])]),default:a(()=>[je((n(),f(he,{data:O.value,onSelectionChange:_e},{default:a(()=>[s($,{type:"selection",width:"55"}),s($,{prop:"question_type",label:"题型",width:"100"},{default:a(({row:o})=>[i(v(H(o.question_type)),1)]),_:1}),s($,{prop:"text",label:"试题内容"},{default:a(({row:o})=>[s(qe,{placement:"top","show-after":500,"max-width":300},{content:a(()=>[r("div",He,v(o.text),1)]),default:a(()=>[r("div",Je,v(o.text),1)]),_:2},1024)]),_:1}),s($,{prop:"platform",label:"平台",width:"100"},{default:a(({row:o})=>[i(v(J(o.platform)),1)]),_:1}),s($,{prop:"tests_title",label:"所属测试",width:"220"},{default:a(({row:o})=>[o.tests_title?(n(),f(j,{key:0,type:"primary",class:"test-tag",size:"large"},{default:a(()=>[i(v(o.tests_title),1)]),_:2},1024)):(n(),f(j,{key:1,type:"info",class:"test-tag",size:"large"},{default:a(()=>e[20]||(e[20]=[i(" 未分配 ")])),_:1}))]),_:1}),s($,{label:"操作",width:"220",fixed:"right"},{default:a(({row:o})=>[s(Ce,null,{default:a(()=>[s(y,{type:"primary",onClick:p=>ge(o)},{default:a(()=>e[21]||(e[21]=[i("查看")])),_:2},1032,["onClick"]),s(y,{type:"success",onClick:p=>ve(o)},{default:a(()=>e[22]||(e[22]=[i("编辑")])),_:2},1032,["onClick"]),s(y,{type:"danger",onClick:p=>Ve(o)},{default:a(()=>e[23]||(e[23]=[i("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ae,F.value]]),!F.value&&O.value.length===0?(n(),f(ze,{key:0,description:"暂无问题"})):b("",!0)]),_:1}),s(Qe,{pagination:V,"onUpdate:pagination":ce},null,8,["pagination"]),s(Y,{title:T.value?"编辑试题":"添加试题",modelValue:h.value,"onUpdate:modelValue":e[13]||(e[13]=o=>h.value=o),width:"50%"},{footer:a(()=>[s(y,{onClick:e[12]||(e[12]=o=>h.value=!1)},{default:a(()=>e[30]||(e[30]=[i("取消")])),_:1}),s(y,{type:"primary",onClick:we},{default:a(()=>e[31]||(e[31]=[i("确定")])),_:1})]),default:a(()=>[s(De,{model:t,rules:de,ref_key:"questionFormRef",ref:G,"label-width":"100px"},{default:a(()=>[s(x,{label:"题型",prop:"question_type"},{default:a(()=>[s(Ue,{modelValue:t.question_type,"onUpdate:modelValue":e[3]||(e[3]=o=>t.question_type=o)},{default:a(()=>[s(A,{label:"select"},{default:a(()=>e[24]||(e[24]=[i("选择题")])),_:1}),s(A,{label:"judge"},{default:a(()=>e[25]||(e[25]=[i("判断题")])),_:1}),s(A,{label:"fill"},{default:a(()=>e[26]||(e[26]=[i("填空题")])),_:1}),s(A,{label:"question"},{default:a(()=>e[27]||(e[27]=[i("问答题")])),_:1}),s(A,{label:"reading"},{default:a(()=>e[28]||(e[28]=[i("阅读题")])),_:1})]),_:1},8,["modelValue"])]),_:1}),s(x,{label:"平台",prop:"platform"},{default:a(()=>[s(U,{modelValue:t.platform,"onUpdate:modelValue":e[4]||(e[4]=o=>t.platform=o),placeholder:"请选择平台",style:{width:"100%"}},{default:a(()=>[(n(),m(w,null,q(L,o=>s(_,{key:o.value,label:o.label,value:o.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),s(x,{label:"所属测试",prop:"tests_id"},{default:a(()=>[s(U,{modelValue:t.tests_id,"onUpdate:modelValue":e[5]||(e[5]=o=>t.tests_id=o),placeholder:"请选择测试",style:{width:"100%"},onChange:me,clearable:""},{default:a(()=>[(n(!0),m(w,null,q(I.value,o=>(n(),f(_,{key:o.id,label:o.title,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t.question_type==="select"?(n(),f(x,{key:0,label:"题目类型"},{default:a(()=>[s($e,{modelValue:t.is_multiple,"onUpdate:modelValue":e[6]||(e[6]=o=>t.is_multiple=o),"active-text":"多选题","inactive-text":"单选题"},null,8,["modelValue"])]),_:1})):b("",!0),s(x,{label:"试题内容",prop:"text"},{default:a(()=>[t.question_type==="select"?(n(),f(u,{key:0,modelValue:t.text,"onUpdate:modelValue":e[7]||(e[7]=o=>t.text=o),type:"textarea",rows:4,placeholder:"请输入试题内容"},null,8,["modelValue"])):b("",!0),t.question_type==="reading"?(n(),f(u,{key:1,modelValue:t.text,"onUpdate:modelValue":e[8]||(e[8]=o=>t.text=o),type:"textarea",rows:8,placeholder:"请输入试题内容"},null,8,["modelValue"])):b("",!0)]),_:1}),t.question_type==="reading"?(n(),f(x,{key:1,label:"参考答案"},{default:a(()=>[s(u,{modelValue:t.correct_answer,"onUpdate:modelValue":e[9]||(e[9]=o=>t.correct_answer=o),type:"textarea",rows:5,placeholder:"请输入参考答案"},null,8,["modelValue"])]),_:1})):b("",!0),t.question_type==="select"?(n(),m(w,{key:2},[s(x,{label:"选项",prop:"options"},{default:a(()=>[(n(!0),m(w,null,q(t.options,(o,p)=>(n(),m("div",{key:p,class:"option-item"},[s(u,{modelValue:t.options[p],"onUpdate:modelValue":B=>t.options[p]=B,placeholder:"请输入选项内容"},{prefix:a(()=>[r("span",null,v(String.fromCharCode(65+p))+". ",1)]),append:a(()=>[s(y,{onClick:B=>be(p),disabled:t.options.length<=2},{default:a(()=>[s(Se,null,{default:a(()=>[s(ie(Fe))]),_:1})]),_:2},1032,["onClick","disabled"])]),_:2},1032,["modelValue","onUpdate:modelValue"])]))),128)),r("div",Xe,[s(y,{onClick:ye,disabled:t.options.length>=6},{default:a(()=>e[29]||(e[29]=[i("添加选项")])),_:1},8,["disabled"])])]),_:1}),s(x,{label:"正确答案",prop:"correct_answer"},{default:a(()=>[t.is_multiple?(n(),f(U,{key:1,modelValue:t.correct_answer,"onUpdate:modelValue":e[11]||(e[11]=o=>t.correct_answer=o),placeholder:"请选择正确答案（多选）",style:{width:"100%"},multiple:""},{default:a(()=>[(n(!0),m(w,null,q(t.options,(o,p)=>(n(),f(_,{key:p,label:`${String.fromCharCode(65+p)}. ${o}`,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):(n(),f(U,{key:0,modelValue:t.correct_answer,"onUpdate:modelValue":e[10]||(e[10]=o=>t.correct_answer=o),placeholder:"请选择正确答案",style:{width:"100%"}},{default:a(()=>[(n(!0),m(w,null,q(t.options,(o,p)=>(n(),f(_,{key:p,label:`${String.fromCharCode(65+p)}. ${o}`,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]))]),_:1})],64)):b("",!0)]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),s(Y,{title:"试题详情",modelValue:N.value,"onUpdate:modelValue":e[15]||(e[15]=o=>N.value=o),width:"50%"},{footer:a(()=>[s(y,{onClick:e[14]||(e[14]=o=>N.value=!1)},{default:a(()=>e[41]||(e[41]=[i("关闭")])),_:1})]),default:a(()=>{var o,p,B,Z,ee,te,le,oe,ae,se;return[r("div",Ke,[r("div",We,[r("p",null,[e[32]||(e[32]=r("strong",null,"题型:",-1)),e[33]||(e[33]=i()),r("span",null,v(H((o=c.value)==null?void 0:o.question_type)),1)]),((p=c.value)==null?void 0:p.question_type)==="select"?(n(),m("p",Ye,[e[34]||(e[34]=r("strong",null,"类型:",-1)),s(j,{type:(B=c.value)!=null&&B.is_multiple?"warning":"primary",size:"small"},{default:a(()=>{var S;return[i(v((S=c.value)!=null&&S.is_multiple?"多选题":"单选题"),1)]}),_:1},8,["type"])])):b("",!0),r("p",null,[e[35]||(e[35]=r("strong",null,"平台:",-1)),e[36]||(e[36]=i()),r("span",null,v(J((Z=c.value)==null?void 0:Z.platform)),1)])]),e[40]||(e[40]=r("p",null,[r("strong",null,"试题内容:")],-1)),r("div",Ze,v((ee=c.value)==null?void 0:ee.text),1),((te=c.value)==null?void 0:te.question_type)==="reading"?(n(),m("p",et,e[37]||(e[37]=[r("strong",null,"参考答案:",-1)]))):b("",!0),((le=c.value)==null?void 0:le.question_type)==="reading"?(n(),m("div",tt,v((oe=c.value)==null?void 0:oe.correct_answer),1)):b("",!0),((ae=c.value)==null?void 0:ae.question_type)==="select"?(n(),m(w,{key:2},[e[39]||(e[39]=r("p",null,[r("strong",null,"选项:")],-1)),r("div",lt,[(n(!0),m(w,null,q((se=c.value)==null?void 0:se.options,(S,ne)=>(n(),m("div",{key:ne,class:"option-item"},[r("div",{class:Ge({"correct-answer":X(S,c.value)})},[i(v(String.fromCharCode(65+ne))+". "+v(S)+" ",1),X(S,c.value)?(n(),f(j,{key:0,size:"small",type:"success"},{default:a(()=>e[38]||(e[38]=[i("正确答案")])),_:1})):b("",!0)],2)]))),128))])],64)):b("",!0)])]}),_:1},8,["modelValue"])])}}}),ut=Ee(ot,[["__scopeId","data-v-58d68999"]]);export{ut as default};
