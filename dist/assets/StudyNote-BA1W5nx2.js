import{d as U,r as m,u as B,c as F,w as a,b as u,a as l,f as b,e as x,M as c,v as R,s as h,j as z,_ as M}from"./index-CCiOYfNf.js";const P=U({__name:"StudyNote",setup($){const V={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},g=m(new Date),o=m({title:"",content:""}),p=m(),s=m([]),f=m(!1),N=B(),k=n=>{if(n.size&&n.size>10*1024*1024)return c.warning("文件大小不能超过10MB"),s.value=[],!1;s.value=[n]},C=()=>{s.value=[]},D=async n=>{var e;try{const t=(e=N.user)==null?void 0:e.user_id;if(!t)throw new Error("用户未登录");const r=n.name.split(".").pop(),i=`study-notes/${`${t}-${Date.now()}.${r}`}`,{data:w,error:_}=await h.storage.from("attachments").upload(i,n,{cacheControl:"3600",upsert:!1});if(_)throw _;const{data:y}=h.storage.from("attachments").getPublicUrl(i);return{url:y.publicUrl,name:n.name,type:n.type}}catch(t){return console.error("上传文件失败:",t),c.error("文件上传失败"),null}},S=async()=>{if(!p.value||!o.value.title||!o.value.content){c.error("请填写完整信息");return}await p.value.validate(async n=>{var e;if(n){f.value=!0;try{let t=null;if(s.value.length>0&&s.value[0].raw&&(t=await D(s.value[0].raw),!t)){f.value=!1;return}const r={title:o.value.title,content:o.value.content,...t&&{attachment_url:t.url,attachment_name:t.name,attachment_type:t.type}};await R.createNote(r),c.success("提交成功"),(e=p.value)==null||e.resetFields(),o.value.title="",o.value.content="",s.value=[]}catch(t){console.error("提交失败:",t),c.error("提交失败")}finally{f.value=!1}}})};return(n,e)=>{const t=u("el-date-picker"),r=u("el-form-item"),v=u("el-input"),i=u("el-button"),w=u("el-upload"),_=u("el-form"),y=u("el-card");return z(),F(y,{style:{"min-height":"400px","margin-top":"30px"}},{header:a(()=>e[3]||(e[3]=[x("div",{class:"subtitle"},"写下你的学习心得",-1)])),default:a(()=>[l(_,{model:o.value,ref_key:"formRef",ref:p,rules:V,"label-width":"50px",style:{width:"100%","max-width":"800px","margin-top":"40px"}},{default:a(()=>[l(r,{label:"日期"},{default:a(()=>[l(t,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=d=>g.value=d),type:"date",placeholder:"Pick a day",size:"default",readonly:!0},null,8,["modelValue"])]),_:1}),l(r,{label:"标题"},{default:a(()=>[l(v,{modelValue:o.value.title,"onUpdate:modelValue":e[1]||(e[1]=d=>o.value.title=d)},null,8,["modelValue"])]),_:1}),l(r,{label:"内容"},{default:a(()=>[l(v,{modelValue:o.value.content,"onUpdate:modelValue":e[2]||(e[2]=d=>o.value.content=d),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1}),l(r,{label:"附件"},{default:a(()=>[l(w,{class:"upload-demo",action:"#","auto-upload":!1,"on-change":k,"on-remove":C,limit:1,"file-list":s.value},{tip:a(()=>e[5]||(e[5]=[x("div",{class:"el-upload__tip"}," 可以上传PDF、Word、图片等文件，大小不超过10MB ",-1)])),default:a(()=>[l(i,{type:"primary"},{default:a(()=>e[4]||(e[4]=[b("选择文件")])),_:1})]),_:1},8,["file-list"])]),_:1}),l(r,null,{default:a(()=>[l(i,{type:"primary",onClick:S,loading:f.value},{default:a(()=>e[6]||(e[6]=[b("提交")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})}}}),q=M(P,[["__scopeId","data-v-b583ba88"]]);export{q as default};
