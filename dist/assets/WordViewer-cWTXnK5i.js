import{x as ie,r as g,c as j,ax as re,w as de,j as ue,W as ce,y as _,A as u,J as F,P as i,H as r,u as w,ag as H,M as J,D as M,O as fe,a6 as me,n as $,L as m,ay as ve,z as b}from"./vendor-kUynFKsh.js";import{m as Y,f as ge,b as pe,E as c,H as he,K as ye,L as G}from"./elementPlus-7n3J9xVR.js";import{s as Q,b as we}from"./index-t-_HdCcH.js";import{m as X}from"./index-BBl8hZ3Q.js";import"./supabase-Dk90AXsH.js";const Ce={class:"word-viewer-container"},_e={class:"viewer-header"},be={class:"header-left"},ke={class:"file-title"},Te={class:"header-right"},xe={class:"viewer-content"},He={class:"sidebar-header"},$e={class:"sidebar-actions"},Ee={key:0,class:"sidebar-content"},Le={class:"toc-tree"},Se=["onClick"],De={class:"main-content"},Ne={class:"content-wrapper"},Re={key:0,class:"view-mode"},Ae=["innerHTML"],Me={key:1,class:"edit-mode"},qe={class:"editor-toolbar"},Be={key:0,class:"loading-overlay"},Ie=ie({__name:"WordViewer",setup(Ve){const q=re(),Z=ve(),E=g(!1),L=g(!1),h=g("view"),k=g(!1),T=g(""),p=g(""),B=g(""),S=g(""),x=g([]),I=g(),d=g(),D=j(()=>q.params.id),V=j(()=>q.query.url),ee=async()=>{if(!D.value){c.error("文件ID不存在");return}E.value=!0;try{const{data:t,error:e}=await Q.from("word_files").select("*").eq("id",D.value).single();if(e){console.error("从数据库加载文件信息失败:",e),c.error("加载文件信息失败");return}if(B.value=t.name||"未命名文档",t.content&&t.content.trim()!==""){console.log("从数据库加载编辑后的内容"),T.value=t.content,p.value=t.content,await $(),setTimeout(()=>{C()},500),c.success("文档加载成功（已编辑版本）");return}if(!V.value){c.error("文件URL不存在");return}console.log("从原始Word文件加载内容");const n=await fetch(V.value);if(!n.ok)throw new Error("文件下载失败");const o=await n.arrayBuffer(),l=await X.convertToHtml({arrayBuffer:o,convertImage:X.images.imgElement(function(f){return f.read("base64").then(function(s){return{src:"data:"+f.contentType+";base64,"+s}})}),styleMap:["p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='Heading 4'] => h4:fresh","p[style-name='Heading 5'] => h5:fresh","p[style-name='Heading 6'] => h6:fresh","p[style-name='Title'] => h1.title:fresh","p[style-name='Subtitle'] => h2.subtitle:fresh","p[style-name='标题 1'] => h1:fresh","p[style-name='标题 2'] => h2:fresh","p[style-name='标题 3'] => h3:fresh","p[style-name='标题 4'] => h4:fresh","p[style-name='标题 5'] => h5:fresh","p[style-name='标题 6'] => h6:fresh","p[style-name='标题1'] => h1:fresh","p[style-name='标题2'] => h2:fresh","p[style-name='标题3'] => h3:fresh","p[style-name='标题4'] => h4:fresh","p[style-name='标题5'] => h5:fresh","p[style-name='标题6'] => h6:fresh","r[style-name='Strong'] => strong","r[style-name='Emphasis'] => em","r[style-name='Hyperlink'] => a","r[style-name='加粗'] => strong","r[style-name='倾斜'] => em","r[style-name='超链接'] => a","table => table.table:fresh","tr => tr:fresh","td => td:fresh","th => th:fresh"],transformDocument:function(f){return f.children.forEach(function(s){s.children&&s.children.forEach(function(a){a.type==="hyperlink"&&(a.type="hyperlink")})}),f}});T.value=l.value,p.value=l.value,await $(),setTimeout(()=>{C()},500),c.success("文档加载成功（原始版本）")}catch(t){console.error("加载文档失败:",t),c.error(`加载文档失败: ${t.message}`)}finally{E.value=!1}},C=()=>{const t=I.value;if(!t){console.log("wordContentRef.value 为空，无法生成目录");return}const e=[];t.querySelectorAll('a[id^="heading_"]').forEach((o,l)=>{var v,y;const f=o.getAttribute("id")||`heading-${l}`;let s=o.nextElementSibling,a="";if(s&&s.tagName.toLowerCase()==="strong")a=((v=s.textContent)==null?void 0:v.trim())||"";else{const z=o.parentElement;if(z){const K=z.querySelector("strong");K&&(a=((y=K.textContent)==null?void 0:y.trim())||"")}}a||(a=`标题 ${l+1}`),a&&a.length>0&&e.push({id:f,title:a,level:1,element:o})}),e.length===0&&t.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((l,f)=>{var v;const s=O(l),a=((v=l.textContent)==null?void 0:v.trim())||"";if(a&&a.length>0){const y=`heading-${f}`;l.id=y,e.push({id:y,title:a,level:s,element:l})}}),e.length===0&&t.querySelectorAll('h1, h2, h3, h4, h5, h6, .title, .subtitle, p[style*="heading"], p[style*="title"], p[style*="Heading"]').forEach((l,f)=>{var v;const s=O(l),a=((v=l.textContent)==null?void 0:v.trim())||"";if(a&&a.length>0){const y=`heading-${f}`;l.id=y,e.push({id:y,title:a,level:s,element:l})}}),e.length===0&&t.querySelectorAll("p").forEach((l,f)=>{var a;const s=((a=l.textContent)==null?void 0:a.trim())||"";if(s.match(/^[一二三四五六七八九十]+[、．.]/)||s.match(/^\d+[、．.]/)||s.includes("了解")||s.includes("申请")||s.includes("培训")){const v=`heading-${f}`;l.id=v,e.push({id:v,title:s,level:1,element:l})}}),x.value=e,e.length===0?x.value=[{id:"test-1",title:"文档开始",level:1},{id:"test-2",title:"主要内容",level:2}]:console.log("目录生成成功，共",e.length,"个条目")},O=t=>{const e=t.tagName.toLowerCase();if(e.startsWith("h"))return parseInt(e.charAt(1));const n=t.className;if(n.includes("title"))return 1;if(n.includes("subtitle"))return 2;const o=t.textContent||"";return o.length<20&&t.tagName==="P"?2:o.length<50&&t.tagName==="P"?3:4},te=t=>{let e=document.getElementById(t);e||(e=document.querySelector(`a[id="${t}"]`)),e||(e=document.querySelector(`[id="${t}"]`)),e?(e.scrollIntoView({behavior:"smooth",block:"start"}),e.style.backgroundColor="#fff3cd",setTimeout(()=>{e.style.backgroundColor=""},2e3),S.value=t):c.warning("未找到对应的标题位置")};let N=null;const W=()=>{N&&clearTimeout(N),N=setTimeout(()=>{d.value&&(p.value=d.value.innerHTML)},100)},ne=t=>{W()},se=t=>{t.preventDefault();const e=t.clipboardData;if(e){const n=e.getData("text/plain"),o=e.getData("text/html");o?document.execCommand("insertHTML",!1,o):n&&document.execCommand("insertText",!1,n)}},oe=t=>{W(),h.value==="edit"&&setTimeout(()=>{C()},200)},R=t=>{if(!d.value)return;d.value.focus(),document.execCommand(t,!1)?(p.value=d.value.innerHTML,c.success(`已应用${t}格式`)):c.warning("格式化失败，请重试")},A=t=>{if(!d.value)return;d.value.focus();const e=window.getSelection();if(e&&e.rangeCount>0){const n=e.getRangeAt(0),o=document.createElement(`h${t}`);o.textContent="新标题",o.id=`heading-${Date.now()}`,n.deleteContents(),n.insertNode(o),n.selectNode(o),e.removeAllRanges(),e.addRange(n),p.value=d.value.innerHTML,setTimeout(()=>{C()},100),c.success(`已插入H${t}标题`)}else c.warning("请先选择插入位置")},P=t=>{if(!d.value)return;d.value.focus(),document.execCommand(t==="ul"?"insertUnorderedList":"insertOrderedList",!1)?(p.value=d.value.innerHTML,c.success(`已插入${t==="ul"?"无序":"有序"}列表`)):c.warning("插入列表失败，请重试")},le=async()=>{if(h.value==="view"){c.warning("当前处于查看模式，请切换到编辑模式");return}L.value=!0;try{const{error:t}=await Q.from("word_files").update({content:p.value,updated_at:new Date().toISOString()}).eq("id",D.value);if(t)throw t;c.success("文档保存成功"),T.value=p.value}catch(t){console.error("保存文档失败:",t),c.error(`保存文档失败: ${t.message}`)}finally{L.value=!1}},ae=()=>{Z.go(-1)},U=()=>{const t=window.pageYOffset||document.documentElement.scrollTop,e=x.value;for(let n=e.length-1;n>=0;n--){const o=e[n],l=document.getElementById(o.id);if(l&&l.offsetTop<=t+100){S.value=o.id;break}}};return de(h,async(t,e)=>{if(t==="edit"&&e==="view"){if(await $(),d.value){d.value.innerHTML=p.value;const n=document.createRange(),o=window.getSelection();o&&(n.selectNodeContents(d.value),n.collapse(!1),o.removeAllRanges(),o.addRange(n),d.value.focus())}setTimeout(()=>{C()},200)}else t==="view"&&e==="edit"&&(T.value=p.value,await $(),setTimeout(()=>{C()},200))}),ue(()=>{ee(),window.addEventListener("scroll",U)}),ce(()=>{window.removeEventListener("scroll",U)}),(t,e)=>{const n=H("el-button"),o=H("el-button-group"),l=H("el-divider"),f=H("el-loading");return b(),_("div",Ce,[u("div",_e,[u("div",be,[i(n,{onClick:ae,icon:w(Y)},{default:r(()=>e[11]||(e[11]=[m("返回")])),_:1},8,["icon"]),u("span",ke,J(B.value),1)]),u("div",Te,[i(o,null,{default:r(()=>[i(n,{type:h.value==="view"?"primary":"",onClick:e[0]||(e[0]=s=>h.value="view"),icon:w(he)},{default:r(()=>e[12]||(e[12]=[m(" 查看 ")])),_:1},8,["type","icon"]),i(n,{type:h.value==="edit"?"primary":"",onClick:e[1]||(e[1]=s=>h.value="edit"),icon:w(ye)},{default:r(()=>e[13]||(e[13]=[m(" 编辑 ")])),_:1},8,["type","icon"])]),_:1}),i(n,{type:"success",onClick:le,loading:L.value,icon:w(ge)},{default:r(()=>e[14]||(e[14]=[m(" 保存 ")])),_:1},8,["loading","icon"])])]),u("div",xe,[u("div",{class:M(["sidebar",{collapsed:k.value}])},[u("div",He,[e[16]||(e[16]=u("span",null,"文档目录",-1)),u("div",$e,[i(n,{type:"text",size:"small",onClick:C,title:"刷新目录"},{default:r(()=>e[15]||(e[15]=[m(" 刷新 ")])),_:1}),i(n,{type:"text",onClick:e[2]||(e[2]=s=>k.value=!k.value),icon:k.value?w(pe):w(Y)},null,8,["icon"])])]),k.value?F("",!0):(b(),_("div",Ee,[u("div",Le,[(b(!0),_(fe,null,me(x.value,(s,a)=>(b(),_("div",{key:a,class:M(["toc-item",{active:S.value===s.id}]),onClick:v=>te(s.id)},[u("span",{class:M(["toc-level",`level-${s.level}`])},J(s.title),3)],10,Se))),128))])]))],2),u("div",De,[u("div",Ne,[h.value==="view"?(b(),_("div",Re,[u("div",{class:"word-content",innerHTML:T.value,ref_key:"wordContentRef",ref:I},null,8,Ae)])):(b(),_("div",Me,[u("div",qe,[i(o,null,{default:r(()=>[i(n,{onClick:e[3]||(e[3]=s=>R("bold"))},{default:r(()=>e[17]||(e[17]=[m("粗体")])),_:1}),i(n,{onClick:e[4]||(e[4]=s=>R("italic"))},{default:r(()=>e[18]||(e[18]=[m("斜体")])),_:1}),i(n,{onClick:e[5]||(e[5]=s=>R("underline"))},{default:r(()=>e[19]||(e[19]=[m("下划线")])),_:1})]),_:1}),i(l,{direction:"vertical"}),i(o,null,{default:r(()=>[i(n,{onClick:e[6]||(e[6]=s=>A(1))},{default:r(()=>e[20]||(e[20]=[m("H1")])),_:1}),i(n,{onClick:e[7]||(e[7]=s=>A(2))},{default:r(()=>e[21]||(e[21]=[m("H2")])),_:1}),i(n,{onClick:e[8]||(e[8]=s=>A(3))},{default:r(()=>e[22]||(e[22]=[m("H3")])),_:1})]),_:1}),i(l,{direction:"vertical"}),i(o,null,{default:r(()=>[i(n,{onClick:e[9]||(e[9]=s=>P("ul")),icon:w(G)},{default:r(()=>e[23]||(e[23]=[m("无序列表")])),_:1},8,["icon"]),i(n,{onClick:e[10]||(e[10]=s=>P("ol")),icon:w(G)},{default:r(()=>e[24]||(e[24]=[m("有序列表")])),_:1},8,["icon"])]),_:1})]),u("div",{class:"editor-content",contenteditable:"true",onInput:oe,onKeydown:ne,onPaste:se,ref_key:"editorRef",ref:d},null,544)]))])])]),E.value?(b(),_("div",Be,[i(f,{"element-loading-text":"正在加载文档...","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.8)"})])):F("",!0)])}}}),Ke=we(Ie,[["__scopeId","data-v-459547dd"]]);export{Ke as default};
