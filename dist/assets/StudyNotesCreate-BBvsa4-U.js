import{x as R,r as m,G as q,H as l,ag as i,P as a,A as d,u as x,L as w,az as z,z as P}from"./vendor-COQJj1AX.js";import{l as S,z as $,E as c,B as F}from"./elementPlus-DTEdDlyA.js";import{s as h,a as I,_ as D}from"./index-Dg-ntNTN.js";import"./supabase-Dt8ksRgS.js";const j=R({__name:"StudyNotesCreate",setup(A){const N=z(),_=m(),v=m(!1),V=m([]),r=m(null),n=m({title:"",content:""}),C={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},B=u=>u.size/1024/1024<10?!0:(c.error("文件大小不能超过 10MB!"),!1),E=async u=>{const{file:e,onSuccess:s,onError:t}=u;if(!e){t==null||t(new Error("文件不存在"));return}const f=F.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const o=e,g=o.name.split(".").pop(),p=`study_notes/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${g}`}`,{data:k,error:b}=await h.storage.from("attachments").upload(p,o,{cacheControl:"3600",upsert:!1});if(b)throw b;const{data:{publicUrl:L}}=h.storage.from("attachments").getPublicUrl(k.path);r.value={url:L,name:o.name,type:o.type},s==null||s(r.value),c.success("文件上传成功")}catch(o){console.error("文件上传错误:",o),t==null||t(new Error(o instanceof Error?o.message:"上传失败")),c.error("文件上传失败，请重试")}finally{f.close()}},M=()=>{r.value=null},U=async()=>{_.value&&await _.value.validate(async u=>{var e,s,t;if(u){v.value=!0;try{await I.createNote({...n.value,attachment_url:(e=r.value)==null?void 0:e.url,attachment_name:(s=r.value)==null?void 0:s.name,attachment_type:(t=r.value)==null?void 0:t.type}),c.success("心得提交成功"),N.push("/system/study-notes/list")}catch{c.error("提交失败")}finally{v.value=!1}}})};return(u,e)=>{const s=i("el-input"),t=i("el-form-item"),f=i("el-icon"),o=i("el-upload"),g=i("el-button"),y=i("el-card");return P(),q(y,{style:{"min-height":"400px","margin-top":"30px"}},{header:l(()=>e[2]||(e[2]=[d("div",{class:"subtitle"},"添加学习心得",-1)])),default:l(()=>[a(x($),{model:n.value,ref_key:"formRef",ref:_,rules:C,"label-width":"80px",style:{width:"100%","max-width":"800px","margin-top":"20px"}},{default:l(()=>[a(t,{label:"标题",prop:"title"},{default:l(()=>[a(s,{modelValue:n.value.title,"onUpdate:modelValue":e[0]||(e[0]=p=>n.value.title=p),placeholder:"请输入心得标题"},null,8,["modelValue"]),e[3]||(e[3]=d("div",{class:"form-tip"},"请简要描述您的学习心得主题",-1))]),_:1}),a(t,{label:"内容",prop:"content"},{default:l(()=>[a(s,{modelValue:n.value.content,"onUpdate:modelValue":e[1]||(e[1]=p=>n.value.content=p),type:"textarea",rows:8,placeholder:"请输入学习心得内容"},null,8,["modelValue"]),e[4]||(e[4]=d("div",{class:"form-tip"},"详细描述您的学习收获、体会和建议",-1))]),_:1}),a(t,{label:"附件"},{default:l(()=>[a(o,{class:"upload-container",drag:"","auto-upload":!0,"http-request":E,"on-remove":M,"before-upload":B,limit:1,"file-list":V.value},{tip:l(()=>e[5]||(e[5]=[d("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:l(()=>[a(f,{class:"el-icon--upload"},{default:l(()=>[a(x(S))]),_:1}),e[6]||(e[6]=d("div",{class:"el-upload__text"},[w(" 将文件拖到此处，或"),d("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),a(t,null,{default:l(()=>[a(g,{type:"primary",onClick:U,loading:v.value},{default:l(()=>e[7]||(e[7]=[w("提交")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})}}}),W=D(j,[["__scopeId","data-v-8933d72b"]]);export{W as default};
