import{s as l,u as w,a7 as S}from"./index-BsBxzW2u.js";const m=e=>{if(e==null){const a=w();e=Number(a.roleId||localStorage.getItem("roleId"))}return console.log(e,"roleid============================"),e!==null&&[0,1,11].includes(e)},q={async getAllFeedback(e){if(!w().getUser())throw new Error("未登录");const c=(e==null?void 0:e.page)||1,s=(e==null?void 0:e.pageSize)||10,d=(c-1)*s,u=d+s-1;let r=l.from("feedback_with_users").select("*",{count:"exact"});const f=m();if(f||(r=r.eq("is_show",!0)),f&&(e!=null&&e.showStatus)&&(r=r.eq("is_show",e.showStatus==="true"),console.log("query",r)),e!=null&&e.query&&(r=r.or(`title.ilike.%${e.query}%,full_name.ilike.%${e.query}%`)),e!=null&&e.startDate&&(e!=null&&e.endDate)){const{startUTC:h,endUTC:_}=S(e.startDate,e.endDate);r=r.gte("created_at",h).lte("created_at",_)}e!=null&&e.replyStatus&&e.replyStatus!=="all"&&(e.replyStatus==="replied"?r=r.eq("status","resolved"):e.replyStatus==="in_progress"?r=r.eq("status","in_progress"):e.replyStatus==="pending"&&(r=r.eq("status","pending"))),e!=null&&e.platform&&e.platform!=="all"&&(r=r.eq("platform",e.platform)),r=r.order("created_at",{ascending:!1}).range(d,u);const{data:i,error:n,count:g}=await r;if(n)throw console.error("获取反馈失败:",n),new Error("获取反馈失败");return{data:i,total:g||0}},async getPersonalFeedback(e){const t=w().getUser();if(!t)throw new Error("未登录");const c=(e==null?void 0:e.page)||1,s=(e==null?void 0:e.pageSize)||10,d=(c-1)*s,u=d+s-1;let r=l.from("feedback_with_users").select("*",{count:"exact"}).eq("user_id",t.user_id);m()||(r=r.eq("is_show",!0)),e!=null&&e.platform&&e.platform!=="all"&&(r=r.eq("platform",e.platform)),r=r.order("created_at",{ascending:!1}).range(d,u);const{data:i,error:n,count:g}=await r;if(n)throw console.error("获取个人反馈失败:",n),new Error("获取个人反馈失败");return{data:i,total:g||0}},async createFeedback(e){const t=w().getUser();if(!t)throw new Error("未登录");const{data:c,error:s}=await l.from("feedback").insert([{...e,user_id:t.user_id,is_show:!0}]).select().single();if(s)throw console.error("创建反馈失败:",s),new Error("创建反馈失败");return c},async updateFeedback(e,a){const{data:t,error:c}=await l.from("feedback").update(a).eq("id",e).select().single();if(c)throw console.error("更新反馈失败:",c),new Error("更新反馈失败");return t},async deleteFeedback(e){const{error:a}=await l.from("feedback").delete().eq("id",e);if(a)throw console.error("删除反馈失败:",a),new Error("删除反馈失败")},async hideFeedback(e){const{error:a}=await l.from("feedback").update({is_show:!1}).eq("id",e);if(a)throw console.error("隐藏反馈失败:",a),new Error("隐藏反馈失败")},async submitReply(e,a){const c=w().getUser();if(!c)throw new Error("未登录");const{data:s,error:d}=await l.from("feedback").select("id").eq("id",e).single();if(d||!s)throw console.error("反馈不存在:",d),new Error("反馈不存在");const u={admin_id:c.user_id,status:a.status||"resolved",is_show:a.is_show};a.admin_reply&&(u.admin_reply=a.admin_reply,u.replied_at=new Date().toISOString());const{data:r,error:f}=await l.from("feedback").update(u).eq("id",e).select().single();if(f)throw console.error("提交更新失败:",f),new Error("提交更新失败");return r},async checkFeedbackExists(e){const{data:a,error:t}=await l.from("feedback").select("id").eq("id",e).single();return!(t||!a)}};export{q as f,m as h};
