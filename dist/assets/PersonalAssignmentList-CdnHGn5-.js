import{d as ue,u as de,r as m,H as ce,J as _e,k as T,o as pe,l as d,a as l,w as a,b as r,P as me,M as b,y as ve,O as fe,c as L,e as o,t as u,g as v,a2 as j,f as c,q as V,F as ge,m as he,A as ye,j as i,_ as we}from"./index-w0Vcq8R-.js";import{a as H}from"./assignmentService-CNRluYtR.js";const ke={class:"personal-assignment-list"},be={class:"card-header"},xe={class:"tooltip-content"},Ae={class:"text-truncate"},Ce={class:"tooltip-content"},Ve={class:"content-preview"},ze={key:1},Se={key:0,class:"assignment-detail"},De={class:"assignment-meta"},Ue={class:"assignment-content"},Fe={key:0,class:"assignment-attachment"},Le={class:"attachment-box"},Ne={class:"attachment-name"},Pe={key:1,class:"assignment-replies"},Be={class:"reply-header"},Ee={class:"reply-author"},Re={key:0,class:"reply-role"},Ie={class:"reply-form"},Me={class:"attachment-preview"},$e=["src"],qe=["src"],Te={key:2,class:"attachment-download"},je=ue({__name:"PersonalAssignmentList",setup(He){const p=de(),z=m(!1),S=m([]),D=m(!1),n=m(null),f=m(""),x=m(!1),g=m(""),h=m(""),J=ce();m(J.query.platform||"google");const y=_e({page:1,pageSize:10,total:0}),U=s=>s?new Date(s).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",O=T(()=>h.value?h.value.startsWith("image/"):!1),W=T(()=>h.value?h.value==="application/pdf":!1),G=s=>{s.attachment_url&&(g.value=s.attachment_url,h.value=s.attachment_type||"",x.value=!0)},K=()=>{var s;(s=n.value)!=null&&s.attachment_url&&(g.value=n.value.attachment_url,h.value=n.value.attachment_type||"",x.value=!0)},Q=()=>{g.value&&window.open(g.value,"_blank")},A=async()=>{z.value=!0;try{const{data:s,total:e}=await H.getPersonalAssignments(y.page,y.pageSize,{status:""});S.value=s,y.total=e}catch(s){console.error("获取作业列表失败:",s),b.error("获取作业列表失败")}finally{z.value=!1}},X=s=>{n.value=s,D.value=!0,f.value=""},Y=async()=>{var s;if(n.value){if(!f.value.trim()){b.warning("回复内容不能为空");return}try{if(!((s=p.user)!=null&&s.user_id)||!n.value.id){b.error("用户信息或作业ID缺失");return}const e=await H.addReply({assignment_id:n.value.id,user_id:p.user.user_id,content:f.value,full_name:p.user.full_name||""});n.value.replies||(n.value.replies=[]),n.value.replies.push(e),b.success("提交回复成功"),f.value="",A()}catch(e){console.error("提交回复失败:",e),b.error("提交回复失败")}}},Z=()=>{A()},ee=s=>{y.page=s.page,y.pageSize=s.pageSize,A()},N=s=>{if(!s.replies||s.replies.length===0)return{type:"warning",text:"待完成"};const e=s.replies.some(_=>{var k;return _.user_id===((k=p.user)==null?void 0:k.user_id)});return s.replies.some(_=>_.user_id!==s.assigned_to),e?{type:"success",text:"已完成"}:{type:"warning",text:"待完成"}};return pe(()=>{A()}),(s,e)=>{const _=r("el-button"),k=r("el-tooltip"),w=r("el-table-column"),P=r("el-icon"),te=r("el-tag"),ae=r("el-button-group"),le=r("el-table"),se=r("el-empty"),ne=r("el-card"),C=r("el-divider"),oe=r("el-input"),B=r("el-form-item"),ie=r("el-form"),E=r("el-dialog"),re=fe("loading");return i(),d("div",ke,[l(ne,{class:"box-card",shadow:"always",style:{"margin-top":"30px","min-height":"400px"}},{header:a(()=>[o("div",be,[e[4]||(e[4]=o("span",null,"我的作业列表",-1)),l(_,{type:"primary",onClick:Z},{default:a(()=>e[3]||(e[3]=[c("刷新")])),_:1})])]),default:a(()=>[ve((i(),d("div",null,[S.value.length>0?(i(),L(le,{key:0,data:S.value,style:{width:"100%"}},{default:a(()=>[l(w,{prop:"title",label:"标题","min-width":"180"},{default:a(t=>[l(k,{placement:"top","show-after":500,"max-width":300},{content:a(()=>[o("div",xe,u(t.row.title),1)]),default:a(()=>[o("div",Ae,u(t.row.title),1)]),_:2},1024)]),_:1}),l(w,{label:"内容","min-width":"250"},{default:a(t=>[l(k,{placement:"top","show-after":500},{content:a(()=>[o("div",Ce,u(t.row.content),1)]),default:a(()=>[o("div",Ve,u(t.row.content),1)]),_:2},1024)]),_:1}),l(w,{label:"附件",width:"80"},{default:a(t=>[t.row.attachment_url?(i(),L(_,{key:0,type:"primary",link:"",onClick:F=>G(t.row)},{default:a(()=>[l(P,{color:"#409EFF",size:"18"},{default:a(()=>[l(v(j))]),_:1})]),_:2},1032,["onClick"])):(i(),d("span",ze,"-"))]),_:1}),l(w,{prop:"created_at",label:"创建时间",width:"180"},{default:a(t=>[c(u(U(t.row.created_at)),1)]),_:1}),l(w,{label:"状态",width:"100"},{default:a(t=>[l(te,{type:N(t.row).type},{default:a(()=>[c(u(N(t.row).text),1)]),_:2},1032,["type"])]),_:1}),l(w,{label:"操作",width:"200"},{default:a(t=>[l(ae,null,{default:a(()=>[l(_,{type:"primary",onClick:F=>X(t.row)},{default:a(()=>e[5]||(e[5]=[c("查看")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])):(i(),L(se,{key:1,description:"暂无分配给您的作业"}))])),[[re,z.value]])]),_:1}),l(me,{pagination:y,"onUpdate:pagination":ee},null,8,["pagination"]),l(E,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=t=>D.value=t),title:"作业详情",width:"600px"},{default:a(()=>[n.value?(i(),d("div",Se,[o("h3",null,u(n.value.title),1),o("div",De,[o("p",null,"创建时间: "+u(U(n.value.created_at)),1)]),o("div",Ue,[l(C,{"content-position":"left"},{default:a(()=>e[6]||(e[6]=[c("作业内容")])),_:1}),o("p",null,u(n.value.content),1)]),n.value.attachment_url?(i(),d("div",Fe,[l(C,{"content-position":"left"},{default:a(()=>e[7]||(e[7]=[c("附件")])),_:1}),o("div",Le,[l(P,{color:"#409EFF",size:"16"},{default:a(()=>[l(v(j))]),_:1}),o("span",Ne,u(n.value.attachment_name),1),l(_,{type:"primary",size:"small",onClick:K},{default:a(()=>e[8]||(e[8]=[c("查看附件")])),_:1})])])):V("",!0),n.value.replies&&n.value.replies.length>0?(i(),d("div",Pe,[l(C,{"content-position":"left"},{default:a(()=>e[9]||(e[9]=[c("回复记录")])),_:1}),(i(!0),d(ge,null,he(n.value.replies,(t,F)=>{var R,I,M,$,q;return i(),d("div",{key:F,class:ye(["reply-item",{"my-reply":t.user_id===((R=v(p).user)==null?void 0:R.user_id),"admin-reply":t.user_id!==n.value.assigned_to&&t.user_id!==((I=v(p).user)==null?void 0:I.user_id),"other-reply":t.user_id!==((M=v(p).user)==null?void 0:M.user_id)&&t.user_id===n.value.assigned_to}])},[o("div",Be,[o("span",Ee,u(t.user_id===(($=v(p).user)==null?void 0:$.user_id)?"我":t.full_name||"未知用户"),1),t.user_id!==n.value.assigned_to&&t.user_id!==((q=v(p).user)==null?void 0:q.user_id)?(i(),d("span",Re,"管理员")):V("",!0)]),o("p",null,u(t.content),1),o("small",null,u(U(t.created_at)),1)],2)}),128))])):V("",!0),o("div",Ie,[l(C,{"content-position":"left"},{default:a(()=>e[10]||(e[10]=[c("提交回复")])),_:1}),l(ie,null,{default:a(()=>[l(B,null,{default:a(()=>[l(oe,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=t=>f.value=t),type:"textarea",rows:4,placeholder:"请输入您的回复内容"},null,8,["modelValue"])]),_:1}),l(B,null,{default:a(()=>[l(_,{type:"primary",onClick:Y},{default:a(()=>e[11]||(e[11]=[c("提交回复")])),_:1})]),_:1})]),_:1})])])):V("",!0)]),_:1},8,["modelValue"]),l(E,{modelValue:x.value,"onUpdate:modelValue":e[2]||(e[2]=t=>x.value=t),title:"附件预览",width:"80%","destroy-on-close":""},{default:a(()=>[o("div",Me,[O.value?(i(),d("img",{key:0,src:g.value,class:"attachment-image"},null,8,$e)):W.value?(i(),d("iframe",{key:1,src:g.value,class:"attachment-frame"},null,8,qe)):(i(),d("div",Te,[e[13]||(e[13]=o("p",null,"无法预览此类型的文件，请下载后查看",-1)),l(_,{type:"primary",onClick:Q},{default:a(()=>e[12]||(e[12]=[c("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])}}}),We=we(je,[["__scopeId","data-v-87205c12"]]);export{We as default};
