import{x as ne,r,c as H,j as ie,y as v,A as t,P as l,I as ue,J as h,M as c,H as a,ag as p,aq as de,G as x,L as m,u as $,az as re,z as i}from"./vendor-COQJj1AX.js";import{E as y,w as ce,h as _e,x as me,v as ve,y as pe}from"./elementPlus-Dv7g5dxn.js";import{a as P,s as J,_ as fe}from"./index-BfpeTqGr.js";import"./supabase-Bqqw4QDB.js";const ye={class:"study-notes-list"},he={class:"study-body"},ge={class:"study-header"},be={class:"header-left"},ke={class:"header-stats"},we={key:1},Ve={key:1,class:"empty-state"},Ce={class:"empty-icon"},xe={class:"attachment-box"},De={class:"attachment-name"},Ne={key:1,class:"dialog-content"},Le={class:"note-details"},Ee={class:"note-header"},Se={class:"note-title"},Ue={class:"note-meta"},Ae={class:"meta-item"},Me={key:0,class:"meta-item"},$e={class:"note-section"},ze={class:"note-content"},Be={key:0,class:"note-section"},Fe={class:"attachment-box"},Ie={class:"attachment-name"},Pe={key:1,class:"note-section"},qe={class:"previous-reply"},Re={class:"reply-header"},Te={class:"reply-author"},je={class:"admin-reply-content"},We={key:0,class:"reply-timestamp"},Ge={class:"dialog-footer"},He={class:"attachment-preview"},Je=["src"],Oe=["src"],Ke={key:2,class:"attachment-download"},Qe=ne({__name:"StudyNotesList",setup(Xe){re();const N=r(!1),L=r([]),k=r(!1),g=r(!1),D=r(!1),z=r(""),B=r(),s=r({}),q=r([]);r(!1);const E=r(!1),w=r(""),V=r(""),b=r(null),f=r({title:"",content:""}),O={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},R=H(()=>V.value?V.value.startsWith("image/"):!1),T=H(()=>V.value?V.value==="application/pdf":!1),K=()=>D.value?"查看心得":g.value?"编辑心得":"新建心得",F=async()=>{N.value=!0;try{L.value=await P.getNotes()}catch{y.error("获取心得列表失败")}finally{N.value=!1}},Q=o=>{D.value=!0,g.value=!1,z.value=o.id,s.value=o,k.value=!0},X=o=>{if(o.admin_reply){y.warning("已回复的心得不能修改");return}g.value=!0,D.value=!1,z.value=o.id,s.value=o,f.value={title:o.title,content:o.content},q.value=[],b.value=null,k.value=!0},Y=o=>{o.attachment_url?(w.value=o.attachment_url,V.value=o.attachment_type||"",E.value=!0):y.warning("该心得没有附件")},Z=()=>{var o;(o=s.value)!=null&&o.attachment_url&&(w.value=s.value.attachment_url,V.value=s.value.attachment_type||"",E.value=!0)},j=()=>{w.value?window.open(w.value,"_blank"):s.value.attachment_url&&window.open(s.value.attachment_url,"_blank")},ee=o=>o.size/1024/1024<10?!0:(y.error("文件大小不能超过 10MB!"),!1),te=async o=>{const{file:e,onSuccess:u,onError:d}=o;if(!e){d==null||d(new Error("文件不存在"));return}const S=pe.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const _=e,I=_.name.split(".").pop(),U=`study_notes/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${I}`}`,{data:C,error:A}=await J.storage.from("attachments").upload(U,_,{cacheControl:"3600",upsert:!1});if(A)throw A;const{data:{publicUrl:M}}=J.storage.from("attachments").getPublicUrl(C.path);b.value={url:M,name:_.name,type:_.type},u==null||u(b.value),y.success("文件上传成功")}catch(_){console.error("文件上传错误:",_),d==null||d(new Error(_ instanceof Error?_.message:"上传失败")),y.error("文件上传失败，请重试")}finally{S.close()}},ae=()=>{b.value=null},le=async()=>{B.value&&await B.value.validate(async o=>{var e,u,d;if(o)try{g.value?(await P.updateNote(z.value,{title:f.value.title,content:f.value.content}),y.success("修改成功")):(await P.createNote({...f.value,attachment_url:(e=b.value)==null?void 0:e.url,attachment_name:(u=b.value)==null?void 0:u.name,attachment_type:(d=b.value)==null?void 0:d.type}),y.success("创建成功")),k.value=!1,F()}catch{y.error(g.value?"修改失败":"创建失败")}})},se=()=>{F()};return ie(()=>{F()}),(o,e)=>{const u=p("el-button"),d=p("el-table-column"),S=p("el-tag"),_=p("el-icon"),I=p("el-button-group"),W=p("el-table"),U=p("el-input"),C=p("el-form-item"),A=p("el-upload"),M=p("el-dialog"),oe=de("loading");return i(),v("div",ye,[t("div",he,[t("div",ge,[t("div",be,[e[5]||(e[5]=t("div",{class:"header-title"},"学习心得列表",-1)),t("div",ke,"共计 "+c(L.value.length)+" 篇心得",1)]),l(u,{type:"primary",onClick:se},{default:a(()=>e[6]||(e[6]=[m("刷新")])),_:1})]),L.value.length>0?ue((i(),x(W,{key:0,data:L.value},{default:a(()=>[l(d,{prop:"title",label:"标题"}),l(d,{label:"状态",width:"100"},{default:a(({row:n})=>[l(S,{type:n.admin_reply?"success":"info"},{default:a(()=>[m(c(n.admin_reply?"已回复":"未回复"),1)]),_:2},1032,["type"])]),_:1}),l(d,{label:"附件",width:"80"},{default:a(({row:n})=>[n.attachment_url?(i(),x(u,{key:0,type:"primary",link:"",onClick:G=>Y(n)},{default:a(()=>[l(_,{color:"#409EFF",size:"18"},{default:a(()=>[l($(ce))]),_:1})]),_:2},1032,["onClick"])):(i(),v("span",we,"-"))]),_:1}),l(d,{prop:"created_at",label:"创建时间",width:"180"},{default:a(({row:n})=>[m(c(new Date(n.created_at).toLocaleString()),1)]),_:1}),l(d,{prop:"updated_at",label:"修改时间",width:"180"},{default:a(({row:n})=>[m(c(n.updated_at?new Date(n.updated_at).toLocaleString():"-"),1)]),_:1}),l(d,{label:"操作",width:"160"},{default:a(({row:n})=>[l(I,null,{default:a(()=>[l(u,{type:"primary",onClick:G=>Q(n)},{default:a(()=>e[7]||(e[7]=[m("查看")])),_:2},1032,["onClick"]),l(u,{type:"warning",onClick:G=>X(n),disabled:!!n.admin_reply},{default:a(()=>e[8]||(e[8]=[m("编辑")])),_:2},1032,["onClick","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[oe,N.value]]):N.value?h("",!0):(i(),v("div",Ve,[t("div",Ce,[l(_,{size:"60",color:"#c0c4cc"},{default:a(()=>[l($(_e))]),_:1})]),e[9]||(e[9]=t("div",{class:"empty-text"},"暂无学习心得",-1))]))]),l(M,{title:K(),modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=n=>k.value=n),width:"60%","close-on-click-modal":!1,top:"10vh",class:"note-detail-dialog"},{footer:a(()=>[t("span",Ge,[l(u,{onClick:e[2]||(e[2]=n=>k.value=!1)},{default:a(()=>e[19]||(e[19]=[m("关闭")])),_:1}),D.value?h("",!0):(i(),x(u,{key:0,type:"primary",onClick:le},{default:a(()=>e[20]||(e[20]=[m("确定")])),_:1}))])]),default:a(()=>[D.value?(i(),v("div",Ne,[t("div",Le,[t("div",Ee,[t("h2",Se,c(s.value.title||"无标题"),1),t("div",Ue,[t("span",Ae,[e[14]||(e[14]=t("i",{class:"el-icon-time"},null,-1)),t("span",null,"提交于: "+c(new Date(s.value.created_at).toLocaleString()),1)]),s.value.updated_at&&s.value.updated_at!==s.value.created_at?(i(),v("span",Me,[e[15]||(e[15]=t("i",{class:"el-icon-edit"},null,-1)),t("span",null,"修改于: "+c(new Date(s.value.updated_at).toLocaleString()),1)])):h("",!0)])]),t("div",$e,[e[16]||(e[16]=t("div",{class:"section-title"},"我的内容",-1)),t("div",ze,c(s.value.content||"无内容"),1)]),s.value.attachment_url?(i(),v("div",Be,[e[17]||(e[17]=t("div",{class:"section-title"},"附件",-1)),t("div",Fe,[t("span",Ie,c(s.value.attachment_name),1),l(u,{type:"primary",size:"small",onClick:Z},{default:a(()=>[m(c(R.value?"预览图片":T.value?"预览PDF":"查看附件"),1)]),_:1})])])):h("",!0),s.value.admin_reply?(i(),v("div",Pe,[e[18]||(e[18]=t("div",{class:"section-title"},"管理员回复",-1)),t("div",qe,[t("div",Re,[t("span",Te,c(s.value.admin_name||"未知")+":",1)]),t("div",je,c(s.value.admin_reply),1),s.value.replied_at?(i(),v("div",We," 回复于： "+c(new Date(s.value.replied_at).toLocaleString()),1)):h("",!0)])])):h("",!0)])])):(i(),x($(ve),{key:0,model:f.value,ref_key:"formRef",ref:B,rules:O},{default:a(()=>[l(C,{label:"标题",prop:"title"},{default:a(()=>[l(U,{modelValue:f.value.title,"onUpdate:modelValue":e[0]||(e[0]=n=>f.value.title=n)},null,8,["modelValue"])]),_:1}),l(C,{label:"内容",prop:"content"},{default:a(()=>[l(U,{modelValue:f.value.content,"onUpdate:modelValue":e[1]||(e[1]=n=>f.value.content=n),type:"textarea",rows:6},null,8,["modelValue"])]),_:1}),g.value?h("",!0):(i(),x(C,{key:0,label:"附件"},{default:a(()=>[l(A,{class:"upload-container",drag:"","auto-upload":!0,"http-request":te,"on-remove":ae,"before-upload":ee,limit:1,"file-list":q.value},{tip:a(()=>e[10]||(e[10]=[t("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[l(_,{class:"el-icon--upload"},{default:a(()=>[l($(me))]),_:1}),e[11]||(e[11]=t("div",{class:"el-upload__text"},[m(" 将文件拖到此处，或"),t("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})),g.value&&s.value.attachment_url?(i(),x(C,{key:1,label:"当前附件"},{default:a(()=>[t("div",xe,[t("span",De,c(s.value.attachment_name),1),l(u,{type:"primary",size:"small",onClick:j},{default:a(()=>e[12]||(e[12]=[m("下载")])),_:1})]),e[13]||(e[13]=t("div",{class:"el-upload__tip",style:{"margin-top":"8px"}}," 注意：编辑模式下暂不支持修改附件 ",-1))]),_:1})):h("",!0)]),_:1},8,["model"]))]),_:1},8,["title","modelValue"]),l(M,{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=n=>E.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{default:a(()=>[t("div",He,[R.value?(i(),v("img",{key:0,src:w.value,class:"attachment-image"},null,8,Je)):T.value?(i(),v("iframe",{key:1,src:w.value,class:"attachment-frame"},null,8,Oe)):(i(),v("div",Ke,[e[22]||(e[22]=t("p",null,"无法预览此类型的文件，请下载后查看",-1)),l(u,{type:"primary",onClick:j},{default:a(()=>e[21]||(e[21]=[m("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])}}}),at=fe(Qe,[["__scopeId","data-v-f45b69f3"]]);export{at as default};
