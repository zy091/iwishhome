import{E as f,t as ge,H as ke,I as ye,J as Q,c as be}from"./elementPlus-Be5V1zcU.js";import{B as Ce,s as $,b as $e}from"./index-Dg6Dv2jL.js";import{d as Y,H as W}from"./index-C7A_eenk.js";import{m as xe}from"./index-BaMLHsVY.js";import{v as q,G as ee,g as he}from"./pdf-CrTmMCjV.js";import{x as Me,X as te,r as _,c as De,j as Ne,y as V,P as t,A as u,H as a,ag as c,J as T,u as E,L as n,M as A,I as Fe,aq as Ve,G as Pe,D as ze,z as D}from"./vendor-CcmhhHhJ.js";import"./supabase-fOlwtt9p.js";const Te={class:"layout"},Ee={class:"card-header"},Be={class:"converter-content"},je={class:"upload-section"},He={key:0,class:"conversion-options"},Ue={key:1,class:"conversion-progress"},Le={class:"progress-text"},Se={key:2,class:"conversion-result"},Ie={class:"result-actions"},Oe={class:"card-header"},We={class:"markdown-preview-container"},qe={class:"markdown-toolbar"},Ae={key:0,class:"markdown-editor"},Ge={key:1,class:"markdown-preview-content"},Je=["innerHTML"],Re=Me({__name:"FileConverter",setup(Xe){const G=[`https://cdn.jsdelivr.net/npm/pdfjs-dist@${q}/build/pdf.worker.min.js`,`https://unpkg.com/pdfjs-dist@${q}/build/pdf.worker.min.js`,`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${q}/pdf.worker.min.js`];ee.workerSrc=G[0];const oe=te([{name:"数据管理",path:""},{name:"文件转换工具",path:"/system/file-converter"}]),J=_([]),y=_(null),B=_(!1),k=_(0),P=_(""),w=_(""),h=_(null),R=_([]),U=_(!1),N=_(!1),g=_("preview"),b=_(""),L=_(!1),C=_(null),m=te({outputName:"",options:["preserveFormatting","includeTables"]});Y.setOptions({highlight:function(o,e){if(e&&W.getLanguage(e))try{return W.highlight(o,{language:e}).value}catch(l){console.error("代码高亮错误:",l)}return W.highlightAuto(o).value},breaks:!0,gfm:!0});const ae=De(()=>b.value?Y(b.value):""),S=o=>{if(!o)return"untitled";let e=o.replace(/[^\w\s\-_.]/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"").toLowerCase().substring(0,100);return(!e||e.trim()==="")&&(e="untitled"),e},le=o=>{const e=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(o.type),l=o.size/1024/1024<50;return e?l?!0:(f.error("文件大小不能超过 50MB！"),!1):(f.error("只支持 PDF、DOC、DOCX 格式的文件！"),!1)},re=o=>{if(o.raw){y.value=o.raw;const e=o.name.replace(/\.[^/.]+$/,""),l=S(e);m.outputName=l+"_converted",e!==l&&f.info(`文件名已自动清理为: ${l}_converted`)}},ne=async()=>{if(!y.value){f.warning("请先选择要转换的文件");return}B.value=!0,k.value=0,P.value="",w.value="准备转换...";try{const{data:o,error:e}=await $.from("file_conversions").insert({original_name:y.value.name,output_name:m.outputName,file_type:y.value.type,status:"processing",options:m.options}).select("id").single();if(e)throw e;C.value=o.id;let l="";const s=y.value.type;s==="application/pdf"?l=await se(y.value):(s.includes("word")||s.includes("document"))&&(l=await ie(y.value)),k.value=80,w.value="上传转换结果...";const p=`${S(m.outputName)}.md`,v=new File([l],p,{type:"text/markdown"}),{data:M,error:d}=await $.storage.from("converted_files").upload(`markdown/${Date.now()}-${p}`,v);if(d)throw d;const{data:r}=$.storage.from("converted_files").getPublicUrl(M.path);k.value=100,w.value="转换完成！";const{error:z}=await $.from("file_conversions").update({status:"completed",output_file_url:r.publicUrl,markdown_content:l}).eq("id",C.value);if(z)throw z;h.value={id:C.value,fileName:p,url:r.publicUrl,content:l},P.value="success",f.success("文件转换成功！"),j()}catch(o){console.error("转换失败:",o),P.value="exception",w.value="转换失败",f.error(`转换失败: ${o.message}`),C.value&&await $.from("file_conversions").update({status:"failed"}).eq("id",C.value)}finally{B.value=!1}},se=async o=>{k.value=20,w.value="解析PDF文件...";try{const e=await o.arrayBuffer();let l,s;for(const d of G)try{ee.workerSrc=d,l=await he({data:e}).promise;break}catch(r){s=r,console.warn(`Worker源 ${d} 失败，尝试下一个...`);continue}if(!l)throw s||new Error("所有PDF worker源都失败了");k.value=30,w.value="提取PDF文本...";let x="";const p=l.numPages;for(let d=1;d<=p;d++){const I=(await(await l.getPage(d)).getTextContent()).items.map(H=>H.str).join(" ");x+=I+`

`;const O=30+d/p*40;k.value=Math.round(O),w.value=`提取第 ${d}/${p} 页...`}k.value=70,w.value="转换为Markdown...";let v=`# ${m.outputName}

`;v+=`> 从PDF文件转换而来 (共 ${p} 页)

`,v+=`---

`;const M=x.split(`
`).filter(d=>d.trim());for(const d of M){const r=d.trim();r&&(r.length<50&&/^[A-Z\s]+$/.test(r)?v+=`## ${r}

`:v+=`${r}

`)}return v}catch(e){throw console.error("PDF解析失败:",e),new Error(`PDF解析失败: ${e.message}`)}},ie=async o=>{k.value=20,w.value="解析Word文档...";const e=await o.arrayBuffer(),l=await xe.convertToMarkdown({arrayBuffer:e});k.value=50,w.value="处理转换结果...";let s=l.value;return s=`# ${m.outputName}

> 从Word文档转换而来

---

`+s,l.messages.length>0&&(s+=`

## 转换说明

`,l.messages.forEach(p=>{s+=`- ${p.message}
`})),s},ue=()=>{h.value&&(b.value=h.value.content,N.value=!0)},de=()=>{if(h.value){const o=document.createElement("a");o.href=h.value.url,o.download=h.value.fileName,document.body.appendChild(o),o.click(),document.body.removeChild(o)}},ce=async()=>{if(!C.value||!b.value){f.warning("没有可保存的内容");return}L.value=!0;try{const e=`${S(m.outputName)}_edited.md`,l=new File([b.value],e,{type:"text/markdown"}),{data:s,error:x}=await $.storage.from("converted_files").upload(`markdown/${Date.now()}-${e}`,l,{upsert:!0});if(x)throw x;const{data:p}=$.storage.from("converted_files").getPublicUrl(s.path),{error:v}=await $.from("file_conversions").update({markdown_content:b.value,output_file_url:p.publicUrl}).eq("id",C.value);if(v)throw v;f.success("Markdown文件保存成功！")}catch(o){console.error("保存Markdown失败:",o),f.error(`保存失败: ${o.message}`)}finally{L.value=!1}},j=async()=>{U.value=!0;try{const{data:o,error:e}=await $.from("file_conversions").select("*").order("created_at",{ascending:!1}).limit(50);if(e)throw e;R.value=o||[]}catch(o){console.error("加载转换历史失败:",o),f.error("加载转换历史失败")}finally{U.value=!1}},pe=o=>{o.markdown_content?(b.value=o.markdown_content,C.value=o.id,N.value=!0):f.warning("该转换记录没有可预览的内容")},me=o=>{o.markdown_content?(b.value=o.markdown_content,C.value=o.id,g.value="edit",N.value=!0):f.warning("该转换记录没有可编辑的内容")},ve=async o=>{try{await be.confirm(`确定要删除转换记录 "${o.original_name}" 吗？`,"警告",{type:"warning"});const{error:e}=await $.from("file_conversions").delete().eq("id",o.id);if(e)throw e;f.success("删除成功"),j()}catch(e){e!=="cancel"&&f.error("删除失败")}},X=()=>{J.value=[],y.value=null,m.outputName="",m.options=["preserveFormatting","includeTables"],h.value=null,k.value=0,P.value="",w.value="",C.value=null};return Ne(()=>{j()}),(o,e)=>{const l=c("el-tag"),s=c("el-icon"),x=c("el-upload"),p=c("el-input"),v=c("el-form-item"),M=c("el-checkbox"),d=c("el-checkbox-group"),r=c("el-button"),z=c("el-form"),I=c("el-progress"),O=c("el-alert"),H=c("el-card"),F=c("el-table-column"),Z=c("el-button-group"),fe=c("el-table"),_e=c("el-dialog"),we=Ve("loading");return D(),V("div",Te,[t(Ce,{breadcrumb:oe},null,8,["breadcrumb"]),e[30]||(e[30]=u("div",{class:"layout-title"},[u("h1",{class:"title"},"文件转换工具"),u("p",{class:"subtitle"},"将Word文档和PDF文件转换为Markdown格式")],-1)),t(H,{class:"converter-card",shadow:"always"},{header:a(()=>[u("div",Ee,[e[9]||(e[9]=u("span",null,"文件转换",-1)),t(l,{type:"info"},{default:a(()=>e[8]||(e[8]=[n("支持 .doc, .docx, .pdf 格式")])),_:1})])]),default:a(()=>[u("div",Be,[u("div",je,[t(x,{class:"upload-dragger",drag:"","auto-upload":!1,"on-change":re,"file-list":J.value,limit:1,accept:".doc,.docx,.pdf","before-upload":le},{tip:a(()=>e[10]||(e[10]=[u("div",{class:"el-upload__tip"}," 支持 Word 文档 (.doc, .docx) 和 PDF 文件 (.pdf)，文件大小不超过 50MB ",-1)])),default:a(()=>[t(s,{class:"el-icon--upload"},{default:a(()=>[t(E(ge))]),_:1}),e[11]||(e[11]=u("div",{class:"el-upload__text"},[n(" 将文件拖到此处，或"),u("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),y.value?(D(),V("div",He,[t(z,{model:m,"label-width":"120px"},{default:a(()=>[t(v,{label:"输出文件名"},{default:a(()=>[t(p,{modelValue:m.outputName,"onUpdate:modelValue":e[0]||(e[0]=i=>m.outputName=i),placeholder:"请输入输出文件名（不含扩展名）",clearable:""},null,8,["modelValue"])]),_:1}),t(v,{label:"转换选项"},{default:a(()=>[t(d,{modelValue:m.options,"onUpdate:modelValue":e[1]||(e[1]=i=>m.options=i)},{default:a(()=>[t(M,{label:"preserveFormatting"},{default:a(()=>e[12]||(e[12]=[n("保留格式")])),_:1}),t(M,{label:"includeImages"},{default:a(()=>e[13]||(e[13]=[n("包含图片")])),_:1}),t(M,{label:"includeTables"},{default:a(()=>e[14]||(e[14]=[n("包含表格")])),_:1})]),_:1},8,["modelValue"])]),_:1}),t(v,null,{default:a(()=>[t(r,{type:"primary",onClick:ne,loading:B.value,disabled:!y.value},{default:a(()=>e[15]||(e[15]=[n(" 开始转换 ")])),_:1},8,["loading","disabled"]),t(r,{onClick:X},{default:a(()=>e[16]||(e[16]=[n("重置")])),_:1})]),_:1})]),_:1},8,["model"])])):T("",!0),B.value?(D(),V("div",Ue,[t(I,{percentage:k.value,status:P.value,"stroke-width":8},null,8,["percentage","status"]),u("p",Le,A(w.value),1)])):T("",!0),h.value?(D(),V("div",Se,[t(O,{title:"转换完成",type:"success",closable:!1,"show-icon":""}),u("div",Ie,[t(r,{type:"primary",onClick:ue},{default:a(()=>[t(s,null,{default:a(()=>[t(E(ke))]),_:1}),e[17]||(e[17]=n(" 预览Markdown "))]),_:1}),t(r,{onClick:de},{default:a(()=>[t(s,null,{default:a(()=>[t(E(ye))]),_:1}),e[18]||(e[18]=n(" 下载文件 "))]),_:1}),t(r,{onClick:X},{default:a(()=>[t(s,null,{default:a(()=>[t(E(Q))]),_:1}),e[19]||(e[19]=n(" 转换新文件 "))]),_:1})])])):T("",!0)])]),_:1}),t(H,{class:"history-card",shadow:"always",style:{"margin-top":"20px"}},{header:a(()=>[u("div",Oe,[e[21]||(e[21]=u("span",null,"转换历史",-1)),t(r,{type:"primary",size:"small",onClick:j},{default:a(()=>[t(s,null,{default:a(()=>[t(E(Q))]),_:1}),e[20]||(e[20]=n(" 刷新 "))]),_:1})])]),default:a(()=>[Fe((D(),Pe(fe,{data:R.value,style:{width:"100%"}},{default:a(()=>[t(F,{prop:"original_name",label:"原文件名"}),t(F,{prop:"output_name",label:"输出文件名"}),t(F,{prop:"file_type",label:"文件类型"}),t(F,{prop:"status",label:"状态"},{default:a(({row:i})=>[t(l,{type:i.status==="completed"?"success":"warning"},{default:a(()=>[n(A(i.status==="completed"?"已完成":"处理中"),1)]),_:2},1032,["type"])]),_:1}),t(F,{prop:"created_at",label:"转换时间",width:"180"},{default:a(({row:i})=>[n(A(new Date(i.created_at).toLocaleString()),1)]),_:1}),t(F,{label:"操作",width:"200"},{default:a(({row:i})=>[t(Z,null,{default:a(()=>[t(r,{type:"primary",size:"small",onClick:K=>pe(i)},{default:a(()=>e[22]||(e[22]=[n(" 预览 ")])),_:2},1032,["onClick"]),t(r,{type:"success",size:"small",onClick:K=>me(i)},{default:a(()=>e[23]||(e[23]=[n(" 编辑 ")])),_:2},1032,["onClick"]),t(r,{type:"danger",size:"small",onClick:K=>ve(i)},{default:a(()=>e[24]||(e[24]=[n(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[we,U.value]])]),_:1}),t(_e,{modelValue:N.value,"onUpdate:modelValue":e[7]||(e[7]=i=>N.value=i),title:"Markdown预览",width:"90%","close-on-click-modal":!1,class:"markdown-preview-dialog"},{footer:a(()=>[t(r,{onClick:e[6]||(e[6]=i=>N.value=!1)},{default:a(()=>e[29]||(e[29]=[n("关闭")])),_:1})]),default:a(()=>[u("div",We,[u("div",qe,[t(Z,null,{default:a(()=>[t(r,{type:g.value==="preview"?"primary":"",onClick:e[2]||(e[2]=i=>g.value="preview")},{default:a(()=>e[25]||(e[25]=[n(" 预览 ")])),_:1},8,["type"]),t(r,{type:g.value==="edit"?"primary":"",onClick:e[3]||(e[3]=i=>g.value="edit")},{default:a(()=>e[26]||(e[26]=[n(" 编辑 ")])),_:1},8,["type"]),t(r,{type:g.value==="split"?"primary":"",onClick:e[4]||(e[4]=i=>g.value="split")},{default:a(()=>e[27]||(e[27]=[n(" 分屏 ")])),_:1},8,["type"])]),_:1}),t(r,{type:"success",onClick:ce,loading:L.value},{default:a(()=>e[28]||(e[28]=[n(" 保存 ")])),_:1},8,["loading"])]),u("div",{class:ze(["markdown-container",g.value])},[g.value==="edit"||g.value==="split"?(D(),V("div",Ae,[t(p,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=i=>b.value=i),type:"textarea",rows:25,placeholder:"请输入Markdown内容...",class:"markdown-textarea"},null,8,["modelValue"])])):T("",!0),g.value==="preview"||g.value==="split"?(D(),V("div",Ge,[u("div",{innerHTML:ae.value,class:"markdown-html"},null,8,Je)])):T("",!0)],2)])]),_:1},8,["modelValue"])])}}}),at=$e(Re,[["__scopeId","data-v-7870942a"]]);export{at as default};
