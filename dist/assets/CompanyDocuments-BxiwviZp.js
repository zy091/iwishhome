import{E as y,s as je,F as de,u as Oe,N as Ie,O as He,D as Re,t as We,c as me}from"./elementPlus-Be5V1zcU.js";import{s as w,u as Ge,B as Je,e as Qe,b as Xe}from"./index-BmK0bamU.js";import{x as Ke,X as ee,c as X,r as c,j as Ye,W as Ze,y as z,P as a,A as o,H as l,ag as d,G as D,J as k,u as $,L as m,I as et,aq as tt,M as b,O as at,a6 as lt,z as p}from"./vendor-CcmhhHhJ.js";import"./supabase-fOlwtt9p.js";const nt=s=>s===0,R={async getAllDocuments(s={}){let r=w.from("documents").select("*",{count:"exact"});s.query&&(r=r.ilike("title",`%${s.query}%`)),s.category&&s.category!=="all"&&(r=r.eq("category",s.category)),s.startDate&&s.endDate&&(r=r.gte("created_at",s.startDate).lte("created_at",s.endDate)),s.showStatus!==void 0?r=r.eq("is_show",s.showStatus==="true"):r=r.eq("is_show",!0);const _=((s.page||1)-1)*(s.pageSize||10),u=_+(s.pageSize||10)-1,{data:x,error:h,count:V}=await r.order("created_at",{ascending:!1}).range(_,u);if(h)throw h;return{data:x,total:V||0}},async getDocument(s){const{data:r,error:_}=await w.from("documents").select("*").eq("id",s).single();if(_)throw _;return r},async createDocument(s){const{data:{user:r}}=await w.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:_,error:u}=await w.from("user_profiles").select("full_name").eq("user_id",r.id).single();if(u)throw u;const{data:x,error:h}=await w.from("documents").insert({...s,created_by:r.id,created_by_name:_.full_name||r.email}).select().single();if(h)throw h;return x},async updateDocument(s,r){const{data:_,error:u}=await w.from("documents").update(r).eq("id",s).select().single();if(u)throw u;return _},async deleteDocument(s){const{error:r}=await w.from("documents").delete().eq("id",s);if(r)throw r},async uploadFile(s,r){const _=`${new Date().getTime()}_${s.name}`,u=`${r}/${_}`,{data:x,error:h}=await w.storage.from("documents").upload(u,s);if(h)throw h;const{data:{publicUrl:V}}=w.storage.from("documents").getPublicUrl(u);return{url:V,filename:_}}},ot={class:"layout"},st={class:"layout-title"},rt={class:"status-tabs"},it={class:"documents-content"},ut={class:"card-header"},ct={key:0,class:"header-actions"},dt={style:{"font-size":"14px",color:"#909399"}},mt={key:1},pt={class:"dialog-content"},_t={class:"document-details"},ft={class:"document-header"},gt={class:"document-title"},vt={class:"document-meta"},ht={class:"meta-item"},yt={class:"meta-item"},wt={class:"meta-item"},bt={class:"document-section"},Dt=["innerHTML"],kt={key:0,class:"document-section"},xt={class:"attachment-box"},Vt={class:"attachment-name"},Ct={class:"dialog-footer"},St={class:"attachment-preview"},Ut=["src"],zt=["src"],$t={key:2,class:"attachment-download"},Tt={class:"dialog-footer"},Ft=Ke({__name:"CompanyDocuments",setup(s){const r=ee([{name:"公司文档",path:"/system/company-documents"}]),_=Ge();X(()=>{var t;return((t=_.user)==null?void 0:t.user_id)||""});const u=X(()=>nt(Number(_.roleId))),x=c(!1),h=c([]),V=c(!1),E=c(!1),g=c(null),K=c(""),C=c([]),W=c(""),G=c(!1),M=c("all"),T=c([]),Y=c(),F=c(!1),J=c(!1),B=c(""),A=c(""),i=ee({id:"",title:"",content:"",category:"",is_show:!0,attachment_url:"",attachment_name:""}),pe={title:[{required:!0,message:"请输入文档标题",trigger:"blur"},{min:2,max:100,message:"标题长度应在2到100个字符之间",trigger:"blur"}],category:[{required:!0,message:"请选择文档类型",trigger:"change"}],content:[{required:!0,message:"请输入文档内容",trigger:"blur"},{min:8,max:1e4,message:"内容长度应在8到10000个字符之间",trigger:"blur"}]},_e=[{label:"假勤",value:"attendance"},{label:"行政",value:"administrative"},{label:"财务",value:"financial"},{label:"人事",value:"hr"},{label:"其他",value:"other"}],S=ee({page:1,pageSize:10,total:0});c(null);const te=c([]),N=c(null),fe=X(()=>A.value?A.value.startsWith("image/"):!1),ge=X(()=>A.value?A.value==="application/pdf":!1),ve=[{text:"最近一周",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近一个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近三个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],he=t=>{switch(t){case"attendance":return"primary";case"administrative":return"success";case"financial":return"warning";case"hr":return"danger";case"other":return"info";default:return"info"}},ae=t=>{switch(t){case"attendance":return"假勤";case"administrative":return"行政";case"financial":return"财务";case"hr":return"人事";case"other":return"其他";default:return t||"未知"}},ye=t=>{S.page=t.page,S.pageSize=t.pageSize,q()},q=async()=>{x.value=!0;const t=C.value!=null&&C.value[0]!=null?C.value[0].toDateString():"",e=C.value!=null&&C.value[1]!=null?C.value[1].toDateString():"";try{const f=await R.getAllDocuments({query:K.value,startDate:t,endDate:e,page:S.page,pageSize:S.pageSize,category:M.value!=="all"?M.value:void 0,showStatus:u.value&&W.value!==""?W.value:void 0});h.value=f.data,S.total=f.total}catch(f){y.error("搜索文档失败"),console.error("搜索文档失败:",f)}finally{x.value=!1}},we=async t=>{V.value=!0,g.value=t},be=t=>{t.attachment_url&&(B.value=t.attachment_url,A.value=le(t.attachment_name),J.value=!0)},De=()=>{var t;(t=g.value)!=null&&t.attachment_url&&(B.value=g.value.attachment_url,A.value=le(g.value.attachment_name),J.value=!0)},le=t=>{if(!t)return"";const e=Se(t);return["jpg","jpeg","png","gif","webp"].includes(e)?"image/"+e:e==="pdf"?"application/pdf":""},ke=()=>{B.value&&window.open(B.value,"_blank")},xe=t=>{F.value=!0,E.value=!0,Object.assign(i,{id:t.id,title:t.title,content:t.content,category:t.category,is_show:t.is_show,attachment_url:t.attachment_url,attachment_name:t.attachment_name})},Ve=()=>{F.value=!1,E.value=!0,Object.assign(i,{id:"",title:"",content:"",category:"",is_show:!0,attachment_url:"",attachment_name:""})},Ce=t=>{T.value=t},Se=t=>{if(!t)return"";const e=t.split(".");return e.length>1?e[e.length-1].toLowerCase():""},Ue=t=>{const e=["application/pdf","application/msword","text/plain","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/jpeg","image/png","image/gif","image/webp"],f=t.raw&&e.includes(t.raw.type),j=t.raw&&t.raw.size/1024/1024<10;if(!f)return y.error("文件类型不支持！"),!1;if(!j)return y.error("文件大小超过 10MB 限制！"),!1;N.value=t.raw,console.log("Selected file:",N.value)},ze=async t=>{if(!t)throw new Error("No file selected");const e=t.name.split(".").pop(),j=`companydocuments/${`${Date.now()}-${Math.random().toString(36).substring(2)}.${e}`}`,{data:O,error:Q}=await w.storage.from("materials").upload(j,t);if(Q)throw Q;const{data:I}=w.storage.from("materials").getPublicUrl(O.path);return I.publicUrl},$e=async()=>{Y.value&&await Y.value.validate(async t=>{if(t){G.value=!0;try{if(N.value)try{const e=await ze(N.value);i.attachment_url=e,i.attachment_name=N.value.name}catch(e){y.error(`文件上传失败: ${e.message||"未知错误"}`),G.value=!1;return}F.value?(await R.updateDocument(i.id,{title:i.title,content:i.content,category:i.category,is_show:i.is_show,attachment_url:i.attachment_url,attachment_name:i.attachment_name}),y.success("文档已更新")):(await R.createDocument({title:i.title,content:i.content,category:i.category,is_show:i.is_show,attachment_url:i.attachment_url,attachment_name:i.attachment_name}),y.success("文档已创建")),E.value=!1,q(),te.value=[],N.value=null}catch(e){y.error(F.value?"更新文档失败":"创建文档失败"),console.error(F.value?"更新文档失败:":"创建文档失败:",e)}finally{G.value=!1}}})},Te=async t=>{try{await me.confirm(`确定要删除 "${t.title}" 这份文档吗？`,"提示",{type:"warning"}),await R.deleteDocument(t.id),y.success("删除成功"),q()}catch(e){e!=="cancel"&&(y.error("删除失败"),console.error("删除失败:",e))}},Fe=async()=>{if(T.value.length!==0)try{await me.confirm(`确定要删除选中的 ${T.value.length} 份文档吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=T.value.map(e=>R.deleteDocument(e.id));await Promise.all(t),y.success(`成功删除 ${T.value.length} 份文档`),T.value=[],q()}catch(t){t!=="cancel"&&(console.error("批量删除文档失败:",t),y.error("批量删除失败"))}},qe=t=>{M.value=t,S.page=1,q()};return Ye(()=>{q()}),Ze(()=>{}),(t,e)=>{const f=d("el-tab-pane"),j=d("el-tabs"),O=d("el-input"),Q=d("el-date-picker"),I=d("el-option"),ne=d("el-select"),v=d("el-button"),Ee=d("el-space"),oe=d("el-card"),U=d("el-table-column"),se=d("el-tag"),P=d("el-icon"),Be=d("el-button-group"),Ae=d("el-empty"),Ne=d("el-table"),Z=d("el-dialog"),H=d("el-form-item"),Pe=d("el-upload"),Le=d("el-switch"),Me=tt("loading");return p(),z("div",ot,[a(Je,{breadbcrum:r},null,8,["breadbcrum"]),o("div",st,[e[13]||(e[13]=o("h1",{class:"title"},"公司文档",-1)),o("div",rt,[a(j,{class:"demo-tabs",modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=n=>M.value=n),onTabChange:qe},{default:l(()=>[a(f,{name:"all",label:"全部文档"}),a(f,{name:"attendance",label:"假勤"}),a(f,{name:"administrative",label:"行政"}),a(f,{name:"financial",label:"财务"}),a(f,{name:"hr",label:"人事"}),a(f,{name:"other",label:"其他"})]),_:1},8,["modelValue"])])]),a(oe,{shadow:"always",style:{"margin-bottom":"20px"}},{default:l(()=>[a(Ee,{alignment:"start",size:30},{default:l(()=>[a(O,{modelValue:K.value,"onUpdate:modelValue":e[1]||(e[1]=n=>K.value=n),style:{width:"240px"},placeholder:"请输入文档标题","suffix-icon":$(je),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),a(Q,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=n=>C.value=n),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:ve,size:"large"},null,8,["modelValue"]),u.value?(p(),D(ne,{key:0,modelValue:W.value,"onUpdate:modelValue":e[3]||(e[3]=n=>W.value=n),placeholder:"选择展示状态",style:{width:"160px"},size:"large",clearable:""},{default:l(()=>[a(I,{label:"显示",value:"true"}),a(I,{label:"隐藏",value:"false"})]),_:1},8,["modelValue"])):k("",!0),a(v,{type:"primary",size:"large",onClick:q},{default:l(()=>e[14]||(e[14]=[m("搜索")])),_:1}),u.value?(p(),D(v,{key:1,type:"success",size:"large",onClick:Ve},{default:l(()=>e[15]||(e[15]=[m("添加文档")])),_:1})):k("",!0)]),_:1})]),_:1}),o("div",it,[a(oe,{style:{"min-height":"400px"}},{header:l(()=>[o("div",ut,[e[17]||(e[17]=m(" 文档列表 ")),u.value?(p(),z("div",ct,[a(v,{type:"danger",disabled:!T.value.length,onClick:Fe},{default:l(()=>e[16]||(e[16]=[m(" 批量删除 ")])),_:1},8,["disabled"]),o("div",dt,"共计"+b(S.total)+"条数据",1)])):k("",!0)])]),default:l(()=>[et((p(),D(Ne,{data:h.value,onSelectionChange:Ce},{default:l(()=>[u.value?(p(),D(U,{key:0,type:"selection",width:"55"})):k("",!0),a(U,{prop:"title",label:"标题","min-width":"200"}),a(U,{prop:"category",label:"类型",width:"130"},{default:l(({row:n})=>[a(se,{type:he(n.category),size:"large"},{default:l(()=>[m(b(ae(n.category)),1)]),_:2},1032,["type"])]),_:1}),u.value?(p(),D(U,{key:1,prop:"is_show",label:"展示状态",width:"100"},{default:l(({row:n})=>[a(se,{type:n.is_show?"success":"danger",size:"large"},{default:l(()=>[m(b(n.is_show?"显示":"隐藏"),1)]),_:2},1032,["type"])]),_:1})):k("",!0),a(U,{prop:"created_at",label:"创建时间",width:"180"},{default:l(({row:n})=>[m(b(new Date(n.created_at).toLocaleString()),1)]),_:1}),u.value?(p(),D(U,{key:2,prop:"created_by_name",label:"创建人",width:"120"})):k("",!0),a(U,{label:"附件",width:"80"},{default:l(({row:n})=>[n.attachment_url?(p(),D(v,{key:0,type:"primary",link:"",onClick:L=>be(n)},{default:l(()=>[a(P,{color:"#409EFF",size:"18"},{default:l(()=>[a($(de))]),_:1})]),_:2},1032,["onClick"])):(p(),z("span",mt,"-"))]),_:1}),a(U,{label:"操作",width:"230",fixed:"right"},{default:l(({row:n})=>[a(Be,null,{default:l(()=>[a(v,{type:"primary",onClick:L=>we(n)},{default:l(()=>e[18]||(e[18]=[m("查看")])),_:2},1032,["onClick"]),u.value?(p(),D(v,{key:0,type:"warning",onClick:L=>xe(n)},{default:l(()=>e[19]||(e[19]=[m("编辑")])),_:2},1032,["onClick"])):k("",!0),u.value?(p(),D(v,{key:1,type:"danger",onClick:L=>Te(n)},{default:l(()=>e[20]||(e[20]=[m("删除")])),_:2},1032,["onClick"])):k("",!0)]),_:2},1024)]),_:1}),a(Ae,null,{description:l(()=>e[21]||(e[21]=[m(" 暂无文档数据 ")])),_:1})]),_:1},8,["data"])),[[Me,x.value]])]),_:1}),a(Qe,{pagination:S,"onUpdate:pagination":ye},null,8,["pagination"]),a(Z,{title:"文档详情",modelValue:V.value,"onUpdate:modelValue":e[5]||(e[5]=n=>V.value=n),width:"60%","close-on-click-modal":!1,top:"5vh",class:"document-detail-dialog"},{footer:l(()=>[o("span",Ct,[a(v,{onClick:e[4]||(e[4]=n=>V.value=!1)},{default:l(()=>e[25]||(e[25]=[m("关闭")])),_:1})])]),default:l(()=>{var n,L,re,ie,ue,ce;return[o("div",pt,[o("div",_t,[o("div",ft,[o("h2",gt,b(((n=g.value)==null?void 0:n.title)||"无标题"),1),o("div",vt,[o("span",ht,[a(P,null,{default:l(()=>[a($(Oe))]),_:1}),o("span",null,b(((L=g.value)==null?void 0:L.created_by_name)||"未知用户"),1)]),o("span",yt,[a(P,null,{default:l(()=>[a($(Ie))]),_:1}),o("span",null,b(g.value?new Date((re=g.value)==null?void 0:re.created_at).toLocaleString():"未知时间"),1)]),o("span",wt,[a(P,null,{default:l(()=>[a($(He))]),_:1}),o("span",null,b(ae(((ie=g.value)==null?void 0:ie.category)||"")),1)])])]),o("div",bt,[e[22]||(e[22]=o("div",{class:"section-title"},"内容",-1)),o("div",{class:"document-content",style:{padding:"10px"},innerHTML:((ue=g.value)==null?void 0:ue.content)||"无内容"},null,8,Dt)]),(ce=g.value)!=null&&ce.attachment_url?(p(),z("div",kt,[e[24]||(e[24]=o("div",{class:"section-title"},"附件",-1)),o("div",xt,[a(P,{color:"#409EFF",size:"16"},{default:l(()=>[a($(de))]),_:1}),o("span",Vt,b(g.value.attachment_name),1),a(v,{type:"primary",size:"small",onClick:De},{default:l(()=>e[23]||(e[23]=[m("查看附件")])),_:1})])])):k("",!0)])])]}),_:1},8,["modelValue"]),a(Z,{modelValue:J.value,"onUpdate:modelValue":e[6]||(e[6]=n=>J.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{default:l(()=>[o("div",St,[fe.value?(p(),z("img",{key:0,src:B.value,class:"attachment-image"},null,8,Ut)):ge.value?(p(),z("iframe",{key:1,src:B.value,class:"attachment-frame"},null,8,zt)):(p(),z("div",$t,[e[27]||(e[27]=o("p",null,"无法预览此类型的文件，请下载后查看",-1)),a(v,{type:"primary",onClick:ke},{default:l(()=>e[26]||(e[26]=[m("下载附件")])),_:1})]))])]),_:1},8,["modelValue"]),a(Z,{title:F.value?"编辑文档":"创建文档",modelValue:E.value,"onUpdate:modelValue":e[12]||(e[12]=n=>E.value=n),width:"50%","close-on-click-modal":!1},{footer:l(()=>[o("span",Tt,[a(v,{onClick:e[11]||(e[11]=n=>E.value=!1)},{default:l(()=>e[30]||(e[30]=[m("取消")])),_:1}),a(v,{type:"primary",onClick:$e,loading:G.value},{default:l(()=>[m(b(F.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:l(()=>[a($(Re),{model:i,rules:pe,ref_key:"documentForm",ref:Y,"label-width":"80px",style:{"max-width":"800px"}},{default:l(()=>[a(H,{label:"标题",prop:"title"},{default:l(()=>[a(O,{modelValue:i.title,"onUpdate:modelValue":e[7]||(e[7]=n=>i.title=n),placeholder:"请输入文档标题"},null,8,["modelValue"])]),_:1}),a(H,{label:"类型",prop:"category"},{default:l(()=>[a(ne,{modelValue:i.category,"onUpdate:modelValue":e[8]||(e[8]=n=>i.category=n),placeholder:"选择文档类型",style:{width:"100%"}},{default:l(()=>[(p(),z(at,null,lt(_e,n=>a(I,{key:n.value,label:n.label,value:n.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(H,{label:"内容",prop:"content"},{default:l(()=>[a(O,{type:"textarea",modelValue:i.content,"onUpdate:modelValue":e[9]||(e[9]=n=>i.content=n),rows:10,placeholder:"请输入文档内容"},null,8,["modelValue"])]),_:1}),a(H,{label:"附件"},{default:l(()=>[a(Pe,{class:"upload-box","auto-upload":!1,"on-change":Ue,"file-list":te.value,limit:1,drag:"",action:"https://run.mocky.io/v3/9d059bf9-4660-45f2-925d-ce80ad6c4d15",multiple:""},{tip:l(()=>e[28]||(e[28]=[o("div",{class:"el-upload__tip"}," 支持 .pdf, .doc, .docx, .xls, .xlsx 格式文件，不超过10MB ",-1)])),default:l(()=>[a(P,{class:"el-icon--upload"},{default:l(()=>[a($(We))]),_:1}),e[29]||(e[29]=o("div",{class:"el-upload__text"},[m(" 拖拽文件或"),o("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),a(H,{label:"状态"},{default:l(()=>[a(Le,{modelValue:i.is_show,"onUpdate:modelValue":e[10]||(e[10]=n=>i.is_show=n),"active-text":"显示","inactive-text":"隐藏"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])])])}}}),Nt=Xe(Ft,[["__scopeId","data-v-0c471cf9"]]);export{Nt as default};
