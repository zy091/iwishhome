import{s as _,b as be}from"./index-BID3odBW.js";import{E as d,y as K,K as ye,r as he,z as we,c as Ve}from"./elementPlus-BSeP1oVM.js";import{x as xe,r as v,X,j as Ce,y as V,A as i,I as ke,P as t,H as l,ag as n,aq as Ae,G as U,L as c,u as B,M as y,J as S,O as G,a6 as O,z as p}from"./vendor-kUynFKsh.js";import"./supabase-CBzAt1Op.js";const Ue={class:"instructor-manage"},Me={class:"manage-header"},qe={key:0,style:{color:"#909399","font-size":"12px"}},Ee={style:{"font-size":"12px"}},$e=["src"],ze={class:"course-manage-content"},Be={key:0,class:"selected-instructor"},Ie={class:"course-selection"},Fe={class:"current-courses"},Pe=xe({__name:"InstructorManage",setup(De){const P=v(!1),x=v(!1),C=v(!1),M=v(!1),D=v("添加讲师"),q=v(),L=v([]),T=v([]),k=v([]),g=v(null),E=v([]),o=X({name:"",avatar_url:null,title:"",department:"",specialties:[],introduction:"",teaching_experience:0,total_courses:0,total_students:0,rating:5,email:"",phone:"",is_active:!0}),Q=X({name:[{required:!0,message:"请输入讲师姓名",trigger:"blur"}],title:[{required:!0,message:"请输入职称",trigger:"blur"}],department:[{required:!0,message:"请选择部门",trigger:"change"}],specialties:[{required:!0,message:"请选择专业领域",trigger:"change"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],introduction:[{required:!0,message:"请输入个人简介",trigger:"blur"}]}),I=async()=>{P.value=!0;try{const{data:r,error:e}=await _.from("instructors").select("*").order("created_at",{ascending:!1});if(e)throw e;L.value=r||[]}catch(r){console.error("获取讲师列表失败:",r),d.error("获取讲师列表失败")}finally{P.value=!1}},W=async()=>{try{const{data:r,error:e}=await _.from("instructor_courses").select("*").order("course_name",{ascending:!0});if(e)throw e;T.value=r||[]}catch(r){console.error("获取课程列表失败:",r)}},Y=r=>{const e=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399"],s=r.charCodeAt(0)%e.length;return`https://ui-avatars.com/api/?name=${encodeURIComponent(r)}&background=${e[s].substring(1)}&color=fff&size=200`},Z=()=>{D.value="添加讲师",R(),C.value=!0},ee=r=>{D.value="编辑讲师",Object.assign(o,r),C.value=!0},te=async r=>{try{await Ve.confirm(`确定要删除讲师"${r.name}"吗？此操作将同时删除该讲师的所有课程关联。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const{error:e}=await _.from("instructors").delete().eq("id",r.id);if(e)throw e;d.success("删除成功"),I()}catch(e){e!=="cancel"&&(console.error("删除失败:",e),d.error("删除失败"))}},le=async r=>{g.value=r,M.value=!0;try{const{data:e,error:s}=await _.from("instructor_courses").select("*").eq("instructor_id",r.id);if(s)throw s;k.value=e||[],E.value=k.value.map(f=>f.id)}catch(e){console.error("获取讲师课程失败:",e)}},ae=async r=>{try{const{error:e}=await _.from("instructor_courses").delete().eq("id",r);if(e)throw e;k.value=k.value.filter(s=>s.id!==r),E.value=E.value.filter(s=>s!==r),d.success("移除成功"),await j()}catch(e){console.error("移除课程失败:",e),d.error("移除课程失败")}},j=async()=>{if(!g.value)return;const{count:r}=await _.from("instructor_courses").select("*",{count:"exact",head:!0}).eq("instructor_id",g.value.id);await _.from("instructors").update({total_courses:r||0}).eq("id",g.value.id),I()},oe=async()=>{if(g.value){x.value=!0;try{d.success("课程关联已更新"),M.value=!1,await j()}catch(r){console.error("保存课程失败:",r),d.error("保存课程失败")}finally{x.value=!1}}},re=async()=>{q.value&&await q.value.validate(async r=>{if(r){x.value=!0;try{const e={name:o.name,avatar_url:o.avatar_url,title:o.title,department:o.department,specialties:o.specialties,introduction:o.introduction,teaching_experience:o.teaching_experience,email:o.email,phone:o.phone,is_active:o.is_active,rating:o.rating||5};if(o.id){const{error:s}=await _.from("instructors").update(e).eq("id",o.id);if(s)throw s;d.success("更新成功")}else{const{error:s}=await _.from("instructors").insert(e);if(s)throw s;d.success("添加成功")}C.value=!1,I()}catch(e){console.error("操作失败:",e),d.error("操作失败："+e.message)}finally{x.value=!1}}})},se=r=>r.size/1024/1024>2?(d.error("头像大小不能超过 2MB!"),!1):!0,ne=async r=>{const e=r.file,s=e.name.split(".").pop(),u=`instructor-avatars/${`${Math.random()}.${s}`}`;try{const{error:h}=await _.storage.from("documents").upload(u,e);if(h)throw h;const{data:$}=_.storage.from("documents").getPublicUrl(u);o.avatar_url=$.publicUrl,d.success("上传成功")}catch(h){console.error("上传失败:",h),d.error("上传失败")}},R=()=>{q.value&&q.value.resetFields(),Object.assign(o,{id:void 0,name:"",avatar_url:null,title:"",department:"",specialties:[],introduction:"",teaching_experience:0,total_courses:0,total_students:0,rating:5,email:"",phone:"",is_active:!0})};return Ce(()=>{I(),W()}),(r,e)=>{const s=n("el-icon"),f=n("el-button"),u=n("el-table-column"),h=n("el-avatar"),$=n("el-tag"),ie=n("el-table"),z=n("el-input"),b=n("el-form-item"),w=n("el-col"),F=n("el-row"),m=n("el-option"),N=n("el-select"),ue=n("el-input-number"),de=n("el-switch"),ce=n("el-upload"),pe=n("el-form"),H=n("el-dialog"),me=n("el-divider"),fe=n("el-empty"),_e=Ae("loading");return p(),V("div",Ue,[i("div",Me,[e[15]||(e[15]=i("h2",null,"讲师管理",-1)),t(f,{type:"primary",onClick:Z},{default:l(()=>[t(s,null,{default:l(()=>[t(B(K))]),_:1}),e[14]||(e[14]=c(" 添加讲师 "))]),_:1})]),ke((p(),U(ie,{data:L.value,stripe:"",style:{width:"100%"},class:"instructor-table"},{default:l(()=>[t(u,{type:"index",label:"序号",width:"60"}),t(u,{label:"头像",width:"80"},{default:l(({row:a})=>[t(h,{src:a.avatar_url||Y(a.name),size:50},{default:l(()=>[c(y(a.name.charAt(0)),1)]),_:2},1032,["src"])]),_:1}),t(u,{prop:"name",label:"姓名",width:"120"}),t(u,{prop:"title",label:"职称",width:"150"}),t(u,{prop:"department",label:"部门",width:"120"}),t(u,{label:"专业领域","min-width":"200"},{default:l(({row:a})=>{var A,J;return[(p(!0),V(G,null,O((A=a.specialties)==null?void 0:A.slice(0,2),(ve,ge)=>(p(),U($,{key:ge,size:"small",type:"info",effect:"plain",style:{"margin-right":"5px"}},{default:l(()=>[c(y(ve),1)]),_:2},1024))),128)),((J=a.specialties)==null?void 0:J.length)>2?(p(),V("span",qe," +"+y(a.specialties.length-2),1)):S("",!0)]}),_:1}),t(u,{prop:"email",label:"邮箱",width:"180","show-overflow-tooltip":""}),t(u,{label:"状态",width:"80"},{default:l(({row:a})=>[t($,{type:a.is_active?"success":"info"},{default:l(()=>[c(y(a.is_active?"在职":"离职"),1)]),_:2},1032,["type"])]),_:1}),t(u,{label:"课程/学员",width:"120"},{default:l(({row:a})=>[i("div",Ee,[i("div",null,"课程: "+y(a.total_courses||0),1),i("div",null,"学员: "+y(a.total_students||0),1)])]),_:1}),t(u,{label:"操作",width:"200",fixed:"right"},{default:l(({row:a})=>[t(f,{link:"",type:"primary",onClick:A=>ee(a)},{default:l(()=>[t(s,null,{default:l(()=>[t(B(ye))]),_:1}),e[16]||(e[16]=c(" 编辑 "))]),_:2},1032,["onClick"]),t(f,{link:"",type:"warning",onClick:A=>le(a)},{default:l(()=>[t(s,null,{default:l(()=>[t(B(he))]),_:1}),e[17]||(e[17]=c(" 课程 "))]),_:2},1032,["onClick"]),t(f,{link:"",type:"danger",onClick:A=>te(a)},{default:l(()=>[t(s,null,{default:l(()=>[t(B(we))]),_:1}),e[18]||(e[18]=c(" 删除 "))]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[_e,P.value]]),t(H,{modelValue:C.value,"onUpdate:modelValue":e[10]||(e[10]=a=>C.value=a),title:D.value,width:"600px",onClose:R},{footer:l(()=>[t(f,{onClick:e[9]||(e[9]=a=>C.value=!1)},{default:l(()=>e[20]||(e[20]=[c("取消")])),_:1}),t(f,{type:"primary",onClick:re,loading:x.value},{default:l(()=>e[21]||(e[21]=[c(" 确定 ")])),_:1},8,["loading"])]),default:l(()=>[t(pe,{ref_key:"formRef",ref:q,model:o,rules:Q,"label-width":"100px"},{default:l(()=>[t(F,{gutter:20},{default:l(()=>[t(w,{span:12},{default:l(()=>[t(b,{label:"姓名",prop:"name"},{default:l(()=>[t(z,{modelValue:o.name,"onUpdate:modelValue":e[0]||(e[0]=a=>o.name=a),placeholder:"请输入讲师姓名"},null,8,["modelValue"])]),_:1})]),_:1}),t(w,{span:12},{default:l(()=>[t(b,{label:"职称",prop:"title"},{default:l(()=>[t(z,{modelValue:o.title,"onUpdate:modelValue":e[1]||(e[1]=a=>o.title=a),placeholder:"如：高级讲师"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(F,{gutter:20},{default:l(()=>[t(w,{span:12},{default:l(()=>[t(b,{label:"部门",prop:"department"},{default:l(()=>[t(N,{modelValue:o.department,"onUpdate:modelValue":e[2]||(e[2]=a=>o.department=a),placeholder:"请选择部门",style:{width:"100%"}},{default:l(()=>[t(m,{label:"Google广告部",value:"Google广告部"}),t(m,{label:"Meta广告部",value:"Meta广告部"}),t(m,{label:"数字营销部",value:"数字营销部"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(w,{span:12},{default:l(()=>[t(b,{label:"教学经验",prop:"teaching_experience"},{default:l(()=>[t(ue,{modelValue:o.teaching_experience,"onUpdate:modelValue":e[3]||(e[3]=a=>o.teaching_experience=a),min:0,max:50,placeholder:"年",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(b,{label:"专业领域",prop:"specialties"},{default:l(()=>[t(N,{modelValue:o.specialties,"onUpdate:modelValue":e[4]||(e[4]=a=>o.specialties=a),multiple:"",filterable:"","allow-create":"",placeholder:"请选择或输入专业领域",style:{width:"100%"}},{default:l(()=>[t(m,{label:"Google Ads",value:"Google Ads"}),t(m,{label:"PLA",value:"PLA"}),t(m,{label:"PMax",value:"PMax"}),t(m,{label:"Facebook Ads",value:"Facebook Ads"}),t(m,{label:"Instagram Ads",value:"Instagram Ads"}),t(m,{label:"数字营销策略",value:"数字营销策略"}),t(m,{label:"SEO",value:"SEO"}),t(m,{label:"SEM",value:"SEM"})]),_:1},8,["modelValue"])]),_:1}),t(F,{gutter:20},{default:l(()=>[t(w,{span:12},{default:l(()=>[t(b,{label:"邮箱",prop:"email"},{default:l(()=>[t(z,{modelValue:o.email,"onUpdate:modelValue":e[5]||(e[5]=a=>o.email=a),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1}),t(w,{span:12},{default:l(()=>[t(b,{label:"电话",prop:"phone"},{default:l(()=>[t(z,{modelValue:o.phone,"onUpdate:modelValue":e[6]||(e[6]=a=>o.phone=a),placeholder:"请输入电话"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(b,{label:"个人简介",prop:"introduction"},{default:l(()=>[t(z,{modelValue:o.introduction,"onUpdate:modelValue":e[7]||(e[7]=a=>o.introduction=a),type:"textarea",rows:4,placeholder:"请输入个人简介，包括工作经历、专业特长等"},null,8,["modelValue"])]),_:1}),t(F,{gutter:20},{default:l(()=>[t(w,{span:12},{default:l(()=>[t(b,{label:"状态",prop:"is_active"},{default:l(()=>[t(de,{modelValue:o.is_active,"onUpdate:modelValue":e[8]||(e[8]=a=>o.is_active=a),"active-text":"在职","inactive-text":"离职"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(b,{label:"头像",prop:"avatar_url"},{default:l(()=>[t(ce,{class:"avatar-uploader","show-file-list":!1,"before-upload":se,"http-request":ne},{default:l(()=>[o.avatar_url?(p(),V("img",{key:0,src:o.avatar_url,class:"avatar"},null,8,$e)):(p(),U(s,{key:1,class:"avatar-uploader-icon"},{default:l(()=>[t(B(K))]),_:1}))]),_:1}),e[19]||(e[19]=i("div",{class:"upload-tip"},"建议上传 1:1 比例的图片，大小不超过 2MB",-1))]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),t(H,{modelValue:M.value,"onUpdate:modelValue":e[13]||(e[13]=a=>M.value=a),title:"管理讲师课程",width:"700px"},{footer:l(()=>[t(f,{onClick:e[12]||(e[12]=a=>M.value=!1)},{default:l(()=>e[24]||(e[24]=[c("取消")])),_:1}),t(f,{type:"primary",onClick:oe,loading:x.value},{default:l(()=>e[25]||(e[25]=[c(" 保存 ")])),_:1},8,["loading"])]),default:l(()=>[i("div",ze,[g.value?(p(),V("div",Be,[t(h,{src:g.value.avatar_url,size:60},{default:l(()=>[c(y(g.value.name.charAt(0)),1)]),_:1},8,["src"]),i("div",null,[i("h3",null,y(g.value.name),1),i("p",null,y(g.value.position),1)])])):S("",!0),t(me),i("div",Ie,[e[22]||(e[22]=i("h4",null,"添加课程",-1)),t(N,{modelValue:E.value,"onUpdate:modelValue":e[11]||(e[11]=a=>E.value=a),multiple:"",filterable:"",placeholder:"请选择课程",style:{width:"100%"}},{default:l(()=>[(p(!0),V(G,null,O(T.value,a=>(p(),U(m,{key:a.id,label:a.course_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),i("div",Fe,[e[23]||(e[23]=i("h4",null,"当前课程",-1)),(p(!0),V(G,null,O(k.value,a=>(p(),U($,{key:a.id,closable:"",onClose:A=>ae(a.id),type:"success",class:"course-tag-item"},{default:l(()=>[c(y(a.course_name),1)]),_:2},1032,["onClose"]))),128)),k.value.length===0?(p(),U(fe,{key:0,description:"暂无课程","image-size":60})):S("",!0)])])]),_:1},8,["modelValue"])])}}}),Le=be(Pe,[["__scopeId","data-v-cb26a61f"]]);export{Le as default};
