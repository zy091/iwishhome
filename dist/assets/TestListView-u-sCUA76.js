import{R as pe,r as y,s as D,d as Z,I as _e,o as ee,l as C,y as te,a as o,O as se,c as L,b as m,w as i,f as h,t as w,q as H,F as ae,e as c,M as P,j as v,_ as le,J as fe,H as ge,k as ve,m as ye,P as me,i as he,U as we}from"./index-DCqMzgSt.js";import{t as oe}from"./testResultService-CQoPyZnv.js";const F=pe("test",()=>{const p=y(!1),g=y(null);return{loading:p,error:g,getTests:async t=>{p.value=!0,g.value=null;try{let a=D.from("tests").select("*",{count:"exact"});if(t!=null&&t.searchQuery&&(a=a.ilike("title",`%${t.searchQuery}%`)),t!=null&&t.testType&&(a=a.eq("type",t.testType)),t!=null&&t.platform&&(a=a.eq("platform",t.platform)),t!=null&&t.chapter&&(a=a.eq("chapter",t.chapter)),t!=null&&t.page&&(t!=null&&t.pageSize)){const k=(t.page-1)*t.pageSize,r=k+t.pageSize-1;a=a.range(k,r)}a=a.order("created_at",{ascending:!1});const{data:d,error:b,count:z}=await a;if(b)throw b;return{data:d,total:z||0}}catch(a){return g.value=a.message,{data:[],total:0}}finally{p.value=!1}},getTestById:async t=>{p.value=!0,g.value=null;try{const{data:a,error:d}=await D.from("tests").select("*").eq("id",t).single();if(d)throw d;return a}catch(a){return g.value=a.message,null}finally{p.value=!1}},getUserTestStatus:async t=>{var a;p.value=!0,g.value=null;try{const{data:d,error:b}=await D.auth.getUser();if(b)throw b;const z=(a=d.user)==null?void 0:a.id;if(!z)throw new Error("用户未登录");const{data:k,error:r}=await D.from("user_tests").select("*").eq("user_id",z).eq("test_id",t).single();if(r&&r.code!=="PGRST116")throw r;return k||null}catch(d){return g.value=d.message,null}finally{p.value=!1}},updateUserTestStatus:async(t,a)=>{var d;p.value=!0,g.value=null;try{const{data:b,error:z}=await D.auth.getUser();if(z)throw z;const k=(d=b.user)==null?void 0:d.id;if(!k)throw new Error("用户未登录");const{data:r,error:l}=await D.from("user_tests").select("*").eq("user_id",k).eq("test_id",t).single();let f;if(l&&l.code==="PGRST116"){const{data:S,error:T}=await D.from("user_tests").insert({user_id:k,test_id:t,...a}).select().single();if(T)throw T;f=S}else{const{data:S,error:T}=await D.from("user_tests").update(a).eq("user_id",k).eq("test_id",t).select().single();if(T)throw T;f=S}return f}catch(b){return g.value=b.message,null}finally{p.value=!1}}}}),Te={getTests:p=>F().getTests(p),getTestById:p=>F().getTestById(p),getUserTestStatus:p=>F().getUserTestStatus(p),updateUserTestStatus:(p,g)=>F().updateUserTestStatus(p,g)},be={class:"personal-test-history"},ke={class:"feedback-header"},Se={class:"feedback-item"},xe={class:"feedback-item"},ze={class:"feedback-content"},Ve=Z({__name:"PersonalTestHistory",props:{testId:{}},setup(p){const g=p,U=y(!1),I=y([]),R=y(!1),x=y(null),t=async()=>{U.value=!0;try{const{data:r}=await oe.getUserTestResults({page:1,pageSize:100});I.value=r.filter(l=>l.test_id===g.testId).sort((l,f)=>new Date(f.submitted_at).getTime()-new Date(l.submitted_at).getTime())}catch(r){console.error("加载测试历史记录失败:",r),P.error("加载测试历史记录失败，请稍后重试")}finally{U.value=!1}};_e(()=>g.testId,()=>{t()});const a=r=>r?new Date(r).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",d=(r,l,f)=>r===null?"info":l=="case"||l=="comprehensive"?f?"success":"warning":r>=80?"success":r>=60?"warning":"danger",b=r=>{const{score:l,type:f,is_graded:S,grade_level:T}=r;return S?f==="case"?T?`评级: ${T}`:`${l}分`:f==="comprehensive"?`${l}分`:`${l}分`:"待批改"},z=r=>{switch(r){case"A":return"success";case"B":return"success";case"C":return"warning";case"D":return"danger";default:return"info"}},k=r=>{x.value=r,R.value=!0};return ee(()=>{t()}),(r,l)=>{const f=m("el-table-column"),S=m("el-tag"),T=m("el-button"),q=m("el-empty"),G=m("el-table"),B=m("el-divider"),A=m("el-dialog"),$=se("loading");return v(),C("div",be,[te((v(),L(G,{data:I.value},{default:i(()=>[o(f,{prop:"test_title",label:"测试标题"}),o(f,{prop:"score",label:"分数/评级",width:"120"},{default:i(_=>[o(S,{size:"large",style:{"font-size":"14px"},type:d(_.row.score,_.row.type,_.row.is_graded)},{default:i(()=>[h(w(b(_.row)),1)]),_:2},1032,["type"])]),_:1}),o(f,{prop:"submitted_at",label:"提交时间",width:"180"},{default:i(_=>[h(w(a(_.row.submitted_at)),1)]),_:1}),o(f,{label:"批改状态",width:"100"},{default:i(_=>[o(S,{style:{"font-size":"14px"},size:"large",type:_.row.is_graded?"success":"warning"},{default:i(()=>[h(w(_.row.is_graded?"已批改":"待批改"),1)]),_:2},1032,["type"])]),_:1}),o(f,{label:"操作",width:"100"},{default:i(_=>[_.row.is_graded&&_.row.type==="case"?(v(),L(T,{key:0,size:"small",type:"primary",onClick:N=>k(_.row)},{default:i(()=>l[1]||(l[1]=[h("查看反馈")])),_:2},1032,["onClick"])):H("",!0)]),_:1}),o(q,null,{description:i(()=>l[2]||(l[2]=[h(" 暂无测试记录 ")])),_:1})]),_:1},8,["data"])),[[$,U.value]]),o(A,{modelValue:R.value,"onUpdate:modelValue":l[0]||(l[0]=_=>R.value=_),title:"评价反馈",width:"600px"},{default:i(()=>[x.value?(v(),C(ae,{key:0},[c("div",ke,[c("div",Se,[l[3]||(l[3]=c("span",{class:"label"},"评级:",-1)),o(S,{size:"large",style:{"font-size":"16px"},type:z(x.value.grade_level)},{default:i(()=>[h(w(x.value.grade_level||"-"),1)]),_:1},8,["type"])]),c("div",xe,[l[4]||(l[4]=c("span",{class:"label"},"提交时间:",-1)),c("span",null,w(a(x.value.submitted_at)),1)])]),o(B,{"content-position":"left"},{default:i(()=>l[5]||(l[5]=[h("评价内容")])),_:1}),c("div",ze,w(x.value.feedback_text||"老师暂未留下具体评价。"),1)],64)):H("",!0)]),_:1},8,["modelValue"])])}}}),Ce=le(Ve,[["__scopeId","data-v-17136486"]]),Ue={class:"test-list-container"},qe={class:"test-list"},$e={key:1,class:"test-grid"},De={class:"test-card-content"},Ie={class:"test-type-tag flex"},Re={class:"test-title"},Be={class:"test-info"},Ee={class:"info-item"},Le={class:"info-item"},Ne={class:"info-item"},Pe={class:"test-status"},He={key:0,class:"status-tag"},Me={class:"score-text"},Fe={key:1,class:"status-tag"},Ge={key:2,class:"status-tag"},Ae={class:"test-actions"},Qe={key:2,class:"pagination"},je=Z({__name:"TestListView",setup(p){const g=he(),U=y(!0),I=y([]),R=y({}),x=y(""),t=y(""),a=y(!1),d=fe({page:1,pageSize:10,total:0}),b=e=>{d.page=e.page,d.pageSize=e.pageSize,S()},z=y([]),k=async()=>{try{const{data:e}=await oe.getUserTestResults({page:1,pageSize:100}),s={};e.forEach(u=>{u.test_id&&(!s[u.test_id]||new Date(u.submitted_at)>new Date(s[u.test_id].submitted_at))&&(s[u.test_id]=u)}),z.value=e,R.value=s}catch(e){console.error("加载测试结果失败:",e),P.error("加载测试结果失败，请稍后重试")}};ee(async()=>{await Promise.all([S(),k()])});const r=ge(),l=y(r.query.platform||"google"),f=y(r.query.chapter||"base"),S=async()=>{U.value=!0;try{const{data:e,total:s}=await Te.getTests({platform:l.value,chapter:f.value});d.total=s;let u=[...e];x.value&&(u=u.filter(V=>V.title.toLowerCase().includes(x.value.toLowerCase()))),t.value&&(u=u.filter(V=>V.type===t.value)),I.value=u,d.total=u.length}catch(e){console.error("加载测验失败:",e),P.error("加载测验失败，请稍后重试")}finally{U.value=!1}},T=()=>{d.page=1,S()},q=ve(()=>e=>R.value[e]),G=e=>{var V;if(e.type==="case"&&N(e.id)>=3){P.warning("您已达到最大尝试次数(3次)，不能再次作答");return}const s=e.type;let u="";switch(s){case"case":u="case-study";break;case"select":u="multiple-choice";break;case"comprehensive":u="comprehensive-test";break;default:u="multiple-choice"}((V=q.value(e.id))==null?void 0:V.completion_status)==="completed"?we.confirm("您已完成此测验，确定要重新开始吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{g.push({name:u,query:{testId:e.id,testName:$(e.platform||"")+"-"+$(e.chapter||"")+"-"+e.title,platform:e.platform,chapter:e.chapter,type:e.type}})}).catch(()=>{P.info("已取消重新开始")}):g.push({name:u,query:{testId:e.id,testName:$(e.platform||"")+"-"+$(e.chapter||"")+"-"+e.title,platform:e.platform,chapter:e.chapter,type:e.type}})},B=y(null),A=e=>{B.value=e,a.value=!0},$=e=>{switch(e){case"select":return"选择题";case"case":return"案例分析";case"comprehensive":return"综合测验";case"google":return"Google";case"facebook":return"FaceBook";case"base":return"基础";case"middle":return"中级";case"advanced":return"高级";default:return"未知类型"}},_=e=>{switch(e){case"select":return"primary";case"case":return"success";case"comprehensive":return"warning";case"google":return"danger";case"facebook":return"primary";case"base":return"primary";case"middle":return"success";case"advanced":return"warning";default:return"info"}},N=e=>{let s=0;return Object.values(z.value).forEach(u=>{u.test_id===e&&s++}),s},re=(e,s)=>{if(N((s==null?void 0:s.id)||"")>=3)return"尝试次数已用完";switch(e){case"completed":return"重新测试";case"in_progress":return"继续测试";default:return"开始测试"}},ne=e=>e?e.is_graded?e.type==="case"&&e.grade_level?`评级: ${e.grade_level}`:`${e.score}分`:"待批改":"0分";return(e,s)=>{var J;const u=m("el-input"),V=m("el-option"),j=m("el-select"),Q=m("el-button"),ie=m("el-space"),O=m("el-card"),ue=m("el-empty"),E=m("el-tag"),ce=m("el-dialog"),de=se("loading");return v(),C("div",Ue,[o(O,{class:"testing-search",style:{"margin-bottom":"20px"}},{default:i(()=>[o(ie,{alignment:"start",size:30},{default:i(()=>[o(u,{size:"large",style:{width:"240px"},modelValue:x.value,"onUpdate:modelValue":s[0]||(s[0]=n=>x.value=n),placeholder:"搜索测验名称",class:"search-input",clearable:"",onInput:T},null,8,["modelValue"]),o(j,{size:"large",style:{width:"240px"},modelValue:t.value,"onUpdate:modelValue":s[1]||(s[1]=n=>t.value=n),placeholder:"测验类型",onChange:T,class:"filter-select"},{default:i(()=>[o(V,{label:"全部类型",value:""}),o(V,{label:"选择题",value:"select"}),o(V,{label:"案例分析",value:"case"}),o(V,{label:"综合测验",value:"comprehensive"})]),_:1},8,["modelValue"]),o(Q,{type:"primary",size:"large",onClick:T},{default:i(()=>s[3]||(s[3]=[h("搜索")])),_:1})]),_:1})]),_:1}),te((v(),C("div",qe,[I.value.length===0&&!U.value?(v(),L(ue,{key:0,description:"暂无测验内容"})):(v(),C("div",$e,[(v(!0),C(ae,null,ye(I.value,n=>(v(),L(O,{key:n.id,class:"test-card",shadow:"hover"},{default:i(()=>{var K,W,X,Y;return[c("div",De,[c("div",Ie,[o(E,{type:_(n.type)},{default:i(()=>[h(w($(n.type)),1)]),_:2},1032,["type"]),o(E,{type:_(n.platform||"")},{default:i(()=>[h(w($(n.platform||"")),1)]),_:2},1032,["type"]),o(E,{type:_(n.chapter||"")},{default:i(()=>[h(w($(n.chapter||"")),1)]),_:2},1032,["type"])]),c("h3",Re,w(n.title),1),c("div",Be,[c("div",Ee,[s[4]||(s[4]=c("i",{class:"el-icon-question"},null,-1)),c("span",null,w(n.question_count||0)+"道题目",1)]),c("div",Le,[s[5]||(s[5]=c("i",{class:"el-icon-medal"},null,-1)),c("span",null,w(n.score_weight||100)+"分值",1)]),c("div",Ne,[s[6]||(s[6]=c("i",{class:"el-icon-refresh"},null,-1)),c("span",null,"尝试次数: "+w(N(n.id))+"/3",1)])]),c("div",Pe,[((K=q.value(n.id))==null?void 0:K.completion_status)==="completed"?(v(),C("div",He,[o(E,{type:"success"},{default:i(()=>s[7]||(s[7]=[h("已完成")])),_:1}),c("span",Me,"最新分数: "+w(ne(q.value(n.id))),1)])):((W=q.value(n.id))==null?void 0:W.completion_status)==="in_progress"?(v(),C("div",Fe,[o(E,{type:"warning"},{default:i(()=>s[8]||(s[8]=[h("进行中")])),_:1})])):(v(),C("div",Ge,[o(E,{type:"info"},{default:i(()=>s[9]||(s[9]=[h("未开始")])),_:1})]))]),c("div",Ae,[o(Q,{type:"primary",disabled:((X=q.value(n.id))==null?void 0:X.completion_status)==="in_progress"||N(n.id)>=3,onClick:M=>G(n)},{default:i(()=>{var M;return[h(w(re((M=q.value(n.id))==null?void 0:M.completion_status,n)),1)]}),_:2},1032,["disabled","onClick"]),((Y=q.value(n.id))==null?void 0:Y.completion_status)==="completed"?(v(),L(Q,{key:0,type:"info",plain:"",onClick:M=>A(n)},{default:i(()=>s[10]||(s[10]=[h(" 查看历史 ")])),_:2},1032,["onClick"])):H("",!0)])])]}),_:2},1024))),128))])),d.total>0?(v(),C("div",Qe,[o(me,{pagination:d,onUpdate:b},null,8,["pagination"])])):H("",!0)])),[[de,U.value]]),o(ce,{modelValue:a.value,"onUpdate:modelValue":s[2]||(s[2]=n=>a.value=n),title:((J=B.value)==null?void 0:J.title)+" - 测试历史记录",width:"800px"},{default:i(()=>[B.value?(v(),L(Ce,{key:0,testId:B.value.id},null,8,["testId"])):H("",!0)]),_:1},8,["modelValue","title"])])}}}),Ke=le(je,[["__scopeId","data-v-2a3f887c"]]);export{Ke as default};
