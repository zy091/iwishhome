import{d as T,r as b,o as G,M as h,y as N,O as H,c as p,b as u,w as r,l as R,a as _,q as B,m as E,F as C,f as v,z as J,u as F,s as K,j as i,t as U,e as P,_ as Q}from"./index-CF7jzyo9.js";import{t as W}from"./testResultService-Dy4JAC1K.js";const X={class:"reading-lable",style:{"margin-bottom":"20px"}},I=3,Y=T({__name:"DynamicForm",props:{questions:{},testId:{},testName:{},type:{}},emits:["submitAnswers","limitReached"],setup(z,{emit:M}){const n=z,$=M,s=b({}),O=b({}),V=b(!1),D=b(!1),L=async()=>{var d;try{const c=(d=F().user)==null?void 0:d.user_id;if(!c)throw new Error("用户未登录");const{data:w,error:o,count:f}=await K.from("test_results").select("*",{count:"exact"}).eq("user_id",c).eq("test_id",n.testId);if(o)throw o;return{count:f||0,hasReachedLimit:(f||0)>=I}}catch(l){return console.error("检查尝试次数失败:",l),{count:0,hasReachedLimit:!1}}},j=async()=>{var w;if(!n.questions.every(o=>o.question_type=="select"?s.value[o.id]!==void 0:s.value[o.id]!==void 0&&s.value[o.id].trim()!=="")){h.error("请将所有题目作答完毕后再提交");return}const{count:l,hasReachedLimit:c}=await L();if(c){h.error(`您已达到最大尝试次数(${I}次)，不能再次作答`);return}D.value=!0;try{const f=(w=F().user)==null?void 0:w.user_id;if(!f)throw new Error("用户未登录");let m=0;const g=[];for(const e of n.questions){const y=e.question_type==="select"?s.value[e.id].split(".")[1]:s.value[e.id],t=e.question_type==="select"?s.value[e.id].split("-")[0]:`第${n.questions.indexOf(e)+1}题`;e.question_type==="reading"?(m+=0,g.push({questionIndex:t,questionId:e.id,userAnswer:y,correctAnswer:"待批改"})):y===e.correct_answer?m+=10:g.push({questionIndex:t,questionId:e.id,userAnswer:y,correctAnswer:e.correct_answer})}const x={user_id:f,test_id:n.testId,test_title:n.testName,score:m,is_passed:m>=60,submitted_at:new Date().toISOString(),completion_status:"completed",is_graded:n.type==="select",type:n.type},k=n.questions.map((e,y)=>({test_result_id:"",question_id:String(e.id)||"",question_type:e.question_type||"",question_text:e.text,answer:s.value[e.id]||"",is_correct:e.question_type==="reading"?null:s.value[e.id].split(".")[1]===e.correct_answer,score:e.question_type=="select"&&s.value[e.id].split(".")[1]===e.correct_answer?n.type==="select"?10:5:0,question_order:y+1}));await W.submitTestResult(x,k),n.type==="select"?(h.success("测试答案提交成功！"),V.value=!0):(h.success("答案已提交，请等待管理员批改！"),V.value=!0),$("submitAnswers",{answers:s.value,score:m,incorrectAnswers:g})}catch(o){console.error("提交测试结果失败:",o),h.error("提交测试结果失败，请稍后重试")}finally{D.value=!1}},q=()=>{V.value=!1,s.value={}};return G(async()=>{const{hasReachedLimit:d}=await L();d&&(h.warning(`您已达到最大尝试次数(${I}次)，不能再次作答`),$("limitReached"))}),(d,l)=>{const c=u("el-radio"),w=u("el-radio-group"),o=u("el-input"),f=u("el-text"),m=u("el-form-item"),g=u("el-button"),x=u("el-tooltip"),k=u("el-empty"),e=u("el-form"),y=H("loading");return N((i(),p(e,{"element-loading-text":"Loading...",model:O.value,"label-width":"auto",style:{width:"100%","max-width":"800px"}},{default:r(()=>[(i(!0),R(C,null,E(d.questions,(t,A)=>(i(),p(m,{key:t.id,label:t.question_type==="reading"?"":`${A+1}. ${t.text}`,"label-position":"left",style:{"flex-direction":"column"}},{default:r(()=>[t.question_type==="select"?(i(),p(w,{key:0,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a},{default:r(()=>[l[0]||(l[0]=v(" //在option前面加个A. B. C. D. E. ")),(i(!0),R(C,null,E(t.options,(a,S)=>(i(),p(c,{key:S,value:`第${A+1}题-${String.fromCharCode(65+S)}.${a}`},{default:r(()=>[v(U(`${String.fromCharCode(65+S)}. ${a}`),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.question_type==="judge"?(i(),p(w,{key:1,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a},{default:r(()=>[_(c,{value:"是"},{default:r(()=>l[1]||(l[1]=[v("是")])),_:1}),_(c,{value:"否"},{default:r(()=>l[2]||(l[2]=[v("否")])),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.question_type==="fill"?(i(),p(o,{key:2,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a,placeholder:"请填写答案"},null,8,["modelValue","onUpdate:modelValue"])):t.question_type==="question"?(i(),p(o,{key:3,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a,type:"textarea",placeholder:"请简要描述"},null,8,["modelValue","onUpdate:modelValue"])):t.question_type==="reading"?(i(),R(C,{key:4},[P("div",X,[_(f,{class:"mx-1",size:"large",style:{"line-height":"1"}},{default:r(()=>[v(U(A+1)+". "+U(t.text),1)]),_:2},1024)]),_(o,{modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a,type:"textarea",placeholder:"请阅读并回答",autosize:{minRows:6,maxRows:15}},null,8,["modelValue","onUpdate:modelValue"])],64)):B("",!0)]),_:2},1032,["label"]))),128)),_(m,{"label-position":"left"},{default:r(()=>[_(g,{style:{"margin-left":"0","margin-right":"50px"},type:"primary",onClick:j,disabled:V.value},{default:r(()=>l[3]||(l[3]=[v("提交答案")])),_:1},8,["disabled"]),_(x,{class:"box-item",effect:"dark",content:"点击后将清空所有答案",placement:"top-start"},{default:r(()=>[N(_(g,{type:"warning",plain:"",onClick:q},{default:r(()=>l[4]||(l[4]=[v("重新作答")])),_:1},512),[[J,V.value]])]),_:1})]),_:1}),d.questions.length?B("",!0):(i(),p(k,{key:0,description:"暂无数据"}))]),_:1},8,["model"])),[[y,!d.questions.length]])}}}),te=Q(Y,[["__scopeId","data-v-5e6b5635"]]);export{te as D};
