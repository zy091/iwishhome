import{d as K,k as Q,r as k,J as R,I as X,l as x,a as r,b as i,w as n,c as U,q as C,F as N,m as S,e as P,t as q,f as F,M as f,s as d,j as p,_ as Y}from"./index-w0Vcq8R-.js";const Z={class:"upload"},ee={key:0},le=K({__name:"UploadMaterials",props:{visible:{type:Boolean,default:!1}},emits:["update:visible"],setup(L,{emit:j}){const D=L,M=Q({get:()=>D.visible,set:t=>z("update:visible",t)}),z=j,W=k([{value:"image",label:"图片"},{value:"video",label:"视频"},{value:"ppt",label:"PPT"},{value:"pdf",label:"PDF"},{value:"link",label:"链接"},{value:"txt",label:"文本"},{value:"word",label:"Word"},{value:"excel",label:"Excel"},{value:"zip",label:"压缩包"}]),I=k([{value:"google",label:"Google"},{value:"facebook",label:"Facebook"},{value:"microsoft",label:"Microsoft"},{value:"meta",label:"Meta"},{value:"other",label:"Other"}]),B=k([]),O=async()=>{try{const{data:t,error:e}=await d.from("ad_platforms").select("*");if(e)throw e;B.value=await Promise.all(t.map(async s=>{const{data:o,error:u}=await d.from("ad_categories").select("*").eq("platform_id",s.id);if(u)throw u;const v=await Promise.all(o.map(async c=>{const{data:g,error:b}=await d.from("ad_subcategories").select("*").eq("category_id",c.id);if(b)throw b;const V=await Promise.all(g.map(async y=>{const{data:m,error:w}=await d.from("ad_topics").select("*").eq("subcategory_id",y.id);if(w)throw w;return{...y,children:m}}));return{...c,children:V}}));return{id:s.id,name:s.name,children:v}}))}catch(t){f.error("加载文件夹结构失败："+t.message)}finally{}},l=R({title:"",type:"",platform:"",chapter:"",folderPath:[],linkUrl:""});X(()=>l.platform,t=>{O()});const T=()=>{l.title="",l.type="",l.platform="",l.chapter="",l.folderPath=[],l.linkUrl="",$.value=[],_.value=null},$=k([]),_=k(null),E=k(!1),A=t=>{const e=["image/png","image/jpeg","image/webp","video/mp4","application/pdf","application/vnd.ms-powerpoint","text/plain","text/csv","text/html","text/xml","application/json","application/xml","application/octet-stream","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],s=t.raw&&e.includes(t.raw.type),o=t.raw&&t.raw.size/1024/1024<100;if(!s)return f.error("文件类型不支持！"),!1;if(!o)return f.error("文件大小超过 10MB 限制！"),!1;_.value=t.raw,console.log(_.value)},G=async()=>{var t;if(l.type==="link"&&!l.linkUrl){f.warning("请输入链接地址");return}if(l.type!=="link"&&!_.value){f.warning("请选择文件");return}E.value=!0;try{await J(l.type==="link"?null:_.value,{title:l.title,platform:l.platform,type:l.type},l.type==="link"?l.title:((t=_.value)==null?void 0:t.name)||"")&&(f.success("上传成功！"),T())}catch(e){f.error(`上传失败: ${e.message}`)}finally{E.value=!1}},J=async(t,e,s)=>{try{let o="";if(e.type==="link")o=l.linkUrl;else{if(!t)throw new Error("未选择文件");const b=t.name.split(".").pop(),V=`${Date.now()}-${Math.random().toString(36).slice(2)}.${b}`,{data:y,error:m}=await d.storage.from("materials").upload(`documents/${V}`,t);if(m)throw m;const{data:w}=d.storage.from("materials").getPublicUrl(y.path);o=w.publicUrl}const u=["platform_id","category_id","subcategory_id","topic_id"],{data:v,error:c}=await d.from("study_materials").insert({...e,[u[l.folderPath.length-1]]:l.folderPath[l.folderPath.length-1]}).select("id").single();if(c)throw c;const{error:g}=await d.from("material_contents").insert({material_id:v.id,title:e.title,content:o,content_type:e.type});if(g)throw g;return console.log("文件上传并关联成功！"),o}catch(o){return console.error("操作失败:",o.message),null}};return(t,e)=>{const s=i("el-input"),o=i("el-form-item"),u=i("el-option"),v=i("el-select"),c=i("el-empty"),g=i("el-cascader"),b=i("upload-filled"),V=i("el-icon"),y=i("el-upload"),m=i("el-button"),w=i("el-form"),H=i("el-dialog");return p(),x("div",Z,[r(H,{onClose:e[5]||(e[5]=a=>z("update:visible",!1)),modelValue:M.value,"onUpdate:modelValue":e[6]||(e[6]=a=>M.value=a),title:"资料上传",width:"50%"},{default:n(()=>[r(w,{model:l,"label-width":"auto",style:{"max-width":"600px",margin:"50px 30px"}},{default:n(()=>[r(o,{label:"文件标题"},{default:n(()=>[r(s,{size:"large",modelValue:l.title,"onUpdate:modelValue":e[0]||(e[0]=a=>l.title=a),placeholder:"输入文件标题"},null,8,["modelValue"])]),_:1}),r(o,{label:"文件类型"},{default:n(()=>[r(v,{size:"large",modelValue:l.type,"onUpdate:modelValue":e[1]||(e[1]=a=>l.type=a),placeholder:"选择文件类型"},{default:n(()=>[(p(!0),x(N,null,S(W.value,(a,h)=>(p(),U(u,{label:a.label,value:a.value,key:h},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(o,{label:"文件所属平台"},{default:n(()=>[r(v,{size:"large",modelValue:l.platform,"onUpdate:modelValue":e[2]||(e[2]=a=>l.platform=a),placeholder:"选择平台"},{default:n(()=>[(p(!0),x(N,null,S(I.value,(a,h)=>(p(),U(u,{label:a.label,value:a.value,key:h},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(o,{label:"选择文件夹"},{default:n(()=>[r(g,{size:"large",modelValue:l.folderPath,"onUpdate:modelValue":e[3]||(e[3]=a=>l.folderPath=a),options:B.value,props:{checkStrictly:!0,emitPath:!0,value:"id",label:"name",children:"children"},clearable:"",placeholder:"请选择资料存放位置",style:{width:"100%"}},{default:n(({node:a,data:h})=>[P("span",null,q(h.name),1),a.isLeaf?C("",!0):(p(),x("span",ee," ("+q(h.children.length)+") ",1))]),empty:n(()=>[r(c,{description:"暂无数据，先选择平台"})]),_:1},8,["modelValue","options"])]),_:1}),l.type==="link"?(p(),U(o,{key:0,label:"链接地址"},{default:n(()=>[r(s,{size:"large",modelValue:l.linkUrl,"onUpdate:modelValue":e[4]||(e[4]=a=>l.linkUrl=a),placeholder:"请输入链接地址"},null,8,["modelValue"])]),_:1})):C("",!0),l.type!=="link"?(p(),U(o,{key:1,label:"文件上传"},{default:n(()=>[r(y,{class:"upload-box","auto-upload":!1,"on-change":A,"file-list":$.value,limit:1,drag:"",action:"https://run.mocky.io/v3/9d059bf9-4660-45f2-925d-ce80ad6c4d15",multiple:""},{tip:n(()=>e[7]||(e[7]=[P("div",{class:"el-upload__tip"},"支持所有文本型、图片、视频等文件，且不超过 100MB",-1)])),default:n(()=>[r(V,{class:"el-icon--upload"},{default:n(()=>[r(b)]),_:1}),e[8]||(e[8]=P("div",{class:"el-upload__text"},[F(" 拖拽文件或"),P("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})):C("",!0),r(o,null,{default:n(()=>[r(m,{type:"primary",loading:E.value,onClick:G},{default:n(()=>e[9]||(e[9]=[F("开始上传")])),_:1},8,["loading"]),r(m,{onClick:T},{default:n(()=>e[10]||(e[10]=[F("清空内容")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ae=Y(le,[["__scopeId","data-v-a6ece109"]]);export{ae as U};
