import{E as v,t as he,c as oe}from"./elementPlus-7n3J9xVR.js";import{B as $e,s as g,b as Fe}from"./index-BKDCXq68.js";import{x as Ae,X as A,r as n,c as L,j as Le,w as De,y,P as t,A as f,H as a,ag as u,L as r,I as se,aq as Me,G as D,M as G,O as Be,a6 as Ee,u as Ne,J as H,z as d}from"./vendor-kUynFKsh.js";import"./supabase-Dk90AXsH.js";const je={class:"layout"},Pe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},qe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Ie={key:1},Re={class:"el-upload__tip"},ze={key:0,style:{"margin-bottom":"5px"}},Se={class:"attachment-preview"},Oe=["src"],Qe=["src"],Ge=["src"],He={key:3,class:"attachment-download"},Je={class:"fullscreen-preview"},Te=["src"],We=["src"],Xe=Ae({__name:"AdminAdsManagement",setup(Ke){const re=A([{name:"数据管理",path:""},{name:"广告内容管理",path:"/system/admin-ads-management"}]),P=n("formats"),k=A({formats:!1,courses:!1}),w=A({format:!1,course:!1}),_=A({formatVisible:!1,courseVisible:!1}),M=A({format:!1,course:!1}),B=n([]),V=n({}),h=n(""),ne=L(()=>h.value?B.value.filter(l=>l.title&&l.title.toLowerCase().includes(h.value.toLowerCase())||l.adsform&&l.adsform.toLowerCase().includes(h.value.toLowerCase())):B.value),q=n([]),m=n({}),$=n(""),ue=L(()=>$.value?q.value.filter(l=>l.label&&l.label.toLowerCase().includes($.value.toLowerCase())||l.name&&l.name.toLowerCase().includes($.value.toLowerCase())):q.value),I=n(),R=n([]),x=n(null),J=n(!1),de=n(0),E=n(!1),z=n(!1),c=n(""),T=n(""),S=l=>{var e;return l&&((e=l.split(".").pop())==null?void 0:e.toLowerCase())||""},O=L(()=>{const l=S(c.value);return["jpg","jpeg","png","gif","bmp","webp"].includes(l)}),Q=L(()=>S(c.value)==="pdf"),W=L(()=>{const l=S(c.value);return["doc","docx"].includes(l)}),ie=l=>{l.document_url&&(c.value=l.document_url,W.value&&(T.value=`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(c.value)}`),E.value=!0)},me=()=>{c.value&&window.open(c.value,"_blank")},X=()=>{z.value=!0},fe=l=>{if(!l)return"";try{const s=new URL(l).pathname.split("/");return decodeURIComponent(s[s.length-1])}catch{return l}},N=async()=>{k.formats=!0;try{const{data:l,error:e}=await g.from("ad_formats").select("*").order("created_at",{ascending:!1});if(e)throw e;B.value=l}catch(l){v.error("获取广告形式失败: "+l.message)}finally{k.formats=!1}},F=async()=>{k.courses=!0;try{const{data:l,error:e}=await g.from("ad_courses").select("*, ad_formats(title)").order("created_at",{ascending:!1});if(e)throw e;q.value=l}catch(l){v.error("获取广告课程失败: "+l.message)}finally{k.courses=!1}},K=(l=null)=>{M.format=!!l,V.value=l?{...l}:{title:"",adsform:""},_.formatVisible=!0},ce=async()=>{w.format=!0;try{const{created_at:l,...e}=V.value,{error:s}=await g.from("ad_formats").upsert(e);if(s)throw s;v.success("广告形式保存成功"),_.formatVisible=!1,N()}catch(l){v.error("保存失败: "+l.message)}finally{w.format=!1}},pe=async l=>{try{await oe.confirm(`确定要删除广告形式 "${l.title}" 吗？其下的所有课程也将被删除。`,"警告",{type:"warning"});const{error:e}=await g.from("ad_formats").delete().eq("id",l.id);if(e)throw e;v.success("删除成功"),N(),F()}catch(e){e!=="cancel"&&v.error("删除失败: "+e.message)}},Y=(l=null)=>{M.course=!!l,m.value=l?{...l}:{label:"",name:"",ad_format_id:null,document_url:null},x.value=null,R.value=[],_.courseVisible=!0},ve=l=>{l.raw&&(x.value=l.raw)},_e=l=>{I.value.clearFiles();const e=l[0];I.value.handleStart(e)},be=async()=>{if(!x.value)return null;J.value=!0,de.value=0;try{const l=x.value.name.split(".").pop(),s=`word-files/${`${Date.now()}-${Math.random().toString(36).substring(2)}.${l}`}`,{data:p,error:b}=await g.storage.from("documents").upload(s,x.value,{cacheControl:"3600",upsert:!1});if(b)throw b;const{data:i}=g.storage.from("documents").getPublicUrl(p.path);return i.publicUrl}catch(l){return v.error("文件上传失败: "+l.message),null}finally{J.value=!1}},ye=async()=>{w.course=!0;try{let l=m.value.document_url;if(x.value){const i=await be();if(i)l=i;else{w.course=!1;return}}const{created_at:e,ad_formats:s,...p}=m.value;p.document_url=l;const{error:b}=await g.from("ad_courses").upsert(p);if(b)throw b;v.success("课程保存成功"),_.courseVisible=!1,F()}catch(l){v.error("保存失败: "+l.message)}finally{w.course=!1}},ge=async l=>{try{await oe.confirm(`确定要删除课程 "${l.label}" 吗？`,"警告",{type:"warning"});const{error:e}=await g.from("ad_courses").delete().eq("id",l.id);if(e)throw e;v.success("删除成功"),F()}catch(e){e!=="cancel"&&v.error("删除失败: "+e.message)}};return Le(()=>{N(),F()}),De(P,l=>{l==="formats"?N():l==="courses"&&F()}),(l,e)=>{const s=u("el-button"),p=u("el-input"),b=u("el-card"),i=u("el-table-column"),Z=u("el-button-group"),ee=u("el-table"),le=u("el-tab-pane"),we=u("el-tabs"),U=u("el-form-item"),te=u("el-form"),j=u("el-dialog"),Ve=u("el-option"),Ce=u("el-select"),ke=u("el-icon"),xe=u("el-link"),Ue=u("el-upload"),ae=Me("loading");return d(),y("div",je,[t($e,{breadcrumb:re},null,8,["breadcrumb"]),e[37]||(e[37]=f("div",{class:"layout-title"},[f("h1",{class:"title"},"广告内容管理")],-1)),t(we,{modelValue:P.value,"onUpdate:modelValue":e[4]||(e[4]=o=>P.value=o),class:"tabs-container"},{default:a(()=>[t(le,{label:"广告形式管理",name:"formats"},{default:a(()=>[t(b,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[f("div",Pe,[t(s,{type:"primary",size:"large",onClick:e[0]||(e[0]=o=>K())},{default:a(()=>e[17]||(e[17]=[r("新建广告形式")])),_:1}),t(p,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=o=>h.value=o),placeholder:"按标题或标识符搜索",style:{width:"300px"},clearable:""},null,8,["modelValue"])])]),_:1}),t(b,null,{header:a(()=>e[18]||(e[18]=[f("div",{class:"card-header"},"广告形式列表",-1)])),default:a(()=>[se((d(),D(ee,{data:ne.value},{default:a(()=>[t(i,{prop:"title",label:"标题"}),t(i,{prop:"adsform",label:"标识符 (adsform)"}),t(i,{prop:"created_at",label:"创建时间"},{default:a(({row:o})=>[r(G(new Date(o.created_at).toLocaleString()),1)]),_:1}),t(i,{label:"操作",width:"180",fixed:"right"},{default:a(({row:o})=>[t(Z,null,{default:a(()=>[t(s,{type:"primary",onClick:C=>K(o)},{default:a(()=>e[19]||(e[19]=[r("编辑")])),_:2},1032,["onClick"]),t(s,{type:"danger",onClick:C=>pe(o)},{default:a(()=>e[20]||(e[20]=[r("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ae,k.formats]])]),_:1})]),_:1}),t(le,{label:"广告课程管理",name:"courses"},{default:a(()=>[t(b,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[f("div",qe,[t(s,{type:"primary",size:"large",onClick:e[2]||(e[2]=o=>Y())},{default:a(()=>e[21]||(e[21]=[r("新建课程")])),_:1}),t(p,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=o=>$.value=o),placeholder:"按课程标题或标识搜索",style:{width:"300px"},clearable:""},null,8,["modelValue"])])]),_:1}),t(b,null,{header:a(()=>e[22]||(e[22]=[f("div",{class:"card-header"},"广告课程列表",-1)])),default:a(()=>[se((d(),D(ee,{data:ue.value},{default:a(()=>[t(i,{prop:"label",label:"课程标题 (label)"}),t(i,{prop:"name",label:"课程标识 (name)"}),t(i,{label:"所属广告形式"},{default:a(({row:o})=>{var C;return[r(G(((C=o.ad_formats)==null?void 0:C.title)||"N/A"),1)]}),_:1}),t(i,{label:"文件"},{default:a(({row:o})=>[o.document_url?(d(),D(s,{key:0,type:"primary",size:"small",onClick:C=>ie(o)},{default:a(()=>e[23]||(e[23]=[r("预览")])),_:2},1032,["onClick"])):(d(),y("span",Ie,"未上传"))]),_:1}),t(i,{label:"操作",width:"180",fixed:"right"},{default:a(({row:o})=>[t(Z,null,{default:a(()=>[t(s,{type:"primary",onClick:C=>Y(o)},{default:a(()=>e[24]||(e[24]=[r("编辑")])),_:2},1032,["onClick"]),t(s,{type:"danger",onClick:C=>ge(o)},{default:a(()=>e[25]||(e[25]=[r("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ae,k.courses]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(j,{modelValue:_.formatVisible,"onUpdate:modelValue":e[8]||(e[8]=o=>_.formatVisible=o),title:M.format?"编辑广告形式":"新建广告形式",width:"500px"},{footer:a(()=>[t(s,{onClick:e[7]||(e[7]=o=>_.formatVisible=!1)},{default:a(()=>e[26]||(e[26]=[r("取消")])),_:1}),t(s,{type:"primary",onClick:ce,loading:w.format},{default:a(()=>e[27]||(e[27]=[r("保存")])),_:1},8,["loading"])]),default:a(()=>[t(te,{model:V.value,"label-width":"120px"},{default:a(()=>[t(U,{label:"标题"},{default:a(()=>[t(p,{modelValue:V.value.title,"onUpdate:modelValue":e[5]||(e[5]=o=>V.value.title=o),placeholder:"例如：搜索广告"},null,8,["modelValue"])]),_:1}),t(U,{label:"标识符"},{default:a(()=>[t(p,{modelValue:V.value.adsform,"onUpdate:modelValue":e[6]||(e[6]=o=>V.value.adsform=o),placeholder:"例如：google-search-ads"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(j,{modelValue:_.courseVisible,"onUpdate:modelValue":e[13]||(e[13]=o=>_.courseVisible=o),title:M.course?"编辑课程":"新建课程",width:"500px"},{footer:a(()=>[t(s,{onClick:e[12]||(e[12]=o=>_.courseVisible=!1)},{default:a(()=>e[31]||(e[31]=[r("取消")])),_:1}),t(s,{type:"primary",onClick:ye,loading:w.course},{default:a(()=>e[32]||(e[32]=[r("保存")])),_:1},8,["loading"])]),default:a(()=>[t(te,{model:m.value,"label-width":"120px"},{default:a(()=>[t(U,{label:"课程标题"},{default:a(()=>[t(p,{modelValue:m.value.label,"onUpdate:modelValue":e[9]||(e[9]=o=>m.value.label=o),placeholder:"例如：搜索广告原理"},null,8,["modelValue"])]),_:1}),t(U,{label:"课程标识"},{default:a(()=>[t(p,{modelValue:m.value.name,"onUpdate:modelValue":e[10]||(e[10]=o=>m.value.name=o),placeholder:"例如：principle"},null,8,["modelValue"])]),_:1}),t(U,{label:"所属广告形式"},{default:a(()=>[t(Ce,{modelValue:m.value.ad_format_id,"onUpdate:modelValue":e[11]||(e[11]=o=>m.value.ad_format_id=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(d(!0),y(Be,null,Ee(B.value,o=>(d(),D(Ve,{key:o.id,label:o.title,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(U,{label:"课程文件"},{default:a(()=>[t(Ue,{ref_key:"uploadRef",ref:I,drag:"",action:"#","auto-upload":!1,limit:1,"on-exceed":_e,"on-change":ve,"file-list":R.value},{tip:a(()=>[f("div",Re,[!R.value.length&&m.value.document_url?(d(),y("div",ze,[e[28]||(e[28]=r(" 当前文件: ")),t(xe,{href:m.value.document_url,type:"primary",target:"_blank"},{default:a(()=>[r(G(fe(m.value.document_url)),1)]),_:1},8,["href"])])):H("",!0),e[29]||(e[29]=f("span",null,"支持所有文本型、图片、视频等文件, 且不超过100MB",-1))])]),default:a(()=>[t(ke,{class:"el-icon--upload"},{default:a(()=>[t(Ne(he))]),_:1}),e[30]||(e[30]=f("div",{class:"el-upload__text"},[r(" 将文件拖到此处，或"),f("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(j,{modelValue:E.value,"onUpdate:modelValue":e[15]||(e[15]=o=>E.value=o),title:"附件预览",width:"80%","destroy-on-close":""},{footer:a(()=>[t(s,{onClick:e[14]||(e[14]=o=>E.value=!1)},{default:a(()=>e[35]||(e[35]=[r("关闭")])),_:1}),O.value||Q.value?(d(),D(s,{key:0,type:"primary",onClick:X},{default:a(()=>e[36]||(e[36]=[r(" 全屏查看 ")])),_:1})):H("",!0)]),default:a(()=>[f("div",Se,[O.value?(d(),y("img",{key:0,src:c.value,class:"attachment-image",onClick:X},null,8,Oe)):Q.value?(d(),y("iframe",{key:1,src:c.value,class:"attachment-frame"},null,8,Qe)):W.value?(d(),y("iframe",{key:2,src:T.value,class:"word-preview-frame"},null,8,Ge)):(d(),y("div",He,[e[34]||(e[34]=f("p",null,"无法预览此类型的文件，请下载后查看",-1)),t(s,{type:"primary",onClick:me},{default:a(()=>e[33]||(e[33]=[r("下载附件")])),_:1})]))])]),_:1},8,["modelValue"]),t(j,{modelValue:z.value,"onUpdate:modelValue":e[16]||(e[16]=o=>z.value=o),title:"全屏预览",width:"100%",top:"0","show-close":!0,"destroy-on-close":"",class:"fullscreen-dialog"},{default:a(()=>[f("div",Je,[O.value?(d(),y("img",{key:0,src:c.value,class:"fullscreen-image"},null,8,Te)):Q.value?(d(),y("iframe",{key:1,src:c.value,class:"fullscreen-frame"},null,8,We)):H("",!0)])]),_:1},8,["modelValue"])])}}}),tl=Fe(Xe,[["__scopeId","data-v-7bc36da9"]]);export{tl as default};
