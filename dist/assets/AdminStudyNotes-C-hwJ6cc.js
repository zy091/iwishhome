import{d as ye,J as K,u as fe,k as U,a4 as he,r as u,o as we,l as h,a as s,e as a,K as be,w as o,b as i,c as T,P as ke,v as S,M as w,g as Ve,a5 as Se,f as r,y as xe,O as De,t as d,q as B,U as Q,s as Ce,j as c,_ as Ne}from"./index-CF7jzyo9.js";const ze={class:"layout"},Ue={class:"layout-title"},Te={class:"status-tabs"},Be={class:"training-content"},Ee={class:"card-header"},$e={class:"header-actions"},Ae={style:{"font-size":"14px",color:"#909399"}},Ie={class:"dialog-content"},Le={class:"note-details"},Pe={class:"note-header"},Me={class:"note-title"},Re={class:"note-meta"},Oe={class:"meta-item"},We={class:"meta-item"},je={class:"meta-item"},qe={class:"note-section"},Je={class:"note-content"},Ke={key:0,class:"note-section"},Qe={class:"attachment-box"},Fe={class:"attachment-name"},Ge={key:1,class:"note-section"},He={class:"previous-reply"},Xe={class:"admin-reply-content"},Ye={key:0,class:"reply-time"},Ze={class:"note-section"},et={class:"section-title"},tt={class:"dialog-footer"},at={class:"attachment-preview"},lt=["src"],st=["src"],nt={key:2,class:"attachment-download"},ot=ye({__name:"AdminStudyNotes",setup(it){const F=K([{name:"数据管理",path:"/system/data"},{name:"学习心得",path:"/system/admin-study-notes"}]),G=fe(),H=U(()=>he(Number(G.roleId))),D=u(!1),E=u([]),k=u(!1),l=u(null),C=u(""),p=u([]),V=u(""),N=u(!1),z=u(!1),x=u("all"),X=[{text:"Last week",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"Last month",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"Last 3 months",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],_=K({page:1,pageSize:10,total:0}),Y=t=>{_.page=t.page,_.pageSize=t.pageSize,g()},g=async()=>{D.value=!0,console.log(p.value);const t=p.value!=null&&p.value[0]!=null?p.value[0].toDateString():"",e=p.value!=null&&p.value[1]!=null?p.value[1].toDateString():"";try{const m=await S.searchNotesUsingView(C.value,{startDate:t,endDate:e,page:_.page,pageSize:_.pageSize,replyStatus:x.value});E.value=m.data,_.total=m.total}catch{w.error("搜索笔记失败")}finally{D.value=!1}},Z=t=>{k.value=!0,l.value=t,V.value=t.admin_reply||""},ee=async t=>{var e;try{await Q.confirm(`确定要删除用户 ${((e=t.profile)==null?void 0:e.full_name)||"未知用户"} 的这条笔记吗？`,"提示",{type:"warning"}),await S.deleteNote(t.note_id),w.success("删除成功"),g()}catch(m){m!=="cancel"&&w.error("删除失败")}},y=u([]),te=t=>{y.value=t},ae=async()=>{if(y.value.length!==0)try{await Q.confirm(`确定要删除选中的 ${y.value.length} 条学习心得吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=y.value.map(e=>S.deleteNote(e.note_id));await Promise.all(t),w.success(`成功删除 ${y.value.length} 条学习心得`),y.value=[],g()}catch(t){t!=="cancel"&&(console.error("批量删除学习心得失败:",t),w.error("批量删除失败"))}},le=U(()=>{var t;return(t=l.value)!=null&&t.attachment_type?l.value.attachment_type.startsWith("image/"):!1}),se=U(()=>{var t;return(t=l.value)!=null&&t.attachment_type?l.value.attachment_type==="application/pdf":!1}),ne=()=>{var t;(t=l.value)!=null&&t.attachment_url&&(z.value=!0)},oe=()=>{var t;(t=l.value)!=null&&t.attachment_url&&window.open(l.value.attachment_url,"_blank")},ie=async()=>{if(l.value){N.value=!0;try{const{data:t}=await Ce.auth.getUser();if(!t.user)throw new Error("用户未登录");if(console.log("正在更新笔记，ID:",l.value.note_id),!await S.checkNoteExists(l.value.note_id))throw new Error(`笔记不存在: ${l.value.note_id}`);await S.updateNoteWithReply(l.value.note_id,{admin_reply:V.value,admin_id:t.user.id,replied_at:new Date().toISOString()}),w.success("回复已提交"),l.value&&(l.value.admin_reply=V.value,l.value.admin_id=t.user.id,l.value.replied_at=new Date().toISOString()),g(),k.value=!1}catch(t){console.error("提交回复失败:",t),w.error("提交回复失败: "+(t instanceof Error?t.message:"未知错误"))}finally{N.value=!1}}},de=t=>{x.value=t,_.page=1,g()};return we(()=>{g()}),(t,e)=>{const m=i("el-tab-pane"),re=i("el-tabs"),$=i("el-input"),ue=i("el-date-picker"),v=i("el-button"),ce=i("el-space"),A=i("el-card"),b=i("el-table-column"),pe=i("el-tag"),me=i("el-button-group"),I=i("el-empty"),_e=i("el-table"),L=i("el-dialog"),ve=De("loading");return c(),h("div",ze,[s(be,{breadbcrum:F},null,8,["breadbcrum"]),a("div",Ue,[e[7]||(e[7]=a("h1",{class:"title"},"学习心得",-1)),a("div",Te,[s(re,{class:"demo-tabs",modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=n=>x.value=n),onTabChange:de},{default:o(()=>[s(m,{name:"all",label:"全部心得"}),s(m,{name:"replied",label:"已回复"}),s(m,{name:"pending",label:"待回复"})]),_:1},8,["modelValue"])])]),s(A,{shadow:"always",style:{"margin-bottom":"20px"}},{default:o(()=>[s(ce,{alignment:"start",size:30},{default:o(()=>[s($,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=n=>C.value=n),style:{width:"240px"},placeholder:"请输入提交人或标题","suffix-icon":Ve(Se),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),s(ue,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=n=>p.value=n),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:X,size:"large"},null,8,["modelValue"]),s(v,{type:"primary",size:"large",onClick:g},{default:o(()=>e[8]||(e[8]=[r("搜索")])),_:1})]),_:1})]),_:1}),a("div",Be,[H.value?(c(),T(A,{key:0,style:{"min-height":"400px"}},{header:o(()=>[a("div",Ee,[e[10]||(e[10]=r(" 学习心得管理 ")),a("div",$e,[s(v,{type:"danger",disabled:!y.value.length,onClick:ae},{default:o(()=>e[9]||(e[9]=[r(" 批量删除 ")])),_:1},8,["disabled"]),a("div",Ae,"共计"+d(_.total)+"条数据",1)])])]),default:o(()=>[xe((c(),T(_e,{data:E.value,onSelectionChange:te},{default:o(()=>[s(b,{type:"selection",width:"55"}),s(b,{prop:"profile.full_name",label:"提交人"}),s(b,{prop:"title",label:"标题"}),s(b,{prop:"admin_reply",label:"状态"},{default:o(({row:n})=>[s(pe,{style:{"font-size":"14px"},type:n.admin_reply?"success":"warning",size:"large"},{default:o(()=>[r(d(n.admin_reply?"已回复":"待回复"),1)]),_:2},1032,["type"])]),_:1}),s(b,{prop:"note_created_at",label:"创建时间"},{default:o(({row:n})=>[r(d(new Date(n.note_created_at).toLocaleString()),1)]),_:1}),s(b,{label:"操作",width:"150",fixed:"right"},{default:o(({row:n})=>[s(me,null,{default:o(()=>[s(v,{type:"primary",onClick:f=>Z(n)},{default:o(()=>e[11]||(e[11]=[r("查看")])),_:2},1032,["onClick"]),s(v,{type:"danger",onClick:f=>ee(n)},{default:o(()=>e[12]||(e[12]=[r("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),s(I,null,{description:o(()=>e[13]||(e[13]=[r(" 暂无学习心得 ")])),_:1})]),_:1},8,["data"])),[[ve,D.value]])]),_:1})):(c(),T(I,{key:1,description:"您没有权限查看所有笔记"})),s(ke,{pagination:_,"onUpdate:pagination":Y},null,8,["pagination"]),s(L,{title:"学习心得详情",modelValue:k.value,"onUpdate:modelValue":e[5]||(e[5]=n=>k.value=n),width:"60%","close-on-click-modal":!1,top:"5vh",class:"note-detail-dialog"},{footer:o(()=>[a("span",tt,[s(v,{onClick:e[4]||(e[4]=n=>k.value=!1)},{default:o(()=>e[21]||(e[21]=[r("取消")])),_:1}),s(v,{type:"primary",onClick:ie,loading:N.value},{default:o(()=>{var n;return[r(d((n=l.value)!=null&&n.admin_reply?"更新回复":"提交回复"),1)]}),_:1},8,["loading"])])]),default:o(()=>{var n,f,P,M,R,O,W,j,q,J;return[a("div",Ie,[a("div",Le,[a("div",Pe,[a("h2",Me,d(((n=l.value)==null?void 0:n.title)||"无标题"),1),a("div",Re,[a("span",Oe,[e[14]||(e[14]=a("i",{class:"el-icon-user"},null,-1)),a("span",null,d(((P=(f=l.value)==null?void 0:f.profile)==null?void 0:P.full_name)||"未知用户"),1)]),a("span",We,[e[15]||(e[15]=a("i",{class:"el-icon-message"},null,-1)),a("span",null,d(((R=(M=l.value)==null?void 0:M.profile)==null?void 0:R.email)||"无邮箱"),1)]),a("span",je,[e[16]||(e[16]=a("i",{class:"el-icon-time"},null,-1)),a("span",null,d(l.value?new Date((O=l.value)==null?void 0:O.note_created_at).toLocaleString():"未知时间"),1)])])]),a("div",qe,[e[17]||(e[17]=a("div",{class:"section-title"},"内容",-1)),a("div",Je,d(((W=l.value)==null?void 0:W.content)||"无内容"),1)]),(j=l.value)!=null&&j.attachment_url?(c(),h("div",Ke,[e[19]||(e[19]=a("div",{class:"section-title"},"附件",-1)),a("div",Qe,[a("span",Fe,d(l.value.attachment_name),1),s(v,{type:"primary",size:"small",onClick:ne},{default:o(()=>e[18]||(e[18]=[r("查看附件")])),_:1})])])):B("",!0),(q=l.value)!=null&&q.admin_reply?(c(),h("div",Ge,[e[20]||(e[20]=a("div",{class:"section-title"},"历史回复",-1)),a("div",He,[a("div",Xe,d(l.value.admin_reply),1),l.value.replied_at?(c(),h("p",Ye," 回复于: "+d(new Date(l.value.replied_at).toLocaleString()),1)):B("",!0)])])):B("",!0),a("div",Ze,[a("div",et,d((J=l.value)!=null&&J.admin_reply?"修改回复":"添加回复"),1),s($,{type:"textarea",modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=ge=>V.value=ge),rows:4,placeholder:"请输入您的回复内容...",class:"reply-input"},null,8,["modelValue"])])])])]}),_:1},8,["modelValue"]),s(L,{modelValue:z.value,"onUpdate:modelValue":e[6]||(e[6]=n=>z.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{default:o(()=>{var n,f;return[a("div",at,[le.value?(c(),h("img",{key:0,src:(n=l.value)==null?void 0:n.attachment_url,class:"attachment-image"},null,8,lt)):se.value?(c(),h("iframe",{key:1,src:(f=l.value)==null?void 0:f.attachment_url,class:"attachment-frame"},null,8,st)):(c(),h("div",nt,[e[23]||(e[23]=a("p",null,"无法预览此类型的文件，请下载后查看",-1)),s(v,{type:"primary",onClick:oe},{default:o(()=>e[22]||(e[22]=[r("下载附件")])),_:1})]))])]}),_:1},8,["modelValue"])])])}}}),rt=Ne(ot,[["__scopeId","data-v-72da1958"]]);export{rt as default};
