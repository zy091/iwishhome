import{d as ke,r as h,u as Ce,k as A,o as Te,p as Se,l as k,e as a,a as s,c as L,q as R,t as u,w as n,b as m,s as P,v as be,F as M,m as E,g as _,x as W,y as C,z as T,A as q,B as Z,C as H,D as O,E as J,f as y,T as Pe,G as K,j as p,_ as De}from"./index-BmUZ9zWv.js";import{t as xe}from"./testResultService-zRfHSjei.js";import{a as Ne}from"./assignmentService-BTStiM5U.js";import{f as Fe}from"./feedbackService-C8yd5amZ.js";const Ae={class:"layout"},ze={class:"dashboard-content"},Ue={class:"welcome-section"},Ve={class:"date"},qe={text:"2xl",justify:"center"},Be={class:"stat-icon"},Ie={class:"stat-info"},Le={class:"stat-value"},Me={class:"stat-icon"},Ee={class:"stat-info"},He={class:"stat-value"},Oe={class:"stat-icon"},$e={class:"stat-info"},Ye={class:"stat-value"},je={class:"stat-icon"},Ge={class:"stat-info"},Re={class:"stat-value"},We={class:"stat-icon"},Ze={class:"stat-info"},Je={class:"stat-value"},Ke={class:"stat-icon"},Qe={class:"stat-info"},Xe={class:"stat-value"},et={class:"stat-icon"},tt={class:"stat-info"},st={class:"stat-value"},nt={class:"stat-icon"},at={class:"stat-info"},lt={class:"stat-value"},ot={class:"card-header"},rt={class:"task-title"},ut={key:0,style:{color:"#909399","font-size":"12px","margin-top":"10px"}},it={key:1,style:{color:"#F56C6C","font-size":"12px","margin-top":"10px"}},dt={class:"quick-links"},ct={class:"quick-link-group"},_t={class:"quick-link-group"},ft={class:"notice-list fixed-notice-list"},vt=["onClick"],mt={class:"notice-title"},yt={class:"notice-time"},pt={class:"notice-dialog-header"},gt={class:"notice-dialog-title"},ht={class:"notice-time"},wt={class:"notice-dialog-content"},kt=["innerHTML"],Ct={class:"notice-dialog-footer"},Q=5,Tt=ke({__name:"SystemHome",setup(St){h(null);const w=Ce(),X=A(()=>{var e;return((e=w.user)==null?void 0:e.email)||"用户"}),S=h([]),ee=A(()=>new Date().toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"})),te=A(()=>{var e,t,r;return((e=w.user)==null?void 0:e.role_id)===0||((t=w.user)==null?void 0:t.role_id)===1||((r=w.user)==null?void 0:r.role_id)===11}),l=h({activeUsers:0,userTrend:0,studyCount:0,studyPending:0,testCount:0,testPending:0,assignmentsCount:0,assignmentsPending:0,yourStudyCount:0,yourStudyPending:0,yourTestCount:0,yourTestPending:0,yourAssignmentsCount:0,yourAssignmentsPending:0,feedbackCount:0,feedbackTrend:0,myFeedbackCount:0,myFeedbackTrend:0}),se=async()=>{try{const{data:e,error:t}=await P.from("user_profiles").select("*");if(t)throw t;const r=new Date,i=e==null?void 0:e.filter(d=>new Date(d.created_at).toDateString()===r.toDateString());l.value.activeUsers=(e==null?void 0:e.length)||0,l.value.userTrend=(i==null?void 0:i.length)||0}catch(e){console.error("获取用户失败:",e)}},ne=async()=>{try{const{data:e,error:t}=await P.from("study_notes").select("*");if(t)throw t;l.value.studyCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.admin_reply===null);l.value.studyPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取学习记录失败:",e)}},ae=async()=>{try{const{data:e,error:t}=await P.from("test_results").select("*");if(t)throw t;l.value.testCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.feedback_text===null&&i.type==="case");l.value.testPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取测试结果失败:",e)}},le=async()=>{try{const{data:e,error:t}=await P.from("assignments").select("*");if(t)throw t;l.value.assignmentsCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.admin_reply===null);l.value.assignmentsPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取日常作业失败:",e)}},oe=async()=>{const e=await be.getNotes();l.value.yourStudyCount=(e==null?void 0:e.length)||0;const t=e==null?void 0:e.filter(r=>r.admin_reply===null);l.value.yourStudyPending=(t==null?void 0:t.length)||0,e||console.error("获取你的心得失败")},re=async()=>{const{data:e,total:t}=await xe.getUserTestResults({page:1,pageSize:1e3});l.value.yourTestCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.feedback_text===null&&i.type==="case");l.value.yourTestPending=(r==null?void 0:r.length)||0,e||console.error("获取你的测试失败")},ue=async()=>{const{data:e,total:t,error:r}=await Ne.getPersonalAssignments(1,1e3);l.value.yourAssignmentsCount=t||0,r&&console.error("获取你的作业失败:",r)},ie=async()=>{var e;try{const{data:t}=await Fe.getPersonalFeedback();l.value.myFeedbackCount=(t==null?void 0:t.length)||0,l.value.myFeedbackTrend=((e=t==null?void 0:t.filter(r=>r.replied_at==null))==null?void 0:e.length)||0}catch(t){console.error("获取反馈失败:",t)}},B=h([]),de=async()=>{var r;const{data:e,error:t}=await P.from("tasks").select("*").eq("assigned_to",(r=w.user)==null?void 0:r.user_id);if(t)throw t;B.value=e.filter(i=>i.status!=="completed").map(i=>{const d=new Date(i.due_date),c=new Date,f=d<c,v=Math.abs(d.getTime()-c.getTime()),x=Math.ceil(v/(1e3*60*60*24));return{...i,diffDays:x,isOverdue:f}}).sort((i,d)=>new Date(i.due_date).getTime()-new Date(d.due_date).getTime()),console.log(B.value)};function $(e){switch(e){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function ce(e){switch(e){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function _e(e){switch(e){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function fe(e){switch(e){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}const ve=async()=>{try{const{data:e,error:t}=await P.from("announcements").select("*");if(t)throw t;S.value=e}catch(e){console.error("获取系统公告失败:",e)}},Y=e=>{switch(e){case"important":return"danger";case"normal":return"success";case"update":return"warning";default:return"info"}},j=e=>{switch(e){case"important":return"重要";case"normal":return"新";case"update":return"更新";default:return"其他"}},z=h(!1),me=h(""),G=h(null),D=A(()=>S.value.find(e=>e.id===G.value)||null),ye=e=>{G.value=e,z.value=!0},U=h(0);let I=null;const pe=A(()=>{const e=[],t=S.value.length;for(let r=0;r<Q;r++)if(t===0)e.push({id:null,title:"",type:"",created_at:""});else{const i=(U.value+r)%t;e.push(S.value[i]||{id:null,title:"",type:"",created_at:""})}return e});return Te(()=>{Promise.all([se(),ne(),ae(),le(),oe(),re(),ue(),ve(),de(),ie()]).catch(e=>{console.error("加载数据失败:",e)}),I=setInterval(()=>{S.value.length>Q?U.value=(U.value+1)%S.value.length:U.value=0},3e3)}),Se(()=>{I&&clearInterval(I)}),(e,t)=>{const r=m("el-carousel-item"),i=m("el-carousel"),d=m("el-icon"),c=m("el-link"),f=m("el-card"),v=m("el-col"),x=m("el-row"),V=m("el-tag"),ge=m("el-timeline-item"),he=m("el-timeline"),N=m("el-button"),we=m("el-dialog");return p(),k("div",Ae,[a("div",ze,[a("div",Ue,[a("h2",null,"欢迎回来，"+u(X.value),1),a("p",Ve,u(ee.value),1)]),s(i,{"indicator-position":"outside"},{default:n(()=>[(p(),k(M,null,E(4,o=>s(r,{key:o},{default:n(()=>[a("h3",qe,u(o),1)]),_:2},1024)),64))]),_:1}),te.value?(p(),L(x,{key:0,gutter:20,class:"stat-cards"},{default:n(()=>[s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/users"},{default:n(()=>[a("div",Be,[s(d,null,{default:n(()=>[s(_(W))]),_:1})])]),_:1}),a("div",Ie,[t[2]||(t[2]=a("div",{class:"stat-title"},"系统用户",-1)),a("div",Le,u(l.value.activeUsers),1),C(a("div",{class:q(["stat-trend",{up:l.value.userTrend>0}])}," 新增： "+u(l.value.userTrend>0?"+":"")+u(l.value.userTrend),3),[[T,l.value.userTrend>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-study-notes"},{default:n(()=>[a("div",Me,[s(d,null,{default:n(()=>[s(_(Z))]),_:1})])]),_:1}),a("div",Ee,[t[3]||(t[3]=a("div",{class:"stat-title"},"学习心得",-1)),a("div",He,u(l.value.studyCount),1),C(a("div",{class:"stat-trend"}," 待回复： "+u(l.value.studyPending),513),[[T,l.value.studyPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-test-result"},{default:n(()=>[a("div",Oe,[s(d,null,{default:n(()=>[s(_(H))]),_:1})])]),_:1}),a("div",$e,[t[4]||(t[4]=a("div",{class:"stat-title"},"测试结果",-1)),a("div",Ye,u(l.value.testCount),1),C(a("div",{class:"stat-trend"}," 待批改： "+u(l.value.testPending),513),[[T,l.value.testPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-assignments"},{default:n(()=>[a("div",je,[s(d,null,{default:n(()=>[s(_(O))]),_:1})])]),_:1}),a("div",Ge,[t[5]||(t[5]=a("div",{class:"stat-title"},"日常作业",-1)),a("div",Re,u(l.value.assignmentsCount),1),C(a("div",{class:"stat-trend"}," 待批改： "+u(l.value.assignmentsPending),513),[[T,l.value.assignmentsPending>0]])])]),_:1})]),_:1})]),_:1})):R("",!0),s(x,{gutter:20,class:"stat-cards"},{default:n(()=>[s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/study-notes"},{default:n(()=>[a("div",We,[s(d,null,{default:n(()=>[s(_(Z))]),_:1})])]),_:1}),a("div",Ze,[t[6]||(t[6]=a("div",{class:"stat-title"},"我的心得",-1)),a("div",Je,u(l.value.yourStudyCount),1),C(a("div",{class:q(["stat-trend",{up:l.value.yourStudyPending>0}])}," 待回复： "+u(l.value.yourStudyPending>0?"+":"")+u(l.value.yourStudyPending),3),[[T,l.value.yourStudyPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/test-result"},{default:n(()=>[a("div",Ke,[s(d,null,{default:n(()=>[s(_(H))]),_:1})])]),_:1}),a("div",Qe,[t[7]||(t[7]=a("div",{class:"stat-title"},"我的测试",-1)),a("div",Xe,u(l.value.yourTestCount),1),C(a("div",{class:q(["stat-trend",{up:l.value.yourTestPending>0}])}," 待批改："+u(l.value.yourTestPending>0?"+":"")+u(l.value.yourTestPending),3),[[T,l.value.yourTestPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/daily-assignments"},{default:n(()=>[a("div",et,[s(d,null,{default:n(()=>[s(_(O))]),_:1})])]),_:1}),a("div",tt,[t[8]||(t[8]=a("div",{class:"stat-title"},"我的作业",-1)),a("div",st,u(l.value.yourAssignmentsCount),1)])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[a("div",nt,[s(d,null,{default:n(()=>[s(_(J))]),_:1})])]),_:1}),a("div",at,[t[9]||(t[9]=a("div",{class:"stat-title"},"我的反馈",-1)),a("div",lt,u(l.value.myFeedbackCount),1),C(a("div",{class:q(["stat-trend",{up:l.value.myFeedbackTrend>0}])}," 待处理："+u(l.value.myFeedbackTrend>0?"+":"")+u(l.value.myFeedbackTrend),3),[[T,l.value.myFeedbackTrend>0]])])]),_:1})]),_:1})]),_:1}),s(x,{gutter:20,class:"main-content"},{default:n(()=>[s(v,{span:16},{default:n(()=>[s(f,{class:"task-card"},{header:n(()=>[a("div",ot,[t[11]||(t[11]=a("span",null,"待办任务",-1)),s(c,{type:"primary",link:"",href:"/system/task-management"},{default:n(()=>t[10]||(t[10]=[y(" 查看全部 ")])),_:1})])]),default:n(()=>[s(he,null,{default:n(()=>[(p(!0),k(M,null,E(B.value,(o,g)=>(p(),L(ge,{key:g,type:$(o.priority),timestamp:o.due_date,placement:"top"},{default:n(()=>[s(f,{class:"task-item"},{default:n(()=>[a("div",rt,[a("h4",null,u(o.title),1),s(V,{class:"status-tag",type:_e(o.status)},{default:n(()=>[y(u(fe(o.status)),1)]),_:2},1032,["type"]),t[12]||(t[12]=y()),s(V,{type:$(o.priority)},{default:n(()=>[y(u(ce(o.priority)),1)]),_:2},1032,["type"])]),a("p",null,u(o.description),1),o.isOverdue?(p(),k("p",it,"已过期："+u(o.diffDays)+"天",1)):(p(),k("p",ut,"距离截止日期："+u(o.diffDays)+"天",1))]),_:2},1024)]),_:2},1032,["type","timestamp"]))),128))]),_:1})]),_:1})]),_:1}),s(v,{span:8},{default:n(()=>[s(f,{class:"quick-access"},{header:n(()=>t[13]||(t[13]=[a("div",{class:"card-header"},[a("span",null,"快捷入口")],-1)])),default:n(()=>{var o,g,b,F;return[a("div",dt,[a("div",ct,[s(c,{underline:!1,href:"/system/personal-data"},{default:n(()=>[s(N,{type:"primary",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(_(W))]),_:1}),t[14]||(t[14]=y(" 个人中心 "))]),_:1})]),_:1}),s(c,{underline:!1,href:`/system/training/study-material-folder?platform=${(g=(o=_(w).user)==null?void 0:o.role)==null?void 0:g.mark[0]}`},{default:n(()=>[s(N,{type:"success",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(_(H))]),_:1}),t[15]||(t[15]=y(" 学习资料 "))]),_:1})]),_:1},8,["href"])]),a("div",_t,[s(c,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[s(N,{type:"warning",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(_(J))]),_:1}),t[16]||(t[16]=y(" 反馈中心 "))]),_:1})]),_:1}),s(c,{underline:!1,href:`/system/daily-work/personal-assignments?platform=${(F=(b=_(w).user)==null?void 0:b.role)==null?void 0:F.mark[0]}`},{default:n(()=>[s(N,{type:"info",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(_(O))]),_:1}),t[17]||(t[17]=y(" 日常作业 "))]),_:1})]),_:1},8,["href"])])])]}),_:1}),s(f,{class:"notice-card"},{header:n(()=>t[18]||(t[18]=[a("div",{class:"card-header"},[a("span",null,"系统公告")],-1)])),default:n(()=>[a("div",ft,[s(Pe,{name:"notice-fade",tag:"div"},{default:n(()=>[(p(!0),k(M,null,E(pe.value,(o,g)=>(p(),k("div",{key:o.id?o.id:"empty-"+g,class:"notice-item",onClick:b=>o.id&&ye(o.id)},[o.id?(p(),L(V,{key:0,type:Y(o.type),size:"small"},{default:n(()=>[y(u(j(o.type)),1)]),_:2},1032,["type"])):R("",!0),a("span",mt,u(o.title||""),1),a("span",yt,u(o.created_at?_(K)(o.created_at):""),1)],8,vt))),128))]),_:1})])]),_:1})]),_:1})]),_:1})]),s(we,{modelValue:z.value,"onUpdate:modelValue":t[1]||(t[1]=o=>z.value=o),title:me.value,width:"40%",class:"notice-dialog","close-on-click-modal":!1},{header:n(()=>{var o,g,b;return[a("div",pt,[s(V,{type:Y(((o=D.value)==null?void 0:o.type)||""),size:"small",class:"notice-type-tag"},{default:n(()=>{var F;return[y(u(j(((F=D.value)==null?void 0:F.type)||"")),1)]}),_:1},8,["type"]),a("span",gt,u(((g=D.value)==null?void 0:g.title)||""),1),a("span",ht,u(_(K)(((b=D.value)==null?void 0:b.created_at)||"")),1)])]}),footer:n(()=>[a("div",Ct,[s(N,{type:"primary",onClick:t[0]||(t[0]=o=>z.value=!1)},{default:n(()=>t[19]||(t[19]=[y("关闭")])),_:1})])]),default:n(()=>{var o;return[a("div",wt,[a("div",{innerHTML:(o=D.value)==null?void 0:o.content,class:"notice-content"},null,8,kt)])]}),_:1},8,["modelValue","title"])])}}}),Nt=De(Tt,[["__scopeId","data-v-6a82eacd"]]);export{Nt as default};
