import{u as _,s as c,a4 as D}from"./index-BmUZ9zWv.js";class S{async getUserTestResults(r){var o;const t=(o=_().user)==null?void 0:o.user_id;if(!t)throw new Error("用户未登录");const{page:n,pageSize:a}=r,i=(n-1)*a;if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))throw new Error("无效的用户ID格式");const{data:l,error:s,count:d}=await c.from("test_results").select("*",{count:"exact"}).eq("user_id",t).order("submitted_at",{ascending:!1}).range(i,i+a-1);if(s)throw console.error("获取测试结果失败:",s),s;return{data:l,total:d||0}}async getTestResultDetails(r){const{data:e,error:t}=await c.from("test_results").select("*").eq("id",r).single();if(t)throw console.error("获取测试结果失败:",t),t;const{data:n,error:a}=await c.from("test_answer_details").select("*").eq("test_result_id",r).order("question_order",{ascending:!0});if(a)throw console.error("获取答案详情失败:",a),a;return{testResult:e,answerDetails:n}}async submitTestResult(r,e){const{data:t,error:n}=await c.from("test_results").insert(r).select().single();if(n)throw console.error("提交测试结果失败:",n),n;const a=t.id,i=e.map(s=>({...s,test_result_id:a})),{error:l}=await c.from("test_answer_details").insert(i);if(l)throw console.error("提交答案详情失败:",l),l;return t}async searchTestResultsUsingView(r,e){const t=_();if(!t.getUser())throw new Error("未登录");const a=Number(t.roleId);if(!D(a))throw new Error("没有权限查看所有测试记录");const i=(e==null?void 0:e.page)||1,l=(e==null?void 0:e.pageSize)||10;let s=c.from("simple_test_results_view").select("*",{count:"exact"});if(r&&(s=s.or(`test_title.ilike.%${r}%,full_name.ilike.%${r}%`)),e!=null&&e.type&&(s=s.eq("type",e.type)),(e==null?void 0:e.is_graded)!==void 0&&(s=s.eq("is_graded",e.is_graded)),e!=null&&e.startDate&&(e!=null&&e.endDate)){const{startUTC:u,endUTC:h}=R(e.startDate,e.endDate);s=s.gte("submitted_at",u).lte("submitted_at",h)}const d=(i-1)*l,o=d+l-1,{data:g,error:w,count:m}=await s.order("submitted_at",{ascending:!1}).range(d,o);if(w)throw w;return{data:(g||[]).map(u=>({...u,profile:{full_name:u.full_name,email:u.email}})),total:m||0,page:i,pageSize:l}}async deleteTestResult(r){const{error:e}=await c.from("test_answer_details").delete().eq("test_result_id",r);if(e)throw console.error("删除答案详情失败:",e),e;const{error:t}=await c.from("test_results").delete().eq("id",r);if(t)throw console.error("删除测试结果失败:",t),t}}function R(f,r){const e=new Date(f),t=new Date(r);return e.setHours(0,0,0,0),t.setHours(23,59,59,999),{startUTC:e.toISOString(),endUTC:t.toISOString()}}const U=new S;export{U as t};
