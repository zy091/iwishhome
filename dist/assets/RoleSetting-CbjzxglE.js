import{E as n,s as Y,c as K}from"./elementPlus-DvW_yQnS.js";import{u as O,B as W,b as Z,_ as ee}from"./index-qHT9h40T.js";import{g as te,d as le,u as ae,c as oe}from"./role-DBChlCHr.js";import{x as re,c as N,r as m,X as ne,j as se,y as ie,P as l,A as f,H as a,ag as u,G as y,J as U,u as ue,L as d,I as de,aq as pe,M as $,z as v}from"./vendor-COQJj1AX.js";import"./supabase-ndUUYBZa.js";const ce={class:"layout"},me={class:"role-content"},fe={class:"card-header"},_e={class:"header-actions"},ve={style:{"font-size":"14px",color:"#909399"}},ge={class:"dialog-footer"},ye=re({__name:"RoleSetting",setup(be){const I=[{name:"角色管理",path:"/system/role-setting"}],z=O(),_=N(()=>{var t,e,i;return((t=z.user)==null?void 0:t.role_id)===0||((e=z.user)==null?void 0:e.role_id)===1||((i=z.user)==null?void 0:i.role_id)===11}),C=m(!1),b=m([]),V=m(""),g=m(!1),k=m(""),D=m(null),s=ne({page:1,pageSize:10,total:0}),r=m({role_id:"",name:"",mark:[],description:""}),L={role_id:[{required:!0,message:"请输入角色ID",trigger:"blur"}],name:[{required:!0,message:"请输入角色名称",trigger:"blur"}],description:[{required:!0,message:"请输入描述",trigger:"blur"}]},S=m([]),M=N(()=>{const t=(s.page-1)*s.pageSize,e=t+s.pageSize;return b.value.slice(t,e)}),w=async()=>{C.value=!0;try{const t=await te();S.value=t.data,b.value=t.data,s.total=t.data.length}catch(t){console.error("获取角色列表失败:",t),n.error("获取角色列表失败")}finally{C.value=!1}},E=t=>{s.page=t.page,s.pageSize=t.pageSize,w()},T=()=>{if(s.page=1,!V.value){b.value=S.value,s.total=S.value.length;return}b.value=S.value.filter(t=>t.name.includes(V.value)),s.total=b.value.length},q=()=>{if(!_.value){n.error("您没有权限执行此操作");return}k.value="添加角色",r.value={role_id:"",name:"",mark:[],description:""},g.value=!0},F=t=>{if(!_.value){n.error("您没有权限执行此操作");return}k.value="编辑角色",r.value={...t},g.value=!0},A=async t=>{if(!_.value){n.error("您没有权限执行此操作");return}if(Number(t.role_id)===0){n.warning("系统内置角色不允许删除！");return}try{await K.confirm(`确定要删除角色"${t.name}"吗？

注意：删除后，使用该角色的用户将失去角色权限。
此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0}),await le(Number(t.role_id)),n.success("删除成功"),w()}catch(e){e!=="cancel"&&(console.error("删除角色失败:",e),e.code==="42501"?n.error("权限不足，无法执行此操作"):e.code==="23503"?n.error("该角色正在被使用，无法删除"):n.error("删除失败"))}},H=async()=>{if(D.value){if(!_.value){n.error("您没有权限执行此操作");return}await D.value.validate(async t=>{if(t)try{r.value.id?(await ae(Number(r.value.role_id),r.value),n.success("更新成功")):(await oe(r.value),n.success("创建成功")),g.value=!1,w()}catch(e){console.error(r.value.role_id?"更新失败:":"创建失败:",e),e.code==="42501"?n.error("权限不足，无法执行此操作"):e.code==="23505"?n.error("角色ID已存在"):n.error(r.value.role_id?"更新失败":"创建失败")}})}};function B(t){if(!t)return"-";const e=new Date(t),i=e.getFullYear(),p=String(e.getMonth()+1).padStart(2,"0"),R=String(e.getDate()).padStart(2,"0"),x=String(e.getHours()).padStart(2,"0"),c=String(e.getMinutes()).padStart(2,"0");return`${i}-${p}-${R} ${x}:${c}`}return se(async()=>{await w()}),(t,e)=>{const i=u("el-input"),p=u("el-button"),R=u("el-space"),x=u("el-card"),c=u("el-table-column"),j=u("el-button-group"),G=u("el-table"),h=u("el-form-item"),J=u("el-form"),P=u("el-dialog"),Q=pe("loading");return v(),ie("div",ce,[l(W,{breadbcrum:I}),e[15]||(e[15]=f("div",{class:"layout-title"},[f("h1",{class:"title"},"角色管理")],-1)),l(x,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[l(R,{wrap:"",alignment:"start",size:30},{default:a(()=>[l(i,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=o=>V.value=o),style:{width:"240px"},placeholder:"请输入角色名称","suffix-icon":ue(Y),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),l(p,{type:"primary",size:"large",onClick:T},{default:a(()=>e[7]||(e[7]=[d("搜索")])),_:1}),_.value?(v(),y(p,{key:0,type:"success",size:"large",onClick:q},{default:a(()=>e[8]||(e[8]=[d("添加角色")])),_:1})):U("",!0)]),_:1})]),_:1}),f("div",me,[l(x,{style:{"min-height":"400px"}},{header:a(()=>[f("div",fe,[e[10]||(e[10]=d(" 角色列表 ")),f("div",_e,[e[9]||(e[9]=f("div",{style:{"font-size":"12px",color:"#909399","margin-right":"10px"}}," 注意：删除角色会影响使用该角色的用户权限 ",-1)),f("div",ve,"共计"+$(s.total)+"条数据",1)])])]),default:a(()=>[de((v(),y(G,{data:M.value,"row-key":"role_id"},{default:a(()=>[l(c,{prop:"role_id",label:"ID",width:"80"}),l(c,{prop:"name",label:"角色名称",width:"180"}),l(c,{prop:"description",label:"描述"}),l(c,{prop:"created_at",label:"创建时间",width:"180"},{default:a(({row:o})=>[d($(B(o.created_at)),1)]),_:1}),l(c,{prop:"updated_at",label:"更新时间",width:"180"},{default:a(({row:o})=>[d($(B(o.updated_at)),1)]),_:1}),l(c,{label:"操作",width:"200"},{default:a(({row:o})=>[l(j,null,{default:a(()=>[_.value?(v(),y(p,{key:0,type:"primary",onClick:X=>F(o)},{default:a(()=>e[11]||(e[11]=[d(" 编辑 ")])),_:2},1032,["onClick"])):U("",!0),_.value&&Number(o.role_id)!==0?(v(),y(p,{key:1,type:"danger",onClick:X=>A(o)},{default:a(()=>e[12]||(e[12]=[d(" 删除 ")])),_:2},1032,["onClick"])):U("",!0)]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Q,C.value]])]),_:1}),l(Z,{pagination:s,"onUpdate:pagination":E},null,8,["pagination"]),l(P,{title:k.value,modelValue:g.value,"onUpdate:modelValue":e[6]||(e[6]=o=>g.value=o),width:"500px"},{footer:a(()=>[f("span",ge,[l(p,{onClick:e[5]||(e[5]=o=>g.value=!1)},{default:a(()=>e[13]||(e[13]=[d("取消")])),_:1}),l(p,{type:"primary",onClick:H},{default:a(()=>e[14]||(e[14]=[d("确定")])),_:1})])]),default:a(()=>[l(J,{model:r.value,rules:L,ref_key:"roleFormRef",ref:D,"label-width":"100px"},{default:a(()=>[k.value==="编辑角色"?(v(),y(h,{key:0,label:"角色ID",prop:"role_id"},{default:a(()=>[l(i,{modelValue:r.value.role_id,"onUpdate:modelValue":e[1]||(e[1]=o=>r.value.role_id=o),disabled:""},null,8,["modelValue"])]),_:1})):(v(),y(h,{key:1,label:"角色ID",prop:"role_id"},{default:a(()=>[l(i,{modelValue:r.value.role_id,"onUpdate:modelValue":e[2]||(e[2]=o=>r.value.role_id=o)},null,8,["modelValue"])]),_:1})),l(h,{label:"角色名称",prop:"name"},{default:a(()=>[l(i,{modelValue:r.value.name,"onUpdate:modelValue":e[3]||(e[3]=o=>r.value.name=o)},null,8,["modelValue"])]),_:1}),l(h,{label:"描述",prop:"description"},{default:a(()=>[l(i,{modelValue:r.value.description,"onUpdate:modelValue":e[4]||(e[4]=o=>r.value.description=o)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])])])}}}),he=ee(ye,[["__scopeId","data-v-bb90f027"]]);export{he as default};
