import{x as T,r as x,j as G,I as E,aq as H,G as p,ag as u,H as r,y as R,P as _,J as N,a6 as B,O as C,L as v,Q as J,z as i,M as I,A as P}from"./vendor-COQJj1AX.js";import{t as Q}from"./testResultService-k1Qd2w8B.js";import{u as z,s as K,_ as W}from"./index-DqKYda5u.js";import{E as h}from"./elementPlus-Dv7g5dxn.js";const X={class:"reading-lable",style:{"margin-bottom":"20px"}},U=3,Y=T({__name:"DynamicForm",props:{questions:{},testId:{},testName:{},type:{}},emits:["submitAnswers","limitReached"],setup(F,{emit:M}){const n=F,$=M,s=x({}),O=x({}),V=x(!1),D=x(!1),L=async()=>{var d;try{const c=(d=z().user)==null?void 0:d.user_id;if(!c)throw new Error("用户未登录");const{data:w,error:l,count:f}=await K.from("test_results").select("*",{count:"exact"}).eq("user_id",c).eq("test_id",n.testId);if(l)throw l;return{count:f||0,hasReachedLimit:(f||0)>=U}}catch(o){return console.error("检查尝试次数失败:",o),{count:0,hasReachedLimit:!1}}},j=async()=>{var w;if(!n.questions.every(l=>l.question_type=="select"?s.value[l.id]!==void 0:s.value[l.id]!==void 0&&s.value[l.id].trim()!=="")){h.error("请将所有题目作答完毕后再提交");return}const{count:o,hasReachedLimit:c}=await L();if(c){h.error(`您已达到最大尝试次数(${U}次)，不能再次作答`);return}D.value=!0;try{const f=(w=z().user)==null?void 0:w.user_id;if(!f)throw new Error("用户未登录");let m=0;const g=[];for(const e of n.questions){const y=e.question_type==="select"?s.value[e.id].split(".")[1]:s.value[e.id],t=e.question_type==="select"?s.value[e.id].split("-")[0]:`第${n.questions.indexOf(e)+1}题`;e.question_type==="reading"?(m+=0,g.push({questionIndex:t,questionId:e.id,userAnswer:y,correctAnswer:"待批改"})):y===e.correct_answer?m+=10:g.push({questionIndex:t,questionId:e.id,userAnswer:y,correctAnswer:e.correct_answer})}const b={user_id:f,test_id:n.testId,test_title:n.testName,score:m,is_passed:m>=60,submitted_at:new Date().toISOString(),completion_status:"completed",is_graded:n.type==="select",type:n.type},A=n.questions.map((e,y)=>({test_result_id:"",question_id:String(e.id)||"",question_type:e.question_type||"",question_text:e.text,answer:s.value[e.id]||"",is_correct:e.question_type==="reading"?null:s.value[e.id].split(".")[1]===e.correct_answer,score:e.question_type=="select"&&s.value[e.id].split(".")[1]===e.correct_answer?n.type==="select"?10:5:0,question_order:y+1}));await Q.submitTestResult(b,A),n.type==="select"?(h.success("测试答案提交成功！"),V.value=!0):(h.success("答案已提交，请等待管理员批改！"),V.value=!0),$("submitAnswers",{answers:s.value,score:m,incorrectAnswers:g})}catch(l){console.error("提交测试结果失败:",l),h.error("提交测试结果失败，请稍后重试")}finally{D.value=!1}},q=()=>{V.value=!1,s.value={}};return G(async()=>{const{hasReachedLimit:d}=await L();d&&(h.warning(`您已达到最大尝试次数(${U}次)，不能再次作答`),$("limitReached"))}),(d,o)=>{const c=u("el-radio"),w=u("el-radio-group"),l=u("el-input"),f=u("el-text"),m=u("el-form-item"),g=u("el-button"),b=u("el-tooltip"),A=u("el-empty"),e=u("el-form"),y=H("loading");return E((i(),p(e,{"element-loading-text":"Loading...",model:O.value,"label-width":"auto",style:{width:"100%","max-width":"800px"}},{default:r(()=>[(i(!0),R(C,null,B(d.questions,(t,k)=>(i(),p(m,{key:t.id,label:t.question_type==="reading"?"":`${k+1}. ${t.text}`,"label-position":"left",style:{"flex-direction":"column"}},{default:r(()=>[t.question_type==="select"?(i(),p(w,{key:0,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a},{default:r(()=>[o[0]||(o[0]=v(" //在option前面加个A. B. C. D. E. ")),(i(!0),R(C,null,B(t.options,(a,S)=>(i(),p(c,{key:S,value:`第${k+1}题-${String.fromCharCode(65+S)}.${a}`},{default:r(()=>[v(I(`${String.fromCharCode(65+S)}. ${a}`),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.question_type==="judge"?(i(),p(w,{key:1,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a},{default:r(()=>[_(c,{value:"是"},{default:r(()=>o[1]||(o[1]=[v("是")])),_:1}),_(c,{value:"否"},{default:r(()=>o[2]||(o[2]=[v("否")])),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.question_type==="fill"?(i(),p(l,{key:2,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a,placeholder:"请填写答案"},null,8,["modelValue","onUpdate:modelValue"])):t.question_type==="question"?(i(),p(l,{key:3,modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a,type:"textarea",placeholder:"请简要描述"},null,8,["modelValue","onUpdate:modelValue"])):t.question_type==="reading"?(i(),R(C,{key:4},[P("div",X,[_(f,{class:"mx-1",size:"large",style:{"line-height":"1"}},{default:r(()=>[v(I(k+1)+". "+I(t.text),1)]),_:2},1024)]),_(l,{modelValue:s.value[t.id],"onUpdate:modelValue":a=>s.value[t.id]=a,type:"textarea",placeholder:"请阅读并回答",autosize:{minRows:6,maxRows:15}},null,8,["modelValue","onUpdate:modelValue"])],64)):N("",!0)]),_:2},1032,["label"]))),128)),_(m,{"label-position":"left"},{default:r(()=>[_(g,{style:{"margin-left":"0","margin-right":"50px"},type:"primary",onClick:j,disabled:V.value},{default:r(()=>o[3]||(o[3]=[v("提交答案")])),_:1},8,["disabled"]),_(b,{class:"box-item",effect:"dark",content:"点击后将清空所有答案",placement:"top-start"},{default:r(()=>[E(_(g,{type:"warning",plain:"",onClick:q},{default:r(()=>o[4]||(o[4]=[v("重新作答")])),_:1},512),[[J,V.value]])]),_:1})]),_:1}),d.questions.length?N("",!0):(i(),p(A,{key:0,description:"暂无数据"}))]),_:1},8,["model"])),[[y,!d.questions.length]])}}}),oe=W(Y,[["__scopeId","data-v-5e6b5635"]]);export{oe as D};
