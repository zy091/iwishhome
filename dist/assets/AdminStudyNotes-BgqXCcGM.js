import{E as b,s as Ce,c as se}from"./elementPlus-COdCHMXA.js";import{u as Ne,i as ze,B as Ue,e as Ee,c as C,s as Ie,b as Ae}from"./index-BTZmLT2e.js";import{x as Be,X as ne,c as N,r as c,j as Te,y as v,P as s,A as l,H as o,ag as p,G as k,u as $e,L as u,I as Pe,aq as Le,M as d,J as V,z as i}from"./vendor-kUynFKsh.js";import"./supabase-Bu12BySZ.js";const Re={class:"layout"},Me={class:"layout-title"},We={class:"status-tabs"},Fe={class:"training-content"},Oe={class:"card-header"},je={class:"header-actions"},qe={style:{"font-size":"14px",color:"#909399"}},Ge={class:"dialog-content"},He={class:"note-details"},Je={class:"note-header"},Qe={class:"note-title"},Xe={class:"note-meta"},Ke={class:"meta-item"},Ye={class:"meta-item"},Ze={class:"meta-item"},et={class:"note-section"},tt={class:"note-content"},at={key:0,class:"note-section"},lt={class:"attachment-box"},st={class:"attachment-name"},nt={key:1,class:"note-section"},ot={class:"previous-reply"},it={class:"reply-header"},rt={class:"reply-author"},ut={class:"admin-reply-content"},dt={key:0,class:"reply-timestamp"},ct={class:"reply-actions"},pt={key:2,class:"note-section"},mt={class:"section-title"},vt={class:"dialog-footer"},_t={class:"attachment-preview"},ft=["src"],yt=["src"],gt=["src"],ht={key:3,class:"attachment-download"},wt={class:"fullscreen-preview"},bt=["src"],kt=["src"],Vt=Be({__name:"AdminStudyNotes",setup(xt){const oe=ne([{name:"数据管理",path:""},{name:"学习心得",path:"/system/admin-study-notes"}]),z=Ne(),ie=N(()=>ze(Number(z.roleId))),re=N(()=>Number(z.roleId)===0),B=c(!1),W=c([]),S=c(!1),a=c(null),T=c(""),f=c([]),g=c(""),$=c(!1),U=c(!1),E=c("all"),x=c(!1),P=c(!1),F=c(""),ue=[{text:"Last week",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"Last month",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"Last 3 months",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],y=ne({page:1,pageSize:10,total:0}),de=t=>{y.page=t.page,y.pageSize=t.pageSize,h()},h=async()=>{B.value=!0,console.log(f.value);const t=f.value!=null&&f.value[0]!=null?f.value[0].toDateString():"",e=f.value!=null&&f.value[1]!=null?f.value[1].toDateString():"";try{const r=await C.searchNotesUsingView(T.value,{startDate:t,endDate:e,page:y.page,pageSize:y.pageSize,replyStatus:E.value});W.value=r.data,y.total=r.total}catch{b.error("搜索笔记失败")}finally{B.value=!1}},ce=t=>{S.value=!0,a.value=t,g.value="",x.value=!1},pe=()=>{var t;x.value=!0,g.value=((t=a.value)==null?void 0:t.admin_reply)||""},me=()=>{S.value=!1,x.value=!1,g.value=""},ve=async t=>{var e;try{await se.confirm(`确定要删除用户 ${((e=t.profile)==null?void 0:e.full_name)||"未知用户"} 的这条笔记吗？`,"提示",{type:"warning"}),await C.deleteNote(t.note_id),b.success("删除成功"),h()}catch(r){r!=="cancel"&&b.error("删除失败")}},w=c([]),_e=t=>{w.value=t},fe=async()=>{if(w.value.length!==0)try{await se.confirm(`确定要删除选中的 ${w.value.length} 条学习心得吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=w.value.map(e=>C.deleteNote(e.note_id));await Promise.all(t),b.success(`成功删除 ${w.value.length} 条学习心得`),w.value=[],h()}catch(t){t!=="cancel"&&(console.error("批量删除学习心得失败:",t),b.error("批量删除失败"))}},I=N(()=>{var t;return(t=a.value)!=null&&t.attachment_type?a.value.attachment_type.startsWith("image/"):!1}),A=N(()=>{var t;return(t=a.value)!=null&&t.attachment_type?a.value.attachment_type==="application/pdf":!1}),L=N(()=>{var t;return(t=a.value)!=null&&t.attachment_type?a.value.attachment_type==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||a.value.attachment_type==="application/msword":!1}),ye=()=>{var t;(t=a.value)!=null&&t.attachment_url&&(L.value&&(F.value=`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(a.value.attachment_url)}`),U.value=!0)},ge=()=>{var t;(t=a.value)!=null&&t.attachment_url&&window.open(a.value.attachment_url,"_blank")},O=()=>{P.value=!0},he=async()=>{var t,e;if(a.value){$.value=!0;try{const{data:r}=await Ie.auth.getUser();if(!r.user)throw new Error("用户未登录");if(console.log("正在更新笔记，ID:",a.value.note_id),!await C.checkNoteExists(a.value.note_id))throw new Error(`笔记不存在: ${a.value.note_id}`);await C.updateNoteWithReply(a.value.note_id,{admin_reply:g.value,admin_id:r.user.id,admin_name:(t=z.user)==null?void 0:t.full_name,replied_at:new Date().toISOString()}),b.success("回复已提交"),a.value&&(a.value.admin_reply=g.value,a.value.admin_id=r.user.id,a.value.admin_name=(e=z.user)==null?void 0:e.full_name,a.value.replied_at=new Date().toISOString()),h(),S.value=!1,x.value=!1}catch(r){console.error("提交回复失败:",r),b.error("提交回复失败: "+(r instanceof Error?r.message:"未知错误"))}finally{$.value=!1}}},we=t=>{E.value=t,y.page=1,h()};return Te(()=>{h()}),(t,e)=>{const r=p("el-tab-pane"),j=p("el-tabs"),q=p("el-input"),be=p("el-date-picker"),m=p("el-button"),ke=p("el-space"),G=p("el-card"),R=p("el-tag"),H=p("el-tooltip"),D=p("el-table-column"),Ve=p("el-button-group"),J=p("el-empty"),xe=p("el-table"),M=p("el-dialog"),De=Le("loading");return i(),v("div",Re,[s(Ue,{breadcrumb:oe},null,8,["breadcrumb"]),l("div",Me,[e[8]||(e[8]=l("h1",{class:"title"},"学习心得",-1)),l("div",We,[s(j,{class:"demo-tabs",modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=n=>E.value=n),onTabChange:we},{default:o(()=>[s(r,{name:"all",label:"全部心得"}),s(r,{name:"replied",label:"已回复"}),s(r,{name:"pending",label:"待回复"})]),_:1},8,["modelValue"])])]),s(G,{shadow:"always",style:{"margin-bottom":"20px"}},{default:o(()=>[s(ke,{wrap:"",alignment:"start",size:30},{default:o(()=>[s(q,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=n=>T.value=n),style:{width:"240px"},placeholder:"请输入提交人或标题","suffix-icon":$e(Ce),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),s(be,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=n=>f.value=n),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:ue,size:"large"},null,8,["modelValue"]),s(m,{type:"primary",size:"large",onClick:h},{default:o(()=>e[9]||(e[9]=[u("搜索")])),_:1})]),_:1})]),_:1}),l("div",Fe,[ie.value?(i(),k(G,{key:0,style:{"min-height":"400px"}},{header:o(()=>[l("div",Oe,[l("div",null,[e[12]||(e[12]=l("span",null,"学习心得管理",-1)),re.value?(i(),k(H,{key:0,content:"您可以查看所有学习心得",placement:"right"},{default:o(()=>[s(R,{type:"success",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[10]||(e[10]=[u("全部")])),_:1})]),_:1})):(i(),k(H,{key:1,content:"您只能查看本组织的学习心得",placement:"right"},{default:o(()=>[s(R,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[11]||(e[11]=[u("本组织")])),_:1})]),_:1}))]),l("div",je,[s(m,{type:"danger",disabled:!w.value.length,onClick:fe},{default:o(()=>e[13]||(e[13]=[u(" 批量删除 ")])),_:1},8,["disabled"]),l("div",qe,"共计"+d(y.total)+"条数据",1)])])]),default:o(()=>[Pe((i(),k(xe,{data:W.value,onSelectionChange:_e},{default:o(()=>[s(D,{type:"selection",width:"55"}),s(D,{prop:"profile.full_name",label:"提交人"}),s(D,{prop:"title",label:"标题"}),s(D,{prop:"admin_reply",label:"状态"},{default:o(({row:n})=>[s(R,{style:{"font-size":"14px"},type:n.admin_reply?"success":"warning",size:"large"},{default:o(()=>[u(d(n.admin_reply?"已回复":"待回复"),1)]),_:2},1032,["type"])]),_:1}),s(D,{prop:"note_created_at",label:"创建时间"},{default:o(({row:n})=>[u(d(new Date(n.note_created_at).toLocaleString()),1)]),_:1}),s(D,{label:"操作",width:"150",fixed:"right"},{default:o(({row:n})=>[s(Ve,null,{default:o(()=>[s(m,{type:"primary",onClick:_=>ce(n)},{default:o(()=>e[14]||(e[14]=[u("查看")])),_:2},1032,["onClick"]),s(m,{type:"danger",onClick:_=>ve(n)},{default:o(()=>e[15]||(e[15]=[u("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),s(J,null,{description:o(()=>e[16]||(e[16]=[u(" 暂无学习心得 ")])),_:1})]),_:1},8,["data"])),[[De,B.value]])]),_:1})):(i(),k(J,{key:1,description:"您没有权限查看所有笔记"})),s(Ee,{pagination:y,"onUpdate:pagination":de},null,8,["pagination"]),s(M,{title:"学习心得详情",modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=n=>S.value=n),width:"60%","close-on-click-modal":!1,top:"5vh",class:"note-detail-dialog"},{footer:o(()=>[l("span",vt,[s(m,{onClick:me},{default:o(()=>e[24]||(e[24]=[u("取消")])),_:1}),s(m,{type:"primary",onClick:he,loading:$.value},{default:o(()=>{var n;return[u(d((n=a.value)!=null&&n.admin_reply?"更新回复":"提交回复"),1)]}),_:1},8,["loading"])])]),default:o(()=>{var n,_,Q,X,K,Y,Z,ee,te,ae,le;return[l("div",Ge,[l("div",He,[l("div",Je,[l("h2",Qe,d(((n=a.value)==null?void 0:n.title)||"无标题"),1),l("div",Xe,[l("span",Ke,[e[17]||(e[17]=l("i",{class:"el-icon-user"},null,-1)),l("span",null,d(((Q=(_=a.value)==null?void 0:_.profile)==null?void 0:Q.full_name)||"未知用户"),1)]),l("span",Ye,[e[18]||(e[18]=l("i",{class:"el-icon-message"},null,-1)),l("span",null,d(((K=(X=a.value)==null?void 0:X.profile)==null?void 0:K.email)||"无邮箱"),1)]),l("span",Ze,[e[19]||(e[19]=l("i",{class:"el-icon-time"},null,-1)),l("span",null,d(a.value?new Date((Y=a.value)==null?void 0:Y.note_created_at).toLocaleString():"未知时间"),1)])])]),l("div",et,[e[20]||(e[20]=l("div",{class:"section-title"},"内容",-1)),l("div",tt,d(((Z=a.value)==null?void 0:Z.content)||"无内容"),1)]),(ee=a.value)!=null&&ee.attachment_url?(i(),v("div",at,[e[21]||(e[21]=l("div",{class:"section-title"},"附件",-1)),l("div",lt,[l("span",st,d(a.value.attachment_name),1),s(m,{type:"primary",size:"small",onClick:ye},{default:o(()=>[u(d(I.value?"预览图片":A.value?"预览PDF":L.value?"预览Word":"查看附件"),1)]),_:1})])])):V("",!0),(te=a.value)!=null&&te.admin_reply?(i(),v("div",nt,[e[23]||(e[23]=l("div",{class:"section-title"},"历史回复",-1)),l("div",ot,[l("div",it,[l("span",rt,d(a.value.admin_name||"未知")+":",1)]),l("div",ut,d(a.value.admin_reply),1),a.value.replied_at?(i(),v("div",dt,d(new Date(a.value.replied_at).toLocaleString()),1)):V("",!0),l("div",ct,[x.value?V("",!0):(i(),k(m,{key:0,type:"primary",size:"small",onClick:pe},{default:o(()=>e[22]||(e[22]=[u(" 修改回复 ")])),_:1}))])])])):V("",!0),!((ae=a.value)!=null&&ae.admin_reply)||x.value?(i(),v("div",pt,[l("div",mt,d((le=a.value)!=null&&le.admin_reply?"修改回复":"添加回复"),1),s(q,{type:"textarea",modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=Se=>g.value=Se),rows:4,placeholder:"请输入您的回复内容...",class:"reply-input"},null,8,["modelValue"])])):V("",!0)])])]}),_:1},8,["modelValue"]),s(M,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=n=>U.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{footer:o(()=>[s(m,{onClick:e[5]||(e[5]=n=>U.value=!1)},{default:o(()=>e[27]||(e[27]=[u("关闭")])),_:1}),I.value||A.value?(i(),k(m,{key:0,type:"primary",onClick:O},{default:o(()=>e[28]||(e[28]=[u(" 全屏查看 ")])),_:1})):V("",!0)]),default:o(()=>{var n,_;return[l("div",_t,[I.value?(i(),v("img",{key:0,src:(n=a.value)==null?void 0:n.attachment_url,class:"attachment-image",onClick:O},null,8,ft)):A.value?(i(),v("iframe",{key:1,src:(_=a.value)==null?void 0:_.attachment_url,class:"attachment-frame"},null,8,yt)):L.value?(i(),v("iframe",{key:2,src:F.value,class:"word-preview-frame"},null,8,gt)):(i(),v("div",ht,[e[26]||(e[26]=l("p",null,"无法预览此类型的文件，请下载后查看",-1)),s(m,{type:"primary",onClick:ge},{default:o(()=>e[25]||(e[25]=[u("下载附件")])),_:1})]))])]}),_:1},8,["modelValue"]),s(M,{modelValue:P.value,"onUpdate:modelValue":e[7]||(e[7]=n=>P.value=n),title:"全屏预览",width:"100%",top:"0","show-close":!0,"destroy-on-close":"",class:"fullscreen-dialog"},{default:o(()=>{var n,_;return[l("div",wt,[I.value?(i(),v("img",{key:0,src:(n=a.value)==null?void 0:n.attachment_url,class:"fullscreen-image"},null,8,bt)):A.value?(i(),v("iframe",{key:1,src:(_=a.value)==null?void 0:_.attachment_url,class:"fullscreen-frame"},null,8,kt)):V("",!0)])]}),_:1},8,["modelValue"])])])}}}),zt=Ae(Vt,[["__scopeId","data-v-e202ccd4"]]);export{zt as default};
