import{s as c,u as w,j as m}from"./index-CxnpMWLP.js";const h=e=>{if(e==null){const a=w();e=Number(a.roleId||localStorage.getItem("roleId"))}return e!==null&&[0,1,11].includes(e)},b={async getAllFeedback(e){if(!w().getUser())throw new Error("未登录");const s=(e==null?void 0:e.page)||1,d=(e==null?void 0:e.pageSize)||10,u=(s-1)*d,n=u+d-1;let r=c.from("feedback_with_users").select("*",{count:"exact"});const l=h();if(l||(r=r.eq("is_show",!0)),l&&(e!=null&&e.showStatus)&&(r=r.eq("is_show",e.showStatus==="true")),e!=null&&e.query&&(r=r.or(`title.ilike.%${e.query}%,full_name.ilike.%${e.query}%`)),e!=null&&e.startDate&&(e!=null&&e.endDate)){const{startUTC:_,endUTC:o}=m(e.startDate,e.endDate);r=r.gte("created_at",_).lte("created_at",o)}e!=null&&e.replyStatus&&e.replyStatus!=="all"&&(e.replyStatus==="replied"?r=r.eq("status","resolved"):e.replyStatus==="in_progress"?r=r.eq("status","in_progress"):e.replyStatus==="pending"&&(r=r.eq("status","pending"))),e!=null&&e.platform&&e.platform!=="all"&&(r=r.eq("platform",e.platform)),r=r.order("created_at",{ascending:!1}).range(u,n);const{data:f,error:i,count:g}=await r;if(i)throw new Error("获取反馈失败");return{data:f,total:g||0}},async getPersonalFeedback(e){const t=w().getUser();if(!t)throw new Error("未登录");const s=(e==null?void 0:e.page)||1,d=(e==null?void 0:e.pageSize)||10,u=(s-1)*d,n=u+d-1;let r=c.from("feedback_with_users").select("*",{count:"exact"}).eq("user_id",t.user_id);h()||(r=r.eq("is_show",!0)),e!=null&&e.platform&&e.platform!=="all"&&(r=r.eq("platform",e.platform)),r=r.order("created_at",{ascending:!1}).range(u,n);const{data:f,error:i,count:g}=await r;if(i)throw new Error("获取个人反馈失败");return{data:f,total:g||0}},async createFeedback(e){const t=w().getUser();if(!t)throw new Error("未登录");const{data:s,error:d}=await c.from("feedback").insert([{...e,user_id:t.user_id,is_show:!0}]).select().single();if(d)throw console.error("创建反馈失败:",d),new Error("创建反馈失败");return s},async updateFeedback(e,a){const{data:t,error:s}=await c.from("feedback").update(a).eq("id",e).select().single();if(s)throw console.error("更新反馈失败:",s),new Error("更新反馈失败");return t},async deleteFeedback(e){const{error:a}=await c.from("feedback").delete().eq("id",e);if(a)throw console.error("删除反馈失败:",a),new Error("删除反馈失败")},async hideFeedback(e){const{error:a}=await c.from("feedback").update({is_show:!1}).eq("id",e);if(a)throw console.error("隐藏反馈失败:",a),new Error("隐藏反馈失败")},async getFeedbackReplies(e){const{data:a,error:t}=await c.from("feedback_replies_with_users").select("*").eq("feedback_id",e).order("created_at",{ascending:!1});if(t)throw console.error("获取回复失败:",t),new Error("获取回复失败");return a},async submitReply(e,a){const s=w().getUser();if(!s)throw new Error("未登录");const{data:d,error:u}=await c.from("feedback").select("id").eq("id",e).single();if(u||!d)throw console.error("反馈不存在:",u),new Error("反馈不存在");const{data:n,error:r}=await c.from("feedback_replies").insert([{feedback_id:e,user_id:s.user_id,content:a.content}]).select().single();if(r)throw console.error("创建回复失败:",r),new Error("创建回复失败");if(a.status||a.is_show!==void 0){const l={};a.status&&(l.status=a.status),a.is_show!==void 0&&(l.is_show=a.is_show);const{error:f}=await c.from("feedback").update(l).eq("id",e);if(f)throw console.error("更新反馈状态失败:",f),new Error("更新反馈状态失败")}return n},async checkFeedbackExists(e){const{data:a,error:t}=await c.from("feedback").select("id").eq("id",e).single();return!(t||!a)}};export{b as f,h};
