import{d as Ce,r as w,u as be,k as z,o as De,p as Se,l as T,e as a,a as s,c as B,q as K,t as i,w as n,b as v,s as x,v as Pe,F as O,m as H,g as f,x as Z,y as C,z as b,A as L,B as J,C as Y,D as $,E as Q,f as y,T as xe,G as X,j as g,_ as Ne}from"./index-DCqMzgSt.js";import{t as Fe}from"./testResultService-CQoPyZnv.js";import{a as Ae}from"./assignmentService-DXovFKzm.js";import{f as Ie}from"./feedbackService-D7yke1sU.js";const ze="/assets/banner-C5vi_D6D.png",Ue="/assets/iwish-us-BEKIG9la.jpg",Ve={class:"layout"},Be={class:"dashboard-content"},Le={class:"welcome-section"},Me={class:"date"},qe={class:"stat-icon"},Ee={class:"stat-info"},Oe={class:"stat-value"},He={class:"stat-icon"},Ye={class:"stat-info"},$e={class:"stat-value"},Ge={class:"stat-icon"},je={class:"stat-info"},Re={class:"stat-value"},We={class:"stat-icon"},Ke={class:"stat-info"},Ze={class:"stat-value"},Je={class:"stat-icon"},Qe={class:"stat-info"},Xe={class:"stat-value"},et={class:"stat-icon"},tt={class:"stat-info"},st={class:"stat-value"},nt={class:"stat-icon"},at={class:"stat-info"},lt={class:"stat-value"},ot={class:"stat-icon"},rt={class:"stat-info"},it={class:"stat-value"},ut={class:"card-header"},dt={class:"task-title"},ct={key:0,style:{color:"#E6A23C","font-size":"12px","margin-top":"10px","font-weight":"bold"}},_t={key:1,style:{color:"#909399","font-size":"12px","margin-top":"10px"}},ft={key:2,style:{color:"#F56C6C","font-size":"12px","margin-top":"10px"}},vt={class:"quick-links"},mt={class:"quick-link-group"},yt={class:"quick-link-group"},gt={class:"notice-list fixed-notice-list"},pt=["onClick"],ht={class:"notice-title"},wt={class:"notice-time"},Tt={class:"notice-dialog-header"},kt={class:"notice-dialog-title"},Ct={class:"notice-time"},bt={class:"notice-dialog-content"},Dt=["innerHTML"],St={class:"notice-dialog-footer"},ee=5,Pt=Ce({__name:"SystemHome",setup(xt){const te=w([ze,Ue]);w(null);const k=be(),se=z(()=>{var e;return((e=k.user)==null?void 0:e.full_name)||"用户"}),D=w([]),ne=z(()=>new Date().toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"})),ae=z(()=>{var e,t,r;return((e=k.user)==null?void 0:e.role_id)===0||((t=k.user)==null?void 0:t.role_id)===1||((r=k.user)==null?void 0:r.role_id)===11}),l=w({activeUsers:0,userTrend:0,studyCount:0,studyPending:0,testCount:0,testPending:0,assignmentsCount:0,assignmentsPending:0,yourStudyCount:0,yourStudyPending:0,yourTestCount:0,yourTestPending:0,yourAssignmentsCount:0,yourAssignmentsPending:0,feedbackCount:0,feedbackTrend:0,myFeedbackCount:0,myFeedbackTrend:0}),le=async()=>{try{const{data:e,error:t}=await x.from("user_profiles").select("*");if(t)throw t;const r=new Date,u=e==null?void 0:e.filter(p=>new Date(p.created_at).toDateString()===r.toDateString());l.value.activeUsers=(e==null?void 0:e.length)||0,l.value.userTrend=(u==null?void 0:u.length)||0}catch(e){console.error("获取用户失败:",e)}},oe=async()=>{try{const{data:e,error:t}=await x.from("study_notes").select("*");if(t)throw t;l.value.studyCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.admin_reply===null);l.value.studyPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取学习记录失败:",e)}},re=async()=>{try{const{data:e,error:t}=await x.from("test_results").select("*");if(t)throw t;l.value.testCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.feedback_text===null&&u.type==="case");l.value.testPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取测试结果失败:",e)}},ie=async()=>{try{const{data:e,error:t}=await x.from("assignments").select("*");if(t)throw t;l.value.assignmentsCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.admin_reply===null);l.value.assignmentsPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取日常作业失败:",e)}},ue=async()=>{const e=await Pe.getNotes();l.value.yourStudyCount=(e==null?void 0:e.length)||0;const t=e==null?void 0:e.filter(r=>r.admin_reply===null);l.value.yourStudyPending=(t==null?void 0:t.length)||0,e||console.error("获取你的心得失败")},de=async()=>{const{data:e,total:t}=await Fe.getUserTestResults({page:1,pageSize:1e3});l.value.yourTestCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.feedback_text===null&&u.type==="case");l.value.yourTestPending=(r==null?void 0:r.length)||0,e||console.error("获取你的测试失败")},ce=async()=>{try{const{data:e,total:t}=await Ae.getPersonalAssignments(1,1e3);l.value.yourAssignmentsCount=t||0}catch(e){console.error("获取你的作业失败:",e)}},_e=async()=>{var e;try{const{data:t}=await Ie.getPersonalFeedback();l.value.myFeedbackCount=(t==null?void 0:t.length)||0,l.value.myFeedbackTrend=((e=t==null?void 0:t.filter(r=>r.replied_at==null))==null?void 0:e.length)||0}catch(t){console.error("获取反馈失败:",t)}},M=w([]),fe=async()=>{var r;const{data:e,error:t}=await x.from("tasks").select("*").eq("assigned_to",(r=k.user)==null?void 0:r.user_id);if(t)throw t;M.value=e.filter(u=>u.status!=="completed").map(u=>{const p=new Date(u.due_date),d=new Date,c=new Date(p.getFullYear(),p.getMonth(),p.getDate()),_=new Date(d.getFullYear(),d.getMonth(),d.getDate()),m=c<_,F=Math.abs(c.getTime()-_.getTime()),S=Math.ceil(F/(1e3*60*60*24)),E=c.getTime()===_.getTime();return{...u,diffDays:S,isOverdue:m,isToday:E}}).sort((u,p)=>new Date(u.due_date).getTime()-new Date(p.due_date).getTime()),console.log(M.value)};function G(e){switch(e){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function ve(e){switch(e){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function me(e){switch(e){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function ye(e){switch(e){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}const ge=async()=>{try{const{data:e,error:t}=await x.from("announcements").select("*");if(t)throw t;D.value=e}catch(e){console.error("获取系统公告失败:",e)}},j=e=>{switch(e){case"important":return"danger";case"normal":return"success";case"update":return"warning";default:return"info"}},R=e=>{switch(e){case"important":return"重要";case"normal":return"新";case"update":return"更新";default:return"其他"}},U=w(!1),pe=w(""),W=w(null),N=z(()=>D.value.find(e=>e.id===W.value)||null),he=e=>{W.value=e,U.value=!0},V=w(0);let q=null;const we=z(()=>{const e=[],t=D.value.length;for(let r=0;r<ee;r++)if(t===0)e.push({id:null,title:"",type:"",created_at:""});else{const u=(V.value+r)%t;e.push(D.value[u]||{id:null,title:"",type:"",created_at:""})}return e});return De(()=>{Promise.all([le(),oe(),re(),ie(),ue(),de(),ce(),ge(),fe(),_e()]).catch(e=>{console.error("加载数据失败:",e)}),q=setInterval(()=>{D.value.length>ee?V.value=(V.value+1)%D.value.length:V.value=0},3e3)}),Se(()=>{q&&clearInterval(q)}),(e,t)=>{const r=v("el-image"),u=v("el-carousel-item"),p=v("el-carousel"),d=v("el-icon"),c=v("el-link"),_=v("el-card"),m=v("el-col"),F=v("el-row"),S=v("el-tag"),E=v("el-timeline-item"),Te=v("el-timeline"),A=v("el-button"),ke=v("el-dialog");return g(),T("div",Ve,[a("div",Be,[a("div",Le,[a("h2",null,"欢迎回来，"+i(se.value),1),a("p",Me,i(ne.value),1)]),s(p,{"indicator-position":"outside",height:"500px"},{default:n(()=>[(g(!0),T(O,null,H(te.value,o=>(g(),B(u,{key:o},{default:n(()=>[s(r,{src:o},{placeholder:n(()=>t[2]||(t[2]=[a("div",{class:"image-slot"},[y("Loading"),a("span",{class:"dot"},"...")],-1)])),_:2},1032,["src"])]),_:2},1024))),128))]),_:1}),ae.value?(g(),B(F,{key:0,gutter:20,class:"stat-cards"},{default:n(()=>[s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/users"},{default:n(()=>[a("div",qe,[s(d,null,{default:n(()=>[s(f(Z))]),_:1})])]),_:1}),a("div",Ee,[t[3]||(t[3]=a("div",{class:"stat-title"},"系统用户",-1)),a("div",Oe,i(l.value.activeUsers),1),C(a("div",{class:L(["stat-trend",{up:l.value.userTrend>0}])}," 新增： "+i(l.value.userTrend>0?"+":"")+i(l.value.userTrend),3),[[b,l.value.userTrend>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-study-notes"},{default:n(()=>[a("div",He,[s(d,null,{default:n(()=>[s(f(J))]),_:1})])]),_:1}),a("div",Ye,[t[4]||(t[4]=a("div",{class:"stat-title"},"学习心得",-1)),a("div",$e,i(l.value.studyCount),1),C(a("div",{class:"stat-trend"}," 待回复： "+i(l.value.studyPending),513),[[b,l.value.studyPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-test-result"},{default:n(()=>[a("div",Ge,[s(d,null,{default:n(()=>[s(f(Y))]),_:1})])]),_:1}),a("div",je,[t[5]||(t[5]=a("div",{class:"stat-title"},"测试结果",-1)),a("div",Re,i(l.value.testCount),1),C(a("div",{class:"stat-trend"}," 待批改： "+i(l.value.testPending),513),[[b,l.value.testPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-assignments"},{default:n(()=>[a("div",We,[s(d,null,{default:n(()=>[s(f($))]),_:1})])]),_:1}),a("div",Ke,[t[6]||(t[6]=a("div",{class:"stat-title"},"日常作业",-1)),a("div",Ze,i(l.value.assignmentsCount),1),C(a("div",{class:"stat-trend"}," 待批改： "+i(l.value.assignmentsPending),513),[[b,l.value.assignmentsPending>0]])])]),_:1})]),_:1})]),_:1})):K("",!0),s(F,{gutter:20,class:"stat-cards"},{default:n(()=>[s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/study-notes"},{default:n(()=>[a("div",Je,[s(d,null,{default:n(()=>[s(f(J))]),_:1})])]),_:1}),a("div",Qe,[t[7]||(t[7]=a("div",{class:"stat-title"},"我的心得",-1)),a("div",Xe,i(l.value.yourStudyCount),1),C(a("div",{class:L(["stat-trend",{up:l.value.yourStudyPending>0}])}," 待回复： "+i(l.value.yourStudyPending>0?"+":"")+i(l.value.yourStudyPending),3),[[b,l.value.yourStudyPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/test-result"},{default:n(()=>[a("div",et,[s(d,null,{default:n(()=>[s(f(Y))]),_:1})])]),_:1}),a("div",tt,[t[8]||(t[8]=a("div",{class:"stat-title"},"我的测试",-1)),a("div",st,i(l.value.yourTestCount),1),C(a("div",{class:L(["stat-trend",{up:l.value.yourTestPending>0}])}," 待批改："+i(l.value.yourTestPending>0?"+":"")+i(l.value.yourTestPending),3),[[b,l.value.yourTestPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/daily-assignments"},{default:n(()=>[a("div",nt,[s(d,null,{default:n(()=>[s(f($))]),_:1})])]),_:1}),a("div",at,[t[9]||(t[9]=a("div",{class:"stat-title"},"我的作业",-1)),a("div",lt,i(l.value.yourAssignmentsCount),1)])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[a("div",ot,[s(d,null,{default:n(()=>[s(f(Q))]),_:1})])]),_:1}),a("div",rt,[t[10]||(t[10]=a("div",{class:"stat-title"},"我的反馈",-1)),a("div",it,i(l.value.myFeedbackCount),1),C(a("div",{class:L(["stat-trend",{up:l.value.myFeedbackTrend>0}])}," 待处理："+i(l.value.myFeedbackTrend>0?"+":"")+i(l.value.myFeedbackTrend),3),[[b,l.value.myFeedbackTrend>0]])])]),_:1})]),_:1})]),_:1}),s(F,{gutter:20,class:"main-content"},{default:n(()=>[s(m,{span:16},{default:n(()=>[s(_,{class:"task-card",style:{"min-height":"200px"}},{header:n(()=>[a("div",ut,[t[12]||(t[12]=a("span",null,"待办任务",-1)),s(c,{type:"primary",link:"",href:"/system/task-management"},{default:n(()=>t[11]||(t[11]=[y(" 查看全部 ")])),_:1})])]),default:n(()=>[s(Te,null,{default:n(()=>[(g(!0),T(O,null,H(M.value,(o,h)=>(g(),B(E,{key:h,type:G(o.priority),timestamp:o.due_date,placement:"top"},{default:n(()=>[s(_,{class:"task-item"},{default:n(()=>[a("div",dt,[a("h4",null,i(o.title),1),s(S,{class:"status-tag",type:me(o.status)},{default:n(()=>[y(i(ye(o.status)),1)]),_:2},1032,["type"]),t[13]||(t[13]=y()),s(S,{type:G(o.priority)},{default:n(()=>[y(i(ve(o.priority)),1)]),_:2},1032,["type"])]),a("p",null,i(o.description),1),o.isToday?(g(),T("p",ct," 今天到期 ")):o.isOverdue?(g(),T("p",ft," 已过期："+i(o.diffDays)+"天 ",1)):(g(),T("p",_t," 距离截止日期："+i(o.diffDays)+"天 ",1))]),_:2},1024)]),_:2},1032,["type","timestamp"]))),128))]),_:1})]),_:1})]),_:1}),s(m,{span:8},{default:n(()=>[s(_,{class:"quick-access"},{header:n(()=>t[14]||(t[14]=[a("div",{class:"card-header"},[a("span",null,"快捷入口")],-1)])),default:n(()=>{var o,h,P,I;return[a("div",vt,[a("div",mt,[s(c,{underline:!1,href:"/system/personal-data"},{default:n(()=>[s(A,{type:"primary",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f(Z))]),_:1}),t[15]||(t[15]=y(" 个人中心 "))]),_:1})]),_:1}),s(c,{underline:!1,href:`/system/training/study-material-folder?platform=${(h=(o=f(k).user)==null?void 0:o.role)==null?void 0:h.mark[0]}`},{default:n(()=>[s(A,{type:"success",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f(Y))]),_:1}),t[16]||(t[16]=y(" 学习资料 "))]),_:1})]),_:1},8,["href"])]),a("div",yt,[s(c,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[s(A,{type:"warning",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f(Q))]),_:1}),t[17]||(t[17]=y(" 反馈中心 "))]),_:1})]),_:1}),s(c,{underline:!1,href:`/system/daily-work/personal-assignments?platform=${(I=(P=f(k).user)==null?void 0:P.role)==null?void 0:I.mark[0]}`},{default:n(()=>[s(A,{type:"info",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f($))]),_:1}),t[18]||(t[18]=y(" 日常作业 "))]),_:1})]),_:1},8,["href"])])])]}),_:1}),s(_,{class:"notice-card"},{header:n(()=>t[19]||(t[19]=[a("div",{class:"card-header"},[a("span",null,"系统公告")],-1)])),default:n(()=>[a("div",gt,[s(xe,{name:"notice-fade",tag:"div"},{default:n(()=>[(g(!0),T(O,null,H(we.value,(o,h)=>(g(),T("div",{key:o.id?o.id:"empty-"+h,class:"notice-item",onClick:P=>o.id&&he(o.id)},[o.id?(g(),B(S,{key:0,type:j(o.type),size:"small"},{default:n(()=>[y(i(R(o.type)),1)]),_:2},1032,["type"])):K("",!0),a("span",ht,i(o.title||""),1),a("span",wt,i(o.created_at?f(X)(o.created_at):""),1)],8,pt))),128))]),_:1})])]),_:1})]),_:1})]),_:1})]),s(ke,{modelValue:U.value,"onUpdate:modelValue":t[1]||(t[1]=o=>U.value=o),title:pe.value,width:"40%",class:"notice-dialog","close-on-click-modal":!1},{header:n(()=>{var o,h,P;return[a("div",Tt,[s(S,{type:j(((o=N.value)==null?void 0:o.type)||""),size:"small",class:"notice-type-tag"},{default:n(()=>{var I;return[y(i(R(((I=N.value)==null?void 0:I.type)||"")),1)]}),_:1},8,["type"]),a("span",kt,i(((h=N.value)==null?void 0:h.title)||""),1),a("span",Ct,i(f(X)(((P=N.value)==null?void 0:P.created_at)||"")),1)])]}),footer:n(()=>[a("div",St,[s(A,{type:"primary",onClick:t[0]||(t[0]=o=>U.value=!1)},{default:n(()=>t[20]||(t[20]=[y("关闭")])),_:1})])]),default:n(()=>{var o;return[a("div",bt,[a("div",{innerHTML:(o=N.value)==null?void 0:o.content,class:"notice-content"},null,8,Dt)])]}),_:1},8,["modelValue","title"])])}}}),zt=Ne(Pt,[["__scopeId","data-v-47cd16eb"]]);export{zt as default};
