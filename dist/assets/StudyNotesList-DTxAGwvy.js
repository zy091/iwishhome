import{x as de,r,X as re,c as O,j as ce,y as _,A as t,P as s,I as pe,J as g,M as c,H as a,ag as m,aq as ve,G as D,L as v,u as M,az as _e,z as i}from"./vendor-COQJj1AX.js";import{E as y,w as me,h as fe,x as ye,v as ge,y as he}from"./elementPlus-Dv7g5dxn.js";import{b as be,a as R,s as X,_ as ke}from"./index-Dc3VxstI.js";import"./supabase-Bqqw4QDB.js";const we={class:"study-notes-list"},Ve={class:"study-body",style:{"min-height":"400px"}},xe={class:"study-header"},Ce={class:"header-left"},De={class:"header-stats"},Ne={key:1},Se={key:1,class:"empty-state"},Le={class:"empty-icon"},ze={class:"attachment-box"},Ue={class:"attachment-name"},Ee={key:1,class:"dialog-content"},$e={class:"note-details"},Ae={class:"note-header"},Ie={class:"note-title"},Me={class:"note-meta"},Be={class:"meta-item"},Fe={key:0,class:"meta-item"},Pe={class:"note-section"},qe={class:"note-content"},Re={key:0,class:"note-section"},Te={class:"attachment-box"},je={class:"attachment-name"},We={key:1,class:"note-section"},Ge={class:"previous-reply"},He={class:"reply-header"},Je={class:"reply-author"},Oe={class:"admin-reply-content"},Xe={key:0,class:"reply-timestamp"},Ke={class:"dialog-footer"},Qe={class:"attachment-preview"},Ye=["src"],Ze=["src"],et={key:2,class:"attachment-download"},tt=de({__name:"StudyNotesList",setup(at){_e();const S=r(!1),L=r([]),h=re({page:1,pageSize:10,total:0}),w=r(!1),b=r(!1),N=r(!1),B=r(""),F=r(),o=r({}),T=r([]);r(!1);const z=r(!1),V=r(""),x=r(""),k=r(null),f=r({title:"",content:""}),K={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},j=O(()=>x.value?x.value.startsWith("image/"):!1),W=O(()=>x.value?x.value==="application/pdf":!1),Q=()=>N.value?"查看心得":b.value?"编辑心得":"新建心得",P=r([]),U=async()=>{S.value=!0;try{P.value=await R.getNotes(),h.total=P.value.length;const l=(h.page-1)*h.pageSize,e=l+h.pageSize;L.value=P.value.slice(l,e)}catch{y.error("获取心得列表失败")}finally{S.value=!1}},Y=l=>{N.value=!0,b.value=!1,B.value=l.id,o.value=l,w.value=!0},Z=l=>{if(l.admin_reply){y.warning("已回复的心得不能修改");return}b.value=!0,N.value=!1,B.value=l.id,o.value=l,f.value={title:l.title,content:l.content},T.value=[],k.value=null,w.value=!0},ee=l=>{l.attachment_url?(V.value=l.attachment_url,x.value=l.attachment_type||"",z.value=!0):y.warning("该心得没有附件")},te=()=>{var l;(l=o.value)!=null&&l.attachment_url&&(V.value=o.value.attachment_url,x.value=o.value.attachment_type||"",z.value=!0)},G=()=>{V.value?window.open(V.value,"_blank"):o.value.attachment_url&&window.open(o.value.attachment_url,"_blank")},ae=l=>l.size/1024/1024<10?!0:(y.error("文件大小不能超过 10MB!"),!1),le=async l=>{const{file:e,onSuccess:u,onError:d}=l;if(!e){d==null||d(new Error("文件不存在"));return}const E=he.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const p=e,q=p.name.split(".").pop(),$=`study_notes/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${q}`}`,{data:C,error:A}=await X.storage.from("attachments").upload($,p,{cacheControl:"3600",upsert:!1});if(A)throw A;const{data:{publicUrl:I}}=X.storage.from("attachments").getPublicUrl(C.path);k.value={url:I,name:p.name,type:p.type},u==null||u(k.value),y.success("文件上传成功")}catch(p){console.error("文件上传错误:",p),d==null||d(new Error(p instanceof Error?p.message:"上传失败")),y.error("文件上传失败，请重试")}finally{E.close()}},se=()=>{k.value=null},oe=async()=>{F.value&&await F.value.validate(async l=>{var e,u,d;if(l)try{b.value?(await R.updateNote(B.value,{title:f.value.title,content:f.value.content}),y.success("修改成功")):(await R.createNote({...f.value,attachment_url:(e=k.value)==null?void 0:e.url,attachment_name:(u=k.value)==null?void 0:u.name,attachment_type:(d=k.value)==null?void 0:d.type}),y.success("创建成功")),w.value=!1,U()}catch{y.error(b.value?"修改失败":"创建失败")}})},ne=()=>{U()},ie=l=>{h.page=l.page,h.pageSize=l.pageSize,U()};return ce(()=>{U()}),(l,e)=>{const u=m("el-button"),d=m("el-table-column"),E=m("el-tag"),p=m("el-icon"),q=m("el-button-group"),H=m("el-table"),$=m("el-input"),C=m("el-form-item"),A=m("el-upload"),I=m("el-dialog"),ue=ve("loading");return i(),_("div",we,[t("div",Ve,[t("div",xe,[t("div",Ce,[e[5]||(e[5]=t("div",{class:"header-title"},"学习心得列表",-1)),t("div",De,"共计 "+c(L.value.length)+" 篇心得",1)]),s(u,{type:"primary",onClick:ne},{default:a(()=>e[6]||(e[6]=[v("刷新")])),_:1})]),L.value.length>0?pe((i(),D(H,{key:0,data:L.value},{default:a(()=>[s(d,{prop:"title",label:"标题"}),s(d,{label:"状态",width:"100"},{default:a(({row:n})=>[s(E,{type:n.admin_reply?"success":"info"},{default:a(()=>[v(c(n.admin_reply?"已回复":"未回复"),1)]),_:2},1032,["type"])]),_:1}),s(d,{label:"附件",width:"80"},{default:a(({row:n})=>[n.attachment_url?(i(),D(u,{key:0,type:"primary",link:"",onClick:J=>ee(n)},{default:a(()=>[s(p,{color:"#409EFF",size:"18"},{default:a(()=>[s(M(me))]),_:1})]),_:2},1032,["onClick"])):(i(),_("span",Ne,"-"))]),_:1}),s(d,{prop:"created_at",label:"创建时间",width:"180"},{default:a(({row:n})=>[v(c(new Date(n.created_at).toLocaleString()),1)]),_:1}),s(d,{prop:"updated_at",label:"修改时间",width:"180"},{default:a(({row:n})=>[v(c(n.updated_at?new Date(n.updated_at).toLocaleString():"-"),1)]),_:1}),s(d,{label:"操作",width:"160"},{default:a(({row:n})=>[s(q,null,{default:a(()=>[s(u,{type:"primary",onClick:J=>Y(n)},{default:a(()=>e[7]||(e[7]=[v("查看")])),_:2},1032,["onClick"]),s(u,{type:"warning",onClick:J=>Z(n),disabled:!!n.admin_reply},{default:a(()=>e[8]||(e[8]=[v("编辑")])),_:2},1032,["onClick","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ue,S.value]]):S.value?g("",!0):(i(),_("div",Se,[t("div",Le,[s(p,{size:"60",color:"#c0c4cc"},{default:a(()=>[s(M(fe))]),_:1})]),e[9]||(e[9]=t("div",{class:"empty-text"},"暂无学习心得",-1))]))]),s(be,{pagination:h,"onUpdate:pagination":ie},null,8,["pagination"]),s(I,{title:Q(),modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=n=>w.value=n),width:"60%","close-on-click-modal":!1,top:"10vh",class:"note-detail-dialog"},{footer:a(()=>[t("span",Ke,[s(u,{onClick:e[2]||(e[2]=n=>w.value=!1)},{default:a(()=>e[19]||(e[19]=[v("关闭")])),_:1}),N.value?g("",!0):(i(),D(u,{key:0,type:"primary",onClick:oe},{default:a(()=>e[20]||(e[20]=[v("确定")])),_:1}))])]),default:a(()=>[N.value?(i(),_("div",Ee,[t("div",$e,[t("div",Ae,[t("h2",Ie,c(o.value.title||"无标题"),1),t("div",Me,[t("span",Be,[e[14]||(e[14]=t("i",{class:"el-icon-time"},null,-1)),t("span",null,"提交于: "+c(new Date(o.value.created_at).toLocaleString()),1)]),o.value.updated_at&&o.value.updated_at!==o.value.created_at?(i(),_("span",Fe,[e[15]||(e[15]=t("i",{class:"el-icon-edit"},null,-1)),t("span",null,"修改于: "+c(new Date(o.value.updated_at).toLocaleString()),1)])):g("",!0)])]),t("div",Pe,[e[16]||(e[16]=t("div",{class:"section-title"},"我的内容",-1)),t("div",qe,c(o.value.content||"无内容"),1)]),o.value.attachment_url?(i(),_("div",Re,[e[17]||(e[17]=t("div",{class:"section-title"},"附件",-1)),t("div",Te,[t("span",je,c(o.value.attachment_name),1),s(u,{type:"primary",size:"small",onClick:te},{default:a(()=>[v(c(j.value?"预览图片":W.value?"预览PDF":"查看附件"),1)]),_:1})])])):g("",!0),o.value.admin_reply?(i(),_("div",We,[e[18]||(e[18]=t("div",{class:"section-title"},"管理员回复",-1)),t("div",Ge,[t("div",He,[t("span",Je,c(o.value.admin_name||"未知")+":",1)]),t("div",Oe,c(o.value.admin_reply),1),o.value.replied_at?(i(),_("div",Xe," 回复于： "+c(new Date(o.value.replied_at).toLocaleString()),1)):g("",!0)])])):g("",!0)])])):(i(),D(M(ge),{key:0,model:f.value,ref_key:"formRef",ref:F,rules:K},{default:a(()=>[s(C,{label:"标题",prop:"title"},{default:a(()=>[s($,{modelValue:f.value.title,"onUpdate:modelValue":e[0]||(e[0]=n=>f.value.title=n)},null,8,["modelValue"])]),_:1}),s(C,{label:"内容",prop:"content"},{default:a(()=>[s($,{modelValue:f.value.content,"onUpdate:modelValue":e[1]||(e[1]=n=>f.value.content=n),type:"textarea",rows:6},null,8,["modelValue"])]),_:1}),b.value?g("",!0):(i(),D(C,{key:0,label:"附件"},{default:a(()=>[s(A,{class:"upload-container",drag:"","auto-upload":!0,"http-request":le,"on-remove":se,"before-upload":ae,limit:1,"file-list":T.value},{tip:a(()=>e[10]||(e[10]=[t("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[s(p,{class:"el-icon--upload"},{default:a(()=>[s(M(ye))]),_:1}),e[11]||(e[11]=t("div",{class:"el-upload__text"},[v(" 将文件拖到此处，或"),t("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})),b.value&&o.value.attachment_url?(i(),D(C,{key:1,label:"当前附件"},{default:a(()=>[t("div",ze,[t("span",Ue,c(o.value.attachment_name),1),s(u,{type:"primary",size:"small",onClick:G},{default:a(()=>e[12]||(e[12]=[v("下载")])),_:1})]),e[13]||(e[13]=t("div",{class:"el-upload__tip",style:{"margin-top":"8px"}}," 注意：编辑模式下暂不支持修改附件 ",-1))]),_:1})):g("",!0)]),_:1},8,["model"]))]),_:1},8,["title","modelValue"]),s(I,{modelValue:z.value,"onUpdate:modelValue":e[4]||(e[4]=n=>z.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{default:a(()=>[t("div",Qe,[j.value?(i(),_("img",{key:0,src:V.value,class:"attachment-image"},null,8,Ye)):W.value?(i(),_("iframe",{key:1,src:V.value,class:"attachment-frame"},null,8,Ze)):(i(),_("div",et,[e[22]||(e[22]=t("p",null,"无法预览此类型的文件，请下载后查看",-1)),s(u,{type:"primary",onClick:G},{default:a(()=>e[21]||(e[21]=[v("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])}}}),it=ke(tt,[["__scopeId","data-v-905c30b2"]]);export{it as default};
