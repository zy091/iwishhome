import{E as f,s as ke,c as he}from"./elementPlus-Dv7g5dxn.js";import{u as Se,B as De,b as xe,s as h,_ as Ue}from"./index-02dAV7KX.js";import{x as Ce,c as A,r as d,j as qe,y as R,P as t,A as w,H as r,ag as p,G as U,J as E,u as ze,L as i,I as Me,aq as Te,M as V,O as Q,a6 as K,z as y}from"./vendor-COQJj1AX.js";import"./supabase-BNvKcJjS.js";const Le={class:"layout"},Ye={class:"task-content"},$e={class:"card-header"},Ie={class:"header-actions"},Be={style:{"font-size":"14px",color:"#909399"}},Fe={class:"dialog-footer"},Oe={class:"dialog-footer"},Ae=Ce({__name:"TaskManagement",setup(Re){var P;const W=[{name:"任务管理",path:"/system/task-management"}],C=Se(),S=(P=C.user)==null?void 0:P.user_id,k=A(()=>{var l,e,o;return((l=C.user)==null?void 0:l.role_id)===0||((e=C.user)==null?void 0:e.role_id)===1||((o=C.user)==null?void 0:o.role_id)===11}),X=A(()=>{var l;return s.value.creator&&s.value.creator.full_name?s.value.creator.full_name:((l=C.user)==null?void 0:l.full_name)||""}),Y=d(!1),$=d([]),T=d(""),L=d(""),D=d(null),x=d(!1),I=d(""),B=d(null),q=d(!1),F=d(null),O=d([]),v=d({page:1,pageSize:10,total:0}),s=d({title:"",description:"",priority:"medium",status:"pending",due_date:"",assigned_to:null}),n=d({title:"",description:"",priority:"medium",due_date:"",assigned_to:[]}),Z={title:[{required:!0,message:"请输入任务名称",trigger:"blur"}],description:[{required:!0,message:"请输入任务描述",trigger:"blur"}],priority:[{required:!0,message:"请选择任务优先级",trigger:"change"}],status:[{required:!0,message:"请选择任务状态",trigger:"change"}],due_date:[{required:!0,message:"请选择截止日期",trigger:"change"}]},ee={title:[{required:!0,message:"请输入任务名称",trigger:"blur"}],description:[{required:!0,message:"请输入任务描述",trigger:"blur"}],priority:[{required:!0,message:"请选择任务优先级",trigger:"change"}],due_date:[{required:!0,message:"请选择截止日期",trigger:"change"}],assigned_to:[{required:!0,message:"请选择要指派的用户",trigger:"change"}]},N=d([]),te=A(()=>{const l=(v.value.page-1)*v.value.pageSize,e=l+v.value.pageSize;return $.value.slice(l,e)}),z=async()=>{Y.value=!0;try{let l=h.from("tasks").select(`
                *,
                assignee:user_profiles!tasks_assigned_to_fkey(
                    user_id,
                    full_name
                ),
                creator:user_profiles!tasks_user_id_fkey(
                    user_id,
                    full_name
                )
            `).order("created_at",{ascending:!1});k.value||(l=l.eq("assigned_to",S));const{data:e,error:o}=await l;if(o)throw o;$.value=e||[],N.value=e||[],v.value.total=(e==null?void 0:e.length)||0}catch(l){console.error("获取任务列表失败:",l),f.error("获取任务列表失败")}finally{Y.value=!1}},ae=async()=>{if(k.value)try{const{data:l,error:e}=await h.from("user_profiles").select("user_id, full_name").order("full_name");if(e)throw e;O.value=l||[]}catch(l){console.error("获取用户列表失败:",l),f.error("获取用户列表失败")}},le=l=>{v.value.page=l.page,v.value.pageSize=l.pageSize},re=()=>{v.value.page=1;let l=[...N.value];if(T.value&&(l=l.filter(e=>e.title.toLowerCase().includes(T.value.toLowerCase()))),L.value&&(l=l.filter(e=>e.status===L.value)),D.value&&D.value[0]&&D.value[1]){const[e,o]=D.value;l=l.filter(u=>{const g=new Date(u.due_date).toISOString().split("T")[0];return g>=e&&g<=o})}$.value=l,v.value.total=l.length},oe=()=>{I.value="添加任务",s.value={title:"",description:"",priority:"medium",status:"pending",due_date:"",assigned_to:k.value?null:S},x.value=!0},se=l=>{I.value="编辑任务",s.value={...l},x.value=!0},ue=async l=>{const e=l.status==="pending"?"in_progress":"completed";try{const{error:o}=await h.from("tasks").update({status:e,updated_at:new Date().toISOString()}).eq("id",l.id);if(o)throw o;f.success("更新状态成功"),z()}catch(o){console.error("更新状态失败:",o),f.error("更新状态失败")}},ne=async l=>{try{await he.confirm("确定要删除该任务吗？此操作不可恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const{error:e}=await h.from("tasks").delete().eq("id",l.id);if(e)throw e;f.success("删除成功"),z()}catch(e){e!=="cancel"&&(console.error("删除任务失败:",e),f.error("删除失败"))}},ie=async()=>{B.value&&await B.value.validate(async l=>{if(l)try{if(!k.value)s.value.assigned_to=S,s.value.user_id=S;else if(s.value.assigned_to)s.value.user_id=S;else{f.warning("请选择要指派的用户");return}const e={...s.value};if(delete e.assignee,delete e.creator,s.value.id){const{error:o}=await h.from("tasks").update({...e,updated_at:new Date().toISOString()}).eq("id",s.value.id);if(o)throw o;f.success("更新成功")}else{const{error:o}=await h.from("tasks").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(o)throw o;f.success("创建成功")}x.value=!1,z()}catch(e){console.error(s.value.id?"更新失败:":"创建失败:",e),f.error(s.value.id?"更新失败":"创建失败")}})},de=async()=>{F.value&&await F.value.validate(async l=>{if(l)try{const e=n.value.assigned_to.map(u=>({title:n.value.title,description:n.value.description,priority:n.value.priority,status:"pending",due_date:n.value.due_date,assigned_to:u,user_id:S,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),{error:o}=await h.from("tasks").insert(e);if(o)throw o;f.success(`成功指派任务给 ${e.length} 位用户`),q.value=!1,z(),n.value={title:"",description:"",priority:"medium",due_date:"",assigned_to:[]}}catch(e){console.error("批量指派失败:",e),f.error("批量指派失败")}})};function pe(l){return l?new Date(l).toISOString().split("T")[0]:"-"}function me(l){if(!l)return"-";const e=new Date(l),o=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),g=String(e.getDate()).padStart(2,"0"),M=String(e.getHours()).padStart(2,"0"),m=String(e.getMinutes()).padStart(2,"0");return`${o}-${u}-${g} ${M}:${m}`}function ce(l){switch(l){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function fe(l){switch(l){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function ge(l){switch(l){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function ve(l){switch(l){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}function _e(l){switch(l){case"pending":return"开始";case"in_progress":return"完成";case"completed":return"已完成";default:return"更新"}}return qe(async()=>{await Promise.all([z(),ae()])}),(l,e)=>{const o=p("el-input"),u=p("el-option"),g=p("el-select"),M=p("el-date-picker"),m=p("el-button"),ye=p("el-space"),H=p("el-card"),_=p("el-table-column"),j=p("el-tag"),be=p("el-button-group"),we=p("el-table"),c=p("el-form-item"),G=p("el-form"),J=p("el-dialog"),Ve=Te("loading");return y(),R("div",Le,[t(De,{breadbcrum:W}),e[29]||(e[29]=w("div",{class:"layout-title"},[w("h1",{class:"title"},"任务管理")],-1)),t(H,{shadow:"always",style:{"margin-bottom":"20px"}},{default:r(()=>[t(ye,{wrap:"",alignment:"start",size:30},{default:r(()=>[t(o,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=a=>T.value=a),style:{width:"240px"},placeholder:"请输入任务名称","suffix-icon":ze(ke),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),t(g,{modelValue:L.value,"onUpdate:modelValue":e[1]||(e[1]=a=>L.value=a),placeholder:"状态",clearable:"",style:{width:"150px"},size:"large"},{default:r(()=>[t(u,{label:"待完成",value:"pending"}),t(u,{label:"进行中",value:"in_progress"}),t(u,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"]),t(M,{modelValue:D.value,"onUpdate:modelValue":e[2]||(e[2]=a=>D.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"300px"},size:"large"},null,8,["modelValue"]),t(m,{type:"primary",size:"large",onClick:re},{default:r(()=>e[19]||(e[19]=[i("搜索")])),_:1}),t(m,{type:"success",size:"large",onClick:oe},{default:r(()=>e[20]||(e[20]=[i("添加任务")])),_:1}),k.value?(y(),U(m,{key:0,type:"info",size:"large",onClick:e[3]||(e[3]=a=>q.value=!0)},{default:r(()=>e[21]||(e[21]=[i("批量指派任务")])),_:1})):E("",!0)]),_:1})]),_:1}),w("div",Ye,[t(H,{shadow:"always"},{header:r(()=>[w("div",$e,[e[22]||(e[22]=i(" 任务列表 ")),w("div",Ie,[w("div",Be,"共计"+V(v.value.total)+"条数据",1)])])]),default:r(()=>[Me((y(),U(we,{data:te.value,"row-key":"id",stripe:"",height:"400px"},{default:r(()=>[t(_,{prop:"id",label:"ID",width:"80"}),t(_,{prop:"title",label:"任务名称",width:"200"}),t(_,{prop:"description",label:"任务描述","show-overflow-tooltip":""}),t(_,{prop:"priority",label:"优先级",width:"100"},{default:r(({row:a})=>[t(j,{type:ce(a.priority)},{default:r(()=>[i(V(fe(a.priority)),1)]),_:2},1032,["type"])]),_:1}),t(_,{prop:"status",label:"状态",width:"100"},{default:r(({row:a})=>[t(j,{type:ge(a.status)},{default:r(()=>[i(V(ve(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(_,{prop:"due_date",label:"截止日期",width:"120"},{default:r(({row:a})=>[i(V(pe(a.due_date)),1)]),_:1}),k.value?(y(),U(_,{key:0,prop:"assigned_to",label:"指派给",width:"150"},{default:r(({row:a})=>{var b;return[i(V(((b=a.assignee)==null?void 0:b.full_name)||"未指派"),1)]}),_:1})):E("",!0),t(_,{prop:"user_id",label:"创建人",width:"150"},{default:r(({row:a})=>{var b;return[i(V(((b=a.creator)==null?void 0:b.full_name)||"未知"),1)]}),_:1}),t(_,{prop:"created_at",label:"创建时间",width:"170"},{default:r(({row:a})=>[i(V(me(a.created_at)),1)]),_:1}),t(_,{label:"操作",width:"220",fixed:"right"},{default:r(({row:a})=>[t(be,null,{default:r(()=>[t(m,{type:"primary",onClick:b=>se(a)},{default:r(()=>e[23]||(e[23]=[i(" 编辑 ")])),_:2},1032,["onClick"]),t(m,{type:"success",onClick:b=>ue(a),disabled:a.status==="completed"},{default:r(()=>[i(V(_e(a.status)),1)]),_:2},1032,["onClick","disabled"]),t(m,{type:"danger",onClick:b=>ne(a)},{default:r(()=>e[24]||(e[24]=[i(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ve,Y.value]])]),_:1}),t(xe,{pagination:v.value,"onUpdate:pagination":le},null,8,["pagination"]),t(J,{title:I.value,modelValue:x.value,"onUpdate:modelValue":e[11]||(e[11]=a=>x.value=a),width:"600px"},{footer:r(()=>[w("span",Fe,[t(m,{onClick:e[10]||(e[10]=a=>x.value=!1)},{default:r(()=>e[25]||(e[25]=[i("取消")])),_:1}),t(m,{type:"primary",onClick:ie},{default:r(()=>e[26]||(e[26]=[i("确定")])),_:1})])]),default:r(()=>[t(G,{model:s.value,rules:Z,ref_key:"taskFormRef",ref:B,"label-width":"100px"},{default:r(()=>[t(c,{label:"任务名称",prop:"title"},{default:r(()=>[t(o,{modelValue:s.value.title,"onUpdate:modelValue":e[4]||(e[4]=a=>s.value.title=a)},null,8,["modelValue"])]),_:1}),t(c,{label:"任务描述",prop:"description"},{default:r(()=>[t(o,{modelValue:s.value.description,"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.description=a),type:"textarea",rows:4},null,8,["modelValue"])]),_:1}),t(c,{label:"优先级",prop:"priority"},{default:r(()=>[t(g,{modelValue:s.value.priority,"onUpdate:modelValue":e[6]||(e[6]=a=>s.value.priority=a),placeholder:"请选择任务优先级"},{default:r(()=>[t(u,{label:"低",value:"low"}),t(u,{label:"中",value:"medium"}),t(u,{label:"高",value:"high"}),t(u,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"状态",prop:"status"},{default:r(()=>[t(g,{modelValue:s.value.status,"onUpdate:modelValue":e[7]||(e[7]=a=>s.value.status=a),placeholder:"请选择任务状态"},{default:r(()=>[t(u,{label:"待完成",value:"pending"}),t(u,{label:"进行中",value:"in_progress"}),t(u,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"截止日期",prop:"due_date"},{default:r(()=>[t(M,{modelValue:s.value.due_date,"onUpdate:modelValue":e[8]||(e[8]=a=>s.value.due_date=a),type:"date",placeholder:"选择截止日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),k.value?(y(),U(c,{key:0,label:"指派给",prop:"assigned_to"},{default:r(()=>[t(g,{modelValue:s.value.assigned_to,"onUpdate:modelValue":e[9]||(e[9]=a=>s.value.assigned_to=a),placeholder:"请选择用户(支持模糊搜索)",filterable:""},{default:r(()=>[(y(!0),R(Q,null,K(O.value,a=>(y(),U(u,{filterable:"",key:a.user_id,label:a.full_name,value:a.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):E("",!0),t(c,{label:"创建人"},{default:r(()=>[t(o,{"model-value":X.value,disabled:""},null,8,["model-value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),t(J,{title:"批量指派任务",modelValue:q.value,"onUpdate:modelValue":e[18]||(e[18]=a=>q.value=a),width:"600px"},{footer:r(()=>[w("span",Oe,[t(m,{onClick:e[17]||(e[17]=a=>q.value=!1)},{default:r(()=>e[27]||(e[27]=[i("取消")])),_:1}),t(m,{type:"primary",onClick:de},{default:r(()=>e[28]||(e[28]=[i("确定")])),_:1})])]),default:r(()=>[t(G,{model:n.value,rules:ee,ref_key:"assignFormRef",ref:F,"label-width":"100px"},{default:r(()=>[t(c,{label:"任务名称",prop:"title"},{default:r(()=>[t(o,{modelValue:n.value.title,"onUpdate:modelValue":e[12]||(e[12]=a=>n.value.title=a)},null,8,["modelValue"])]),_:1}),t(c,{label:"任务描述",prop:"description"},{default:r(()=>[t(o,{modelValue:n.value.description,"onUpdate:modelValue":e[13]||(e[13]=a=>n.value.description=a),type:"textarea",rows:4},null,8,["modelValue"])]),_:1}),t(c,{label:"优先级",prop:"priority"},{default:r(()=>[t(g,{modelValue:n.value.priority,"onUpdate:modelValue":e[14]||(e[14]=a=>n.value.priority=a),placeholder:"请选择任务优先级"},{default:r(()=>[t(u,{label:"低",value:"low"}),t(u,{label:"中",value:"medium"}),t(u,{label:"高",value:"high"}),t(u,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"截止日期",prop:"due_date"},{default:r(()=>[t(M,{modelValue:n.value.due_date,"onUpdate:modelValue":e[15]||(e[15]=a=>n.value.due_date=a),type:"date",placeholder:"选择截止日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(c,{label:"指派给",prop:"assigned_to"},{default:r(()=>[t(g,{modelValue:n.value.assigned_to,"onUpdate:modelValue":e[16]||(e[16]=a=>n.value.assigned_to=a),placeholder:"请选择用户(支持模糊搜索)",filterable:"",multiple:"",style:{width:"100%"}},{default:r(()=>[(y(!0),R(Q,null,K(O.value,a=>(y(),U(u,{filterable:"",key:a.user_id,label:a.full_name,value:a.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])])}}}),je=Ue(Ae,[["__scopeId","data-v-1ec5f4f9"]]);export{je as default};
