import{E as m,s as Ue,c as ee}from"./elementPlus-7n3J9xVR.js";import{u as Te,B as $e,e as Ie,s as c,b as Me}from"./index-BKDCXq68.js";import{x as Be,c as B,r as p,j as Le,y as j,P as t,A as g,H as o,ag as f,G as h,J as G,u as Ye,L as u,I as Fe,aq as Oe,M as z,O as te,a6 as ae,z as w}from"./vendor-kUynFKsh.js";import"./supabase-Dk90AXsH.js";const Ae={class:"layout"},Ne={class:"task-content"},Pe={class:"card-header"},Re={class:"header-actions"},Ee={style:{"font-size":"14px",color:"#909399"}},He={class:"dialog-footer"},je={class:"dialog-footer"},Ge=Be({__name:"TaskManagement",setup(Je){var Q;const le=[{name:"任务管理",path:"/system/task-management"}],O=Te(),v=(Q=O.user)==null?void 0:Q.user_id,x=B(()=>{var a;return Number((a=O.user)==null?void 0:a.role_id)}),S=B(()=>x.value===0||x.value===1||x.value===11||x.value===15),D=B(()=>x.value===0||x.value===1),oe=B(()=>{var a;return s.value.creator&&s.value.creator.full_name?s.value.creator.full_name:((a=O.user)==null?void 0:a.full_name)||""}),A=p(!1),C=p(!1),N=p([]),L=p(""),Y=p(""),U=p(null),T=p(!1),P=p(""),R=p(null),I=p(!1),E=p(null),H=p([]),q=p([]),k=p({page:1,pageSize:10,total:0}),s=p({title:"",description:"",priority:"medium",status:"pending",due_date:"",assigned_to:null,organization_id:void 0}),d=p({title:"",description:"",priority:"medium",due_date:"",assigned_to:[]}),re={title:[{required:!0,message:"请输入任务名称",trigger:"blur"}],description:[{required:!0,message:"请输入任务描述",trigger:"blur"}],priority:[{required:!0,message:"请选择任务优先级",trigger:"change"}],status:[{required:!0,message:"请选择任务状态",trigger:"change"}],due_date:[{required:!0,message:"请选择截止日期",trigger:"change"}]},ie={title:[{required:!0,message:"请输入任务名称",trigger:"blur"}],description:[{required:!0,message:"请输入任务描述",trigger:"blur"}],priority:[{required:!0,message:"请选择任务优先级",trigger:"change"}],due_date:[{required:!0,message:"请选择截止日期",trigger:"change"}],assigned_to:[{required:!0,message:"请选择要指派的用户",trigger:"change"}]},J=p([]),se=B(()=>{const a=(k.value.page-1)*k.value.pageSize,e=a+k.value.pageSize;return N.value.slice(a,e)}),$=async()=>{A.value=!0;try{let a=c.from("tasks").select(`
                *,
                assignee:user_profiles!tasks_assigned_to_fkey(
                    user_id,
                    full_name
                ),
                creator:user_profiles!tasks_user_id_fkey(
                    user_id,
                    full_name
                )
            `).order("created_at",{ascending:!1});if(!S.value)a=a.eq("assigned_to",v);else if(!D.value){const{data:r}=await c.from("user_profiles").select("organization_id").eq("user_id",v).single();r!=null&&r.organization_id&&(a=a.eq("organization_id",r.organization_id))}const{data:e,error:i}=await a;if(i)throw i;N.value=e||[],J.value=e||[],k.value.total=(e==null?void 0:e.length)||0}catch(a){console.error("获取任务列表失败:",a),m.error("获取任务列表失败")}finally{A.value=!1}},ne=async()=>{if(S.value)try{let a=c.from("user_profiles").select("user_id, full_name, organization_id").neq("user_id",v).order("full_name");if(!D.value){const{data:r}=await c.from("user_profiles").select("organization_id").eq("user_id",v).single();r!=null&&r.organization_id&&(a=a.eq("organization_id",r.organization_id))}const{data:e,error:i}=await a;if(i)throw i;H.value=e||[]}catch(a){console.error("获取用户列表失败:",a),m.error("获取用户列表失败")}},ue=a=>{k.value.page=a.page,k.value.pageSize=a.pageSize},de=a=>{q.value=a},pe=()=>{k.value.page=1;let a=[...J.value];if(L.value&&(a=a.filter(e=>e.title.toLowerCase().includes(L.value.toLowerCase()))),Y.value&&(a=a.filter(e=>e.status===Y.value)),U.value&&U.value[0]&&U.value[1]){const[e,i]=U.value;a=a.filter(r=>{const n=new Date(r.due_date).toISOString().split("T")[0];return n>=e&&n<=i})}N.value=a,k.value.total=a.length},ge=()=>{P.value="添加任务",s.value={title:"",description:"",priority:"medium",status:"pending",due_date:"",assigned_to:S.value?null:v,organization_id:void 0},T.value=!0},fe=async a=>{if(P.value="编辑任务",s.value={...a},!D.value&&!a.organization_id){const{data:e}=await c.from("user_profiles").select("organization_id").eq("user_id",v).single();e!=null&&e.organization_id&&(s.value.organization_id=e.organization_id)}T.value=!0},me=async a=>{const e=a.status==="pending"?"in_progress":"completed";try{const i={status:e,updated_at:new Date().toISOString()};if(!D.value&&!a.organization_id){const{data:n}=await c.from("user_profiles").select("organization_id").eq("user_id",v).single();n!=null&&n.organization_id&&(i.organization_id=n.organization_id)}const{error:r}=await c.from("tasks").update(i).eq("id",a.id);if(r)throw r;m.success("更新状态成功"),$()}catch(i){console.error("更新状态失败:",i),m.error("更新状态失败")}},ce=async a=>{try{await ee.confirm("确定要删除该任务吗？此操作不可恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const{error:e}=await c.from("tasks").delete().eq("id",a.id);if(e)throw e;m.success("删除成功"),$()}catch(e){e!=="cancel"&&(console.error("删除任务失败:",e),m.error("删除失败"))}},ve=async()=>{if(q.value.length!==0)try{await ee.confirm(`确定要删除选中的 ${q.value.length} 条任务吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=q.value.map(e=>c.from("tasks").delete().eq("id",e.id));await Promise.all(a),m.success(`成功删除 ${q.value.length} 条任务`),q.value=[],$()}catch(a){a!=="cancel"&&(console.error("批量删除任务失败:",a),m.error("批量删除失败"))}},_e=async()=>{R.value&&await R.value.validate(async a=>{if(a){C.value=!0;try{if(!S.value)s.value.assigned_to=v,s.value.user_id=v;else if(s.value.assigned_to)s.value.user_id=v;else{m.warning("请选择要指派的用户");return}if(!D.value){const{data:i}=await c.from("user_profiles").select("organization_id").eq("user_id",v).single();i!=null&&i.organization_id&&(s.value.organization_id=i.organization_id)}const e={...s.value};if(delete e.assignee,delete e.creator,s.value.id){const{error:i}=await c.from("tasks").update({...e,updated_at:new Date().toISOString()}).eq("id",s.value.id);if(i)throw i;m.success("更新成功")}else{const{error:i}=await c.from("tasks").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(i)throw i;m.success("创建成功")}T.value=!1,$()}catch(e){console.error(s.value.id?"更新失败:":"创建失败:",e),m.error(s.value.id?"更新失败":"创建失败")}finally{C.value=!1}}})},ye=async()=>{E.value&&await E.value.validate(async a=>{if(a){C.value=!0;try{let e;if(!D.value){const{data:n}=await c.from("user_profiles").select("organization_id").eq("user_id",v).single();e=n==null?void 0:n.organization_id}const i=d.value.assigned_to.map(n=>({title:d.value.title,description:d.value.description,priority:d.value.priority,status:"pending",due_date:d.value.due_date,assigned_to:n,user_id:v,organization_id:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),{error:r}=await c.from("tasks").insert(i);if(r)throw r;m.success(`成功指派任务给 ${i.length} 位用户`),I.value=!1,$(),d.value={title:"",description:"",priority:"medium",due_date:"",assigned_to:[]}}catch(e){console.error("批量指派失败:",e),m.error("批量指派失败")}finally{C.value=!1}}})};function be(a){return a?new Date(a).toISOString().split("T")[0]:"-"}function we(a){if(!a)return"-";const e=new Date(a),i=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),M=String(e.getHours()).padStart(2,"0"),_=String(e.getMinutes()).padStart(2,"0");return`${i}-${r}-${n} ${M}:${_}`}function ke(a){switch(a){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function Ve(a){switch(a){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function he(a){switch(a){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function ze(a){switch(a){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}function Se(a){switch(a){case"pending":return"开始";case"in_progress":return"完成";case"completed":return"已完成";default:return"更新"}}return Le(async()=>{await Promise.all([$(),ne()])}),(a,e)=>{const i=f("el-input"),r=f("el-option"),n=f("el-select"),M=f("el-date-picker"),_=f("el-button"),De=f("el-space"),K=f("el-card"),F=f("el-tag"),W=f("el-tooltip"),b=f("el-table-column"),qe=f("el-button-group"),xe=f("el-table"),y=f("el-form-item"),X=f("el-form"),Z=f("el-dialog"),Ce=Oe("loading");return w(),j("div",Ae,[t($e,{breadcrumb:le}),e[37]||(e[37]=g("div",{class:"layout-title"},[g("h1",{class:"title"},"任务管理")],-1)),t(K,{shadow:"always",style:{"margin-bottom":"20px"}},{default:o(()=>[t(De,{wrap:"",alignment:"start",size:30},{default:o(()=>[t(i,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=l=>L.value=l),style:{width:"240px"},placeholder:"请输入任务名称","suffix-icon":Ye(Ue),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),t(n,{modelValue:Y.value,"onUpdate:modelValue":e[1]||(e[1]=l=>Y.value=l),placeholder:"状态",clearable:"",style:{width:"150px"},size:"large"},{default:o(()=>[t(r,{label:"待完成",value:"pending"}),t(r,{label:"进行中",value:"in_progress"}),t(r,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"]),t(M,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=l=>U.value=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"300px"},size:"large"},null,8,["modelValue"]),t(_,{type:"primary",size:"large",onClick:pe},{default:o(()=>e[19]||(e[19]=[u("搜索")])),_:1}),t(_,{type:"success",size:"large",onClick:ge},{default:o(()=>e[20]||(e[20]=[u("添加任务")])),_:1}),S.value?(w(),h(_,{key:0,type:"info",size:"large",onClick:e[3]||(e[3]=l=>I.value=!0)},{default:o(()=>e[21]||(e[21]=[u("批量指派任务")])),_:1})):G("",!0)]),_:1})]),_:1}),g("div",Ne,[t(K,{shadow:"always"},{header:o(()=>[g("div",Pe,[g("div",null,[e[24]||(e[24]=g("span",null,"任务列表",-1)),D.value?(w(),h(W,{key:0,content:"您可以查看所有任务",placement:"right"},{default:o(()=>[t(F,{type:"success",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[22]||(e[22]=[u("全部")])),_:1})]),_:1})):(w(),h(W,{key:1,content:"您只能查看本组织的任务",placement:"right"},{default:o(()=>[t(F,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[23]||(e[23]=[u("本组织")])),_:1})]),_:1}))]),g("div",Re,[t(_,{type:"danger",disabled:!q.value.length,onClick:ve},{default:o(()=>e[25]||(e[25]=[u(" 批量删除 ")])),_:1},8,["disabled"]),g("div",Ee,"共计"+z(k.value.total)+"条数据",1)])])]),default:o(()=>[Fe((w(),h(xe,{data:se.value,"row-key":"id",stripe:"",height:"400px",onSelectionChange:de},{default:o(()=>[t(b,{type:"selection",width:"55"}),t(b,{prop:"id",label:"ID",width:"80"}),t(b,{prop:"title",label:"任务名称",width:"200"}),t(b,{prop:"description",label:"任务描述","show-overflow-tooltip":""}),t(b,{prop:"priority",label:"优先级",width:"100"},{default:o(({row:l})=>[t(F,{type:ke(l.priority)},{default:o(()=>[u(z(Ve(l.priority)),1)]),_:2},1032,["type"])]),_:1}),t(b,{prop:"status",label:"状态",width:"100"},{default:o(({row:l})=>[t(F,{type:he(l.status)},{default:o(()=>[u(z(ze(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(b,{prop:"due_date",label:"截止日期",width:"120"},{default:o(({row:l})=>[u(z(be(l.due_date)),1)]),_:1}),S.value?(w(),h(b,{key:0,prop:"assigned_to",label:"指派给",width:"150"},{default:o(({row:l})=>{var V;return[u(z(((V=l.assignee)==null?void 0:V.full_name)||"未指派"),1)]}),_:1})):G("",!0),t(b,{prop:"user_id",label:"创建人",width:"150"},{default:o(({row:l})=>{var V;return[u(z(((V=l.creator)==null?void 0:V.full_name)||"未知"),1)]}),_:1}),t(b,{prop:"created_at",label:"创建时间",width:"170"},{default:o(({row:l})=>[u(z(we(l.created_at)),1)]),_:1}),t(b,{label:"操作",width:"220",fixed:"right"},{default:o(({row:l})=>[t(qe,null,{default:o(()=>[t(_,{type:"primary",onClick:V=>fe(l)},{default:o(()=>e[26]||(e[26]=[u(" 编辑 ")])),_:2},1032,["onClick"]),t(_,{type:"success",onClick:V=>me(l),disabled:l.status==="completed"},{default:o(()=>[u(z(Se(l.status)),1)]),_:2},1032,["onClick","disabled"]),t(_,{type:"danger",onClick:V=>ce(l)},{default:o(()=>e[27]||(e[27]=[u(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ce,A.value]])]),_:1}),t(Ie,{pagination:k.value,"onUpdate:pagination":ue},null,8,["pagination"]),t(Z,{title:P.value,modelValue:T.value,"onUpdate:modelValue":e[11]||(e[11]=l=>T.value=l),width:"40%","close-on-click-modal":!1},{footer:o(()=>[g("span",He,[t(_,{onClick:e[10]||(e[10]=l=>T.value=!1)},{default:o(()=>e[30]||(e[30]=[u("取消")])),_:1}),t(_,{type:"primary",onClick:_e,loading:C.value},{default:o(()=>e[31]||(e[31]=[u("确定")])),_:1},8,["loading"])])]),default:o(()=>[t(X,{model:s.value,rules:re,ref_key:"taskFormRef",ref:R,"label-width":"80px"},{default:o(()=>[t(y,{label:"任务名称",prop:"title"},{default:o(()=>[t(i,{modelValue:s.value.title,"onUpdate:modelValue":e[4]||(e[4]=l=>s.value.title=l),placeholder:"请输入任务名称"},null,8,["modelValue"]),e[28]||(e[28]=g("div",{class:"form-tip"},"请简要描述任务的主要内容",-1))]),_:1}),t(y,{label:"任务描述",prop:"description"},{default:o(()=>[t(i,{modelValue:s.value.description,"onUpdate:modelValue":e[5]||(e[5]=l=>s.value.description=l),type:"textarea",rows:6,placeholder:"请详细描述任务的具体要求、步骤和注意事项"},null,8,["modelValue"]),e[29]||(e[29]=g("div",{class:"form-tip"},"详细描述任务的具体要求、执行步骤和相关注意事项",-1))]),_:1}),t(y,{label:"优先级",prop:"priority"},{default:o(()=>[t(n,{modelValue:s.value.priority,"onUpdate:modelValue":e[6]||(e[6]=l=>s.value.priority=l),placeholder:"请选择任务优先级",style:{width:"100%"}},{default:o(()=>[t(r,{label:"低",value:"low"}),t(r,{label:"中",value:"medium"}),t(r,{label:"高",value:"high"}),t(r,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"状态",prop:"status"},{default:o(()=>[t(n,{modelValue:s.value.status,"onUpdate:modelValue":e[7]||(e[7]=l=>s.value.status=l),placeholder:"请选择任务状态",style:{width:"100%"}},{default:o(()=>[t(r,{label:"待完成",value:"pending"}),t(r,{label:"进行中",value:"in_progress"}),t(r,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"截止日期",prop:"due_date"},{default:o(()=>[t(M,{modelValue:s.value.due_date,"onUpdate:modelValue":e[8]||(e[8]=l=>s.value.due_date=l),type:"date",placeholder:"选择截止日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),S.value?(w(),h(y,{key:0,label:"指派给",prop:"assigned_to"},{default:o(()=>[t(n,{modelValue:s.value.assigned_to,"onUpdate:modelValue":e[9]||(e[9]=l=>s.value.assigned_to=l),placeholder:"请选择用户(支持模糊搜索)",filterable:"",style:{width:"100%"}},{default:o(()=>[(w(!0),j(te,null,ae(H.value,l=>(w(),h(r,{filterable:"",key:l.user_id,label:l.full_name,value:l.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):G("",!0),t(y,{label:"创建人"},{default:o(()=>[t(i,{"model-value":oe.value,disabled:""},null,8,["model-value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),t(Z,{title:"批量指派任务",modelValue:I.value,"onUpdate:modelValue":e[18]||(e[18]=l=>I.value=l),width:"40%","close-on-click-modal":!1},{footer:o(()=>[g("span",je,[t(_,{onClick:e[17]||(e[17]=l=>I.value=!1)},{default:o(()=>e[35]||(e[35]=[u("取消")])),_:1}),t(_,{type:"primary",onClick:ye,loading:C.value},{default:o(()=>e[36]||(e[36]=[u("确定")])),_:1},8,["loading"])])]),default:o(()=>[t(X,{model:d.value,rules:ie,ref_key:"assignFormRef",ref:E,"label-width":"80px"},{default:o(()=>[t(y,{label:"任务名称",prop:"title"},{default:o(()=>[t(i,{modelValue:d.value.title,"onUpdate:modelValue":e[12]||(e[12]=l=>d.value.title=l),placeholder:"请输入任务名称"},null,8,["modelValue"]),e[32]||(e[32]=g("div",{class:"form-tip"},"请简要描述任务的主要内容",-1))]),_:1}),t(y,{label:"任务描述",prop:"description"},{default:o(()=>[t(i,{modelValue:d.value.description,"onUpdate:modelValue":e[13]||(e[13]=l=>d.value.description=l),type:"textarea",rows:6,placeholder:"请详细描述任务的具体要求、步骤和注意事项"},null,8,["modelValue"]),e[33]||(e[33]=g("div",{class:"form-tip"},"详细描述任务的具体要求、执行步骤和相关注意事项",-1))]),_:1}),t(y,{label:"优先级",prop:"priority"},{default:o(()=>[t(n,{modelValue:d.value.priority,"onUpdate:modelValue":e[14]||(e[14]=l=>d.value.priority=l),placeholder:"请选择任务优先级",style:{width:"100%"}},{default:o(()=>[t(r,{label:"低",value:"low"}),t(r,{label:"中",value:"medium"}),t(r,{label:"高",value:"high"}),t(r,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"截止日期",prop:"due_date"},{default:o(()=>[t(M,{modelValue:d.value.due_date,"onUpdate:modelValue":e[15]||(e[15]=l=>d.value.due_date=l),type:"date",placeholder:"选择截止日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(y,{label:"指派给",prop:"assigned_to"},{default:o(()=>[t(n,{modelValue:d.value.assigned_to,"onUpdate:modelValue":e[16]||(e[16]=l=>d.value.assigned_to=l),placeholder:"请选择用户(支持模糊搜索)",filterable:"",multiple:"",style:{width:"100%"}},{default:o(()=>[(w(!0),j(te,null,ae(H.value,l=>(w(),h(r,{filterable:"",key:l.user_id,label:l.full_name,value:l.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[34]||(e[34]=g("div",{class:"form-tip"},"可以选择多个用户进行批量指派",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])])}}}),Ze=Me(Ge,[["__scopeId","data-v-7f69ec02"]]);export{Ze as default};
