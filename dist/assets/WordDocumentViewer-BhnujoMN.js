import{x as P,r as f,j as z,W as F,y as m,A as a,G as T,J as y,ag as j,u as _,H as L,L as N,M as $,D as k,P as G,O as J,a6 as Y,aA as K,n as Q,z as u}from"./vendor-CcmhhHhJ.js";import{m as A,f as X,n as Z,E as w,o as ee}from"./elementPlus-Be5V1zcU.js";import{m as D}from"./index-BaMLHsVY.js";import{b as te}from"./index-JrTp7-b_.js";const ne={class:"word-viewer-container"},se={class:"viewer-header"},oe={class:"header-left"},le={class:"file-title"},ae={class:"header-right"},re={class:"viewer-content"},ie={class:"sidebar-header"},ce={key:0},de={class:"sidebar-actions"},ue={key:0,class:"sidebar-content"},he={class:"toc-tree"},fe=["onClick"],me={class:"main-content"},pe={class:"content-wrapper"},ge={class:"view-mode"},ve=["innerHTML"],ye=P({__name:"WordDocumentViewer",props:{documentUrl:{},title:{default:"文档查看器"},showBackButton:{type:Boolean,default:!0},showDownloadButton:{type:Boolean,default:!0}},setup(q){const p=q,V=K(),g=f(),C=f(""),h=f(!1),b=f(""),v=f([]),W=()=>{g.value=ee.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),setTimeout(()=>{g.value=null},2e3)},E=f(),M=async()=>{W();try{console.log("开始加载Word文档:",p.documentUrl);const e=await fetch(p.documentUrl);if(!e.ok)throw new Error("文件下载失败");const t=await e.arrayBuffer(),r=await D.convertToHtml({arrayBuffer:t,convertImage:D.images.imgElement(function(s){return s.read("base64").then(function(n){return{src:"data:"+s.contentType+";base64,"+n}})}),styleMap:["p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='Heading 4'] => h4:fresh","p[style-name='Heading 5'] => h5:fresh","p[style-name='Heading 6'] => h6:fresh","p[style-name='Title'] => h1.title:fresh","p[style-name='Subtitle'] => h2.subtitle:fresh","p[style-name='标题 1'] => h1:fresh","p[style-name='标题 2'] => h2:fresh","p[style-name='标题 3'] => h3:fresh","p[style-name='标题 4'] => h4:fresh","p[style-name='标题 5'] => h5:fresh","p[style-name='标题 6'] => h6:fresh","p[style-name='标题1'] => h1:fresh","p[style-name='标题2'] => h2:fresh","p[style-name='标题3'] => h3:fresh","p[style-name='标题4'] => h4:fresh","p[style-name='标题5'] => h5:fresh","p[style-name='标题6'] => h6:fresh","r[style-name='Strong'] => strong","r[style-name='Emphasis'] => em","r[style-name='Hyperlink'] => a","r[style-name='加粗'] => strong","r[style-name='倾斜'] => em","r[style-name='超链接'] => a","table => table.table:fresh","tr => tr:fresh","td => td:fresh","th => th:fresh"],transformDocument:function(s){return s.children.forEach(function(n){n.children&&n.children.forEach(function(i){i.type==="hyperlink"&&(i.type="hyperlink")})}),s}});C.value=r.value,await Q(),setTimeout(()=>{U()},500),w.success("文档加载成功")}catch(e){console.error("加载文档失败:",e),w.error(`加载文档失败: ${e.message}`)}finally{g.value.close(),g.value=null}},U=()=>{const e=E.value;if(!e){console.log("wordContentRef.value 为空，无法生成目录");return}const t=[];e.querySelectorAll('a[id^="heading_"]').forEach((s,n)=>{var c,d;const i=s.getAttribute("id")||`heading-${n}`;let l=s.nextElementSibling,o="";if(l&&l.tagName.toLowerCase()==="strong")o=((c=l.textContent)==null?void 0:c.trim())||"";else{const H=s.parentElement;if(H){const S=H.querySelector("strong");S&&(o=((d=S.textContent)==null?void 0:d.trim())||"")}}o||(o=`标题 ${n+1}`),o&&o.length>0&&t.push({id:i,title:o,level:1,element:s})}),t.length===0&&e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((n,i)=>{var c;const l=B(n),o=((c=n.textContent)==null?void 0:c.trim())||"";if(o&&o.length>0){const d=`heading-${i}`;n.id=d,t.push({id:d,title:o,level:l,element:n})}}),t.length===0&&e.querySelectorAll('h1, h2, h3, h4, h5, h6, .title, .subtitle, p[style*="heading"], p[style*="title"], p[style*="Heading"]').forEach((n,i)=>{var c;const l=B(n),o=((c=n.textContent)==null?void 0:c.trim())||"";if(o&&o.length>0){const d=`heading-${i}`;n.id=d,t.push({id:d,title:o,level:l,element:n})}}),t.length===0&&e.querySelectorAll("p").forEach((n,i)=>{var o;const l=((o=n.textContent)==null?void 0:o.trim())||"";if(l.match(/^[一二三四五六七八九十]+[、．.]/)||l.match(/^\d+[、．.]/)||l.includes("了解")||l.includes("申请")||l.includes("培训")){const c=`heading-${i}`;n.id=c,t.push({id:c,title:l,level:1,element:n})}}),v.value=t,t.length===0?v.value=[{id:"test-1",title:"文档开始",level:1},{id:"test-2",title:"主要内容",level:2}]:console.log("目录生成成功，共",t.length,"个条目")},B=e=>{const t=e.tagName.toLowerCase();if(t.startsWith("h"))return parseInt(t.charAt(1));const r=e.className;if(r.includes("title"))return 1;if(r.includes("subtitle"))return 2;const s=e.textContent||"";return s.length<20&&e.tagName==="P"?2:s.length<50&&e.tagName==="P"?3:4},O=e=>{let t=document.getElementById(e);t||(t=document.querySelector(`a[id="${e}"]`)),t||(t=document.querySelector(`[id="${e}"]`)),t?(t.scrollIntoView({behavior:"smooth",block:"start"}),t.style.backgroundColor="#fff3cd",setTimeout(()=>{t.style.backgroundColor=""},2e3),b.value=e):w.warning("未找到对应的标题位置")},R=()=>{const e=document.createElement("a");e.href=p.documentUrl,e.download=p.title+".docx",document.body.appendChild(e),e.click(),document.body.removeChild(e),w.success("开始下载文档")},I=()=>{V.go(-1)},x=()=>{const e=window.pageYOffset||document.documentElement.scrollTop,t=v.value;for(let r=t.length-1;r>=0;r--){const s=t[r],n=document.getElementById(s.id);if(n&&n.offsetTop<=e+100){b.value=s.id;break}}};return z(()=>{M(),window.addEventListener("scroll",x)}),F(()=>{window.removeEventListener("scroll",x)}),(e,t)=>{const r=j("el-button");return u(),m("div",ne,[a("div",se,[a("div",oe,[e.showBackButton?(u(),T(r,{key:0,onClick:I,icon:_(A)},{default:L(()=>t[1]||(t[1]=[N("返回")])),_:1},8,["icon"])):y("",!0),a("span",le,$(e.title),1)]),a("div",ae,[e.showDownloadButton?(u(),T(r,{key:0,type:"success",onClick:R,icon:_(X)},{default:L(()=>t[2]||(t[2]=[N(" 下载文档 ")])),_:1},8,["icon"])):y("",!0)])]),a("div",re,[a("div",{class:k(["sidebar",{collapsed:h.value}])},[a("div",ie,[h.value?y("",!0):(u(),m("span",ce,"目录")),a("div",de,[G(r,{class:"sidebar-toggle-btn",onClick:t[0]||(t[0]=s=>h.value=!h.value),icon:h.value?_(Z):_(A)},null,8,["icon"])])]),h.value?y("",!0):(u(),m("div",ue,[a("div",he,[(u(!0),m(J,null,Y(v.value,(s,n)=>(u(),m("div",{key:n,class:k(["toc-item",{active:b.value===s.id}]),onClick:i=>O(s.id)},[a("span",{class:k(["toc-level",`level-${s.level}`])},$(s.title),3)],10,fe))),128))])]))],2),a("div",me,[a("div",pe,[a("div",ge,[a("div",{class:"word-content",innerHTML:C.value,ref_key:"wordContentRef",ref:E},null,8,ve)])])])])])}}}),Ce=te(ye,[["__scopeId","data-v-67557d07"]]);export{Ce as W};
