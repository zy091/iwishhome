import{u as U,c as z,s as b,b as B}from"./index-BmK0bamU.js";import{E as m}from"./elementPlus-Be5V1zcU.js";import{x as F,r as c,G as P,H as a,ag as u,P as l,L as x,A as h,z as R}from"./vendor-CcmhhHhJ.js";import"./supabase-fOlwtt9p.js";const E=F({__name:"StudyNote",setup($){const V={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},g=c(new Date),o=c({title:"",content:""}),p=c(),s=c([]),f=c(!1),N=U(),k=n=>{if(n.size&&n.size>10*1024*1024)return m.warning("文件大小不能超过10MB"),s.value=[],!1;s.value=[n]},C=()=>{s.value=[]},D=async n=>{var e;try{const t=(e=N.user)==null?void 0:e.user_id;if(!t)throw new Error("用户未登录");const r=n.name.split(".").pop(),i=`study-notes/${`${t}-${Date.now()}.${r}`}`,{data:w,error:_}=await b.storage.from("attachments").upload(i,n,{cacheControl:"3600",upsert:!1});if(_)throw _;const{data:y}=b.storage.from("attachments").getPublicUrl(i);return{url:y.publicUrl,name:n.name,type:n.type}}catch(t){return console.error("上传文件失败:",t),m.error("文件上传失败"),null}},S=async()=>{if(!p.value||!o.value.title||!o.value.content){m.error("请填写完整信息");return}await p.value.validate(async n=>{var e;if(n){f.value=!0;try{let t=null;if(s.value.length>0&&s.value[0].raw&&(t=await D(s.value[0].raw),!t)){f.value=!1;return}const r={title:o.value.title,content:o.value.content,...t&&{attachment_url:t.url,attachment_name:t.name,attachment_type:t.type}};await z.createNote(r),m.success("提交成功"),(e=p.value)==null||e.resetFields(),o.value.title="",o.value.content="",s.value=[]}catch(t){console.error("提交失败:",t),m.error("提交失败")}finally{f.value=!1}}})};return(n,e)=>{const t=u("el-date-picker"),r=u("el-form-item"),v=u("el-input"),i=u("el-button"),w=u("el-upload"),_=u("el-form"),y=u("el-card");return R(),P(y,{style:{"min-height":"400px","margin-top":"30px"}},{header:a(()=>e[3]||(e[3]=[h("div",{class:"subtitle"},"写下你的学习心得",-1)])),default:a(()=>[l(_,{model:o.value,ref_key:"formRef",ref:p,rules:V,"label-width":"50px",style:{width:"100%","max-width":"800px","margin-top":"40px"}},{default:a(()=>[l(r,{label:"日期"},{default:a(()=>[l(t,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=d=>g.value=d),type:"date",placeholder:"Pick a day",size:"default",readonly:!0},null,8,["modelValue"])]),_:1}),l(r,{label:"标题"},{default:a(()=>[l(v,{modelValue:o.value.title,"onUpdate:modelValue":e[1]||(e[1]=d=>o.value.title=d)},null,8,["modelValue"])]),_:1}),l(r,{label:"内容"},{default:a(()=>[l(v,{modelValue:o.value.content,"onUpdate:modelValue":e[2]||(e[2]=d=>o.value.content=d),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1}),l(r,{label:"附件"},{default:a(()=>[l(w,{class:"upload-demo",action:"#","auto-upload":!1,"on-change":k,"on-remove":C,limit:1,"file-list":s.value},{tip:a(()=>e[5]||(e[5]=[h("div",{class:"el-upload__tip"}," 可以上传PDF、Word、图片等文件，大小不超过10MB ",-1)])),default:a(()=>[l(i,{type:"primary"},{default:a(()=>e[4]||(e[4]=[x("选择文件")])),_:1})]),_:1},8,["file-list"])]),_:1}),l(r,null,{default:a(()=>[l(i,{type:"primary",onClick:S,loading:f.value},{default:a(()=>e[6]||(e[6]=[x("提交")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})}}}),A=B(E,[["__scopeId","data-v-b583ba88"]]);export{A as default};
