import{aw as pe,r as y,x as Z,w as _e,j as ee,y as C,I as te,P as o,aq as se,G as L,ag as m,H as i,L as h,M as w,J as G,O as ae,A as c,z as v,X as fe,aF as ge,c as ve,a6 as ye,az as me}from"./vendor-COQJj1AX.js";import{s as D,_ as le,b as he}from"./index-Dc3VxstI.js";import{t as oe}from"./testResultService-DZPpcAVE.js";import{E as P,c as we}from"./elementPlus-Dv7g5dxn.js";import"./supabase-Bqqw4QDB.js";const M=pe("test",()=>{const p=y(!1),g=y(null);return{loading:p,error:g,getTests:async t=>{p.value=!0,g.value=null;try{let a=D.from("tests").select("*",{count:"exact"});if(t!=null&&t.searchQuery&&(a=a.ilike("title",`%${t.searchQuery}%`)),t!=null&&t.testType&&(a=a.eq("type",t.testType)),t!=null&&t.platform&&(a=a.eq("platform",t.platform)),t!=null&&t.chapter&&(a=a.eq("chapter",t.chapter)),t!=null&&t.page&&(t!=null&&t.pageSize)){const k=(t.page-1)*t.pageSize,r=k+t.pageSize-1;a=a.range(k,r)}a=a.order("created_at",{ascending:!1});const{data:d,error:b,count:z}=await a;if(b)throw b;return{data:d,total:z||0}}catch(a){return g.value=a.message,{data:[],total:0}}finally{p.value=!1}},getTestById:async t=>{p.value=!0,g.value=null;try{const{data:a,error:d}=await D.from("tests").select("*").eq("id",t).single();if(d)throw d;return a}catch(a){return g.value=a.message,null}finally{p.value=!1}},getUserTestStatus:async t=>{var a;p.value=!0,g.value=null;try{const{data:d,error:b}=await D.auth.getUser();if(b)throw b;const z=(a=d.user)==null?void 0:a.id;if(!z)throw new Error("用户未登录");const{data:k,error:r}=await D.from("user_tests").select("*").eq("user_id",z).eq("test_id",t).single();if(r&&r.code!=="PGRST116")throw r;return k||null}catch(d){return g.value=d.message,null}finally{p.value=!1}},updateUserTestStatus:async(t,a)=>{var d;p.value=!0,g.value=null;try{const{data:b,error:z}=await D.auth.getUser();if(z)throw z;const k=(d=b.user)==null?void 0:d.id;if(!k)throw new Error("用户未登录");const{data:r,error:l}=await D.from("user_tests").select("*").eq("user_id",k).eq("test_id",t).single();let f;if(l&&l.code==="PGRST116"){const{data:x,error:T}=await D.from("user_tests").insert({user_id:k,test_id:t,...a}).select().single();if(T)throw T;f=x}else{const{data:x,error:T}=await D.from("user_tests").update(a).eq("user_id",k).eq("test_id",t).select().single();if(T)throw T;f=x}return f}catch(b){return g.value=b.message,null}finally{p.value=!1}}}}),Te={getTests:p=>M().getTests(p),getTestById:p=>M().getTestById(p),getUserTestStatus:p=>M().getUserTestStatus(p),updateUserTestStatus:(p,g)=>M().updateUserTestStatus(p,g)},be={class:"personal-test-history"},ke={class:"feedback-header"},xe={class:"feedback-item"},Se={class:"feedback-item"},ze={class:"feedback-content"},Ve=Z({__name:"PersonalTestHistory",props:{testId:{}},setup(p){const g=p,q=y(!1),I=y([]),B=y(!1),S=y(null),t=async()=>{q.value=!0;try{const{data:r}=await oe.getUserTestResults({page:1,pageSize:100});I.value=r.filter(l=>l.test_id===g.testId).sort((l,f)=>new Date(f.submitted_at).getTime()-new Date(l.submitted_at).getTime())}catch(r){console.error("加载测试历史记录失败:",r),P.error("加载测试历史记录失败，请稍后重试")}finally{q.value=!1}};_e(()=>g.testId,()=>{t()});const a=r=>r?new Date(r).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",d=(r,l,f)=>r===null?"info":l=="case"||l=="comprehensive"?f?"success":"warning":r>=80?"success":r>=60?"warning":"danger",b=r=>{const{score:l,type:f,is_graded:x,grade_level:T}=r;return x?f==="case"?T?`评级: ${T}`:`${l}分`:f==="comprehensive"?`${l}分`:`${l}分`:"待批改"},z=r=>{switch(r){case"A":return"success";case"B":return"success";case"C":return"warning";case"D":return"danger";default:return"info"}},k=r=>{S.value=r,B.value=!0};return ee(()=>{t()}),(r,l)=>{const f=m("el-table-column"),x=m("el-tag"),T=m("el-button"),U=m("el-empty"),A=m("el-table"),R=m("el-divider"),F=m("el-dialog"),$=se("loading");return v(),C("div",be,[te((v(),L(A,{data:I.value},{default:i(()=>[o(f,{prop:"test_title",label:"测试标题"}),o(f,{prop:"score",label:"分数/评级",width:"120"},{default:i(_=>[o(x,{size:"large",style:{"font-size":"14px"},type:d(_.row.score,_.row.type,_.row.is_graded)},{default:i(()=>[h(w(b(_.row)),1)]),_:2},1032,["type"])]),_:1}),o(f,{prop:"submitted_at",label:"提交时间",width:"180"},{default:i(_=>[h(w(a(_.row.submitted_at)),1)]),_:1}),o(f,{label:"批改状态",width:"100"},{default:i(_=>[o(x,{style:{"font-size":"14px"},size:"large",type:_.row.is_graded?"success":"warning"},{default:i(()=>[h(w(_.row.is_graded?"已批改":"待批改"),1)]),_:2},1032,["type"])]),_:1}),o(f,{label:"操作",width:"100"},{default:i(_=>[_.row.is_graded&&_.row.type==="case"?(v(),L(T,{key:0,size:"small",type:"primary",onClick:N=>k(_.row)},{default:i(()=>l[1]||(l[1]=[h("查看反馈")])),_:2},1032,["onClick"])):G("",!0)]),_:1}),o(U,null,{description:i(()=>l[2]||(l[2]=[h(" 暂无测试记录 ")])),_:1})]),_:1},8,["data"])),[[$,q.value]]),o(F,{modelValue:B.value,"onUpdate:modelValue":l[0]||(l[0]=_=>B.value=_),title:"评价反馈",width:"600px"},{default:i(()=>[S.value?(v(),C(ae,{key:0},[c("div",ke,[c("div",xe,[l[3]||(l[3]=c("span",{class:"label"},"评级:",-1)),o(x,{size:"large",style:{"font-size":"16px"},type:z(S.value.grade_level)},{default:i(()=>[h(w(S.value.grade_level||"-"),1)]),_:1},8,["type"])]),c("div",Se,[l[4]||(l[4]=c("span",{class:"label"},"提交时间:",-1)),c("span",null,w(a(S.value.submitted_at)),1)])]),o(R,{"content-position":"left"},{default:i(()=>l[5]||(l[5]=[h("评价内容")])),_:1}),c("div",ze,w(S.value.feedback_text||"老师暂未留下具体评价。"),1)],64)):G("",!0)]),_:1},8,["modelValue"])])}}}),Ce=le(Ve,[["__scopeId","data-v-17136486"]]),qe={class:"test-list-container"},Ue={class:"test-list"},$e={key:1,class:"test-grid"},De={class:"test-card-content"},Ie={class:"test-type-tag flex"},Be={class:"test-title"},Re={class:"test-info"},Ee={class:"info-item"},Le={class:"info-item"},Ne={class:"info-item"},Pe={class:"test-status"},Ge={key:0,class:"status-tag"},He={class:"score-text"},Me={key:1,class:"status-tag"},Ae={key:2,class:"status-tag"},Fe={class:"test-actions"},Qe={key:2,class:"pagination"},je=Z({__name:"TestListView",setup(p){const g=me(),q=y(!0),I=y([]),B=y({}),S=y(""),t=y(""),a=y(!1),d=fe({page:1,pageSize:10,total:0}),b=e=>{d.page=e.page,d.pageSize=e.pageSize,x()},z=y([]),k=async()=>{try{const{data:e}=await oe.getUserTestResults({page:1,pageSize:100}),s={};e.forEach(u=>{u.test_id&&(!s[u.test_id]||new Date(u.submitted_at)>new Date(s[u.test_id].submitted_at))&&(s[u.test_id]=u)}),z.value=e,B.value=s}catch(e){console.error("加载测试结果失败:",e),P.error("加载测试结果失败，请稍后重试")}};ee(async()=>{await Promise.all([x(),k()])});const r=ge(),l=y(r.query.platform||"google"),f=y(r.query.chapter||"base"),x=async()=>{q.value=!0;try{const{data:e,total:s}=await Te.getTests({platform:l.value,chapter:f.value});d.total=s;let u=[...e];S.value&&(u=u.filter(V=>V.title.toLowerCase().includes(S.value.toLowerCase()))),t.value&&(u=u.filter(V=>V.type===t.value)),I.value=u,d.total=u.length}catch(e){console.error("加载测验失败:",e),P.error("加载测验失败，请稍后重试")}finally{q.value=!1}},T=()=>{d.page=1,x()},U=ve(()=>e=>B.value[e]),A=e=>{var V;if(e.type==="case"&&N(e.id)>=3){P.warning("您已达到最大尝试次数(3次)，不能再次作答");return}const s=e.type;let u="";switch(s){case"case":u="case-study";break;case"select":u="multiple-choice";break;case"comprehensive":u="comprehensive-test";break;default:u="multiple-choice"}((V=U.value(e.id))==null?void 0:V.completion_status)==="completed"?we.confirm("您已完成此测验，确定要重新开始吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{g.push({name:u,query:{testId:e.id,testName:$(e.platform||"")+"-"+$(e.chapter||"")+"-"+e.title,platform:e.platform,chapter:e.chapter,type:e.type}})}).catch(()=>{P.info("已取消重新开始")}):g.push({name:u,query:{testId:e.id,testName:$(e.platform||"")+"-"+$(e.chapter||"")+"-"+e.title,platform:e.platform,chapter:e.chapter,type:e.type}})},R=y(null),F=e=>{R.value=e,a.value=!0},$=e=>{switch(e){case"select":return"选择题";case"case":return"案例分析";case"comprehensive":return"综合测验";case"google":return"Google";case"facebook":return"FaceBook";case"base":return"基础";case"middle":return"中级";case"advanced":return"高级";default:return"未知类型"}},_=e=>{switch(e){case"select":return"primary";case"case":return"success";case"comprehensive":return"warning";case"google":return"danger";case"facebook":return"primary";case"base":return"primary";case"middle":return"success";case"advanced":return"warning";default:return"info"}},N=e=>{let s=0;return Object.values(z.value).forEach(u=>{u.test_id===e&&s++}),s},re=(e,s)=>{if(N((s==null?void 0:s.id)||"")>=3)return"尝试次数已用完";switch(e){case"completed":return"重新测试";case"in_progress":return"继续测试";default:return"开始测试"}},ne=e=>e?e.is_graded?e.type==="case"&&e.grade_level?`评级: ${e.grade_level}`:`${e.score}分`:"待批改":"0分";return(e,s)=>{var J;const u=m("el-input"),V=m("el-option"),j=m("el-select"),Q=m("el-button"),ie=m("el-space"),O=m("el-card"),ue=m("el-empty"),E=m("el-tag"),ce=m("el-dialog"),de=se("loading");return v(),C("div",qe,[o(O,{class:"testing-search",style:{"margin-bottom":"20px"}},{default:i(()=>[o(ie,{alignment:"start",size:30},{default:i(()=>[o(u,{size:"large",style:{width:"240px"},modelValue:S.value,"onUpdate:modelValue":s[0]||(s[0]=n=>S.value=n),placeholder:"搜索测验名称",class:"search-input",clearable:"",onInput:T},null,8,["modelValue"]),o(j,{size:"large",style:{width:"240px"},modelValue:t.value,"onUpdate:modelValue":s[1]||(s[1]=n=>t.value=n),placeholder:"测验类型",onChange:T,class:"filter-select"},{default:i(()=>[o(V,{label:"全部类型",value:""}),o(V,{label:"选择题",value:"select"}),o(V,{label:"案例分析",value:"case"}),o(V,{label:"综合测验",value:"comprehensive"})]),_:1},8,["modelValue"]),o(Q,{type:"primary",size:"large",onClick:T},{default:i(()=>s[3]||(s[3]=[h("搜索")])),_:1})]),_:1})]),_:1}),te((v(),C("div",Ue,[I.value.length===0&&!q.value?(v(),L(ue,{key:0,description:"暂无测验内容"})):(v(),C("div",$e,[(v(!0),C(ae,null,ye(I.value,n=>(v(),L(O,{key:n.id,class:"test-card",shadow:"hover"},{default:i(()=>{var X,K,W,Y;return[c("div",De,[c("div",Ie,[o(E,{type:_(n.type)},{default:i(()=>[h(w($(n.type)),1)]),_:2},1032,["type"]),o(E,{type:_(n.platform||"")},{default:i(()=>[h(w($(n.platform||"")),1)]),_:2},1032,["type"]),o(E,{type:_(n.chapter||"")},{default:i(()=>[h(w($(n.chapter||"")),1)]),_:2},1032,["type"])]),c("h3",Be,w(n.title),1),c("div",Re,[c("div",Ee,[s[4]||(s[4]=c("i",{class:"el-icon-question"},null,-1)),c("span",null,w(n.question_count||0)+"道题目",1)]),c("div",Le,[s[5]||(s[5]=c("i",{class:"el-icon-medal"},null,-1)),c("span",null,w(n.score_weight||100)+"分值",1)]),c("div",Ne,[s[6]||(s[6]=c("i",{class:"el-icon-refresh"},null,-1)),c("span",null,"尝试次数: "+w(N(n.id))+"/3",1)])]),c("div",Pe,[((X=U.value(n.id))==null?void 0:X.completion_status)==="completed"?(v(),C("div",Ge,[o(E,{type:"success"},{default:i(()=>s[7]||(s[7]=[h("已完成")])),_:1}),c("span",He,"最新分数: "+w(ne(U.value(n.id))),1)])):((K=U.value(n.id))==null?void 0:K.completion_status)==="in_progress"?(v(),C("div",Me,[o(E,{type:"warning"},{default:i(()=>s[8]||(s[8]=[h("进行中")])),_:1})])):(v(),C("div",Ae,[o(E,{type:"info"},{default:i(()=>s[9]||(s[9]=[h("未开始")])),_:1})]))]),c("div",Fe,[o(Q,{type:"primary",disabled:((W=U.value(n.id))==null?void 0:W.completion_status)==="in_progress"||N(n.id)>=3,onClick:H=>A(n)},{default:i(()=>{var H;return[h(w(re((H=U.value(n.id))==null?void 0:H.completion_status,n)),1)]}),_:2},1032,["disabled","onClick"]),((Y=U.value(n.id))==null?void 0:Y.completion_status)==="completed"?(v(),L(Q,{key:0,type:"info",plain:"",onClick:H=>F(n)},{default:i(()=>s[10]||(s[10]=[h(" 查看历史 ")])),_:2},1032,["onClick"])):G("",!0)])])]}),_:2},1024))),128))])),d.total>0?(v(),C("div",Qe,[o(he,{pagination:d,onUpdate:b},null,8,["pagination"])])):G("",!0)])),[[de,q.value]]),o(ce,{modelValue:a.value,"onUpdate:modelValue":s[2]||(s[2]=n=>a.value=n),title:((J=R.value)==null?void 0:J.title)+" - 测试历史记录",width:"800px"},{default:i(()=>[R.value?(v(),L(Ce,{key:0,testId:R.value.id},null,8,["testId"])):G("",!0)]),_:1},8,["modelValue","title"])])}}}),Ye=le(je,[["__scopeId","data-v-2a3f887c"]]);export{Ye as default};
