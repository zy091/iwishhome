import{d as oe,u as ie,r as p,J as re,k as j,o as ue,l as u,e as o,y as de,a as l,t as r,w as s,b as d,O as ce,c as q,P as _e,M as k,f as c,g as v,a2 as J,q as x,F as me,m as pe,A as ve,j as i,_ as fe}from"./index-w0Vcq8R-.js";import{a as O}from"./assignmentService-CNRluYtR.js";const ge={class:"personal-assignments"},he={class:"assignments-header"},ye={class:"tooltip-content"},we={class:"text-truncate"},ke={key:1},be={key:0,class:"assignment-detail"},Ae={class:"assignment-meta"},Ce={class:"assignment-content"},Ve={key:0,class:"assignment-attachment"},xe={class:"attachment-box"},De={class:"attachment-name"},ze={key:1,class:"assignment-replies"},Se={class:"reply-header"},Ue={class:"reply-author"},Fe={key:0,class:"reply-role"},Ne={class:"reply-form"},Be={class:"attachment-preview"},Ee=["src"],Ie=["src"],Le={key:2,class:"attachment-download"},Me=oe({__name:"DailyAssignments",setup(Pe){const m=ie(),D=p(!1),z=p([]),S=p(!1),n=p(null),f=p(""),U=p(!1),b=p(!1),g=p(""),h=p(""),y=re({page:1,pageSize:10,total:0}),F=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",W=j(()=>h.value?h.value.startsWith("image/"):!1),G=j(()=>h.value?h.value==="application/pdf":!1),H=a=>{a.attachment_url&&(g.value=a.attachment_url,h.value=a.attachment_type||"",b.value=!0)},K=()=>{var a;(a=n.value)!=null&&a.attachment_url&&(g.value=n.value.attachment_url,h.value=n.value.attachment_type||"",b.value=!0)},Q=()=>{g.value&&window.open(g.value,"_blank")},A=async()=>{D.value=!0;try{const{data:a,total:e}=await O.getPersonalAssignments(y.page,y.pageSize,{status:""});z.value=a,y.total=e}catch(a){console.error("获取作业列表失败:",a),k.error("获取作业列表失败")}finally{D.value=!1}},X=a=>{n.value=a,S.value=!0,f.value=""},Y=async()=>{var a;if(n.value){if(!f.value.trim()){k.warning("回复内容不能为空");return}U.value=!0;try{if(!((a=m.user)!=null&&a.user_id)||!n.value.id){k.error("用户信息或作业ID缺失");return}const e=await O.addReply({assignment_id:n.value.id,user_id:m.user.user_id,content:f.value,full_name:m.user.full_name||""});n.value.replies||(n.value.replies=[]),n.value.replies.push(e),k.success("提交回复成功"),f.value="",A()}catch(e){console.error("提交回复失败:",e),k.error("提交回复失败")}finally{U.value=!1}}},Z=()=>{A()},ee=a=>{y.page=a.page,y.pageSize=a.pageSize,A()},B=a=>{if(!a.replies||a.replies.length===0)return{type:"warning",text:"待完成"};const e=a.replies.some(_=>{var C;return _.user_id===((C=m.user)==null?void 0:C.user_id)});return a.replies.some(_=>_.user_id!==a.assigned_to),e?{type:"success",text:"已完成"}:{type:"warning",text:"待完成"}};return ue(()=>{A()}),(a,e)=>{const _=d("el-button"),C=d("el-tooltip"),w=d("el-table-column"),E=d("el-icon"),te=d("el-tag"),ae=d("el-table"),V=d("el-divider"),le=d("el-input"),I=d("el-form-item"),se=d("el-form"),L=d("el-dialog"),ne=ce("loading");return i(),u("div",ge,[o("div",he,[o("div",null,"共计"+r(z.value.length)+"个作业",1),l(_,{type:"primary",onClick:Z},{default:s(()=>e[3]||(e[3]=[c("刷新")])),_:1})]),de((i(),q(ae,{data:z.value},{default:s(()=>[l(w,{prop:"title",label:"标题","min-width":"180"},{default:s(t=>[l(C,{placement:"top","show-after":500,"max-width":300},{content:s(()=>[o("div",ye,r(t.row.title),1)]),default:s(()=>[o("div",we,r(t.row.title),1)]),_:2},1024)]),_:1}),l(w,{label:"附件",width:"80"},{default:s(t=>[t.row.attachment_url?(i(),q(_,{key:0,type:"primary",link:"",onClick:N=>H(t.row)},{default:s(()=>[l(E,{color:"#409EFF",size:"18"},{default:s(()=>[l(v(J))]),_:1})]),_:2},1032,["onClick"])):(i(),u("span",ke,"-"))]),_:1}),l(w,{label:"状态",width:"100"},{default:s(t=>[l(te,{type:B(t.row).type},{default:s(()=>[c(r(B(t.row).text),1)]),_:2},1032,["type"])]),_:1}),l(w,{prop:"created_at",label:"创建时间",width:"180"},{default:s(t=>[c(r(F(t.row.created_at)),1)]),_:1}),l(w,{label:"操作",width:"120"},{default:s(t=>[l(_,{type:"primary",onClick:N=>X(t.row)},{default:s(()=>e[4]||(e[4]=[c("查看")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ne,D.value]]),l(_e,{pagination:y,"onUpdate:pagination":ee},null,8,["pagination"]),l(L,{modelValue:S.value,"onUpdate:modelValue":e[1]||(e[1]=t=>S.value=t),title:"作业详情",width:"600px"},{default:s(()=>[n.value?(i(),u("div",be,[o("h3",null,r(n.value.title),1),o("div",Ae,[o("p",null,"创建时间: "+r(F(n.value.created_at)),1)]),o("div",Ce,[l(V,{"content-position":"left"},{default:s(()=>e[5]||(e[5]=[c("作业内容")])),_:1}),o("p",null,r(n.value.content),1)]),n.value.attachment_url?(i(),u("div",Ve,[l(V,{"content-position":"left"},{default:s(()=>e[6]||(e[6]=[c("附件")])),_:1}),o("div",xe,[l(E,{color:"#409EFF",size:"16"},{default:s(()=>[l(v(J))]),_:1}),o("span",De,r(n.value.attachment_name),1),l(_,{type:"primary",size:"small",onClick:K},{default:s(()=>e[7]||(e[7]=[c("查看附件")])),_:1})])])):x("",!0),n.value.replies&&n.value.replies.length>0?(i(),u("div",ze,[l(V,{"content-position":"left"},{default:s(()=>e[8]||(e[8]=[c("回复记录")])),_:1}),(i(!0),u(me,null,pe(n.value.replies,(t,N)=>{var M,P,R,$,T;return i(),u("div",{key:N,class:ve(["reply-item",{"my-reply":t.user_id===((M=v(m).user)==null?void 0:M.user_id),"admin-reply":t.user_id!==n.value.assigned_to&&t.user_id!==((P=v(m).user)==null?void 0:P.user_id),"other-reply":t.user_id!==((R=v(m).user)==null?void 0:R.user_id)&&t.user_id===n.value.assigned_to}])},[o("div",Se,[o("span",Ue,r(t.user_id===(($=v(m).user)==null?void 0:$.user_id)?"我":t.full_name||"未知用户"),1),t.user_id!==n.value.assigned_to&&t.user_id!==((T=v(m).user)==null?void 0:T.user_id)?(i(),u("span",Fe,"管理员")):x("",!0)]),o("p",null,r(t.content),1),o("small",null,r(F(t.created_at)),1)],2)}),128))])):x("",!0),o("div",Ne,[l(V,{"content-position":"left"},{default:s(()=>e[9]||(e[9]=[c("提交回复")])),_:1}),l(se,null,{default:s(()=>[l(I,null,{default:s(()=>[l(le,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=t=>f.value=t),type:"textarea",rows:4,placeholder:"请输入您的回复内容"},null,8,["modelValue"])]),_:1}),l(I,null,{default:s(()=>[l(_,{type:"primary",onClick:Y,loading:U.value},{default:s(()=>e[10]||(e[10]=[c("提交回复")])),_:1},8,["loading"])]),_:1})]),_:1})])])):x("",!0)]),_:1},8,["modelValue"]),l(L,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=t=>b.value=t),title:"附件预览",width:"80%","destroy-on-close":""},{default:s(()=>[o("div",Be,[W.value?(i(),u("img",{key:0,src:g.value,class:"attachment-image"},null,8,Ee)):G.value?(i(),u("iframe",{key:1,src:g.value,class:"attachment-frame"},null,8,Ie)):(i(),u("div",Le,[e[12]||(e[12]=o("p",null,"无法预览此类型的文件，请下载后查看",-1)),l(_,{type:"primary",onClick:Q},{default:s(()=>e[11]||(e[11]=[c("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])}}}),Te=fe(Me,[["__scopeId","data-v-b4262b87"]]);export{Te as default};
