import{E as w,s as Xe,w as ve,C as Ke,u as Ye,A as Ze,B as Ie,v as et,x as tt,c as ge}from"./elementPlus-Dv7g5dxn.js";import{s as h,u as at,B as lt,b as nt,_ as st}from"./index-_R_LCzP9.js";import{x as ot,X as le,c as I,r as c,j as rt,y as C,P as a,A as s,H as n,ag as d,G as V,J as x,u as z,O as fe,a6 as ye,L as m,I as it,aq as ut,M as b,z as u}from"./vendor-COQJj1AX.js";import"./supabase-Bqqw4QDB.js";const ct=r=>r===0||r===1||r===11,J={async getAllCases(r={}){let i=h.from("case_sharing").select("*",{count:"exact"});if(r.query&&(i=i.ilike("title",`%${r.query}%`)),r.category&&r.category!=="all"&&(i=i.eq("category",r.category)),r.startDate&&r.endDate&&(i=i.gte("created_at",r.startDate).lte("created_at",r.endDate)),r.viewType==="my"){const{data:{user:q}}=await h.auth.getUser();q&&(i=i.eq("created_by",q.id))}r.showStatus!==void 0?i=i.eq("is_show",r.showStatus==="true"):i=i.eq("is_show",!0);const p=((r.page||1)-1)*(r.pageSize||10),f=p+(r.pageSize||10)-1,{data:v,error:y,count:N}=await i.order("created_at",{ascending:!1}).range(p,f);if(y)throw y;return{data:v,total:N||0}},async getCase(r){const{data:i,error:p}=await h.from("case_sharing").select("*").eq("id",r).single();if(p)throw p;return i},async createCase(r){const{data:{user:i}}=await h.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:p,error:f}=await h.from("user_profiles").select("full_name, organization_id").eq("user_id",i.id).single();if(f)throw f;const{data:v,error:y}=await h.from("case_sharing").insert({...r,created_by:i.id,created_by_name:p.full_name||i.email,organization_id:p.organization_id}).select().single();if(y)throw y;return v},async updateCase(r,i){const{data:p,error:f}=await h.from("case_sharing").update(i).eq("id",r).select().single();if(f)throw f;return p},async deleteCase(r){const{error:i}=await h.from("case_sharing").delete().eq("id",r);if(i)throw i},async uploadFile(r,i){const p=`${new Date().getTime()}_${r.name}`,f=`${i}/${p}`,{data:v,error:y}=await h.storage.from("materials").upload(f,r);if(y)throw y;const{data:{publicUrl:N}}=h.storage.from("materials").getPublicUrl(f);return{url:N,filename:p}}},dt={class:"layout"},mt={class:"layout-title"},pt={class:"status-tabs"},_t={class:"cases-content"},vt={class:"card-header"},gt={key:0,class:"header-actions"},ft={style:{"font-size":"14px",color:"#909399"}},yt={key:2},ht={class:"dialog-content"},wt={class:"case-details"},bt={class:"case-header"},kt={class:"case-title"},Ct={class:"case-meta"},Vt={class:"meta-item"},xt={class:"meta-item"},Dt={class:"meta-item"},zt={class:"case-section"},St=["innerHTML"],Ut={key:0,class:"case-section"},Tt={class:"attachment-box"},$t={class:"attachment-name"},qt={key:1,class:"case-section"},Et={class:"link-box"},Ft={class:"link-url"},At={class:"dialog-footer"},Bt={class:"attachment-preview"},Lt=["src"],Nt=["src"],Pt={key:2,class:"attachment-download"},Mt={class:"dialog-footer"},jt=ot({__name:"CaseSharing",setup(r){const i=le([{name:"分享分享",path:"/system/case-sharing"}]),p=at(),f=I(()=>{var t;return((t=p.user)==null?void 0:t.user_id)||""}),v=I(()=>ct(Number(p.roleId))),y=c(!1),N=c([]),q=c(!1),P=c(!1),_=c(null),ee=c(""),S=c([]),Q=c(""),W=c(!1),X=c("all"),E=c([]),te=c(),F=c(!1),K=c(""),Y=c(!1),M=c(""),j=c(""),o=le({id:"",title:"",content:"",category:"",is_show:!0,attachment_url:"",attachment_name:"",attachment_type:"",link_url:""}),he={title:[{required:!0,message:"请输入分享标题",trigger:"blur"},{min:2,max:100,message:"标题长度应在2到100个字符之间",trigger:"blur"}],category:[{required:!0,message:"请选择分享类型",trigger:"change"}],content:[{required:!1,message:"请输入分享内容",trigger:"blur"},{min:2,max:1e4,message:"内容长度应在8到10000个字符之间",trigger:"blur"}]},ne=[{label:"广告",value:"advertising"},{label:"素材",value:"material"},{label:"日常运营",value:"daily_operation"},{label:"客户案例",value:"customer_case"},{label:"技术分享",value:"technical"},{label:"其他",value:"other"}],U=le({page:1,pageSize:10,total:0}),Z=c([]),D=c(null),we=[{text:"最近一周",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近一个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近三个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],be=I(()=>j.value?j.value.startsWith("image/"):!1),ke=I(()=>j.value?j.value==="application/pdf":!1),Ce=t=>{switch(t){case"advertising":return"primary";case"material":return"success";case"daily_operation":return"warning";case"customer_case":return"danger";case"technical":return"info";case"other":return"";default:return"info"}},se=t=>{switch(t){case"advertising":return"广告";case"material":return"素材";case"daily_operation":return"日常运营";case"customer_case":return"客户分享";case"technical":return"技术分享";case"other":return"其他";default:return t||"未知"}},Ve=t=>v.value?!0:t.created_by===f.value,xe=t=>v.value?!0:t.created_by===f.value,De=t=>{U.page=t.page,U.pageSize=t.pageSize,A()},A=async()=>{y.value=!0;const t=S.value!=null&&S.value[0]!=null?S.value[0].toDateString():"",e=S.value!=null&&S.value[1]!=null?S.value[1].toDateString():"";try{const k=await J.getAllCases({query:ee.value,startDate:t,endDate:e,page:U.page,pageSize:U.pageSize,category:K.value!==""?K.value:void 0,showStatus:v.value&&Q.value!==""?Q.value:void 0,viewType:X.value});N.value=k.data,U.total=k.total}catch(k){w.error("搜索分享失败"),console.error("搜索分享失败:",k)}finally{y.value=!1}},ze=async t=>{q.value=!0,_.value=t},Se=t=>{t.attachment_url&&(M.value=t.attachment_url,j.value=re(t.attachment_name),Y.value=!0)},Ue=()=>{var t;(t=_.value)!=null&&t.attachment_url&&(M.value=_.value.attachment_url,j.value=re(_.value.attachment_name),Y.value=!0)},Te=()=>{M.value&&window.open(M.value,"_blank")},oe=t=>{t&&window.open(t,"_blank")},re=t=>{if(!t)return"";const e=$e(t);return["jpg","jpeg","png","gif","webp"].includes(e)?"image/"+e:e==="pdf"?"application/pdf":""},$e=t=>{if(!t)return"";const e=t.split(".");return e.length>1?e[e.length-1].toLowerCase():""},qe=()=>{F.value=!1,P.value=!0,Object.assign(o,{id:"",title:"",content:"",category:"",is_show:!0,attachment_url:"",attachment_name:"",attachment_type:"",link_url:""}),Z.value=[],D.value=null},Ee=t=>{F.value=!0,P.value=!0,Object.assign(o,{id:t.id,title:t.title,content:t.content,category:t.category,is_show:t.is_show,attachment_url:t.attachment_url,attachment_name:t.attachment_name,attachment_type:t.attachment_type,link_url:t.link_url}),Z.value=[],D.value=null},Fe=t=>{E.value=t},Ae=t=>{const e=["application/pdf","application/msword","text/plain","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/jpeg","image/png","image/gif","image/webp"],k=t.raw&&e.includes(t.raw.type),R=t.raw&&t.raw.size/1024/1024<10;if(!k)return w.error("文件类型不支持！"),!1;if(!R)return w.error("文件大小超过 10MB 限制！"),!1;D.value=t.raw,console.log("Selected file:",D.value)},Be=async t=>{if(!t)throw new Error("No file selected");const e=t.name.split(".").pop(),R=`casesharing/${`${Date.now()}-${Math.random().toString(36).substring(2)}.${e}`}`,{data:O,error:B}=await h.storage.from("materials").upload(R,t);if(B)throw B;const{data:G}=h.storage.from("materials").getPublicUrl(O.path);return G.publicUrl},Le=async()=>{te.value&&await te.value.validate(async t=>{if(t){W.value=!0;try{if(D.value)try{const e=await Be(D.value);o.attachment_url=e,o.attachment_name=D.value.name,o.attachment_type=D.value.type}catch(e){w.error(`文件上传失败: ${e.message||"未知错误"}`),W.value=!1;return}F.value?(await J.updateCase(o.id,{title:o.title,content:o.content,category:o.category,is_show:o.is_show,attachment_url:o.attachment_url,attachment_name:o.attachment_name,attachment_type:o.attachment_type,link_url:o.link_url}),w.success("分享已更新")):(await J.createCase({title:o.title,content:o.content,category:o.category,is_show:o.is_show,attachment_url:o.attachment_url,attachment_name:o.attachment_name,attachment_type:o.attachment_type,link_url:o.link_url}),w.success("分享已创建")),P.value=!1,A(),Z.value=[],D.value=null}catch(e){w.error(F.value?"更新分享失败":"创建分享失败"),console.error(F.value?"更新分享失败:":"创建分享失败:",e)}finally{W.value=!1}}})},Ne=async t=>{try{await ge.confirm(`确定要删除 "${t.title}" 这个分享吗？`,"提示",{type:"warning"}),await J.deleteCase(t.id),w.success("删除成功"),A()}catch(e){e!=="cancel"&&(w.error("删除失败"),console.error("删除失败:",e))}},Pe=async()=>{if(E.value.length!==0)try{await ge.confirm(`确定要删除选中的 ${E.value.length} 个分享吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=E.value.map(e=>J.deleteCase(e.id));await Promise.all(t),w.success(`成功删除 ${E.value.length} 个分享`),E.value=[],A()}catch(t){t!=="cancel"&&(console.error("批量删除分享失败:",t),w.error("批量删除失败"))}},Me=t=>{X.value=t,U.page=1,A()};return rt(()=>{A()}),(t,e)=>{const k=d("el-tab-pane"),R=d("el-tabs"),O=d("el-input"),B=d("el-option"),G=d("el-select"),je=d("el-date-picker"),g=d("el-button"),Oe=d("el-space"),ie=d("el-card"),T=d("el-table-column"),ue=d("el-tag"),$=d("el-icon"),He=d("el-button-group"),Re=d("el-empty"),Ge=d("el-table"),ae=d("el-dialog"),H=d("el-form-item"),Je=d("el-upload"),Qe=d("el-switch"),We=ut("loading");return u(),C("div",dt,[a(lt,{breadbcrum:i},null,8,["breadbcrum"]),s("div",mt,[e[16]||(e[16]=s("h1",{class:"title"},"知识分享",-1)),s("div",pt,[a(R,{class:"demo-tabs",modelValue:X.value,"onUpdate:modelValue":e[0]||(e[0]=l=>X.value=l),onTabChange:Me},{default:n(()=>[a(k,{name:"all",label:"全部分享"}),a(k,{name:"my",label:"我的分享"})]),_:1},8,["modelValue"])])]),a(ie,{shadow:"always",style:{"margin-bottom":"20px"}},{default:n(()=>[a(Oe,{alignment:"start",size:30},{default:n(()=>[a(O,{modelValue:ee.value,"onUpdate:modelValue":e[1]||(e[1]=l=>ee.value=l),style:{width:"240px"},placeholder:"请输入分享标题","suffix-icon":z(Xe),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),a(G,{modelValue:K.value,"onUpdate:modelValue":e[2]||(e[2]=l=>K.value=l),placeholder:"分享类型",clearable:"",style:{width:"180px"},size:"large"},{default:n(()=>[(u(),C(fe,null,ye(ne,l=>a(B,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),a(je,{modelValue:S.value,"onUpdate:modelValue":e[3]||(e[3]=l=>S.value=l),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:we,size:"large"},null,8,["modelValue"]),v.value?(u(),V(G,{key:0,modelValue:Q.value,"onUpdate:modelValue":e[4]||(e[4]=l=>Q.value=l),placeholder:"选择展示状态",style:{width:"160px"},size:"large",clearable:""},{default:n(()=>[a(B,{label:"显示",value:"true"}),a(B,{label:"隐藏",value:"false"})]),_:1},8,["modelValue"])):x("",!0),a(g,{type:"primary",size:"large",onClick:A},{default:n(()=>e[17]||(e[17]=[m("搜索")])),_:1}),a(g,{type:"success",size:"large",onClick:qe},{default:n(()=>e[18]||(e[18]=[m("添加分享")])),_:1})]),_:1})]),_:1}),s("div",_t,[a(ie,{style:{"min-height":"400px"}},{header:n(()=>[s("div",vt,[e[20]||(e[20]=m(" 分享列表 ")),v.value?(u(),C("div",gt,[a(g,{type:"danger",disabled:!E.value.length,onClick:Pe},{default:n(()=>e[19]||(e[19]=[m(" 批量删除 ")])),_:1},8,["disabled"]),s("div",ft,"共计"+b(U.total)+"条数据",1)])):x("",!0)])]),default:n(()=>[it((u(),V(Ge,{data:N.value,onSelectionChange:Fe},{default:n(()=>[v.value?(u(),V(T,{key:0,type:"selection",width:"55"})):x("",!0),a(T,{prop:"title",label:"标题","min-width":"200"}),a(T,{prop:"category",label:"类型",width:"130"},{default:n(({row:l})=>[a(ue,{type:Ce(l.category),size:"large"},{default:n(()=>[m(b(se(l.category)),1)]),_:2},1032,["type"])]),_:1}),a(T,{label:"附件/链接",width:"120"},{default:n(({row:l})=>[l.attachment_url?(u(),V(g,{key:0,type:"primary",link:"",onClick:L=>Se(l)},{default:n(()=>[a($,{color:"#409EFF",size:"18"},{default:n(()=>[a(z(ve))]),_:1})]),_:2},1032,["onClick"])):l.link_url?(u(),V(g,{key:1,type:"primary",link:"",onClick:L=>oe(l.link_url)},{default:n(()=>[a($,{color:"#67C23A",size:"18"},{default:n(()=>[a(z(Ke))]),_:1})]),_:2},1032,["onClick"])):(u(),C("span",yt,"-"))]),_:1}),v.value?(u(),V(T,{key:1,prop:"is_show",label:"展示状态",width:"100"},{default:n(({row:l})=>[a(ue,{type:l.is_show?"success":"danger",size:"large"},{default:n(()=>[m(b(l.is_show?"显示":"隐藏"),1)]),_:2},1032,["type"])]),_:1})):x("",!0),a(T,{prop:"created_at",label:"创建时间",width:"180"},{default:n(({row:l})=>[m(b(new Date(l.created_at).toLocaleString()),1)]),_:1}),v.value?(u(),V(T,{key:2,prop:"created_by_name",label:"创建人",width:"120"})):x("",!0),a(T,{label:"操作",width:"230",fixed:"right"},{default:n(({row:l})=>[a(He,null,{default:n(()=>[a(g,{type:"primary",onClick:L=>ze(l)},{default:n(()=>e[21]||(e[21]=[m("查看")])),_:2},1032,["onClick"]),Ve(l)?(u(),V(g,{key:0,type:"warning",onClick:L=>Ee(l)},{default:n(()=>e[22]||(e[22]=[m("编辑")])),_:2},1032,["onClick"])):x("",!0),xe(l)?(u(),V(g,{key:1,type:"danger",onClick:L=>Ne(l)},{default:n(()=>e[23]||(e[23]=[m("删除")])),_:2},1032,["onClick"])):x("",!0)]),_:2},1024)]),_:1}),a(Re,null,{description:n(()=>e[24]||(e[24]=[m(" 暂无分享数据 ")])),_:1})]),_:1},8,["data"])),[[We,y.value]])]),_:1}),a(nt,{pagination:U,"onUpdate:pagination":De},null,8,["pagination"]),a(ae,{title:"分享详情",modelValue:q.value,"onUpdate:modelValue":e[7]||(e[7]=l=>q.value=l),width:"60%","close-on-click-modal":!1,top:"5vh",class:"case-detail-dialog"},{footer:n(()=>[s("span",At,[a(g,{onClick:e[6]||(e[6]=l=>q.value=!1)},{default:n(()=>e[31]||(e[31]=[m("关闭")])),_:1})])]),default:n(()=>{var l,L,ce,de,me,pe,_e;return[s("div",ht,[s("div",wt,[s("div",bt,[s("h2",kt,b(((l=_.value)==null?void 0:l.title)||"无标题"),1),s("div",Ct,[s("span",Vt,[a($,null,{default:n(()=>[a(z(Ye))]),_:1}),s("span",null,b(((L=_.value)==null?void 0:L.created_by_name)||"未知用户"),1)]),s("span",xt,[a($,null,{default:n(()=>[a(z(Ze))]),_:1}),s("span",null,b(_.value?new Date((ce=_.value)==null?void 0:ce.created_at).toLocaleString():"未知时间"),1)]),s("span",Dt,[a($,null,{default:n(()=>[a(z(Ie))]),_:1}),s("span",null,b(se(((de=_.value)==null?void 0:de.category)||"")),1)])])]),s("div",zt,[e[25]||(e[25]=s("div",{class:"section-title"},"内容",-1)),s("div",{class:"case-content",style:{padding:"10px"},innerHTML:((me=_.value)==null?void 0:me.content)||"无内容"},null,8,St)]),(pe=_.value)!=null&&pe.attachment_url?(u(),C("div",Ut,[e[27]||(e[27]=s("div",{class:"section-title"},"附件",-1)),s("div",Tt,[a($,{color:"#409EFF",size:"16"},{default:n(()=>[a(z(ve))]),_:1}),s("span",$t,b(_.value.attachment_name),1),a(g,{type:"primary",size:"small",onClick:Ue},{default:n(()=>e[26]||(e[26]=[m("查看附件")])),_:1})])])):x("",!0),(_e=_.value)!=null&&_e.link_url?(u(),C("div",qt,[e[30]||(e[30]=s("div",{class:"section-title"},"相关链接",-1)),s("div",Et,[a($,{color:"#67C23A",size:"16"},{default:n(()=>e[28]||(e[28]=[s("link",null,null,-1)])),_:1}),s("span",Ft,b(_.value.link_url),1),a(g,{type:"success",size:"small",onClick:e[5]||(e[5]=Ot=>oe(_.value.link_url))},{default:n(()=>e[29]||(e[29]=[m("打开链接")])),_:1})])])):x("",!0)])])]}),_:1},8,["modelValue"]),a(ae,{modelValue:Y.value,"onUpdate:modelValue":e[8]||(e[8]=l=>Y.value=l),title:"附件预览",width:"80%","destroy-on-close":""},{default:n(()=>[s("div",Bt,[be.value?(u(),C("img",{key:0,src:M.value,class:"attachment-image"},null,8,Lt)):ke.value?(u(),C("iframe",{key:1,src:M.value,class:"attachment-frame"},null,8,Nt)):(u(),C("div",Pt,[e[33]||(e[33]=s("p",null,"无法预览此类型的文件，请下载后查看",-1)),a(g,{type:"primary",onClick:Te},{default:n(()=>e[32]||(e[32]=[m("下载附件")])),_:1})]))])]),_:1},8,["modelValue"]),a(ae,{title:F.value?"编辑分享":"知识分享",modelValue:P.value,"onUpdate:modelValue":e[15]||(e[15]=l=>P.value=l),width:"50%","close-on-click-modal":!1},{footer:n(()=>[s("span",Mt,[a(g,{onClick:e[14]||(e[14]=l=>P.value=!1)},{default:n(()=>e[36]||(e[36]=[m("取消")])),_:1}),a(g,{type:"primary",onClick:Le,loading:W.value},{default:n(()=>[m(b(F.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:n(()=>[a(z(et),{model:o,rules:he,ref_key:"caseForm",ref:te,"label-width":"80px",style:{"max-width":"800px"}},{default:n(()=>[a(H,{label:"标题",prop:"title"},{default:n(()=>[a(O,{modelValue:o.title,"onUpdate:modelValue":e[9]||(e[9]=l=>o.title=l),placeholder:"请输入分享标题"},null,8,["modelValue"])]),_:1}),a(H,{label:"类型",prop:"category"},{default:n(()=>[a(G,{modelValue:o.category,"onUpdate:modelValue":e[10]||(e[10]=l=>o.category=l),placeholder:"选择分享类型",style:{width:"100%"}},{default:n(()=>[(u(),C(fe,null,ye(ne,l=>a(B,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(H,{label:"内容",prop:"content"},{default:n(()=>[a(O,{type:"textarea",modelValue:o.content,"onUpdate:modelValue":e[11]||(e[11]=l=>o.content=l),rows:10,placeholder:"请输入分享内容"},null,8,["modelValue"])]),_:1}),a(H,{label:"附件"},{default:n(()=>[a(Je,{class:"upload-box","auto-upload":!1,"on-change":Ae,"file-list":Z.value,limit:1,drag:"",action:"https://run.mocky.io/v3/9d059bf9-4660-45f2-925d-ce80ad6c4d15",multiple:""},{tip:n(()=>e[34]||(e[34]=[s("div",{class:"el-upload__tip"}," 支持 .pdf, .doc, .docx, .xls, .xlsx, 图片等格式文件，不超过10MB ",-1)])),default:n(()=>[a($,{class:"el-icon--upload"},{default:n(()=>[a(z(tt))]),_:1}),e[35]||(e[35]=s("div",{class:"el-upload__text"},[m(" 拖拽文件或"),s("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),a(H,{label:"链接"},{default:n(()=>[a(O,{modelValue:o.link_url,"onUpdate:modelValue":e[12]||(e[12]=l=>o.link_url=l),placeholder:"请输入相关链接（可选）"},null,8,["modelValue"])]),_:1}),v.value?(u(),V(H,{key:0,label:"状态"},{default:n(()=>[a(Qe,{modelValue:o.is_show,"onUpdate:modelValue":e[13]||(e[13]=l=>o.is_show=l),"active-text":"显示","inactive-text":"隐藏"},null,8,["modelValue"])]),_:1})):x("",!0)]),_:1},8,["model"])]),_:1},8,["title","modelValue"])])])}}}),Qt=st(jt,[["__scopeId","data-v-e1dc3a34"]]);export{Qt as default};
