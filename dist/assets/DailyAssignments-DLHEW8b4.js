import{E as c,w as H,x as ae,y as se}from"./elementPlus-Dv7g5dxn.js";import{a as J}from"./assignmentService-W9w5zUm5.js";import{u as xe,b as Ve,s as P,_ as Ce}from"./index-DqKYda5u.js";import{x as Ae,r as d,X as De,c as ne,j as Ue,y as _,A as n,I as ze,P as t,M as p,H as a,ag as v,aq as Fe,G as oe,L as u,u as w,J as S,O as Ee,a6 as Se,D as $e,z as m}from"./vendor-COQJj1AX.js";import"./supabase-Bqqw4QDB.js";const Ne={class:"personal-assignments"},Pe={class:"assignments-header"},Re={class:"tooltip-content"},qe={class:"text-truncate"},Be={key:1},Ie={key:0,class:"assignment-detail"},Le={class:"assignment-meta"},Me={class:"assignment-content"},We={key:0,class:"assignment-attachment"},Te={class:"attachment-box"},je={class:"attachment-name"},Ge={key:1,class:"assignment-replies"},He={class:"reply-header"},Je={class:"reply-author"},Oe={key:0,class:"reply-role"},Xe={key:0,class:"reply-attachment"},Ke={class:"attachment-name"},Qe={class:"reply-form"},Ye={class:"attachment-preview"},Ze=["src"],et=["src"],tt={key:2,class:"attachment-download"},lt=Ae({__name:"DailyAssignments",setup(at){const h=xe(),R=d(!1),q=d([]),B=d(!1),i=d(null),A=d(""),I=d(!1),F=d(!1),k=d(""),x=d(""),$=d([]),V=d(null),E=d(!1),f=d({title:"",content:"",assigned_to:""}),L=d([]),D=d(null),U=De({page:1,pageSize:10,total:0}),M=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",ie=ne(()=>x.value?x.value.startsWith("image/"):!1),re=ne(()=>x.value?x.value==="application/pdf":!1),ue=l=>{l.attachment_url&&(k.value=l.attachment_url,x.value=l.attachment_type||"",F.value=!0)},de=()=>{var l;(l=i.value)!=null&&l.attachment_url&&(k.value=i.value.attachment_url,x.value=i.value.attachment_type||"",F.value=!0)},ce=()=>{k.value&&window.open(k.value,"_blank")},O=l=>l.size/1024/1024<10?!0:(c.error("文件大小不能超过10MB!"),!1),me=async l=>{const{file:e}=l,o=se.service({lock:!0,text:"上传中...",background:"rgba(0, 0, 0, 0.7)"});try{const r=e.name.split(".").pop(),y=`assignments/replies/${`reply_${Date.now()}.${r}`}`,{data:W,error:C}=await P.storage.from("attachments").upload(y,e);if(C)throw C;const{data:{publicUrl:b}}=P.storage.from("attachments").getPublicUrl(y);V.value={url:b,name:e.name,type:e.type},c.success("文件上传成功")}catch(r){console.error("文件上传失败:",r),c.error("文件上传失败"),$.value=[]}finally{o.close()}},pe=()=>{V.value=null},_e=l=>{l.attachment_url&&(k.value=l.attachment_url,x.value=l.attachment_type||"",F.value=!0)},N=async()=>{R.value=!0;try{const{data:l,total:e}=await J.getPersonalAssignments(U.page,U.pageSize,{status:""});q.value=l,U.total=e}catch(l){console.error("获取作业列表失败:",l),c.error("获取作业列表失败")}finally{R.value=!1}},ve=l=>{i.value=l,B.value=!0,A.value="",$.value=[],V.value=null},fe=async()=>{var l,e,o,r;if(i.value){if(!A.value.trim()){c.warning("回复内容不能为空");return}I.value=!0;try{if(!((l=h.user)!=null&&l.user_id)||!i.value.id){c.error("用户信息或作业ID缺失");return}const g=await J.addReply({assignment_id:i.value.id,user_id:h.user.user_id,content:A.value,full_name:h.user.full_name||"",attachment_url:((e=V.value)==null?void 0:e.url)||void 0,attachment_name:((o=V.value)==null?void 0:o.name)||void 0,attachment_type:((r=V.value)==null?void 0:r.type)||void 0});i.value.replies||(i.value.replies=[]),i.value.replies.push(g),c.success("提交回复成功"),A.value="",$.value=[],V.value=null,N()}catch(g){console.error("提交回复失败:",g),c.error("提交回复失败")}finally{I.value=!1}}},ge=()=>{var l;E.value=!0,f.value={title:"",content:"",assigned_to:((l=h.user)==null?void 0:l.user_id)||""},L.value=[],D.value=null},ye=async l=>{const{file:e}=l,o=se.service({lock:!0,text:"上传中...",background:"rgba(0, 0, 0, 0.7)"});try{const r=e.name.split(".").pop(),y=`assignments/${`assignment_${Date.now()}.${r}`}`,{data:W,error:C}=await P.storage.from("attachments").upload(y,e);if(C)throw C;const{data:{publicUrl:b}}=P.storage.from("attachments").getPublicUrl(y);D.value={url:b,name:e.name,type:e.type},c.success("文件上传成功")}catch(r){console.error("文件上传失败:",r),c.error("文件上传失败"),L.value=[]}finally{o.close()}},he=()=>{D.value=null},we=async()=>{var l,e,o;if(!f.value.title.trim()){c.warning("请输入作业标题");return}if(!f.value.content.trim()){c.warning("请输入作业内容");return}try{const r={title:f.value.title,content:f.value.content,assigned_to:f.value.assigned_to,attachment_url:((l=D.value)==null?void 0:l.url)||void 0,attachment_name:((e=D.value)==null?void 0:e.name)||void 0,attachment_type:((o=D.value)==null?void 0:o.type)||void 0};await J.createAssignment(r),c.success("作业创建成功"),E.value=!1,N()}catch(r){console.error("创建作业失败:",r),c.error("创建作业失败")}},be=l=>{U.page=l.page,U.pageSize=l.pageSize,N()},X=l=>{if(!l.replies||l.replies.length===0)return{type:"warning",text:"待完成"};const e=l.replies.some(o=>{var r;return o.user_id===((r=h.user)==null?void 0:r.user_id)});return l.replies.some(o=>o.user_id!==l.assigned_to),e?{type:"success",text:"已完成"}:{type:"warning",text:"待完成"}};return Ue(()=>{N()}),(l,e)=>{const o=v("el-button"),r=v("el-tooltip"),g=v("el-table-column"),y=v("el-icon"),W=v("el-tag"),C=v("el-table"),b=v("el-divider"),T=v("el-input"),z=v("el-form-item"),K=v("el-upload"),Q=v("el-form"),j=v("el-dialog"),ke=Fe("loading");return m(),_("div",Ne,[n("div",Pe,[n("div",null,"共计"+p(q.value.length)+"个作业",1),t(o,{type:"primary",onClick:ge},{default:a(()=>e[7]||(e[7]=[u("添加作业")])),_:1})]),ze((m(),oe(C,{data:q.value,height:"300px"},{default:a(()=>[t(g,{prop:"title",label:"标题","min-width":"180"},{default:a(s=>[t(r,{placement:"top","show-after":500,"max-width":300},{content:a(()=>[n("div",Re,p(s.row.title),1)]),default:a(()=>[n("div",qe,p(s.row.title),1)]),_:2},1024)]),_:1}),t(g,{label:"附件",width:"80"},{default:a(s=>[s.row.attachment_url?(m(),oe(o,{key:0,type:"primary",link:"",onClick:G=>ue(s.row)},{default:a(()=>[t(y,{color:"#409EFF",size:"18"},{default:a(()=>[t(w(H))]),_:1})]),_:2},1032,["onClick"])):(m(),_("span",Be,"-"))]),_:1}),t(g,{label:"状态",width:"100"},{default:a(s=>[t(W,{type:X(s.row).type},{default:a(()=>[u(p(X(s.row).text),1)]),_:2},1032,["type"])]),_:1}),t(g,{prop:"created_at",label:"创建时间",width:"180"},{default:a(s=>[u(p(M(s.row.created_at)),1)]),_:1}),t(g,{label:"操作",width:"120"},{default:a(s=>[t(o,{type:"primary",onClick:G=>ve(s.row)},{default:a(()=>e[8]||(e[8]=[u("查看")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ke,R.value]]),t(Ve,{pagination:U,"onUpdate:pagination":be},null,8,["pagination"]),t(j,{modelValue:B.value,"onUpdate:modelValue":e[1]||(e[1]=s=>B.value=s),title:"作业详情",width:"600px"},{default:a(()=>[i.value?(m(),_("div",Ie,[n("h3",null,p(i.value.title),1),n("div",Le,[n("p",null,"创建时间: "+p(M(i.value.created_at)),1)]),n("div",Me,[t(b,{"content-position":"left"},{default:a(()=>e[9]||(e[9]=[u("作业内容")])),_:1}),n("p",null,p(i.value.content),1)]),i.value.attachment_url?(m(),_("div",We,[t(b,{"content-position":"left"},{default:a(()=>e[10]||(e[10]=[u("附件")])),_:1}),n("div",Te,[t(y,{color:"#409EFF",size:"16"},{default:a(()=>[t(w(H))]),_:1}),n("span",je,p(i.value.attachment_name),1),t(o,{type:"primary",size:"small",onClick:de},{default:a(()=>e[11]||(e[11]=[u("查看附件")])),_:1})])])):S("",!0),i.value.replies&&i.value.replies.length>0?(m(),_("div",Ge,[t(b,{"content-position":"left"},{default:a(()=>e[12]||(e[12]=[u("回复记录")])),_:1}),(m(!0),_(Ee,null,Se(i.value.replies,(s,G)=>{var Y,Z,ee,te,le;return m(),_("div",{key:G,class:$e(["reply-item",{"my-reply":s.user_id===((Y=w(h).user)==null?void 0:Y.user_id),"admin-reply":s.user_id!==i.value.assigned_to&&s.user_id!==((Z=w(h).user)==null?void 0:Z.user_id),"other-reply":s.user_id!==((ee=w(h).user)==null?void 0:ee.user_id)&&s.user_id===i.value.assigned_to}])},[n("div",He,[n("span",Je,p(s.user_id===((te=w(h).user)==null?void 0:te.user_id)?"我":s.full_name||"未知用户"),1),s.user_id!==i.value.assigned_to&&s.user_id!==((le=w(h).user)==null?void 0:le.user_id)?(m(),_("span",Oe,"管理员")):S("",!0)]),n("p",null,p(s.content),1),s.attachment_url?(m(),_("div",Xe,[t(y,{color:"#409EFF",size:"14"},{default:a(()=>[t(w(H))]),_:1}),n("span",Ke,p(s.attachment_name),1),t(o,{type:"primary",link:"",size:"small",onClick:st=>_e(s)},{default:a(()=>e[13]||(e[13]=[u("查看")])),_:2},1032,["onClick"])])):S("",!0),n("small",null,p(M(s.created_at)),1)],2)}),128))])):S("",!0),n("div",Qe,[t(b,{"content-position":"left"},{default:a(()=>e[14]||(e[14]=[u("提交回复")])),_:1}),t(Q,null,{default:a(()=>[t(z,null,{default:a(()=>[t(T,{modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=s=>A.value=s),type:"textarea",rows:4,placeholder:"请输入您的回复内容"},null,8,["modelValue"])]),_:1}),t(z,{label:"附件"},{default:a(()=>[t(K,{class:"upload-container",drag:"","auto-upload":!0,"http-request":me,"on-remove":pe,"before-upload":O,limit:1,"file-list":$.value},{tip:a(()=>e[15]||(e[15]=[n("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[t(y,{class:"el-icon--upload"},{default:a(()=>[t(w(ae))]),_:1}),e[16]||(e[16]=n("div",{class:"el-upload__text"},[u(" 将文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),t(z,null,{default:a(()=>[t(o,{type:"primary",onClick:fe,loading:I.value},{default:a(()=>e[17]||(e[17]=[u("提交回复")])),_:1},8,["loading"])]),_:1})]),_:1})])])):S("",!0)]),_:1},8,["modelValue"]),t(j,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=s=>F.value=s),title:"附件预览",width:"80%","destroy-on-close":""},{default:a(()=>[n("div",Ye,[ie.value?(m(),_("img",{key:0,src:k.value,class:"attachment-image"},null,8,Ze)):re.value?(m(),_("iframe",{key:1,src:k.value,class:"attachment-frame"},null,8,et)):(m(),_("div",tt,[e[19]||(e[19]=n("p",null,"无法预览此类型的文件，请下载后查看",-1)),t(o,{type:"primary",onClick:ce},{default:a(()=>e[18]||(e[18]=[u("下载附件")])),_:1})]))])]),_:1},8,["modelValue"]),t(j,{modelValue:E.value,"onUpdate:modelValue":e[6]||(e[6]=s=>E.value=s),title:"添加作业",width:"600px"},{footer:a(()=>[t(o,{onClick:e[5]||(e[5]=s=>E.value=!1)},{default:a(()=>e[22]||(e[22]=[u("取消")])),_:1}),t(o,{type:"primary",onClick:we},{default:a(()=>e[23]||(e[23]=[u("添加")])),_:1})]),default:a(()=>[t(Q,{model:f.value,"label-width":"80px"},{default:a(()=>[t(z,{label:"标题",required:""},{default:a(()=>[t(T,{modelValue:f.value.title,"onUpdate:modelValue":e[3]||(e[3]=s=>f.value.title=s),placeholder:"请输入作业标题"},null,8,["modelValue"])]),_:1}),t(z,{label:"内容",required:""},{default:a(()=>[t(T,{modelValue:f.value.content,"onUpdate:modelValue":e[4]||(e[4]=s=>f.value.content=s),type:"textarea",rows:6,placeholder:"请输入作业内容"},null,8,["modelValue"])]),_:1}),t(z,{label:"附件"},{default:a(()=>[t(K,{class:"upload-container",drag:"","auto-upload":!0,"http-request":ye,"on-remove":he,"before-upload":O,limit:1,"file-list":L.value},{tip:a(()=>e[20]||(e[20]=[n("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[t(y,{class:"el-icon--upload"},{default:a(()=>[t(w(ae))]),_:1}),e[21]||(e[21]=n("div",{class:"el-upload__text"},[u(" 将文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),dt=Ce(lt,[["__scopeId","data-v-51182065"]]);export{dt as default};
