import{x as Pe,r as w,c as z,j as Se,W as De,y as P,A as a,P as s,G as M,J as K,M as i,H as n,ag as g,O as E,a6 as Y,u as v,I as k,Q as T,D as V,L as y,am as xe,z as p}from"./vendor-CcmhhHhJ.js";import{u as Z,j as X,r as $,f as j,k as G}from"./elementPlus-Be5V1zcU.js";import{u as Ne,s as C,c as Ae,d as ee,b as Fe}from"./index-Dg6Dv2jL.js";/* empty css                  */import{t as Ie}from"./testResultService-D7Hm3hym.js";import{a as ze}from"./assignmentService-CKAUPzIx.js";import{f as Ue}from"./feedbackService-lgHqOGiw.js";import"./supabase-fOlwtt9p.js";const Le="/assets/banner-C5vi_D6D.png",Me="/assets/iwish-us-BEKIG9la.jpg",Ve={class:"layout"},Oe={class:"dashboard-content"},qe={class:"welcome-section"},Be={class:"date"},He={class:"stat-icon"},Ee={class:"stat-info"},Ye={class:"stat-value"},$e={class:"stat-icon"},je={class:"stat-info"},Ge={class:"stat-value"},We={class:"stat-icon"},Qe={class:"stat-info"},Re={class:"stat-value"},Je={class:"stat-icon"},Ke={class:"stat-info"},Ze={class:"stat-value"},Xe={class:"stat-icon"},et={class:"stat-info"},tt={class:"stat-value"},st={class:"stat-icon"},nt={class:"stat-info"},at={class:"stat-value"},lt={class:"stat-icon"},ot={class:"stat-info"},rt={class:"stat-value"},it={class:"stat-icon"},ut={class:"stat-info"},dt={class:"stat-value"},ct={class:"stat-icon"},_t={class:"stat-info"},ft={class:"stat-value"},vt={class:"stat-icon"},mt={class:"stat-info"},gt={class:"stat-value"},yt={class:"card-header"},pt={class:"task-title"},ht={key:0,style:{color:"#E6A23C","font-size":"12px","margin-top":"10px","font-weight":"bold"}},wt={key:1,style:{color:"#909399","font-size":"12px","margin-top":"10px"}},kt={key:2,style:{color:"#F56C6C","font-size":"12px","margin-top":"10px"}},Tt={class:"quick-links"},Ct={class:"quick-link-group"},bt={class:"quick-link-group"},Pt={class:"notice-list fixed-notice-list"},St=["onClick"],Dt={class:"notice-title"},xt={class:"notice-time"},Nt={class:"notice-dialog-header"},At={class:"notice-dialog-title"},Ft={class:"notice-time"},It={class:"notice-dialog-content"},zt=["innerHTML"],Ut={class:"notice-dialog-footer"},te=5,Lt=Pe({__name:"SystemHome",setup(Mt){const se=w([Le,Me]);w(null);const b=Ne(),ne=z(()=>{var t;return((t=b.user)==null?void 0:t.full_name)||"用户"}),S=w([]),ae=z(()=>new Date().toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"})),O=z(()=>{var t,e,o;return((t=b.user)==null?void 0:t.role_id)===0||((e=b.user)==null?void 0:e.role_id)===1||((o=b.user)==null?void 0:o.role_id)===11}),l=w({activeUsers:0,userTrend:0,studyCount:0,studyPending:0,testCount:0,testPending:0,assignmentsCount:0,assignmentsPending:0,yourStudyCount:0,yourStudyPending:0,yourTestCount:0,yourTestPending:0,yourAssignmentsCount:0,yourAssignmentsPending:0,feedbackCount:0,feedbackTrend:0,feedbackPending:0,myFeedbackCount:0,myFeedbackTrend:0,caseSharingCount:0,caseSharingPending:0}),le=async()=>{try{const{data:t,error:e}=await C.from("user_profiles").select("*");if(e)throw e;const o=new Date,u=t==null?void 0:t.filter(c=>new Date(c.created_at).toDateString()===o.toDateString());l.value.activeUsers=(t==null?void 0:t.length)||0,l.value.userTrend=(u==null?void 0:u.length)||0}catch(t){console.error("获取用户失败:",t)}},oe=async()=>{try{const{data:t,error:e}=await C.from("study_notes").select("*");if(e)throw e;l.value.studyCount=(t==null?void 0:t.length)||0;const o=t==null?void 0:t.filter(u=>u.admin_reply===null);l.value.studyPending=(o==null?void 0:o.length)||0}catch(t){console.error("获取学习记录失败:",t)}},re=async()=>{try{const{data:t,error:e}=await C.from("test_results").select("*");if(e)throw e;l.value.testCount=(t==null?void 0:t.length)||0;const o=t==null?void 0:t.filter(u=>u.feedback_text===null&&u.type==="case");l.value.testPending=(o==null?void 0:o.length)||0}catch(t){console.error("获取测试结果失败:",t)}},ie=async()=>{try{const{data:t,error:e}=await C.from("assignments").select("*");if(e)throw e;l.value.assignmentsCount=(t==null?void 0:t.length)||0;const o=t==null?void 0:t.filter(u=>u.admin_reply===null);l.value.assignmentsPending=(o==null?void 0:o.length)||0}catch(t){console.error("获取日常作业失败:",t)}},ue=async()=>{const t=await Ae.getNotes();l.value.yourStudyCount=(t==null?void 0:t.length)||0;const e=t==null?void 0:t.filter(o=>o.admin_reply===null);l.value.yourStudyPending=(e==null?void 0:e.length)||0,t||console.error("获取你的心得失败")},de=async()=>{const{data:t,total:e}=await Ie.getUserTestResults({page:1,pageSize:1e3});l.value.yourTestCount=(t==null?void 0:t.length)||0;const o=t==null?void 0:t.filter(u=>u.feedback_text===null&&u.type==="case");l.value.yourTestPending=(o==null?void 0:o.length)||0,t||console.error("获取你的测试失败")},ce=async()=>{try{const{data:t,total:e}=await ze.getPersonalAssignments(1,1e3);l.value.yourAssignmentsCount=e||0}catch(t){console.error("获取你的作业失败:",t)}},_e=async()=>{var t;try{const{data:e}=await Ue.getPersonalFeedback();if(l.value.myFeedbackCount=(e==null?void 0:e.length)||0,l.value.myFeedbackTrend=((t=e==null?void 0:e.filter(o=>o.reply_count===0))==null?void 0:t.length)||0,O.value){const{data:o,error:u}=await C.from("feedback_with_users").select("*");if(!u){l.value.feedbackCount=(o==null?void 0:o.length)||0;const c=o==null?void 0:o.filter(d=>d.reply_count===0);l.value.feedbackPending=(c==null?void 0:c.length)||0}}else l.value.feedbackCount=(e==null?void 0:e.length)||0,l.value.feedbackPending=l.value.myFeedbackTrend}catch(e){console.error("获取反馈失败:",e)}},fe=async()=>{var t;try{if(O.value){const{data:e,error:o}=await C.from("case_sharing").select("*");if(!o){l.value.caseSharingCount=(e==null?void 0:e.length)||0;const u=e==null?void 0:e.filter(c=>c.status==="pending"||c.status===null);l.value.caseSharingPending=(u==null?void 0:u.length)||0}}else{const{data:e,error:o}=await C.from("case_sharing").select("*").eq("user_id",(t=b.user)==null?void 0:t.user_id);if(!o){l.value.caseSharingCount=(e==null?void 0:e.length)||0;const u=e==null?void 0:e.filter(c=>c.status==="pending"||c.status===null);l.value.caseSharingPending=(u==null?void 0:u.length)||0}}}catch(e){console.error("获取知识分享失败:",e)}},q=w([]),ve=async()=>{var o;const{data:t,error:e}=await C.from("tasks").select("*").eq("assigned_to",(o=b.user)==null?void 0:o.user_id);if(e)throw e;q.value=t.filter(u=>u.status!=="completed").map(u=>{const c=new Date(u.due_date),d=new Date,_=new Date(c.getFullYear(),c.getMonth(),c.getDate()),f=new Date(d.getFullYear(),d.getMonth(),d.getDate()),m=_<f,H=Math.abs(_.getTime()-f.getTime()),A=Math.ceil(H/(1e3*60*60*24)),D=_.getTime()===f.getTime();return{...u,diffDays:A,isOverdue:m,isToday:D}}).sort((u,c)=>new Date(u.due_date).getTime()-new Date(c.due_date).getTime()),console.log(q.value)};function W(t){switch(t){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function me(t){switch(t){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function ge(t){switch(t){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function ye(t){switch(t){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}const pe=async()=>{try{const{data:t,error:e}=await C.from("announcements").select("*");if(e)throw e;S.value=t}catch(t){console.error("获取系统公告失败:",t)}},Q=t=>{switch(t){case"important":return"danger";case"normal":return"success";case"update":return"warning";default:return"info"}},R=t=>{switch(t){case"important":return"重要";case"normal":return"新";case"update":return"更新";default:return"其他"}},U=w(!1),he=w(""),J=w(null),N=z(()=>S.value.find(t=>t.id===J.value)||null),we=t=>{J.value=t,U.value=!0},L=w(0);let B=null;const ke=z(()=>{const t=[],e=S.value.length;for(let o=0;o<te;o++)if(e===0)t.push({id:null,title:"",type:"",created_at:""});else{const u=(L.value+o)%e;t.push(S.value[u]||{id:null,title:"",type:"",created_at:""})}return t});return Se(()=>{Promise.all([le(),oe(),re(),ie(),ue(),de(),ce(),pe(),ve(),_e(),fe()]).catch(t=>{console.error("加载数据失败:",t)}),B=setInterval(()=>{S.value.length>te?L.value=(L.value+1)%S.value.length:L.value=0},3e3)}),De(()=>{B&&clearInterval(B)}),(t,e)=>{const o=g("el-image"),u=g("el-carousel-item"),c=g("el-carousel"),d=g("el-icon"),_=g("el-link"),f=g("el-card"),m=g("el-col"),H=g("Notebook"),A=g("el-row"),D=g("el-tag"),Te=g("el-timeline-item"),Ce=g("el-timeline"),F=g("el-button"),be=g("el-dialog");return p(),P("div",Ve,[a("div",Oe,[a("div",qe,[a("h2",null,"欢迎回来，"+i(ne.value),1),a("p",Be,i(ae.value),1)]),s(c,{"indicator-position":"outside",height:"500px"},{default:n(()=>[(p(!0),P(E,null,Y(se.value,r=>(p(),M(u,{key:r},{default:n(()=>[s(o,{src:r},{placeholder:n(()=>e[2]||(e[2]=[a("div",{class:"image-slot"},[y("Loading"),a("span",{class:"dot"},"...")],-1)])),_:2},1032,["src"])]),_:2},1024))),128))]),_:1}),O.value?(p(),M(A,{key:0,gutter:20,class:"stat-cards"},{default:n(()=>[s(m,{span:4},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/users"},{default:n(()=>[a("div",He,[s(d,null,{default:n(()=>[s(v(Z))]),_:1})])]),_:1}),a("div",Ee,[e[3]||(e[3]=a("div",{class:"stat-title"},"系统用户",-1)),a("div",Ye,i(l.value.activeUsers),1),k(a("div",{class:V(["stat-trend",{up:l.value.userTrend>0}])}," 新增： "+i(l.value.userTrend>0?"+":"")+i(l.value.userTrend),3),[[T,l.value.userTrend>0]])])]),_:1})]),_:1}),s(m,{span:4},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/admin-study-notes"},{default:n(()=>[a("div",$e,[s(d,null,{default:n(()=>[s(v(X))]),_:1})])]),_:1}),a("div",je,[e[4]||(e[4]=a("div",{class:"stat-title"},"学习心得",-1)),a("div",Ge,i(l.value.studyCount),1),k(a("div",{class:"stat-trend"}," 待回复： "+i(l.value.studyPending),513),[[T,l.value.studyPending>0]])])]),_:1})]),_:1}),s(m,{span:4},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/case-sharing"},{default:n(()=>[a("div",We,[s(d,null,{default:n(()=>[s(H)]),_:1})])]),_:1}),a("div",Qe,[e[5]||(e[5]=a("div",{class:"stat-title"},"知识分享",-1)),a("div",Re,i(l.value.caseSharingCount||0),1),k(a("div",{class:"stat-trend"}," 待审核： "+i(l.value.caseSharingPending),513),[[T,l.value.caseSharingPending>0]])])]),_:1})]),_:1}),s(m,{span:4},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/admin-test-result"},{default:n(()=>[a("div",Je,[s(d,null,{default:n(()=>[s(v($))]),_:1})])]),_:1}),a("div",Ke,[e[6]||(e[6]=a("div",{class:"stat-title"},"测试结果",-1)),a("div",Ze,i(l.value.testCount),1),k(a("div",{class:"stat-trend"}," 待批改： "+i(l.value.testPending),513),[[T,l.value.testPending>0]])])]),_:1})]),_:1}),s(m,{span:4},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/admin-assignments"},{default:n(()=>[a("div",Xe,[s(d,null,{default:n(()=>[s(v(j))]),_:1})])]),_:1}),a("div",et,[e[7]||(e[7]=a("div",{class:"stat-title"},"日常作业",-1)),a("div",tt,i(l.value.assignmentsCount),1),k(a("div",{class:"stat-trend"}," 待批改： "+i(l.value.assignmentsPending),513),[[T,l.value.assignmentsPending>0]])])]),_:1})]),_:1}),s(m,{span:4},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[a("div",st,[s(d,null,{default:n(()=>[s(v(G))]),_:1})])]),_:1}),a("div",nt,[e[8]||(e[8]=a("div",{class:"stat-title"},"FAQ",-1)),a("div",at,i(l.value.feedbackCount||0),1),k(a("div",{class:"stat-trend"}," 待处理： "+i(l.value.feedbackPending),513),[[T,l.value.feedbackPending>0]])])]),_:1})]),_:1})]),_:1})):K("",!0),s(A,{gutter:20,class:"stat-cards"},{default:n(()=>[s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/personal-data/study-notes"},{default:n(()=>[a("div",lt,[s(d,null,{default:n(()=>[s(v(X))]),_:1})])]),_:1}),a("div",ot,[e[9]||(e[9]=a("div",{class:"stat-title"},"我的心得",-1)),a("div",rt,i(l.value.yourStudyCount),1),k(a("div",{class:V(["stat-trend",{up:l.value.yourStudyPending>0}])}," 待回复： "+i(l.value.yourStudyPending>0?"+":"")+i(l.value.yourStudyPending),3),[[T,l.value.yourStudyPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/personal-data/test-result"},{default:n(()=>[a("div",it,[s(d,null,{default:n(()=>[s(v($))]),_:1})])]),_:1}),a("div",ut,[e[10]||(e[10]=a("div",{class:"stat-title"},"我的测试",-1)),a("div",dt,i(l.value.yourTestCount),1),k(a("div",{class:V(["stat-trend",{up:l.value.yourTestPending>0}])}," 待批改："+i(l.value.yourTestPending>0?"+":"")+i(l.value.yourTestPending),3),[[T,l.value.yourTestPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/personal-data/daily-assignments"},{default:n(()=>[a("div",ct,[s(d,null,{default:n(()=>[s(v(j))]),_:1})])]),_:1}),a("div",_t,[e[11]||(e[11]=a("div",{class:"stat-title"},"我的作业",-1)),a("div",ft,i(l.value.yourAssignmentsCount),1)])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[a("div",vt,[s(d,null,{default:n(()=>[s(v(G))]),_:1})])]),_:1}),a("div",mt,[e[12]||(e[12]=a("div",{class:"stat-title"},"我的反馈",-1)),a("div",gt,i(l.value.myFeedbackCount),1),k(a("div",{class:V(["stat-trend",{up:l.value.myFeedbackTrend>0}])}," 待处理："+i(l.value.myFeedbackTrend>0?"+":"")+i(l.value.myFeedbackTrend),3),[[T,l.value.myFeedbackTrend>0]])])]),_:1})]),_:1})]),_:1}),s(A,{gutter:20,class:"main-content"},{default:n(()=>[s(m,{span:16},{default:n(()=>[s(f,{class:"task-card",style:{"min-height":"200px"}},{header:n(()=>[a("div",yt,[e[14]||(e[14]=a("span",null,"待办任务",-1)),s(_,{type:"primary",link:"",href:"/system/task-management"},{default:n(()=>e[13]||(e[13]=[y(" 查看全部 ")])),_:1})])]),default:n(()=>[s(Ce,null,{default:n(()=>[(p(!0),P(E,null,Y(q.value,(r,h)=>(p(),M(Te,{key:h,type:W(r.priority),timestamp:r.due_date,placement:"top"},{default:n(()=>[s(f,{class:"task-item"},{default:n(()=>[a("div",pt,[a("h4",null,i(r.title),1),s(D,{class:"status-tag",type:ge(r.status)},{default:n(()=>[y(i(ye(r.status)),1)]),_:2},1032,["type"]),e[15]||(e[15]=y()),s(D,{type:W(r.priority)},{default:n(()=>[y(i(me(r.priority)),1)]),_:2},1032,["type"])]),a("p",null,i(r.description),1),r.isToday?(p(),P("p",ht," 今天到期 ")):r.isOverdue?(p(),P("p",kt," 已过期："+i(r.diffDays)+"天 ",1)):(p(),P("p",wt," 距离截止日期："+i(r.diffDays)+"天 ",1))]),_:2},1024)]),_:2},1032,["type","timestamp"]))),128))]),_:1})]),_:1})]),_:1}),s(m,{span:8},{default:n(()=>[s(f,{class:"quick-access"},{header:n(()=>e[16]||(e[16]=[a("div",{class:"card-header"},[a("span",null,"快捷入口")],-1)])),default:n(()=>{var r,h,x,I;return[a("div",Tt,[a("div",Ct,[s(_,{underline:!1,href:"/system/personal-data"},{default:n(()=>[s(F,{type:"primary",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(v(Z))]),_:1}),e[17]||(e[17]=y(" 个人中心 "))]),_:1})]),_:1}),s(_,{underline:!1,href:`/system/training/study-material-folder?platform=${(h=(r=v(b).user)==null?void 0:r.role)==null?void 0:h.mark[0]}`},{default:n(()=>[s(F,{type:"success",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(v($))]),_:1}),e[18]||(e[18]=y(" 学习资料 "))]),_:1})]),_:1},8,["href"])]),a("div",bt,[s(_,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[s(F,{type:"warning",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(v(G))]),_:1}),e[19]||(e[19]=y(" 反馈中心 "))]),_:1})]),_:1}),s(_,{underline:!1,href:`/system/daily-work/personal-assignments?platform=${(I=(x=v(b).user)==null?void 0:x.role)==null?void 0:I.mark[0]}`},{default:n(()=>[s(F,{type:"info",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(v(j))]),_:1}),e[20]||(e[20]=y(" 日常作业 "))]),_:1})]),_:1},8,["href"])])])]}),_:1}),s(f,{class:"notice-card"},{header:n(()=>e[21]||(e[21]=[a("div",{class:"card-header"},[a("span",null,"系统公告")],-1)])),default:n(()=>[a("div",Pt,[s(xe,{name:"notice-fade",tag:"div"},{default:n(()=>[(p(!0),P(E,null,Y(ke.value,(r,h)=>(p(),P("div",{key:r.id?r.id:"empty-"+h,class:"notice-item",onClick:x=>r.id&&we(r.id)},[r.id?(p(),M(D,{key:0,type:Q(r.type),size:"small"},{default:n(()=>[y(i(R(r.type)),1)]),_:2},1032,["type"])):K("",!0),a("span",Dt,i(r.title||""),1),a("span",xt,i(r.created_at?v(ee)(r.created_at):""),1)],8,St))),128))]),_:1})])]),_:1})]),_:1})]),_:1})]),s(be,{modelValue:U.value,"onUpdate:modelValue":e[1]||(e[1]=r=>U.value=r),title:he.value,width:"40%",class:"notice-dialog","close-on-click-modal":!1},{header:n(()=>{var r,h,x;return[a("div",Nt,[s(D,{type:Q(((r=N.value)==null?void 0:r.type)||""),size:"small",class:"notice-type-tag"},{default:n(()=>{var I;return[y(i(R(((I=N.value)==null?void 0:I.type)||"")),1)]}),_:1},8,["type"]),a("span",At,i(((h=N.value)==null?void 0:h.title)||""),1),a("span",Ft,i(v(ee)(((x=N.value)==null?void 0:x.created_at)||"")),1)])]}),footer:n(()=>[a("div",Ut,[s(F,{type:"primary",onClick:e[0]||(e[0]=r=>U.value=!1)},{default:n(()=>e[22]||(e[22]=[y("关闭")])),_:1})])]),default:n(()=>{var r;return[a("div",It,[a("div",{innerHTML:(r=N.value)==null?void 0:r.content,class:"notice-content"},null,8,zt)])]}),_:1},8,["modelValue","title"])])}}}),jt=Fe(Lt,[["__scopeId","data-v-4cd7eebe"]]);export{jt as default};
