import{_ as pl,a as ml,b as _l,c as Al,d as yl,e as hl,f as bl,g as wl,h as Cl,i as kl,j as xl,k as El,l as Bl}from"./zip-KiBfUjci.js";import{d as Il,J as _e,r as p,o as Ql,I as Le,p as Ml,l as L,a as r,e as m,K as Dl,w as n,b,s as d,M as w,g as ue,a6 as Ue,F as Ae,m as ye,f as _,y as Ge,c as S,q as K,O as Jl,t as I,P as Yl,a7 as Sl,N as Fl,Q as ql,U as he,j as E,_ as Pl}from"./index-CCiOYfNf.js";import{U as Vl}from"./UploadMaterials-BVHoJSul.js";import{J as $l,m as Tl,r as zl,u as Ll}from"./xlsx-Bssgg7WC.js";const Ul={class:"layout"},Gl={class:"materials-content"},jl={class:"card-header"},Nl={class:"header-actions"},Kl={style:{"font-size":"14px",color:"#909399"}},Hl={class:"dialog-content"},Ol={class:"material-details"},Xl={class:"material-header"},Wl={class:"material-title"},Rl={key:0,class:"material-actions"},Zl=["innerHTML"],ea={key:3,class:"editor-container"},la={key:0},aa=Il({__name:"AdminMaterialAndFolders",setup(ta){const je=_e([{name:"数据管理",path:"/system/data-management"},{name:"学习资料管理",path:"/system/admin-material"}]),le=p("materials"),ae=p(!1),de=p([]),te=p(!1),D=p(null),B=p(""),oe=p(""),re=p(""),ne=p(""),U=p([]),se=p(!1),x=p(!1),G=p(""),F=p(""),A=p(null),J=p(null),v=p(null),u=p([]),q=p([]),W=p(!1),y=p(null),H=p([]),j=p(new Map),ie=p(new Map),R=p(new Map),Z=p(new Map),k=_e({name:"",platform:"",folderPath:[]}),be=[{value:"image",label:"图片"},{value:"video",label:"视频"},{value:"ppt",label:"PPT"},{value:"pdf",label:"PDF"},{value:"link",label:"链接"},{value:"txt",label:"文本"},{value:"word",label:"Word"},{value:"excel",label:"Excel"},{value:"zip",label:"压缩包"}],we=[{value:"google",label:"Google"},{value:"facebook",label:"Facebook"},{value:"microsoft",label:"Microsoft"},{value:"meta",label:"Meta"},{value:"other",label:"Other"}],V=_e({page:1,pageSize:10,total:0}),ce=p(null);let C=null;const Ne=()=>{se.value=!0},Ke=e=>{se.value=e,e||O()},He=e=>{V.page=e.page,V.pageSize=e.pageSize,O()},O=async()=>{ae.value=!0;try{let e=d.from("study_materials").select(`
                *,
                platform_info:ad_platforms(name),
                category_info:ad_categories(name),
                subcategory_info:ad_subcategories(name),
                topic_info:ad_topics(name)
            `,{count:"exact"});oe.value&&(e=e.ilike("title",`%${oe.value}%`)),re.value&&(e=e.eq("type",re.value)),ne.value&&(e=e.eq("platform",ne.value));const{data:l,error:a,count:o}=await e.order("created_at",{ascending:!1}).range((V.page-1)*V.pageSize,V.page*V.pageSize-1);if(a)throw a;de.value=l,V.total=o||0}catch(e){w.error("搜索学习资料失败"),console.error(e)}finally{ae.value=!1}},Ce=async e=>{D.value=e,te.value=!0,C&&(C.destruct(),C=null),e.type!=="link"&&e.type!=="video"&&e.type!=="pdf"&&ce.value&&(C=$l.make(ce.value,{height:500,readonly:!0,toolbar:!1,statusbar:!1,language:"zh_cn",uploader:{insertImageAsBase64URI:!0}}),C.value='<div style="text-align: center; padding: 50px;">文件加载中，请稍候...</div>');try{const{data:l,error:a}=await d.from("material_contents").select("*").eq("material_id",e.id).single();if(a)throw a;if(console.log("Material content data:",l),e.type==="link"||e.type==="video"||e.type==="pdf")B.value=l.content;else{const o=l.content;console.log("Attempting to fetch file from path:",o);const i=l.content.split("/materials/").pop();try{if(e.type==="word"){const{data:s,error:c}=await d.storage.from("materials").download(i);if(c)throw c;const h=await s.arrayBuffer(),f=await Tl.convertToHtml({arrayBuffer:h});B.value=f.value;const Q=`
                        <style>
                            .word-content {
                                font-family: Arial, sans-serif;
                                line-height: 1.6;
                                padding: 20px;
                            }
                            .word-content p {
                                margin: 0 0 1em 0;
                            }
                            .word-content h1, .word-content h2, .word-content h3 {
                                margin: 1em 0 0.5em 0;
                            }
                            .word-content table {
                                border-collapse: collapse;
                                margin: 1em 0;
                            }
                            .word-content td, .word-content th {
                                border: 1px solid #ddd;
                                padding: 8px;
                            }
                        </style>
                    `;B.value=Q+'<div class="word-content">'+B.value+"</div>",C&&(C.value=B.value)}else if(e.type==="excel"){const{data:s,error:c}=await d.storage.from("materials").download(i);if(c)throw c;const h=await s.arrayBuffer(),f=zl(h,{type:"array"}),Q=f.Sheets[f.SheetNames[0]],Y=Ll.sheet_to_html(Q),P=`
                        <style>
                            .excel-content {
                                font-family: Arial, sans-serif;
                                line-height: 1.6;
                                padding: 20px;
                            }
                            .excel-content table {
                                border-collapse: collapse;
                                width: 100%;
                                margin: 1em 0;
                            }
                            .excel-content td, .excel-content th {
                                border: 1px solid #ddd;
                                padding: 8px;
                                text-align: left;
                            }
                            .excel-content th {
                                background-color: #f5f5f5;
                            }
                            .excel-content tr:nth-child(even) {
                                background-color: #f9f9f9;
                            }
                        </style>
                    `;B.value=P+'<div class="excel-content">'+Y+"</div>",C&&(C.value=B.value)}else if(e.type==="txt"){const{data:s,error:c}=await d.storage.from("materials").download(i);if(c)throw c;const h=await s.text();B.value=h,C&&(C.value=B.value)}else if(e.type==="image"){const{data:{publicUrl:s}}=await d.storage.from("materials").getPublicUrl(i);B.value=s,C&&(C.value=`<img src="${s}" alt="${e.title}" style="max-width: 100%;">`)}else{const{data:{publicUrl:s}}=await d.storage.from("materials").getPublicUrl(i);B.value=s,C&&(C.value=`
                            <div style="text-align: center; padding: 20px;">
                                <p>此文件类型不支持直接预览</p>
                                <a href="${s}" target="_blank" class="el-button el-button--primary">
                                    下载文件
                                </a>
                            </div>
                        `)}}catch(s){throw console.error("Storage error:",s),w.error(`无法获取文件: ${s.message}`),s;C&&(C.value=`
                        <div style="color: red; text-align: center; padding: 20px;">
                            <p>文件加载失败: ${s.message||"未知错误"}</p>
                        </div>
                    `)}}}catch(l){console.error("获取资料内容失败:",l),B.value="",w.error("获取文件内容失败"),C&&(C.value=`
                <div style="color: red; text-align: center; padding: 20px;">
                    <p>无法获取文件信息</p>
                </div>
            `)}},Oe=e=>{if(B.value)try{if(e.type==="link"||e.type==="video"||e.type==="pdf")window.open(B.value,"_blank");else{const l=document.createElement("a");l.href=B.value,l.download=e.title,document.body.appendChild(l),l.click(),document.body.removeChild(l)}}catch(l){console.error("打开文件失败:",l),w.error("打开文件失败")}},ke=async e=>{try{await he.confirm(`确定要删除资料 "${e.title}" 吗？此操作不可恢复。`,"警告",{type:"warning"});const{error:l}=await d.from("material_contents").delete().eq("material_id",e.id);if(l)throw l;const{error:a}=await d.from("study_materials").delete().eq("id",e.id);if(a)throw a;w.success("删除成功"),O()}catch(l){l!=="cancel"&&(console.error("删除资料失败:",l),w.error("删除失败"))}},Xe=async()=>{if(U.value.length!==0)try{await he.confirm(`确定要删除选中的 ${U.value.length} 个资料吗？此操作不可恢复。`,"警告",{type:"warning"});const e=U.value.map(o=>o.id),{error:l}=await d.from("material_contents").delete().in("material_id",e);if(l)throw l;const{error:a}=await d.from("study_materials").delete().in("id",e);if(a)throw a;w.success(`成功删除 ${U.value.length} 个资料`),U.value=[],O()}catch(e){e!=="cancel"&&(console.error("批量删除资料失败:",e),w.error("批量删除失败"))}},We=e=>{U.value=e},Re=()=>new URL("data:image/png;base64,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",import.meta.url).href,fe=e=>new URL(Object.assign({"/src/assets/icons/excel.png":Bl,"/src/assets/icons/file.png":El,"/src/assets/icons/image.png":xl,"/src/assets/icons/link.png":kl,"/src/assets/icons/music.png":Cl,"/src/assets/icons/pdf.png":wl,"/src/assets/icons/ppt.png":bl,"/src/assets/icons/reading.png":hl,"/src/assets/icons/select.png":yl,"/src/assets/icons/txt.png":Al,"/src/assets/icons/video.png":_l,"/src/assets/icons/word.png":ml,"/src/assets/icons/zip.png":pl})[`/src/assets/icons/${e||"file"}.png`],import.meta.url).href,Ze=e=>e?new Date(e).toLocaleString():"",ve=async()=>{x.value=!0;try{u.value=[],v.value=null,A.value=null,J.value=null;const e="root",l=j.value.get(e);if(l){q.value=l;return}const{data:a,error:o}=await d.from("ad_platforms").select("*").order("name");if(o)throw o;const i=a.map(s=>({...s,is_folder:!0}));q.value=i,j.value.set(e,i)}catch(e){console.error("加载平台列表失败:",e),w.error("加载平台列表失败")}finally{x.value=!1}},el=async()=>{x.value=!0;try{if(u.value=[],v.value=null,G.value){const{data:e,error:l}=await d.from("ad_platforms").select("*").eq("platform",G.value).single();if(l)throw l;A.value=e.id,J.value=e.name}else A.value=null,J.value=null;await $()}catch(e){w.error("加载文件夹结构失败"),console.error(e)}finally{x.value=!1}},$=async()=>{x.value=!0;try{let e,l;const o=A.value?u.value.length===1?`platform_${A.value}`:u.value.length===2?`category_${v.value}`:u.value.length===3?`subcategory_${v.value}`:`topic_${v.value}`:"root",i=j.value.get(o),s=ie.value.get(o);if(!A.value){if(i){q.value=i,x.value=!1;return}const{data:Y,error:P}=await d.from("ad_platforms").select("*").order("name");if(P)throw P;const N=Y.map(g=>({...g,is_folder:!0}));q.value=N,j.value.set(o,N),x.value=!1;return}if(i&&s){q.value=[...i,...s],x.value=!1;return}u.value.length===1?(e=d.from("ad_categories").select("*").eq("platform_id",A.value).order("sort_order, name"),l=d.from("study_materials").select("*").eq("platform_id",A.value).is("category_id",null).order("title")):u.value.length===2?(e=d.from("ad_subcategories").select("*").eq("category_id",v.value).order("sort_order, name"),l=d.from("study_materials").select("*").eq("category_id",v.value).is("subcategory_id",null).order("title")):u.value.length===3?(e=d.from("ad_topics").select("*").eq("subcategory_id",v.value).order("sort_order, name"),l=d.from("study_materials").select("*").eq("subcategory_id",v.value).is("topic_id",null).order("title")):(e=null,l=d.from("study_materials").select("*").eq("topic_id",v.value).order("title"));const[c,h]=await Promise.all([e||Promise.resolve({data:[],error:null}),l]);if(c!=null&&c.error)throw c.error;if(h.error)throw h.error;const f=((c==null?void 0:c.data)||[]).map(Y=>({...Y,is_folder:!0})),Q=(h.data||[]).map(Y=>({...Y,is_folder:!1}));j.value.set(o,f),ie.value.set(o,Q),q.value=[...f,...Q]}catch(e){console.error("加载失败:",e),w.error("加载失败")}finally{x.value=!1}},xe=async e=>{var l;if(e.is_folder){if(F.value.trim()&&e.folder_level){if(F.value="",u.value=[],e.folder_level==="platform")A.value=e.id,J.value=e.name,u.value.push(e),v.value=e.id;else if(e.folder_level==="category"){if(e.platform_id)try{const{data:a,error:o}=await d.from("ad_platforms").select("*").eq("id",e.platform_id).single();if(o)throw o;A.value=a.id,J.value=a.name,u.value.push(a),u.value.push(e),v.value=e.id}catch(a){console.error("获取平台信息失败:",a),A.value=null,J.value=null}}else if(e.folder_level==="subcategory"){if(e.category_id)try{const{data:a,error:o}=await d.from("ad_categories").select("*, platform:ad_platforms(*)").eq("id",e.category_id).single();if(o)throw o;a.platform&&(A.value=a.platform.id,J.value=a.platform.name,u.value.push(a.platform)),u.value.push(a),u.value.push(e),v.value=e.id}catch(a){console.error("获取分类信息失败:",a),A.value=null,J.value=null}}else if(e.folder_level==="topic"&&e.subcategory_id)try{const{data:a,error:o}=await d.from("ad_subcategories").select("*, category:ad_categories(*, platform:ad_platforms(*))").eq("id",e.subcategory_id).single();if(o)throw o;(l=a.category)!=null&&l.platform&&(A.value=a.category.platform.id,J.value=a.category.platform.name,u.value.push(a.category.platform)),a.category&&u.value.push(a.category),u.value.push(a),u.value.push(e),v.value=e.id}catch(a){console.error("获取子分类信息失败:",a),A.value=null,J.value=null}await $();return}u.value.length===0?(A.value=e.id,J.value=e.name,u.value.push(e),v.value=e.id):(u.value.length===1||u.value.length,u.value.push(e),v.value=e.id),await $()}else e.type&&Ce(e)},ll=async()=>{u.value.length>0&&(u.value.pop(),u.value.length===0?(v.value=null,A.value=null,J.value=null):v.value=u.value[u.value.length-1].id,await $())},al=async()=>{u.value=[],v.value=null,A.value=null,J.value=null,await $()},tl=async e=>{const l=u.value.findIndex(a=>a.id===e.id);l>=0&&(u.value=u.value.slice(0,l+1),v.value=e.id,await $())},ol=async e=>{try{if(!await rl(e)){w.warning(`无法删除，${e.is_folder?"文件夹可能包含子项":"无权删除此文件"}`);return}if(await he.confirm(`确定要删除${e.is_folder?"文件夹":"文件"} "${e.is_folder?e.name:e.title}" 吗？此操作不可恢复。`,"警告",{type:"warning"}),e.is_folder){x.value=!0;let a="",o="id",i=e.id;console.log("准备删除文件夹:",e);try{if(e.folder_level==="platform"||u.value.length===0&&!e.folder_level)a="ad_categories",o="id",console.log("删除类型: 分类, ID:",i);else if(e.folder_level==="category"||u.value.length===1&&!e.folder_level)a="ad_subcategories",o="id",console.log("删除类型: 子分类, ID:",i);else if(e.folder_level==="subcategory"||u.value.length===2&&!e.folder_level)a="ad_topics",o="id",console.log("删除类型: 主题, ID:",i);else throw new Error("未知的文件夹类型");console.log(`开始删除 ${a} 表中 ${o}=${i} 的记录`);const{data:s,error:c}=await d.from(a).select("id").eq(o,i).limit(1);if(c)throw console.error("检查记录是否存在失败:",c),c;if(!s||s.length===0){console.warn("要删除的记录不存在"),w.warning("要删除的记录不存在"),x.value=!1;return}const{error:h}=await d.from(a).delete().eq(o,i);if(h)throw console.error(`删除 ${a} 失败:`,h),h;const{data:f,error:Q}=await d.from(a).select("id").eq(o,i).limit(1);if(Q&&console.warn("验证删除结果时出错:",Q),f&&f.length>0){console.error("删除操作执行了但记录仍然存在"),w.error("删除未成功，请刷新页面后重试"),x.value=!1;return}T(),await $(),w.success("删除成功")}catch(s){console.error("删除过程中出错:",s),w.error(`删除失败: ${s.message||"未知错误"}`)}finally{x.value=!1}}else await ke(e),Qe()}catch(l){l!=="cancel"&&(console.error("删除操作失败:",l),w.error("删除失败，请检查是否有关联的资料"))}},rl=async e=>{if(!e.is_folder)return!0;const l=`delete_${e.id}`;if(R.value.has(l))return R.value.get(l);try{let a=!1;if(console.log("检查文件夹是否可删除:",e.id,e.name,"当前路径层级:",u.value.length),e.folder_level==="platform"||u.value.length===0&&!e.folder_level){const{count:o,error:i}=await d.from("ad_categories").select("*",{count:"exact"}).eq("platform_id",e.id);if(i)throw i;console.log("平台下分类数量:",o);const{count:s,error:c}=await d.from("study_materials").select("*",{count:"exact"}).eq("platform_id",e.id).is("category_id",null);if(c)throw c;console.log("平台直接关联的资料数量:",s),a=o===0&&s===0}else if(e.folder_level==="category"||u.value.length===1&&!e.folder_level){const{count:o,error:i}=await d.from("ad_subcategories").select("*",{count:"exact"}).eq("category_id",e.id);if(i)throw i;console.log("分类下子分类数量:",o);const{count:s,error:c}=await d.from("study_materials").select("*",{count:"exact"}).eq("category_id",e.id).is("subcategory_id",null);if(c)throw c;console.log("分类下直接关联的资料数量:",s),a=o===0&&s===0}else if(e.folder_level==="subcategory"||u.value.length===2&&!e.folder_level){const{count:o,error:i}=await d.from("ad_topics").select("*",{count:"exact"}).eq("subcategory_id",e.id);if(i)throw i;console.log("子分类下主题数量:",o);const{count:s,error:c}=await d.from("study_materials").select("*",{count:"exact"}).eq("subcategory_id",e.id).is("topic_id",null);if(c)throw c;console.log("子分类下直接关联的资料数量:",s),a=o===0&&s===0}else if(e.folder_level==="topic"||u.value.length===3&&!e.folder_level){const{count:o,error:i}=await d.from("study_materials").select("*",{count:"exact"}).eq("topic_id",e.id);if(i)throw i;console.log("主题下资料数量:",o),a=o===0}return console.log("文件夹是否可删除结果:",a),R.value.set(l,a),a}catch(a){return console.error("检查删除权限失败:",a),!1}},Ee=(e=null)=>{var l;y.value=e,k.name="",k.platform=G.value,k.folderPath=[],console.log("showCreateFolderDialog 参数:",e?"有folder":"无folder"),console.log("parentFolder.value:",y.value),e?(console.log("在特定文件夹下创建子文件夹:",e),H.value=[],e.folder_level==="platform"||!e.folder_level&&u.value.length===0?k.folderPath=[e.id]:e.folder_level==="category"||!e.folder_level&&u.value.length===1?k.folderPath=[e.id]:(e.folder_level==="subcategory"||!e.folder_level&&u.value.length===2)&&(k.folderPath=[(l=u.value[1])==null?void 0:l.id,e.id])):(console.log("从顶部按钮创建，加载文件夹路径选择器"),il()),setTimeout(()=>{W.value=!0},100)},nl=async()=>{if(!k.name){w.warning("请输入文件夹名称");return}if(!y.value&&k.folderPath.length===0){w.warning("请选择文件夹位置");return}x.value=!0;try{let e,l=k.folderPath;if(y.value){if(console.log("使用预设路径创建文件夹:",l),y.value.folder_level==="platform"||!y.value.folder_level&&u.value.length===0){const{data:a,error:o}=await d.from("ad_categories").insert({name:k.name,platform_id:y.value.id,sort_order:0}).select();if(o)throw o;e=a,T(`platform_${y.value.id}`)}else if(y.value.folder_level==="category"||!y.value.folder_level&&u.value.length===1){const{data:a,error:o}=await d.from("ad_subcategories").insert({name:k.name,category_id:y.value.id,sort_order:0}).select();if(o)throw o;e=a,T(`category_${y.value.id}`)}else if(y.value.folder_level==="subcategory"||!y.value.folder_level&&u.value.length===2){const{data:a,error:o}=await d.from("ad_topics").insert({name:k.name,subcategory_id:y.value.id,sort_order:0}).select();if(o)throw o;e=a,T(`subcategory_${y.value.id}`)}}else if(l.length===1){const a=l[0],{data:o,error:i}=await d.from("ad_categories").insert({name:k.name,platform_id:a,sort_order:0}).select();if(i)throw i;e=o,T(`platform_${a}`)}else if(l.length===2){const a=l[0],{data:o,error:i}=await d.from("ad_subcategories").insert({name:k.name,category_id:a,sort_order:0}).select();if(i)throw i;e=o,T(`category_${a}`)}else if(l.length===3){const a=l[1],{data:o,error:i}=await d.from("ad_topics").insert({name:k.name,subcategory_id:a,sort_order:0}).select();if(i)throw i;e=o,T(`subcategory_${a}`)}else throw new Error("无法在当前层级创建文件夹");w.success("创建成功"),W.value=!1,Qe()}catch(e){console.error("创建文件夹失败:",e),w.error(`创建失败: ${e.message||"文件夹最多只能有3级"}`)}finally{x.value=!1}},Be=e=>{const l=be.find(a=>a.value===e);return(l==null?void 0:l.label)||e},Ie=e=>{const l=we.find(a=>a.value===e);return(l==null?void 0:l.label)||e},ge=e=>{var a,o,i,s;if(!e)return"";const l=[];return(a=e.platform_info)!=null&&a.name&&l.push(e.platform_info.name),(o=e.category_info)!=null&&o.name&&l.push(e.category_info.name),(i=e.subcategory_info)!=null&&i.name&&l.push(e.subcategory_info.name),(s=e.topic_info)!=null&&s.name&&l.push(e.topic_info.name),l.join(" > ")||"根目录"},sl=e=>{const l=ge(e);return l.length>30?l.substring(0,27)+"...":l},il=async()=>{const e=G.value?`folder_options_${G.value}_${A.value||""}_${v.value||""}`:"folder_options_all";if(Z.value.has(e)){H.value=Z.value.get(e)||[];return}try{const{data:l,error:a}=await d.from("ad_platforms").select("*").order("name");if(a)throw a;const o=l.map(i=>({id:i.id,name:i.name,children:[]}));if(H.value=o,G.value&&A.value)try{const{data:i}=await d.from("ad_categories").select("*").eq("platform_id",A.value).order("name"),s=o.findIndex(c=>c.id===A.value);if(s>=0&&i&&(o[s].children=i.map(c=>({id:c.id,name:c.name,children:[]})),u.value.length===1&&v.value)){const{data:c}=await d.from("ad_subcategories").select("*").eq("category_id",v.value).order("name"),h=o[s].children.findIndex(f=>f.id===v.value);h>=0&&c&&(o[s].children[h].children=c.map(f=>({id:f.id,name:f.name,children:[]})))}}catch(i){console.error("获取分类失败:",i)}Z.value.set(e,o),H.value=o}catch(l){console.error("加载文件夹选项失败:",l),w.error("加载文件夹结构失败"),H.value=[]}},T=e=>{e?(j.value.delete(e),ie.value.delete(e),R.value.clear(),Z.value.clear()):(j.value.clear(),ie.value.clear(),R.value.clear(),Z.value.clear())},Qe=()=>{T(A.value?u.value.length===1?`platform_${A.value}`:u.value.length===2?`category_${v.value}`:u.value.length===3?`subcategory_${v.value}`:`topic_${v.value}`:"root"),$()},Me=async()=>{if(!F.value.trim()){u.value.length===0&&ve();return}x.value=!0;try{const e=[],{data:l,error:a}=await d.from("ad_platforms").select("*").ilike("name",`%${F.value}%`).order("name");if(a)throw a;const o=l.map(g=>({...g,is_folder:!0,folder_level:"platform"}));e.push(...o);const{data:i,error:s}=await d.from("ad_categories").select("*, platform:ad_platforms(name)").ilike("name",`%${F.value}%`).order("name");if(s)throw s;const c=i.map(g=>({...g,is_folder:!0,folder_level:"category",path_info:g.platform?`${g.platform.name} > ${g.name}`:g.name}));e.push(...c);const{data:h,error:f}=await d.from("ad_subcategories").select("*, category:ad_categories(name, platform:ad_platforms(name))").ilike("name",`%${F.value}%`).order("name");if(f)throw f;const Q=h.map(g=>{var z;return{...g,is_folder:!0,folder_level:"subcategory",path_info:g.category?`${((z=g.category.platform)==null?void 0:z.name)||""} > ${g.category.name} > ${g.name}`:g.name}});e.push(...Q);const{data:Y,error:P}=await d.from("ad_topics").select("*, subcategory:ad_subcategories(name, category:ad_categories(name, platform:ad_platforms(name)))").ilike("name",`%${F.value}%`).order("name");if(P)throw P;const N=Y.map(g=>{var z,ee,X;return{...g,is_folder:!0,folder_level:"topic",path_info:g.subcategory?`${((ee=(z=g.subcategory.category)==null?void 0:z.platform)==null?void 0:ee.name)||""} > ${((X=g.subcategory.category)==null?void 0:X.name)||""} > ${g.subcategory.name} > ${g.name}`:g.name}});e.push(...N),q.value=e}catch(e){console.error("搜索文件夹失败:",e),w.error("搜索文件夹失败")}finally{x.value=!1}};Ql(()=>{O(),le.value==="folders"&&ve()});const De=p(!1);Le(le,e=>{e==="folders"&&!De.value&&q.value.length===0&&(ve(),De.value=!0)});let pe=null;return Le(G,(e,l)=>{pe&&clearTimeout(pe),e!==l&&(pe=setTimeout(()=>{e?el():(A.value=null,J.value=null,u.value=[],v.value=null,$())},300))}),Ml(()=>{C&&C.destruct()}),(e,l)=>{const a=b("el-input"),o=b("el-option"),i=b("el-select"),s=b("el-button"),c=b("el-space"),h=b("el-card"),f=b("el-table-column"),Q=b("el-image"),Y=b("el-tooltip"),P=b("el-button-group"),N=b("el-table"),g=b("el-empty"),z=b("el-tab-pane"),ee=b("el-icon"),X=b("el-text"),ul=b("el-breadcrumb-item"),dl=b("el-breadcrumb"),cl=b("el-tabs"),Je=b("el-dialog"),me=b("el-form-item"),fl=b("el-cascader"),vl=b("el-tag"),gl=b("el-form"),Ye=Jl("loading");return E(),L("div",Ul,[r(Dl,{breadbcrum:je},null,8,["breadbcrum"]),l[38]||(l[38]=m("div",{class:"layout-title"},[m("h1",{class:"title"},"学习资料管理")],-1)),r(cl,{modelValue:le.value,"onUpdate:modelValue":l[6]||(l[6]=t=>le.value=t),class:"tabs-container"},{default:n(()=>[r(z,{label:"资料管理",name:"materials"},{default:n(()=>[r(h,{shadow:"always",style:{"margin-bottom":"20px"}},{default:n(()=>[r(c,{wrap:"",alignment:"start",size:30},{default:n(()=>[r(a,{modelValue:oe.value,"onUpdate:modelValue":l[0]||(l[0]=t=>oe.value=t),style:{width:"240px"},placeholder:"请输入资料标题","suffix-icon":ue(Ue),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),r(i,{modelValue:re.value,"onUpdate:modelValue":l[1]||(l[1]=t=>re.value=t),placeholder:"文件类型",clearable:"",style:{width:"180px"},size:"large"},{default:n(()=>[(E(),L(Ae,null,ye(be,t=>r(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),r(i,{modelValue:ne.value,"onUpdate:modelValue":l[2]||(l[2]=t=>ne.value=t),placeholder:"平台",clearable:"",style:{width:"180px"},size:"large"},{default:n(()=>[(E(),L(Ae,null,ye(we,t=>r(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),r(s,{type:"primary",size:"large",onClick:O},{default:n(()=>l[15]||(l[15]=[_("搜索")])),_:1}),r(s,{type:"primary",size:"large",onClick:Ne},{default:n(()=>l[16]||(l[16]=[_("资料上传")])),_:1})]),_:1})]),_:1}),m("div",Gl,[r(h,{style:{"min-height":"400px"}},{header:n(()=>[m("div",jl,[l[18]||(l[18]=_(" 学习资料列表 ")),m("div",Nl,[r(s,{type:"danger",disabled:!U.value.length,onClick:Xe},{default:n(()=>l[17]||(l[17]=[_(" 批量删除 ")])),_:1},8,["disabled"]),m("div",Kl,"共计 "+I(V.total)+" 条数据",1)])])]),default:n(()=>[Ge((E(),S(N,{data:de.value,onSelectionChange:We},{default:n(()=>[r(f,{type:"selection",width:"55"}),r(f,{label:"类型",width:"80"},{default:n(({row:t})=>[r(Q,{style:{width:"30px",height:"30px"},src:fe(t.type),fit:"contain"},null,8,["src"])]),_:1}),r(f,{prop:"title",label:"标题"}),r(f,{prop:"platform",label:"平台"},{default:n(({row:t})=>[_(I(Ie(t.platform)),1)]),_:1}),r(f,{label:"所在位置"},{default:n(({row:t})=>[r(Y,{effect:"dark",content:ge(t),placement:"top"},{default:n(()=>[m("span",null,I(sl(t)),1)]),_:2},1032,["content"])]),_:1}),r(f,{prop:"created_at",label:"创建时间",width:"180"},{default:n(({row:t})=>[_(I(new Date(t.created_at).toLocaleString()),1)]),_:1}),r(f,{label:"操作",width:"180",fixed:"right"},{default:n(({row:t})=>[r(P,null,{default:n(()=>[r(s,{type:"primary",onClick:M=>Ce(t)},{default:n(()=>l[19]||(l[19]=[_("查看")])),_:2},1032,["onClick"]),r(s,{type:"danger",onClick:M=>ke(t)},{default:n(()=>l[20]||(l[20]=[_("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Ye,ae.value]]),!ae.value&&de.value.length===0?(E(),S(g,{key:0,description:"暂无学习资料"})):K("",!0)]),_:1}),r(Yl,{pagination:V,"onUpdate:pagination":He},null,8,["pagination"])])]),_:1}),r(z,{label:"文件夹管理",name:"folders"},{default:n(()=>[r(h,{style:{"margin-bottom":"20px"}},{default:n(()=>[r(c,{alignment:"start",size:30},{default:n(()=>[r(a,{modelValue:F.value,"onUpdate:modelValue":l[3]||(l[3]=t=>F.value=t),placeholder:"搜索文件夹名称",clearable:"",style:{width:"240px"},size:"large",onKeyup:Sl(Me,["enter"]),"suffix-icon":ue(Ue)},null,8,["modelValue","suffix-icon"]),r(s,{type:"primary",size:"large",onClick:Me},{default:n(()=>l[21]||(l[21]=[_("搜索")])),_:1}),r(s,{type:"primary",size:"large",onClick:Ee},{default:n(()=>l[22]||(l[22]=[_("新建文件夹")])),_:1})]),_:1})]),_:1}),r(h,{class:"folder-breadcrumb",style:{"margin-bottom":"20px"}},{default:n(()=>[r(X,{onClick:l[4]||(l[4]=t=>ll()),style:{cursor:"pointer","margin-right":"10px"}},{default:n(()=>[r(ee,{size:16,color:"#000"},{default:n(()=>[r(ue(Fl))]),_:1})]),_:1}),r(X,{onClick:l[5]||(l[5]=t=>al()),style:{cursor:"pointer","margin-right":"10px"}},{default:n(()=>[r(ee,{size:16,color:"#000"},{default:n(()=>[r(ue(ql))]),_:1})]),_:1}),r(dl,{separator:"/"},{default:n(()=>[(E(!0),L(Ae,null,ye(u.value,t=>(E(),S(ul,{key:t.id,onClick:M=>tl(t)},{default:n(()=>[_(I(t.name),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1}),Ge((E(),S(h,{style:{"min-height":"400px"}},{header:n(()=>l[23]||(l[23]=[m("div",{class:"card-header"}," 文件夹列表 ",-1)])),default:n(()=>[r(N,{data:q.value,style:{width:"100%"}},{default:n(()=>[r(f,{label:"",width:"60"},{default:n(({row:t})=>[r(Q,{style:{width:"24px",height:"24px"},src:t.is_folder?Re():fe(t.type),fit:"contain"},null,8,["src"])]),_:1}),r(f,{prop:"name",label:"名称"},{default:n(({row:t})=>[r(X,{class:"folder-title",onClick:M=>xe(t)},{default:n(()=>[_(I(t.is_folder?t.name:t.title),1)]),_:2},1032,["onClick"])]),_:1}),F.value.trim()?(E(),S(f,{key:0,prop:"path_info",label:"路径"},{default:n(({row:t})=>[t.path_info?(E(),S(Y,{key:0,effect:"dark",content:t.path_info||"",placement:"top"},{default:n(()=>{var M;return[m("span",null,I(((M=t.path_info)==null?void 0:M.length)>30?t.path_info.substring(0,27)+"...":t.path_info),1)]}),_:2},1032,["content"])):K("",!0)]),_:1})):K("",!0),r(f,{prop:"type",label:"类型"},{default:n(({row:t})=>[_(I(t.is_folder?"文件夹":Be(t.type)),1)]),_:1}),r(f,{prop:"created_at",label:"创建时间",width:"180"},{default:n(({row:t})=>[_(I(Ze(t.created_at)),1)]),_:1}),r(f,{label:"操作",width:"300"},{default:n(({row:t})=>[r(P,null,{default:n(()=>[r(s,{type:"primary",onClick:M=>xe(t)},{default:n(()=>[_(I(t.is_folder?"打开":"查看"),1)]),_:2},1032,["onClick"]),r(s,{type:"danger",onClick:M=>ol(t),disabled:(t.is_folder,!1)},{default:n(()=>l[24]||(l[24]=[_(" 删除 ")])),_:2},1032,["onClick","disabled"]),t.is_folder?(E(),S(s,{key:0,type:"success",onClick:M=>Ee(t)},{default:n(()=>l[25]||(l[25]=[_(" 新建 ")])),_:2},1032,["onClick"])):K("",!0)]),_:2},1024)]),_:1})]),_:1},8,["data"]),!x.value&&q.value.length===0?(E(),S(g,{key:0,description:"暂无数据"})):K("",!0)]),_:1})),[[Ye,x.value]])]),_:1})]),_:1},8,["modelValue"]),r(Je,{title:"资料详情",modelValue:te.value,"onUpdate:modelValue":l[9]||(l[9]=t=>te.value=t),width:"70%"},{footer:n(()=>[r(s,{onClick:l[8]||(l[8]=t=>te.value=!1)},{default:n(()=>l[35]||(l[35]=[_("关闭")])),_:1})]),default:n(()=>{var t,M,Se,Fe,qe,Pe,Ve,$e,Te,ze;return[m("div",Hl,[m("div",Ol,[m("div",Xl,[r(Q,{style:{width:"40px",height:"40px"},src:fe((t=D.value)==null?void 0:t.type),fit:"contain"},null,8,["src"]),m("h2",Wl,I(((M=D.value)==null?void 0:M.title)||"无标题"),1)]),m("p",null,[l[26]||(l[26]=m("strong",null,"类型:",-1)),l[27]||(l[27]=_()),m("span",null,I(Be((Se=D.value)==null?void 0:Se.type)),1)]),m("p",null,[l[28]||(l[28]=m("strong",null,"平台:",-1)),l[29]||(l[29]=_()),m("span",null,I(Ie((Fe=D.value)==null?void 0:Fe.platform)),1)]),m("p",null,[l[30]||(l[30]=m("strong",null,"位置:",-1)),l[31]||(l[31]=_()),m("span",null,I(ge(D.value)),1)]),m("p",null,[l[32]||(l[32]=m("strong",null,"创建时间:",-1)),l[33]||(l[33]=_()),m("span",null,I((qe=D.value)!=null&&qe.created_at?new Date(D.value.created_at).toLocaleString():""),1)]),B.value&&(((Pe=D.value)==null?void 0:Pe.type)==="link"||((Ve=D.value)==null?void 0:Ve.type)==="video"||(($e=D.value)==null?void 0:$e.type)==="pdf")?(E(),L("div",Rl,[r(s,{type:"primary",onClick:l[7]||(l[7]=oa=>Oe(D.value))},{default:n(()=>l[34]||(l[34]=[_(" 打开链接 ")])),_:1})])):((Te=D.value)==null?void 0:Te.type)==="image"?(E(),S(Q,{key:1,src:B.value,fit:"contain",style:{"max-width":"100%"}},null,8,["src"])):((ze=D.value)==null?void 0:ze.type)==="txt"?(E(),L("div",{key:2,innerHTML:B.value,class:"text-content"},null,8,Zl)):(E(),L("div",ea,[m("div",{ref_key:"editor",ref:ce},null,512)]))])])]}),_:1},8,["modelValue"]),r(Vl,{visible:se.value,"onUpdate:visible":[l[10]||(l[10]=t=>se.value=t),Ke]},null,8,["visible"]),r(Je,{modelValue:W.value,"onUpdate:modelValue":l[14]||(l[14]=t=>W.value=t),title:y.value?`在 '${y.value.name||y.value.title||""}' 下创建文件夹`:"创建文件夹",width:"30%"},{footer:n(()=>[r(s,{onClick:l[13]||(l[13]=t=>W.value=!1)},{default:n(()=>l[36]||(l[36]=[_("取消")])),_:1}),r(s,{type:"primary",onClick:nl},{default:n(()=>l[37]||(l[37]=[_("确定")])),_:1})]),default:n(()=>[r(gl,{model:k,"label-width":"80px"},{default:n(()=>[r(me,{label:"名称"},{default:n(()=>[r(a,{modelValue:k.name,"onUpdate:modelValue":l[11]||(l[11]=t=>k.name=t),placeholder:"请输入文件夹名称"},null,8,["modelValue"])]),_:1}),y.value?y.value?(E(),S(me,{key:1,label:"所在位置"},{default:n(()=>[r(vl,{type:"info"},{default:n(()=>[_(I(y.value.is_folder?y.value.name:y.value.title),1)]),_:1})]),_:1})):K("",!0):(E(),S(me,{key:0,label:"所在位置"},{default:n(()=>[r(fl,{modelValue:k.folderPath,"onUpdate:modelValue":l[12]||(l[12]=t=>k.folderPath=t),options:H.value,props:{checkStrictly:!0,emitPath:!0,value:"id",label:"name",children:"children"},clearable:"",placeholder:"请选择文件夹位置",style:{width:"100%"}},{default:n(({node:t,data:M})=>[m("span",null,I(M.name),1),t.isLeaf?K("",!0):(E(),L("span",la," ("+I(M.children.length)+") ",1))]),empty:n(()=>[r(g,{description:"加载中..."})]),_:1},8,["modelValue","options"])]),_:1}))]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),ua=Pl(aa,[["__scopeId","data-v-e486ecfe"]]);export{ua as default};
