import{d as he,J as G,u as we,k as C,a5 as be,r as c,o as ke,l as h,a as s,e as a,K as xe,w as o,b as i,c as S,P as Se,v as V,M as w,g as Ve,a6 as De,f as r,y as Ce,O as Ne,t as d,q as I,U as H,s as ze,j as u,_ as Ue}from"./index-DCqMzgSt.js";const Te={class:"layout"},Be={class:"layout-title"},Ie={class:"status-tabs"},Ae={class:"training-content"},Ee={class:"card-header"},$e={class:"header-actions"},Le={style:{"font-size":"14px",color:"#909399"}},Pe={class:"dialog-content"},Me={class:"note-details"},Re={class:"note-header"},Oe={class:"note-title"},We={class:"note-meta"},je={class:"meta-item"},qe={class:"meta-item"},Je={class:"meta-item"},Ke={class:"note-section"},Qe={class:"note-content"},Fe={key:0,class:"note-section"},Ge={class:"attachment-box"},He={class:"attachment-name"},Xe={key:1,class:"note-section"},Ye={class:"previous-reply"},Ze={class:"admin-reply-content"},et={key:0,class:"reply-time"},tt={class:"note-section"},at={class:"section-title"},lt={class:"dialog-footer"},st={class:"attachment-preview"},nt=["src"],ot=["src"],it={key:2,class:"attachment-download"},rt=he({__name:"AdminStudyNotes",setup(dt){const X=G([{name:"数据管理",path:"/system/data"},{name:"学习心得",path:"/system/admin-study-notes"}]),A=we(),Y=C(()=>be(Number(A.roleId))),Z=C(()=>Number(A.roleId)===0),N=c(!1),E=c([]),k=c(!1),l=c(null),z=c(""),p=c([]),x=c(""),U=c(!1),T=c(!1),D=c("all"),ee=[{text:"Last week",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"Last month",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"Last 3 months",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],_=G({page:1,pageSize:10,total:0}),te=t=>{_.page=t.page,_.pageSize=t.pageSize,f()},f=async()=>{N.value=!0,console.log(p.value);const t=p.value!=null&&p.value[0]!=null?p.value[0].toDateString():"",e=p.value!=null&&p.value[1]!=null?p.value[1].toDateString():"";try{const m=await V.searchNotesUsingView(z.value,{startDate:t,endDate:e,page:_.page,pageSize:_.pageSize,replyStatus:D.value});E.value=m.data,_.total=m.total}catch{w.error("搜索笔记失败")}finally{N.value=!1}},ae=t=>{k.value=!0,l.value=t,x.value=t.admin_reply||""},le=async t=>{var e;try{await H.confirm(`确定要删除用户 ${((e=t.profile)==null?void 0:e.full_name)||"未知用户"} 的这条笔记吗？`,"提示",{type:"warning"}),await V.deleteNote(t.note_id),w.success("删除成功"),f()}catch(m){m!=="cancel"&&w.error("删除失败")}},g=c([]),se=t=>{g.value=t},ne=async()=>{if(g.value.length!==0)try{await H.confirm(`确定要删除选中的 ${g.value.length} 条学习心得吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=g.value.map(e=>V.deleteNote(e.note_id));await Promise.all(t),w.success(`成功删除 ${g.value.length} 条学习心得`),g.value=[],f()}catch(t){t!=="cancel"&&(console.error("批量删除学习心得失败:",t),w.error("批量删除失败"))}},oe=C(()=>{var t;return(t=l.value)!=null&&t.attachment_type?l.value.attachment_type.startsWith("image/"):!1}),ie=C(()=>{var t;return(t=l.value)!=null&&t.attachment_type?l.value.attachment_type==="application/pdf":!1}),re=()=>{var t;(t=l.value)!=null&&t.attachment_url&&(T.value=!0)},de=()=>{var t;(t=l.value)!=null&&t.attachment_url&&window.open(l.value.attachment_url,"_blank")},ue=async()=>{if(l.value){U.value=!0;try{const{data:t}=await ze.auth.getUser();if(!t.user)throw new Error("用户未登录");if(console.log("正在更新笔记，ID:",l.value.note_id),!await V.checkNoteExists(l.value.note_id))throw new Error(`笔记不存在: ${l.value.note_id}`);await V.updateNoteWithReply(l.value.note_id,{admin_reply:x.value,admin_id:t.user.id,replied_at:new Date().toISOString()}),w.success("回复已提交"),l.value&&(l.value.admin_reply=x.value,l.value.admin_id=t.user.id,l.value.replied_at=new Date().toISOString()),f(),k.value=!1}catch(t){console.error("提交回复失败:",t),w.error("提交回复失败: "+(t instanceof Error?t.message:"未知错误"))}finally{U.value=!1}}},ce=t=>{D.value=t,_.page=1,f()};return ke(()=>{f()}),(t,e)=>{const m=i("el-tab-pane"),pe=i("el-tabs"),$=i("el-input"),me=i("el-date-picker"),v=i("el-button"),_e=i("el-space"),L=i("el-card"),B=i("el-tag"),P=i("el-tooltip"),b=i("el-table-column"),ve=i("el-button-group"),M=i("el-empty"),fe=i("el-table"),R=i("el-dialog"),ge=Ne("loading");return u(),h("div",Te,[s(xe,{breadbcrum:X},null,8,["breadbcrum"]),a("div",Be,[e[7]||(e[7]=a("h1",{class:"title"},"学习心得",-1)),a("div",Ie,[s(pe,{class:"demo-tabs",modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=n=>D.value=n),onTabChange:ce},{default:o(()=>[s(m,{name:"all",label:"全部心得"}),s(m,{name:"replied",label:"已回复"}),s(m,{name:"pending",label:"待回复"})]),_:1},8,["modelValue"])])]),s(L,{shadow:"always",style:{"margin-bottom":"20px"}},{default:o(()=>[s(_e,{alignment:"start",size:30},{default:o(()=>[s($,{modelValue:z.value,"onUpdate:modelValue":e[1]||(e[1]=n=>z.value=n),style:{width:"240px"},placeholder:"请输入提交人或标题","suffix-icon":Ve(De),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),s(me,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=n=>p.value=n),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:ee,size:"large"},null,8,["modelValue"]),s(v,{type:"primary",size:"large",onClick:f},{default:o(()=>e[8]||(e[8]=[r("搜索")])),_:1})]),_:1})]),_:1}),a("div",Ae,[Y.value?(u(),S(L,{key:0,style:{"min-height":"400px"}},{header:o(()=>[a("div",Ee,[a("div",null,[e[11]||(e[11]=a("span",null,"学习心得管理",-1)),Z.value?(u(),S(P,{key:0,content:"您可以查看所有学习心得",placement:"right"},{default:o(()=>[s(B,{type:"success",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[9]||(e[9]=[r("全部")])),_:1})]),_:1})):(u(),S(P,{key:1,content:"您只能查看本组织的学习心得",placement:"right"},{default:o(()=>[s(B,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[10]||(e[10]=[r("本组织")])),_:1})]),_:1}))]),a("div",$e,[s(v,{type:"danger",disabled:!g.value.length,onClick:ne},{default:o(()=>e[12]||(e[12]=[r(" 批量删除 ")])),_:1},8,["disabled"]),a("div",Le,"共计"+d(_.total)+"条数据",1)])])]),default:o(()=>[Ce((u(),S(fe,{data:E.value,onSelectionChange:se},{default:o(()=>[s(b,{type:"selection",width:"55"}),s(b,{prop:"profile.full_name",label:"提交人"}),s(b,{prop:"title",label:"标题"}),s(b,{prop:"admin_reply",label:"状态"},{default:o(({row:n})=>[s(B,{style:{"font-size":"14px"},type:n.admin_reply?"success":"warning",size:"large"},{default:o(()=>[r(d(n.admin_reply?"已回复":"待回复"),1)]),_:2},1032,["type"])]),_:1}),s(b,{prop:"note_created_at",label:"创建时间"},{default:o(({row:n})=>[r(d(new Date(n.note_created_at).toLocaleString()),1)]),_:1}),s(b,{label:"操作",width:"150",fixed:"right"},{default:o(({row:n})=>[s(ve,null,{default:o(()=>[s(v,{type:"primary",onClick:y=>ae(n)},{default:o(()=>e[13]||(e[13]=[r("查看")])),_:2},1032,["onClick"]),s(v,{type:"danger",onClick:y=>le(n)},{default:o(()=>e[14]||(e[14]=[r("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),s(M,null,{description:o(()=>e[15]||(e[15]=[r(" 暂无学习心得 ")])),_:1})]),_:1},8,["data"])),[[ge,N.value]])]),_:1})):(u(),S(M,{key:1,description:"您没有权限查看所有笔记"})),s(Se,{pagination:_,"onUpdate:pagination":te},null,8,["pagination"]),s(R,{title:"学习心得详情",modelValue:k.value,"onUpdate:modelValue":e[5]||(e[5]=n=>k.value=n),width:"60%","close-on-click-modal":!1,top:"5vh",class:"note-detail-dialog"},{footer:o(()=>[a("span",lt,[s(v,{onClick:e[4]||(e[4]=n=>k.value=!1)},{default:o(()=>e[23]||(e[23]=[r("取消")])),_:1}),s(v,{type:"primary",onClick:ue,loading:U.value},{default:o(()=>{var n;return[r(d((n=l.value)!=null&&n.admin_reply?"更新回复":"提交回复"),1)]}),_:1},8,["loading"])])]),default:o(()=>{var n,y,O,W,j,q,J,K,Q,F;return[a("div",Pe,[a("div",Me,[a("div",Re,[a("h2",Oe,d(((n=l.value)==null?void 0:n.title)||"无标题"),1),a("div",We,[a("span",je,[e[16]||(e[16]=a("i",{class:"el-icon-user"},null,-1)),a("span",null,d(((O=(y=l.value)==null?void 0:y.profile)==null?void 0:O.full_name)||"未知用户"),1)]),a("span",qe,[e[17]||(e[17]=a("i",{class:"el-icon-message"},null,-1)),a("span",null,d(((j=(W=l.value)==null?void 0:W.profile)==null?void 0:j.email)||"无邮箱"),1)]),a("span",Je,[e[18]||(e[18]=a("i",{class:"el-icon-time"},null,-1)),a("span",null,d(l.value?new Date((q=l.value)==null?void 0:q.note_created_at).toLocaleString():"未知时间"),1)])])]),a("div",Ke,[e[19]||(e[19]=a("div",{class:"section-title"},"内容",-1)),a("div",Qe,d(((J=l.value)==null?void 0:J.content)||"无内容"),1)]),(K=l.value)!=null&&K.attachment_url?(u(),h("div",Fe,[e[21]||(e[21]=a("div",{class:"section-title"},"附件",-1)),a("div",Ge,[a("span",He,d(l.value.attachment_name),1),s(v,{type:"primary",size:"small",onClick:re},{default:o(()=>e[20]||(e[20]=[r("查看附件")])),_:1})])])):I("",!0),(Q=l.value)!=null&&Q.admin_reply?(u(),h("div",Xe,[e[22]||(e[22]=a("div",{class:"section-title"},"历史回复",-1)),a("div",Ye,[a("div",Ze,d(l.value.admin_reply),1),l.value.replied_at?(u(),h("p",et," 回复于: "+d(new Date(l.value.replied_at).toLocaleString()),1)):I("",!0)])])):I("",!0),a("div",tt,[a("div",at,d((F=l.value)!=null&&F.admin_reply?"修改回复":"添加回复"),1),s($,{type:"textarea",modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=ye=>x.value=ye),rows:4,placeholder:"请输入您的回复内容...",class:"reply-input"},null,8,["modelValue"])])])])]}),_:1},8,["modelValue"]),s(R,{modelValue:T.value,"onUpdate:modelValue":e[6]||(e[6]=n=>T.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{default:o(()=>{var n,y;return[a("div",st,[oe.value?(u(),h("img",{key:0,src:(n=l.value)==null?void 0:n.attachment_url,class:"attachment-image"},null,8,nt)):ie.value?(u(),h("iframe",{key:1,src:(y=l.value)==null?void 0:y.attachment_url,class:"attachment-frame"},null,8,ot)):(u(),h("div",it,[e[25]||(e[25]=a("p",null,"无法预览此类型的文件，请下载后查看",-1)),s(v,{type:"primary",onClick:de},{default:o(()=>e[24]||(e[24]=[r("下载附件")])),_:1})]))])]}),_:1},8,["modelValue"])])])}}}),ct=Ue(rt,[["__scopeId","data-v-51a31f76"]]);export{ct as default};
