import{E as f,B as W,m as oe,A as ie,C as ue}from"./elementPlus-DvW_yQnS.js";import{a as P,s as G,_ as re}from"./index-C76T_Z_L.js";import{x as de,r as d,c as H,j as ce,y as _,A as l,P as a,I as me,M as c,H as t,ag as y,aq as ve,G as D,L as v,u as S,J as w,z as r}from"./vendor-COQJj1AX.js";import"./supabase-ndUUYBZa.js";const pe={class:"study-notes"},_e={class:"study-body"},fe={class:"study-header"},ye={key:1},he={class:"attachment-box"},ge={class:"attachment-name"},be={key:1,class:"note-view"},we={class:"note-title"},ke={class:"note-meta"},Ve={key:0},Ce={class:"note-content-section"},xe={class:"note-content"},De={key:0,class:"note-attachment-section"},Ne={class:"attachment-box"},Ee={class:"attachment-name"},Le={key:1,class:"note-reply-section"},Se={class:"admin-reply"},Ae={class:"reply-header"},Ue={class:"reply-author"},Me={class:"reply-content"},$e={key:0,class:"reply-time"},Be={class:"attachment-preview"},Fe=["src"],ze=["src"],Ie={key:2,class:"attachment-download"},qe=de({__name:"StudyNotes",setup(Pe){const A=d(!1),U=d([]),b=d(!1),h=d(!1),k=d(!1),M=d(""),$=d(),n=d({}),B=d([]);d(!1);const E=d(!1),V=d(""),C=d(""),g=d(null),p=d({title:"",content:""}),J={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},O=H(()=>C.value?C.value.startsWith("image/"):!1),K=H(()=>C.value?C.value==="application/pdf":!1),Q=()=>k.value?"查看笔记":h.value?"编辑笔记":"新建笔记",R=async()=>{A.value=!0;try{U.value=await P.getNotes()}catch{f.error("获取笔记列表失败")}finally{A.value=!1}},X=()=>{h.value=!1,k.value=!1,p.value={title:"",content:""},B.value=[],g.value=null,b.value=!0},Y=s=>{k.value=!0,h.value=!1,M.value=s.id,n.value=s,b.value=!0},Z=s=>{if(s.admin_reply){f.warning("已回复的笔记不能修改");return}h.value=!0,k.value=!1,M.value=s.id,n.value=s,p.value={title:s.title,content:s.content},B.value=[],g.value=null,b.value=!0},ee=s=>{s.attachment_url?(V.value=s.attachment_url,C.value=s.attachment_type||"",E.value=!0):f.warning("该笔记没有附件")},te=()=>{var s;(s=n.value)!=null&&s.attachment_url&&(V.value=n.value.attachment_url,C.value=n.value.attachment_type||"",E.value=!0)},T=()=>{V.value?window.open(V.value,"_blank"):n.value.attachment_url&&window.open(n.value.attachment_url,"_blank")},ae=s=>s.size/1024/1024<10?!0:(f.error("文件大小不能超过 10MB!"),!1),le=async s=>{const{file:e,onSuccess:i,onError:u}=s;if(!e){u==null||u(new Error("文件不存在"));return}const L=ue.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const m=e,F=m.name.split(".").pop(),x=`study_notes/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${F}`}`,{data:I,error:N}=await G.storage.from("attachments").upload(x,m,{cacheControl:"3600",upsert:!1});if(N)throw N;const{data:{publicUrl:q}}=G.storage.from("attachments").getPublicUrl(I.path);g.value={url:q,name:m.name,type:m.type},i==null||i(g.value),f.success("文件上传成功")}catch(m){console.error("文件上传错误:",m),u==null||u(new Error(m instanceof Error?m.message:"上传失败")),f.error("文件上传失败，请重试")}finally{L.close()}},ne=()=>{g.value=null},se=async()=>{$.value&&await $.value.validate(async s=>{var e,i,u;if(s)try{h.value?(await P.updateNote(M.value,{title:p.value.title,content:p.value.content}),f.success("修改成功")):(await P.createNote({...p.value,attachment_url:(e=g.value)==null?void 0:e.url,attachment_name:(i=g.value)==null?void 0:i.name,attachment_type:(u=g.value)==null?void 0:u.type}),f.success("创建成功")),b.value=!1,R()}catch{f.error(h.value?"修改失败":"创建失败")}})};return ce(()=>{R()}),(s,e)=>{const i=y("el-button"),u=y("el-table-column"),L=y("el-tag"),m=y("el-icon"),F=y("el-table"),z=y("el-input"),x=y("el-form-item"),I=y("el-upload"),N=y("el-dialog"),q=ve("loading");return r(),_("div",pe,[l("div",_e,[l("div",fe,[l("div",null,"共计"+c(U.value.length)+"篇笔记",1),a(i,{type:"primary",onClick:X},{default:t(()=>e[5]||(e[5]=[v("新建笔记")])),_:1})]),me((r(),D(F,{data:U.value,height:"300px"},{default:t(()=>[a(u,{prop:"title",label:"标题"}),a(u,{label:"状态",width:"100"},{default:t(({row:o})=>[a(L,{type:o.admin_reply?"success":"info"},{default:t(()=>[v(c(o.admin_reply?"已回复":"未回复"),1)]),_:2},1032,["type"])]),_:1}),a(u,{label:"附件",width:"80"},{default:t(({row:o})=>[o.attachment_url?(r(),D(i,{key:0,type:"primary",link:"",onClick:j=>ee(o)},{default:t(()=>[a(m,{color:"#409EFF",size:"18"},{default:t(()=>[a(S(W))]),_:1})]),_:2},1032,["onClick"])):(r(),_("span",ye,"-"))]),_:1}),a(u,{prop:"created_at",label:"创建时间",width:"180"},{default:t(({row:o})=>[v(c(new Date(o.created_at).toLocaleString()),1)]),_:1}),a(u,{prop:"updated_at",label:"修改时间",width:"180"},{default:t(({row:o})=>[v(c(o.updated_at?new Date(o.updated_at).toLocaleString():"-"),1)]),_:1}),a(u,{label:"操作",width:"160"},{default:t(({row:o})=>[a(i,{type:"primary",onClick:j=>Y(o)},{default:t(()=>e[6]||(e[6]=[v("查看")])),_:2},1032,["onClick"]),a(i,{type:"warning",onClick:j=>Z(o),disabled:!!o.admin_reply},{default:t(()=>e[7]||(e[7]=[v("编辑")])),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[q,A.value]])]),a(N,{title:Q(),modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=o=>b.value=o),width:"40%",style:{"min-width":"400px"}},{footer:t(()=>[a(i,{onClick:e[2]||(e[2]=o=>b.value=!1)},{default:t(()=>e[16]||(e[16]=[v("关闭")])),_:1}),k.value?w("",!0):(r(),D(i,{key:0,type:"primary",onClick:se},{default:t(()=>e[17]||(e[17]=[v("确定")])),_:1}))]),default:t(()=>[k.value?(r(),_("div",be,[l("h3",we,c(n.value.title),1),l("div",ke,[l("p",null,"提交于: "+c(new Date(n.value.created_at).toLocaleString()),1),n.value.updated_at&&n.value.updated_at!==n.value.created_at?(r(),_("p",Ve," 修改于: "+c(new Date(n.value.updated_at).toLocaleString()),1)):w("",!0)]),l("div",Ce,[e[12]||(e[12]=l("div",{class:"section-title"},"我的内容:",-1)),l("div",xe,c(n.value.content),1)]),n.value.attachment_url?(r(),_("div",De,[e[14]||(e[14]=l("div",{class:"section-title"},"附件:",-1)),l("div",Ne,[a(m,{color:"#409EFF",size:"16"},{default:t(()=>[a(S(W))]),_:1}),l("span",Ee,c(n.value.attachment_name),1),a(i,{type:"primary",size:"small",onClick:te},{default:t(()=>e[13]||(e[13]=[v("查看附件")])),_:1})])])):w("",!0),n.value.admin_reply?(r(),_("div",Le,[e[15]||(e[15]=l("div",{class:"section-title"},"管理员回复:",-1)),l("div",Se,[l("div",Ae,[l("span",Ue,c(n.value.admin_name||"未知")+":",1)]),l("p",Me,c(n.value.admin_reply),1),n.value.replied_at?(r(),_("p",$e," 回复于: "+c(new Date(n.value.replied_at).toLocaleString()),1)):w("",!0)])])):w("",!0)])):(r(),D(S(ie),{key:0,model:p.value,ref_key:"formRef",ref:$,rules:J},{default:t(()=>[a(x,{label:"标题",prop:"title"},{default:t(()=>[a(z,{modelValue:p.value.title,"onUpdate:modelValue":e[0]||(e[0]=o=>p.value.title=o)},null,8,["modelValue"])]),_:1}),a(x,{label:"内容",prop:"content"},{default:t(()=>[a(z,{modelValue:p.value.content,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.content=o),type:"textarea",rows:6},null,8,["modelValue"])]),_:1}),h.value?w("",!0):(r(),D(x,{key:0,label:"附件"},{default:t(()=>[a(I,{class:"upload-container",drag:"","auto-upload":!0,"http-request":le,"on-remove":ne,"before-upload":ae,limit:1,"file-list":B.value},{tip:t(()=>e[8]||(e[8]=[l("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:t(()=>[a(m,{class:"el-icon--upload"},{default:t(()=>[a(S(oe))]),_:1}),e[9]||(e[9]=l("div",{class:"el-upload__text"},[v(" 将文件拖到此处，或"),l("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})),h.value&&n.value.attachment_url?(r(),D(x,{key:1,label:"当前附件"},{default:t(()=>[l("div",he,[l("span",ge,c(n.value.attachment_name),1),a(i,{type:"primary",size:"small",onClick:T},{default:t(()=>e[10]||(e[10]=[v("下载")])),_:1})]),e[11]||(e[11]=l("div",{class:"el-upload__tip",style:{"margin-top":"8px"}}," 注意：编辑模式下暂不支持修改附件 ",-1))]),_:1})):w("",!0)]),_:1},8,["model"]))]),_:1},8,["title","modelValue"]),a(N,{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=o=>E.value=o),title:"附件预览",width:"80%","destroy-on-close":""},{default:t(()=>[l("div",Be,[O.value?(r(),_("img",{key:0,src:V.value,class:"attachment-image"},null,8,Fe)):K.value?(r(),_("iframe",{key:1,src:V.value,class:"attachment-frame"},null,8,ze)):(r(),_("div",Ie,[e[19]||(e[19]=l("p",null,"无法预览此类型的文件，请下载后查看",-1)),a(i,{type:"primary",onClick:T},{default:t(()=>e[18]||(e[18]=[v("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])}}}),Ge=re(qe,[["__scopeId","data-v-0672ab0a"]]);export{Ge as default};
