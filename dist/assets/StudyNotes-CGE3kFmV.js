import{d as H,r,o as J,l as h,e as a,a as l,y as K,t as _,w as t,b as m,O as Q,c as U,v as B,M as g,f as p,g as R,a2 as X,a1 as Y,q as x,a3 as Z,s as F,j as v,_ as ee}from"./index-BsBxzW2u.js";const te={class:"study-notes"},le={class:"study-body"},ae={class:"study-header"},oe={key:1,class:"note-view"},se={class:"note-title"},ne={class:"note-meta"},ie={class:"note-content-section"},ue={class:"note-content"},re={key:0,class:"note-attachment-section"},de={class:"attachment-box"},ce={class:"attachment-name"},_e={key:1,class:"note-reply-section"},me={class:"admin-reply"},pe={class:"reply-content"},ve={key:0,class:"reply-time"},fe=H({__name:"StudyNotes",setup(ye){const C=r(!1),D=r([]),b=r(!1),f=r(!1),$=r(""),E=r(),n=r({}),q=r([]);r(!1);const y=r(null),c=r({title:"",content:""}),P={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},I=async()=>{C.value=!0;try{D.value=await B.getNotes()}catch{g.error("获取笔记列表失败")}finally{C.value=!1}},j=()=>{f.value=!1,c.value={title:"",content:""},q.value=[],y.value=null,b.value=!0},z=i=>{f.value=!0,$.value=i.id,n.value=i,c.value={title:i.title,content:i.content},b.value=!0},O=()=>{n.value.attachment_url&&window.open(n.value.attachment_url,"_blank")},A=i=>i.size/1024/1024<10?!0:(g.error("文件大小不能超过 10MB!"),!1),T=async i=>{const{file:e,onSuccess:u,onError:o}=i;if(!e){o==null||o(new Error("文件不存在"));return}const w=Z.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const d=e,k=d.name.split(".").pop(),M=`study_notes/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${k}`}`,{data:S,error:V}=await F.storage.from("attachments").upload(M,d,{cacheControl:"3600",upsert:!1});if(V)throw V;const{data:{publicUrl:L}}=F.storage.from("attachments").getPublicUrl(S.path);y.value={url:L,name:d.name,type:d.type},u==null||u(y.value),g.success("文件上传成功")}catch(d){console.error("文件上传错误:",d),o==null||o(new Error(d instanceof Error?d.message:"上传失败")),g.error("文件上传失败，请重试")}finally{w.close()}},W=()=>{y.value=null},G=async()=>{E.value&&await E.value.validate(async i=>{var e,u,o;if(i)try{f.value?(await B.updateNote($.value,c.value),g.success("更新成功")):(await B.createNote({...c.value,attachment_url:(e=y.value)==null?void 0:e.url,attachment_name:(u=y.value)==null?void 0:u.name,attachment_type:(o=y.value)==null?void 0:o.type}),g.success("创建成功")),b.value=!1,I()}catch{g.error(f.value?"更新失败":"创建失败")}})};return J(()=>{I()}),(i,e)=>{const u=m("el-button"),o=m("el-table-column"),w=m("el-tag"),d=m("el-table"),k=m("el-input"),N=m("el-form-item"),M=m("el-icon"),S=m("el-upload"),V=m("el-dialog"),L=Q("loading");return v(),h("div",te,[a("div",le,[a("div",ae,[a("div",null,"共计"+_(D.value.length)+"篇笔记",1),l(u,{type:"primary",onClick:j},{default:t(()=>e[4]||(e[4]=[p("新建笔记")])),_:1})]),K((v(),U(d,{data:D.value},{default:t(()=>[l(o,{prop:"title",label:"标题"}),l(o,{label:"状态",width:"100"},{default:t(({row:s})=>[l(w,{type:s.admin_reply?"success":"info"},{default:t(()=>[p(_(s.admin_reply?"已回复":"未回复"),1)]),_:2},1032,["type"])]),_:1}),l(o,{prop:"created_at",label:"创建时间"},{default:t(({row:s})=>[p(_(new Date(s.created_at).toLocaleString()),1)]),_:1}),l(o,{label:"操作"},{default:t(({row:s})=>[l(u,{type:"primary",onClick:ge=>z(s)},{default:t(()=>e[5]||(e[5]=[p("查看")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[L,C.value]])]),l(V,{title:f.value?"查看笔记":"新建笔记",modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=s=>b.value=s),width:"40%",style:{"min-width":"400px"}},{footer:t(()=>[l(u,{onClick:e[2]||(e[2]=s=>b.value=!1)},{default:t(()=>e[12]||(e[12]=[p("关闭")])),_:1}),f.value?x("",!0):(v(),U(u,{key:0,type:"primary",onClick:G},{default:t(()=>e[13]||(e[13]=[p("确定")])),_:1}))]),default:t(()=>[f.value?(v(),h("div",oe,[a("h3",se,_(n.value.title),1),a("p",ne,"提交于: "+_(new Date(n.value.created_at).toLocaleString()),1),a("div",ie,[e[8]||(e[8]=a("div",{class:"section-title"},"我的内容:",-1)),a("div",ue,_(n.value.content),1)]),n.value.attachment_url?(v(),h("div",re,[e[10]||(e[10]=a("div",{class:"section-title"},"附件:",-1)),a("div",de,[a("span",ce,_(n.value.attachment_name),1),l(u,{type:"primary",size:"small",onClick:O},{default:t(()=>e[9]||(e[9]=[p("下载")])),_:1})])])):x("",!0),n.value.admin_reply?(v(),h("div",_e,[e[11]||(e[11]=a("div",{class:"section-title"},"管理员回复:",-1)),a("div",me,[a("p",pe,_(n.value.admin_reply),1),n.value.replied_at?(v(),h("p",ve," 回复于: "+_(new Date(n.value.replied_at).toLocaleString()),1)):x("",!0)])])):x("",!0)])):(v(),U(R(Y),{key:0,model:c.value,ref_key:"formRef",ref:E,rules:P},{default:t(()=>[l(N,{label:"标题",prop:"title"},{default:t(()=>[l(k,{modelValue:c.value.title,"onUpdate:modelValue":e[0]||(e[0]=s=>c.value.title=s)},null,8,["modelValue"])]),_:1}),l(N,{label:"内容",prop:"content"},{default:t(()=>[l(k,{modelValue:c.value.content,"onUpdate:modelValue":e[1]||(e[1]=s=>c.value.content=s),type:"textarea",rows:6},null,8,["modelValue"])]),_:1}),l(N,{label:"附件"},{default:t(()=>[l(S,{class:"upload-container",drag:"","auto-upload":!0,"http-request":T,"on-remove":W,"before-upload":A,limit:1,"file-list":q.value},{tip:t(()=>e[6]||(e[6]=[a("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:t(()=>[l(M,{class:"el-icon--upload"},{default:t(()=>[l(R(X))]),_:1}),e[7]||(e[7]=a("div",{class:"el-upload__text"},[p(" 将文件拖到此处，或"),a("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"]))]),_:1},8,["title","modelValue"])])}}}),he=ee(fe,[["__scopeId","data-v-dfabd584"]]);export{he as default};
