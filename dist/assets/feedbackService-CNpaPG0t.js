import{s as c,u as i,g as m}from"./index-o-d80rdM.js";const g=e=>{if(e==null){const a=i();e=Number(a.roleId||localStorage.getItem("roleId"))}return console.log(e,"roleid============================"),e!==null&&[0,1,11].includes(e)},b={async getAllFeedback(e){if(!i().getUser())throw new Error("未登录");const s=(e==null?void 0:e.page)||1,u=(e==null?void 0:e.pageSize)||10,d=(s-1)*u,n=d+u-1;let r=c.from("feedback_with_users").select("*",{count:"exact"});const l=g();if(l||(r=r.eq("is_show",!0)),l&&(e!=null&&e.showStatus)&&(r=r.eq("is_show",e.showStatus==="true"),console.log("query",r)),e!=null&&e.query&&(r=r.or(`title.ilike.%${e.query}%,full_name.ilike.%${e.query}%`)),e!=null&&e.startDate&&(e!=null&&e.endDate)){const{startUTC:h,endUTC:_}=m(e.startDate,e.endDate);r=r.gte("created_at",h).lte("created_at",_)}e!=null&&e.replyStatus&&e.replyStatus!=="all"&&(e.replyStatus==="replied"?r=r.eq("status","resolved"):e.replyStatus==="in_progress"?r=r.eq("status","in_progress"):e.replyStatus==="pending"&&(r=r.eq("status","pending"))),e!=null&&e.platform&&e.platform!=="all"&&(r=r.eq("platform",e.platform)),r=r.order("created_at",{ascending:!1}).range(d,n);const{data:f,error:w,count:o}=await r;if(w)throw console.error("获取反馈失败:",w),new Error("获取反馈失败");return{data:f,total:o||0}},async getPersonalFeedback(e){const t=i().getUser();if(!t)throw new Error("未登录");const s=(e==null?void 0:e.page)||1,u=(e==null?void 0:e.pageSize)||10,d=(s-1)*u,n=d+u-1;let r=c.from("feedback_with_users").select("*",{count:"exact"}).eq("user_id",t.user_id);g()||(r=r.eq("is_show",!0)),e!=null&&e.platform&&e.platform!=="all"&&(r=r.eq("platform",e.platform)),r=r.order("created_at",{ascending:!1}).range(d,n);const{data:f,error:w,count:o}=await r;if(w)throw console.error("获取个人反馈失败:",w),new Error("获取个人反馈失败");return{data:f,total:o||0}},async createFeedback(e){const t=i().getUser();if(!t)throw new Error("未登录");const{data:s,error:u}=await c.from("feedback").insert([{...e,user_id:t.user_id,is_show:!0}]).select().single();if(u)throw console.error("创建反馈失败:",u),new Error("创建反馈失败");return s},async updateFeedback(e,a){const{data:t,error:s}=await c.from("feedback").update(a).eq("id",e).select().single();if(s)throw console.error("更新反馈失败:",s),new Error("更新反馈失败");return t},async deleteFeedback(e){const{error:a}=await c.from("feedback").delete().eq("id",e);if(a)throw console.error("删除反馈失败:",a),new Error("删除反馈失败")},async hideFeedback(e){const{error:a}=await c.from("feedback").update({is_show:!1}).eq("id",e);if(a)throw console.error("隐藏反馈失败:",a),new Error("隐藏反馈失败")},async getFeedbackReplies(e){const{data:a,error:t}=await c.from("feedback_replies_with_users").select("*").eq("feedback_id",e).order("created_at",{ascending:!0});if(t)throw console.error("获取回复失败:",t),new Error("获取回复失败");return a},async submitReply(e,a){const s=i().getUser();if(!s)throw new Error("未登录");const{data:u,error:d}=await c.from("feedback").select("id").eq("id",e).single();if(d||!u)throw console.error("反馈不存在:",d),new Error("反馈不存在");const{data:n,error:r}=await c.from("feedback_replies").insert([{feedback_id:e,user_id:s.user_id,content:a.content}]).select().single();if(r)throw console.error("创建回复失败:",r),new Error("创建回复失败");if(a.status||a.is_show!==void 0){const l={};a.status&&(l.status=a.status),a.is_show!==void 0&&(l.is_show=a.is_show);const{error:f}=await c.from("feedback").update(l).eq("id",e);if(f)throw console.error("更新反馈状态失败:",f),new Error("更新反馈状态失败")}return n},async checkFeedbackExists(e){const{data:a,error:t}=await c.from("feedback").select("id").eq("id",e).single();return!(t||!a)}};export{b as f,g as h};
