import{x as C,E as d,y as E}from"./elementPlus-Dv7g5dxn.js";import{a as L}from"./assignmentService-CKmoURvw.js";import{u as N,s as w,_ as q}from"./index-BfpeTqGr.js";import{x as A,r as g,G as I,H as l,ag as i,P as o,A as v,u as P,L as h,z as $}from"./vendor-COQJj1AX.js";import"./supabase-Bqqw4QDB.js";const z=A({__name:"SelfAssignment",setup(D){const V=N(),U={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},r=g({title:"",content:""}),f=g(),x=g([]),u=g(null),M=m=>m.size/1024/1024<10?!0:(d.error("文件大小不能超过 10MB!"),!1),R=async m=>{const{file:e,onSuccess:n,onError:t}=m;if(!e){t==null||t(new Error("文件不存在"));return}const c=E.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const a=e,s=a.name.split(".").pop(),b=`assignments/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${s}`}`,{data:p,error:y}=await w.storage.from("attachments").upload(b,a,{cacheControl:"3600",upsert:!1});if(y)throw y;const{data:{publicUrl:B}}=w.storage.from("attachments").getPublicUrl(p.path);u.value={url:B,name:a.name,type:a.type},n==null||n(u.value),d.success("文件上传成功")}catch(a){console.error("文件上传错误:",a),t==null||t(new Error(a instanceof Error?a.message:"上传失败")),d.error("文件上传失败，请重试")}finally{c.close()}},S=()=>{u.value=null},k=async()=>{f.value&&await f.value.validate(async m=>{var e,n,t,c,a;if(m)try{const s=(e=V.user)==null?void 0:e.user_id;if(!s){d.error("用户未登录");return}const _={...r.value,assigned_to:s,attachment_url:(n=u.value)==null?void 0:n.url,attachment_name:(t=u.value)==null?void 0:t.name,attachment_type:(c=u.value)==null?void 0:c.type};await L.createAssignment(_),d.success("提交成功"),(a=f.value)==null||a.resetFields(),r.value={title:"",content:""},x.value=[],u.value=null}catch(s){console.error("提交失败:",s),d.error("提交失败")}})};return(m,e)=>{const n=i("el-input"),t=i("el-form-item"),c=i("el-icon"),a=i("el-upload"),s=i("el-button"),_=i("el-form"),b=i("el-card");return $(),I(b,{style:{"min-height":"400px","margin-top":"30px"}},{header:l(()=>e[2]||(e[2]=[v("div",{class:"subtitle"},"添加个人作业",-1)])),default:l(()=>[o(_,{model:r.value,ref_key:"formRef",ref:f,rules:U,"label-width":"80px",style:{width:"100%","max-width":"800px","margin-top":"20px"}},{default:l(()=>[o(t,{label:"标题",prop:"title"},{default:l(()=>[o(n,{modelValue:r.value.title,"onUpdate:modelValue":e[0]||(e[0]=p=>r.value.title=p)},null,8,["modelValue"])]),_:1}),o(t,{label:"内容",prop:"content"},{default:l(()=>[o(n,{modelValue:r.value.content,"onUpdate:modelValue":e[1]||(e[1]=p=>r.value.content=p),type:"textarea",autosize:{minRows:7,maxRows:15}},null,8,["modelValue"])]),_:1}),o(t,{label:"附件"},{default:l(()=>[o(a,{class:"upload-container",drag:"","auto-upload":!0,"http-request":R,"on-remove":S,"before-upload":M,limit:1,"file-list":x.value},{tip:l(()=>e[3]||(e[3]=[v("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:l(()=>[o(c,{class:"el-icon--upload"},{default:l(()=>[o(P(C))]),_:1}),e[4]||(e[4]=v("div",{class:"el-upload__text"},[h(" 将文件拖到此处，或"),v("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),o(t,null,{default:l(()=>[o(s,{type:"primary",onClick:k},{default:l(()=>e[5]||(e[5]=[h("提交")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1})}}}),T=q(z,[["__scopeId","data-v-344dc751"]]);export{T as default};
