import{d as at,J as he,u as st,k as W,r as i,o as nt,l as g,a as l,e as n,K as ot,w as a,b as r,c as x,P as it,M as y,g as J,a6 as rt,f as d,y as we,O as ut,t as f,a2 as xe,F as ke,m as Ve,a3 as dt,q as K,A as ct,a4 as pt,s as De,U as Ae,j as u,_ as mt}from"./index-CCiOYfNf.js";import{a as C}from"./assignmentService-Cc8oV28y.js";const vt={class:"layout"},ft={class:"layout-title"},_t={class:"status-tabs"},gt={class:"assignments-content"},yt={class:"card-header"},bt={class:"header-actions"},ht={style:{"font-size":"14px",color:"#909399"}},wt={class:"tooltip-content"},xt={class:"text-truncate"},kt={key:1},Vt={class:"form-tip"},Dt={key:0,class:"assignment-details"},At={class:"details-header"},zt={class:"detail-item"},Ct={class:"detail-item"},St={class:"detail-item"},Ut={class:"detail-item"},Rt={class:"content"},Bt={key:0,class:"attachment-section"},Ft={class:"attachment-box"},It={class:"attachment-name"},Tt={key:1,class:"replies"},Mt={class:"reply-time"},$t={key:2,class:"action-buttons"},Pt={class:"attachment-preview"},Et=["src"],Nt=["src"],qt={key:2,class:"attachment-download"},Lt=at({__name:"AdminAssignments",setup(Ot){const ze=he([{name:"数据管理",path:"/system/data-management"},{name:"作业管理",path:"/system/assignments"}]),ee=st(),Ce=W(()=>{const t=Number(ee.roleId);return t===0||t===1||t===11}),te=W(()=>Number(ee.roleId)===0),Q=i(!1),G=i(!1),N=i("all");i("all");const H=i(""),k=i([]),I=i([]),le=i([]),T=i(!1),M=i(!1),q=i(!1),L=i(!1),o=i(null),D=i([]),S=i(""),U=i(""),ae=i([]),A=i(null),Se=[{text:"最近一周",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近一个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近三个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],h=he({page:1,pageSize:10,total:0}),Ue={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}],assigned_to:[{required:!0,message:"请选择指定人员",trigger:"change"}]},Re={content:[{required:!0,message:"请输入回复内容",trigger:"blur"}]},w=i({title:"",content:"",assigned_to:void 0}),$=i({assignment_id:"",user_id:"",content:"",full_name:""}),X=i(),Y=i(),Be=W(()=>U.value?U.value.startsWith("image/"):!1),Fe=W(()=>U.value?U.value==="application/pdf":!1),Ie=t=>t.size/1024/1024<10?!0:(y.error("文件大小不能超过 10MB!"),!1),Te=async t=>{const{file:e,onSuccess:c,onError:p}=t;if(!e){p==null||p(new Error("文件不存在"));return}const _=pt.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const m=e,v=m.name.split(".").pop(),O=`assignments/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${v}`}`,{data:B,error:F}=await De.storage.from("attachments").upload(O,m,{cacheControl:"3600",upsert:!1});if(F)throw F;const{data:{publicUrl:b}}=De.storage.from("attachments").getPublicUrl(B.path);A.value={url:b,name:m.name,type:m.type},c==null||c(A.value),y.success("文件上传成功")}catch(m){console.error("文件上传错误:",m),p==null||p(new Error(m instanceof Error?m.message:"上传失败")),y.error("文件上传失败，请重试")}finally{_.close()}},Me=()=>{A.value=null},$e=t=>{t.attachment_url&&(S.value=t.attachment_url,U.value=t.attachment_type||"",L.value=!0)},Pe=()=>{var t;(t=o.value)!=null&&t.attachment_url&&(S.value=o.value.attachment_url,U.value=o.value.attachment_type||"",L.value=!0)},Ee=()=>{S.value&&window.open(S.value,"_blank")},V=async()=>{Q.value=!0;try{const t=k.value&&k.value[0]?k.value[0].toISOString():void 0,e=k.value&&k.value[1]?k.value[1].toISOString():void 0,{data:c,total:p}=await C.getAssignments(h.page,h.pageSize,{query:H.value,startDate:t,endDate:e,status:"all"});N.value==="replied"?I.value=c.filter(_=>R(_).text==="已完成并已回复"):N.value==="pending"?I.value=c.filter(_=>{const m=R(_);return m.text==="待完成"||m.text==="已完成待回复"||m.text==="管理员已回复待完成"||m.text==="待回复"}):I.value=c,h.total=I.value.length}catch(t){console.error("获取作业列表失败:",t),y.error("获取作业列表失败")}finally{Q.value=!1}},Ne=async()=>{try{const t=await C.getOrganizationMembers();le.value=t}catch(t){console.error("获取组织成员失败:",t),y.error("获取组织成员失败")}},qe=()=>{T.value=!0,w.value={title:"",content:"",assigned_to:void 0},ae.value=[],A.value=null},Le=async()=>{X.value&&await X.value.validate(async t=>{var e,c,p;if(t)try{const _={...w.value,attachment_url:(e=A.value)==null?void 0:e.url,attachment_name:(c=A.value)==null?void 0:c.name,attachment_type:(p=A.value)==null?void 0:p.type};await C.createAssignment(_),y.success("布置作业成功"),T.value=!1,V()}catch(_){console.error("布置作业失败:",_),y.error("布置作业失败")}})},Oe=()=>{o.value&&(M.value=!0,$.value={assignment_id:o.value.id||"",user_id:"",content:"",full_name:""})},je=async()=>{Y.value&&await Y.value.validate(async t=>{if(t)try{await C.addReply($.value),y.success("回复成功"),M.value=!1,V(),q.value&&o.value&&se(o.value)}catch(e){console.error("回复失败:",e),y.error("回复失败")}})},se=async t=>{G.value=!0,o.value=t,q.value=!0;try{const e=await C.getAssignmentById(t.id||"");e&&(o.value=e)}catch(e){console.error("获取作业详情失败:",e)}finally{G.value=!1}},ne=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",We=t=>{h.page=t.page,h.pageSize=t.pageSize,V()},Je=t=>{h.page=1,V()},Ke=()=>{h.page=1,V()},Qe=t=>{D.value=t},Ge=async t=>{try{if(await Ae.confirm("确定要删除该作业吗？此操作不可恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),!t.id)throw new Error("作业ID不存在");await C.deleteAssignment(t.id),y.success("删除成功"),V()}catch(e){e!=="cancel"&&(console.error("删除作业失败:",e),y.error("删除失败"))}},He=async()=>{if(D.value.length!==0)try{await Ae.confirm(`确定要删除选中的 ${D.value.length} 个作业吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=D.value.map(e=>e.id?C.deleteAssignment(e.id):Promise.resolve());await Promise.all(t),y.success(`成功删除 ${D.value.length} 个作业`),D.value=[],V()}catch(t){t!=="cancel"&&(console.error("批量删除作业失败:",t),y.error("批量删除失败"))}},R=t=>{if(!t||!t.replies||t.replies.length===0)return{type:"info",text:"待完成",hasAssigneeReply:!1};const e=t.replies.some(p=>p.user_id===t.assigned_to),c=t.replies.some(p=>p.user_id!==t.assigned_to);return e&&c?{type:"success",text:"已完成并已回复",hasAssigneeReply:!0}:e?{type:"warning",text:"已完成待回复",hasAssigneeReply:!0}:c?{type:"warning",text:"管理员已回复待完成",hasAssigneeReply:!1}:{type:"waring",text:"待回复",hasAssigneeReply:!1}};return nt(async()=>{await Promise.all([V(),Ne()])}),(t,e)=>{const c=r("el-tab-pane"),p=r("el-tabs"),_=r("el-input"),m=r("el-date-picker"),v=r("el-button"),oe=r("el-space"),O=r("el-card"),B=r("el-tag"),F=r("el-tooltip"),b=r("el-table-column"),Z=r("el-icon"),Xe=r("el-button-group"),ie=r("el-empty"),Ye=r("el-table"),P=r("el-form-item"),Ze=r("el-option"),et=r("el-select"),re=r("el-text"),tt=r("el-upload"),ue=r("el-form"),j=r("el-dialog"),lt=r("el-divider"),de=ut("loading");return u(),g("div",vt,[l(ot,{breadbcrum:ze},null,8,["breadbcrum"]),n("div",ft,[e[13]||(e[13]=n("h1",{class:"title"},"作业管理",-1)),n("div",_t,[l(p,{class:"demo-tabs",modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=s=>N.value=s),onTabChange:Je},{default:a(()=>[l(c,{name:"all",label:"全部作业"}),l(c,{name:"replied",label:"已完成并已回复"}),l(c,{name:"pending",label:"待处理作业"})]),_:1},8,["modelValue"])])]),l(O,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[l(oe,{wrap:"",alignment:"start",size:30},{default:a(()=>[l(_,{modelValue:H.value,"onUpdate:modelValue":e[1]||(e[1]=s=>H.value=s),style:{width:"240px"},placeholder:"请输入作业标题或提交人","suffix-icon":J(rt),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),l(m,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=s=>k.value=s),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:Se,size:"large"},null,8,["modelValue"]),l(v,{type:"primary",size:"large",onClick:Ke},{default:a(()=>e[14]||(e[14]=[d("搜索")])),_:1}),l(v,{type:"success",size:"large",onClick:qe},{default:a(()=>e[15]||(e[15]=[d("布置作业")])),_:1})]),_:1})]),_:1}),n("div",gt,[Ce.value?(u(),x(O,{key:0,style:{"min-height":"400px"}},{header:a(()=>[n("div",yt,[n("div",null,[e[18]||(e[18]=n("span",null,"作业列表",-1)),te.value?(u(),x(F,{key:0,content:"您可以查看所有作业",placement:"right"},{default:a(()=>[l(B,{type:"success",size:"small",style:{"margin-left":"8px"}},{default:a(()=>e[16]||(e[16]=[d("全部")])),_:1})]),_:1})):(u(),x(F,{key:1,content:"您只能查看本组织的作业",placement:"right"},{default:a(()=>[l(B,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:a(()=>e[17]||(e[17]=[d("本组织")])),_:1})]),_:1}))]),n("div",bt,[l(v,{type:"danger",disabled:!D.value.length,onClick:He},{default:a(()=>e[19]||(e[19]=[d(" 批量删除 ")])),_:1},8,["disabled"]),n("div",ht,"共计"+f(h.total)+"条数据",1)])])]),default:a(()=>[we((u(),x(Ye,{data:I.value,onSelectionChange:Qe},{default:a(()=>[l(b,{type:"selection",width:"55"}),l(b,{prop:"title",label:"作业题目"},{default:a(({row:s})=>[l(F,{placement:"top","show-after":500,"max-width":300},{content:a(()=>[n("div",wt,f(s.title),1)]),default:a(()=>[n("div",xt,f(s.title),1)]),_:2},1024)]),_:1}),l(b,{prop:"creator_profile.full_name",label:"创建人"}),l(b,{prop:"assignee_profile.full_name",label:"指定人员"}),l(b,{label:"附件",width:"80"},{default:a(({row:s})=>[s.attachment_url?(u(),x(v,{key:0,type:"primary",link:"",onClick:E=>$e(s)},{default:a(()=>[l(Z,{color:"#409EFF",size:"18"},{default:a(()=>[l(J(xe))]),_:1})]),_:2},1032,["onClick"])):(u(),g("span",kt,"-"))]),_:1}),l(b,{label:"回复状态"},{default:a(({row:s})=>[l(B,{size:"large",style:{"font-size":"14px"},type:R(s).type},{default:a(()=>[d(f(R(s).text),1)]),_:2},1032,["type"])]),_:1}),l(b,{prop:"created_at",label:"创建时间"},{default:a(({row:s})=>[d(f(ne(s.created_at)),1)]),_:1}),l(b,{label:"操作",width:"180",fixed:"right"},{default:a(({row:s})=>[l(Xe,null,{default:a(()=>[l(v,{type:"primary",onClick:E=>se(s)},{default:a(()=>e[20]||(e[20]=[d("查看详情")])),_:2},1032,["onClick"]),l(v,{type:"danger",onClick:E=>Ge(s)},{default:a(()=>e[21]||(e[21]=[d("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),l(ie,null,{description:a(()=>e[22]||(e[22]=[d(" 暂无作业记录 ")])),_:1})]),_:1},8,["data"])),[[de,Q.value]])]),_:1})):(u(),x(ie,{key:1,description:"您没有权限查看作业列表"})),l(it,{pagination:h,"onUpdate:pagination":We},null,8,["pagination"]),l(j,{modelValue:T.value,"onUpdate:modelValue":e[7]||(e[7]=s=>T.value=s),title:"布置作业",width:"600px"},{footer:a(()=>[l(v,{onClick:e[6]||(e[6]=s=>T.value=!1)},{default:a(()=>e[27]||(e[27]=[d("取消")])),_:1}),l(v,{type:"primary",onClick:Le},{default:a(()=>e[28]||(e[28]=[d("确定")])),_:1})]),default:a(()=>[l(ue,{model:w.value,rules:Ue,ref_key:"createForm",ref:X,"label-width":"80px"},{default:a(()=>[l(P,{label:"标题",prop:"title"},{default:a(()=>[l(_,{modelValue:w.value.title,"onUpdate:modelValue":e[3]||(e[3]=s=>w.value.title=s)},null,8,["modelValue"])]),_:1}),l(P,{label:"指定人员",prop:"assigned_to"},{default:a(()=>[l(et,{modelValue:w.value.assigned_to,"onUpdate:modelValue":e[4]||(e[4]=s=>w.value.assigned_to=s),placeholder:"请选择"},{default:a(()=>[(u(!0),g(ke,null,Ve(le.value,s=>(u(),x(Ze,{key:s.user_id,label:s.full_name,value:s.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n("div",Vt,[te.value?(u(),x(re,{key:0,type:"info",size:"small"},{default:a(()=>e[23]||(e[23]=[d("可选择所有用户")])),_:1})):(u(),x(re,{key:1,type:"info",size:"small"},{default:a(()=>e[24]||(e[24]=[d("只显示本组织成员")])),_:1}))])]),_:1}),l(P,{label:"内容",prop:"content"},{default:a(()=>[l(_,{modelValue:w.value.content,"onUpdate:modelValue":e[5]||(e[5]=s=>w.value.content=s),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1}),l(P,{label:"附件"},{default:a(()=>[l(tt,{class:"upload-container",drag:"","auto-upload":!0,"http-request":Te,"on-remove":Me,"before-upload":Ie,limit:1,"file-list":ae.value},{tip:a(()=>e[25]||(e[25]=[n("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[l(Z,{class:"el-icon--upload"},{default:a(()=>[l(J(dt))]),_:1}),e[26]||(e[26]=n("div",{class:"el-upload__text"},[d(" 将文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(j,{modelValue:M.value,"onUpdate:modelValue":e[10]||(e[10]=s=>M.value=s),title:"回复作业",width:"600px"},{footer:a(()=>[l(v,{onClick:e[9]||(e[9]=s=>M.value=!1)},{default:a(()=>e[29]||(e[29]=[d("取消")])),_:1}),l(v,{type:"primary",onClick:je},{default:a(()=>e[30]||(e[30]=[d("确定")])),_:1})]),default:a(()=>[l(ue,{model:$.value,rules:Re,ref_key:"replyForm",ref:Y,"label-width":"80px"},{default:a(()=>[l(P,{label:"回复内容",prop:"content"},{default:a(()=>[l(_,{modelValue:$.value.content,"onUpdate:modelValue":e[8]||(e[8]=s=>$.value.content=s),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(j,{modelValue:q.value,"onUpdate:modelValue":e[11]||(e[11]=s=>q.value=s),title:"作业详情",width:"700px"},{default:a(()=>{var s,E,ce,pe,me,ve,fe,_e,ge,ye;return[we((u(),g("div",null,[o.value?(u(),g("div",Dt,[n("h3",null,f((s=o.value)==null?void 0:s.title),1),n("div",At,[n("div",zt,[e[31]||(e[31]=n("span",{class:"label"},"创建人：",-1)),n("span",null,f((ce=(E=o.value)==null?void 0:E.creator_profile)==null?void 0:ce.full_name),1)]),n("div",Ct,[e[32]||(e[32]=n("span",{class:"label"},"指定人员：",-1)),n("span",null,f((me=(pe=o.value)==null?void 0:pe.assignee_profile)==null?void 0:me.full_name),1)]),n("div",St,[e[33]||(e[33]=n("span",{class:"label"},"创建时间：",-1)),n("span",null,f(ne((ve=o.value)==null?void 0:ve.created_at)),1)]),n("div",Ut,[e[34]||(e[34]=n("span",{class:"label"},"状态：",-1)),l(B,{size:"large",style:{"font-size":"14px"},type:R(o.value).type},{default:a(()=>[d(f(R(o.value).text),1)]),_:1},8,["type"])])]),l(lt),n("div",Rt,[e[35]||(e[35]=n("strong",null,"作业内容：",-1)),n("p",null,f((fe=o.value)==null?void 0:fe.content),1)]),(_e=o.value)!=null&&_e.attachment_url?(u(),g("div",Bt,[e[37]||(e[37]=n("div",{class:"section-title"},"附件",-1)),n("div",Ft,[l(Z,{color:"#409EFF",size:"16"},{default:a(()=>[l(J(xe))]),_:1}),n("span",It,f(o.value.attachment_name),1),l(v,{type:"primary",size:"small",onClick:Pe},{default:a(()=>e[36]||(e[36]=[d("查看附件")])),_:1})])])):K("",!0),(ye=(ge=o.value)==null?void 0:ge.replies)!=null&&ye.length?(u(),g("div",Tt,[e[38]||(e[38]=n("h4",null,"回复列表",-1)),(u(!0),g(ke,null,Ve(o.value.replies,z=>{var be;return u(),g("div",{key:z.id,class:ct(["reply-item",{"admin-reply":z.user_id!==o.value.assigned_to,"assignee-reply":z.user_id===o.value.assigned_to}])},[n("p",null,[n("strong",null,f((be=z.profile)==null?void 0:be.full_name)+"：",1)]),n("p",null,f(z.content),1),n("p",Mt,f(z.created_at?new Date(z.created_at).toLocaleString():""),1)],2)}),128))])):K("",!0),o.value?(u(),g("div",$t,[l(v,{type:"primary",onClick:Oe},{default:a(()=>e[39]||(e[39]=[d("回复作业")])),_:1})])):K("",!0)])):K("",!0)])),[[de,G.value]])]}),_:1},8,["modelValue"]),l(j,{modelValue:L.value,"onUpdate:modelValue":e[12]||(e[12]=s=>L.value=s),title:"附件预览",width:"80%","destroy-on-close":""},{default:a(()=>[n("div",Pt,[Be.value?(u(),g("img",{key:0,src:S.value,class:"attachment-image"},null,8,Et)):Fe.value?(u(),g("iframe",{key:1,src:S.value,class:"attachment-frame"},null,8,Nt)):(u(),g("div",qt,[e[41]||(e[41]=n("p",null,"无法预览此类型的文件，请下载后查看",-1)),l(v,{type:"primary",onClick:Ee},{default:a(()=>e[40]||(e[40]=[d("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])])}}}),Jt=mt(Lt,[["__scopeId","data-v-33d81429"]]);export{Jt as default};
