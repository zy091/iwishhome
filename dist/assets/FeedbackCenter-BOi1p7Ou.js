import{d as Ne,J as H,u as Re,k as de,r as d,o as Me,l as V,a as t,e as o,K as Oe,w as s,b as r,P as Ee,M as b,c as g,q as m,g as $,a5 as je,F as ce,m as pe,f as i,y as Ge,O as Je,t as p,x as Ke,X as Qe,ab as Xe,ac as He,U as me,j as u,_ as We}from"./index-BsBxzW2u.js";import{h as Ye,f as x}from"./feedbackService-Z98iwdMQ.js";const Ze={class:"layout"},el={class:"layout-title"},ll={class:"status-tabs"},tl={class:"feedback-content"},al={class:"card-header"},sl={key:0,class:"header-actions"},ol={style:{"font-size":"14px",color:"#909399"}},nl={class:"dialog-content"},rl={class:"feedback-details"},ul={class:"feedback-header"},il={class:"feedback-title"},dl={class:"feedback-meta"},cl={class:"meta-item"},pl={class:"meta-item"},ml={class:"meta-item"},vl={class:"meta-item"},_l={class:"feedback-section"},fl={class:"feedback-content",style:{padding:"10px"}},gl={key:0,class:"feedback-section"},bl={class:"previous-reply"},yl={class:"admin-reply-content"},kl={key:0,class:"reply-time"},wl={key:0},hl={key:1,class:"feedback-section"},Vl={class:"section-title"},xl={class:"status-selector",style:{"margin-top":"15px"}},Sl={class:"status-selector",style:{"margin-top":"15px"}},Dl={class:"dialog-footer"},Cl={class:"dialog-footer"},Fl=Ne({__name:"FeedbackCenter",setup(zl){const ve=H([{name:"反馈中心",path:"/system/feedback-center"}]),W=Re(),M=de(()=>{var l;return((l=W.user)==null?void 0:l.user_id)||""}),c=de(()=>Ye(Number(W.roleId)));console.log(c,"hasAdminPerm");const O=d(!1),E=d([]),z=d(!1),U=d(!1),n=d(null),q=d(""),k=d([]),S=d(""),T=d("resolved"),P=d(!0),j=d(!1),G=d(!1),C=d("all"),F=d(""),D=d([]),J=d(),I=d(""),_=H({title:"",content:"",platform:""}),_e={title:[{required:!0,message:"请输入反馈标题",trigger:"blur"},{min:2,max:100,message:"标题长度应在2到100个字符之间",trigger:"blur"}],platform:[{required:!0,message:"请选择平台",trigger:"change"}],content:[{required:!0,message:"请输入反馈内容",trigger:"blur"},{min:8,max:2e3,message:"内容长度应在8到2000个字符之间",trigger:"blur"}]},Y=[{label:"系统反馈",value:"system"},{label:"Google",value:"google"},{label:"Facebook",value:"facebook"},{label:"Instagram",value:"instagram"},{label:"TikTok",value:"tiktok"},{label:"其他",value:"other"}],f=H({page:1,pageSize:10,total:0}),fe=[{text:"最近一周",value:()=>{const l=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,l]}},{text:"最近一个月",value:()=>{const l=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,l]}},{text:"最近三个月",value:()=>{const l=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,l]}}],ge=l=>{switch(l){case"system":return"primary";case"google":return"success";case"facebook":return"info";case"instagram":return"warning";case"tiktok":return"danger";default:return"info"}},Z=l=>{switch(l){case"system":return"系统反馈";case"google":return"Google";case"facebook":return"Facebook";case"instagram":return"Instagram";case"tiktok":return"TikTok";case"other":return"其他";default:return l||"未知"}},be=l=>{switch(l){case"pending":return"info";case"in_progress":return"warning";case"resolved":return"success";default:return"info"}},ye=l=>{switch(l){case"pending":return"待处理";case"in_progress":return"处理中";case"resolved":return"已解决";default:return l||"未知"}},ke=l=>{f.page=l.page,f.pageSize=l.pageSize,w()},w=async()=>{O.value=!0;const l=k.value!=null&&k.value[0]!=null?k.value[0].toDateString():"",e=k.value!=null&&k.value[1]!=null?k.value[1].toDateString():"";try{let v;c.value?v=await x.getAllFeedback({query:q.value,startDate:l,endDate:e,page:f.page,pageSize:f.pageSize,replyStatus:C.value,platform:F.value!==""?F.value:void 0,showStatus:I.value!==""?I.value:void 0}):v=await x.getAllFeedback({query:q.value,startDate:l,endDate:e,page:f.page,pageSize:f.pageSize,platform:F.value!==""?F.value:void 0}),E.value=v.data,f.total=v.total}catch(v){b.error("搜索反馈失败"),console.error("搜索反馈失败:",v)}finally{O.value=!1}},we=l=>{z.value=!0,n.value=l,S.value="",T.value=l.status||"resolved",P.value=l.is_show},he=()=>{U.value=!0,Object.assign(_,{title:"",content:"",platform:""})},Ve=l=>{D.value=l},xe=async()=>{J.value&&await J.value.validate(async l=>{if(l){G.value=!0;try{await x.createFeedback({title:_.title,content:_.content,platform:_.platform}),b.success("反馈已提交"),U.value=!1,w()}catch(e){b.error("创建反馈失败"),console.error("创建反馈失败:",e)}finally{G.value=!1}}})},Se=async()=>{if(!(!n.value||!c.value)){j.value=!0;try{const l={status:T.value,is_show:P.value};S.value.trim()&&(l.admin_reply=S.value),await x.submitReply(n.value.id,l),b.success("更新成功"),n.value&&(S.value.trim()&&(n.value.admin_reply=S.value,n.value.admin_id=M.value,n.value.replied_at=new Date().toISOString()),n.value.status=T.value,n.value.is_show=P.value),w(),z.value=!1}catch(l){b.error("提交失败"),console.error("提交失败:",l)}finally{j.value=!1}}},De=async l=>{try{await me.confirm(`确定要删除 "${l.title}" 这条反馈吗？`,"提示",{type:"warning"}),c.value?await x.deleteFeedback(l.id):l.replied_at?b.error("反馈已处理，不能删除"):await x.hideFeedback(l.id),b.success("删除成功"),C.value==="my_feedback"?ee():w()}catch(e){e!=="cancel"&&(b.error("删除失败"),console.error("删除失败:",e))}},Ce=async()=>{if(D.value.length!==0)try{await me.confirm(`确定要删除选中的 ${D.value.length} 条反馈吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const l=D.value.map(e=>x.deleteFeedback(e.id));await Promise.all(l),b.success(`成功删除 ${D.value.length} 条反馈`),D.value=[],w()}catch(l){l!=="cancel"&&(console.error("批量删除反馈失败:",l),b.error("批量删除失败"))}},ee=async()=>{let l=await x.getPersonalFeedback();console.log(l,"result"),E.value=l.data,f.total=l.total},Fe=l=>{C.value=l,f.page=1,l==="my_feedback"?ee():w()};return Me(()=>{w()}),(l,e)=>{const v=r("el-tab-pane"),ze=r("el-tabs"),L=r("el-input"),A=r("el-option"),K=r("el-select"),Ue=r("el-date-picker"),y=r("el-button"),Te=r("el-space"),le=r("el-card"),h=r("el-table-column"),Q=r("el-tag"),Pe=r("el-button-group"),Be=r("el-empty"),$e=r("el-table"),N=r("el-icon"),te=r("el-radio"),qe=r("el-radio-group"),Ie=r("el-switch"),ae=r("el-dialog"),X=r("el-form-item"),Le=r("el-form"),Ae=Je("loading");return u(),V("div",Ze,[t(Oe,{breadbcrum:ve},null,8,["breadbcrum"]),o("div",el,[e[15]||(e[15]=o("h1",{class:"title"},"反馈中心",-1)),o("div",ll,[t(ze,{class:"demo-tabs",modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=a=>C.value=a),onTabChange:Fe},{default:s(()=>[t(v,{name:"all",label:"全部反馈"}),c.value?(u(),g(v,{key:0,name:"replied",label:"已解决"})):m("",!0),c.value?(u(),g(v,{key:1,name:"in_progress",label:"处理中"})):m("",!0),c.value?(u(),g(v,{key:2,name:"pending",label:"待处理"})):m("",!0),t(v,{name:"my_feedback",label:"我的反馈"})]),_:1},8,["modelValue"])])]),t(le,{shadow:"always",style:{"margin-bottom":"20px"}},{default:s(()=>[t(Te,{alignment:"start",size:30},{default:s(()=>[t(L,{modelValue:q.value,"onUpdate:modelValue":e[1]||(e[1]=a=>q.value=a),style:{width:"240px"},placeholder:"请输入提交人或标题","suffix-icon":$(je),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),t(K,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=a=>F.value=a),placeholder:"选择平台",style:{width:"160px"},size:"large",clearable:""},{default:s(()=>[(u(),V(ce,null,pe(Y,a=>t(A,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),c.value?(u(),g(K,{key:0,modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=a=>I.value=a),placeholder:"选择展示状态",style:{width:"160px"},size:"large",clearable:""},{default:s(()=>[t(A,{label:"显示",value:"true"}),t(A,{label:"隐藏",value:"false"})]),_:1},8,["modelValue"])):m("",!0),t(Ue,{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=a=>k.value=a),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:fe,size:"large"},null,8,["modelValue"]),t(y,{type:"primary",size:"large",onClick:w},{default:s(()=>e[16]||(e[16]=[i("搜索")])),_:1}),t(y,{type:"success",size:"large",onClick:he},{default:s(()=>e[17]||(e[17]=[i("添加反馈")])),_:1})]),_:1})]),_:1}),o("div",tl,[t(le,{style:{"min-height":"400px"}},{header:s(()=>[o("div",al,[e[19]||(e[19]=i(" 反馈列表 ")),c.value?(u(),V("div",sl,[t(y,{type:"danger",disabled:!D.value.length,onClick:Ce},{default:s(()=>e[18]||(e[18]=[i(" 批量删除 ")])),_:1},8,["disabled"]),o("div",ol,"共计"+p(f.total)+"条数据",1)])):m("",!0)])]),default:s(()=>[Ge((u(),g($e,{data:E.value,onSelectionChange:Ve},{default:s(()=>[c.value?(u(),g(h,{key:0,type:"selection",width:"55"})):m("",!0),c.value?(u(),g(h,{key:1,prop:"full_name",label:"提交人",width:"120"})):m("",!0),t(h,{prop:"title",label:"标题","min-width":"200"}),t(h,{prop:"platform",label:"平台",width:"130"},{default:s(({row:a})=>[t(Q,{type:ge(a.platform),size:"large"},{default:s(()=>[i(p(Z(a.platform)),1)]),_:2},1032,["type"])]),_:1}),t(h,{prop:"status",label:"状态",width:"100"},{default:s(({row:a})=>[t(Q,{style:{"font-size":"14px"},type:be(a.status),size:"large"},{default:s(()=>[i(p(ye(a.status)),1)]),_:2},1032,["type"])]),_:1}),c.value?(u(),g(h,{key:2,prop:"is_show",label:"展示状态",width:"100"},{default:s(({row:a})=>[t(Q,{type:a.is_show?"success":"danger",size:"large"},{default:s(()=>[i(p(a.is_show?"显示":"隐藏"),1)]),_:2},1032,["type"])]),_:1})):m("",!0),t(h,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:a})=>[i(p(new Date(a.created_at).toLocaleString()),1)]),_:1}),t(h,{label:"操作",width:"150",fixed:"right"},{default:s(({row:a})=>[t(Pe,null,{default:s(()=>[t(y,{type:"primary",onClick:R=>we(a)},{default:s(()=>e[20]||(e[20]=[i("查看")])),_:2},1032,["onClick"]),c.value||a.user_id===M.value&&C.value==="my_feedback"?(u(),g(y,{key:0,type:"danger",onClick:R=>De(a),disabled:!c.value&&a.user_id==M.value&&a.replied_at},{default:s(()=>e[21]||(e[21]=[i("删除")])),_:2},1032,["onClick","disabled"])):m("",!0)]),_:2},1024)]),_:1}),t(Be,null,{description:s(()=>e[22]||(e[22]=[i(" 暂无反馈数据 ")])),_:1})]),_:1},8,["data"])),[[Ae,O.value]])]),_:1}),t(Ee,{pagination:f,"onUpdate:pagination":ke},null,8,["pagination"]),t(ae,{title:"反馈详情",modelValue:z.value,"onUpdate:modelValue":e[9]||(e[9]=a=>z.value=a),width:"60%","close-on-click-modal":!1,top:"5vh",class:"feedback-detail-dialog"},{footer:s(()=>[o("span",Dl,[t(y,{onClick:e[8]||(e[8]=a=>z.value=!1)},{default:s(()=>e[29]||(e[29]=[i("关闭")])),_:1}),c.value?(u(),g(y,{key:0,type:"primary",onClick:Se,loading:j.value},{default:s(()=>{var a;return[i(p((a=n.value)!=null&&a.admin_reply?"更新":"提交回复"),1)]}),_:1},8,["loading"])):m("",!0)])]),default:s(()=>{var a,R,se,oe,ne,re,ue,ie;return[o("div",nl,[o("div",rl,[o("div",ul,[o("h2",il,p(((a=n.value)==null?void 0:a.title)||"无标题"),1),o("div",dl,[o("span",cl,[t(N,null,{default:s(()=>[t($(Ke))]),_:1}),o("span",null,p(((R=n.value)==null?void 0:R.full_name)||"未知用户"),1)]),o("span",pl,[t(N,null,{default:s(()=>[t($(Qe))]),_:1}),o("span",null,p(((se=n.value)==null?void 0:se.email)||"无邮箱"),1)]),o("span",ml,[t(N,null,{default:s(()=>[t($(Xe))]),_:1}),o("span",null,p(n.value?new Date((oe=n.value)==null?void 0:oe.created_at).toLocaleString():"未知时间"),1)]),o("span",vl,[t(N,null,{default:s(()=>[t($(He))]),_:1}),o("span",null,p(Z(((ne=n.value)==null?void 0:ne.platform)||"")),1)])])]),o("div",_l,[e[23]||(e[23]=o("div",{class:"section-title"},"内容",-1)),o("div",fl,p(((re=n.value)==null?void 0:re.content)||"无内容"),1)]),(ue=n.value)!=null&&ue.admin_reply?(u(),V("div",gl,[e[24]||(e[24]=o("div",{class:"section-title"},"历史回复",-1)),o("div",bl,[o("div",yl,p(n.value.admin_reply),1),n.value.replied_at?(u(),V("p",kl,[i(" 回复于: "+p(new Date(n.value.replied_at).toLocaleString())+" ",1),n.value.admin_name?(u(),V("span",wl," ("+p(n.value.admin_name)+")",1)):m("",!0)])):m("",!0)])])):m("",!0),c.value?(u(),V("div",hl,[o("div",Vl,p((ie=n.value)!=null&&ie.admin_reply?"更新":"添加回复"),1),t(L,{type:"textarea",modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=B=>S.value=B),rows:4,placeholder:"请输入您的回复内容...",class:"reply-input"},null,8,["modelValue"]),o("div",xl,[e[27]||(e[27]=o("span",{class:"status-label"},"状态：",-1)),t(qe,{modelValue:T.value,"onUpdate:modelValue":e[6]||(e[6]=B=>T.value=B)},{default:s(()=>[t(te,{label:"in_progress"},{default:s(()=>e[25]||(e[25]=[i("处理中")])),_:1}),t(te,{label:"resolved"},{default:s(()=>e[26]||(e[26]=[i("已解决")])),_:1})]),_:1},8,["modelValue"])]),o("div",Sl,[e[28]||(e[28]=o("span",{class:"status-label"},"是否显示：",-1)),n.value?(u(),g(Ie,{key:0,modelValue:P.value,"onUpdate:modelValue":e[7]||(e[7]=B=>P.value=B),"active-text":"显示","inactive-text":"隐藏"},null,8,["modelValue"])):m("",!0)])])):m("",!0)])])]}),_:1},8,["modelValue"]),t(ae,{title:"创建反馈",modelValue:U.value,"onUpdate:modelValue":e[14]||(e[14]=a=>U.value=a),width:"50%","close-on-click-modal":!1},{footer:s(()=>[o("span",Cl,[t(y,{onClick:e[13]||(e[13]=a=>U.value=!1)},{default:s(()=>e[30]||(e[30]=[i("取消")])),_:1}),t(y,{type:"primary",onClick:xe,loading:G.value},{default:s(()=>e[31]||(e[31]=[i("创建")])),_:1},8,["loading"])])]),default:s(()=>[t(Le,{model:_,rules:_e,ref_key:"feedbackForm",ref:J,"label-width":"80px"},{default:s(()=>[t(X,{label:"标题",prop:"title"},{default:s(()=>[t(L,{modelValue:_.title,"onUpdate:modelValue":e[10]||(e[10]=a=>_.title=a),placeholder:"请输入反馈标题"},null,8,["modelValue"])]),_:1}),t(X,{label:"平台",prop:"platform"},{default:s(()=>[t(K,{modelValue:_.platform,"onUpdate:modelValue":e[11]||(e[11]=a=>_.platform=a),placeholder:"选择平台",style:{width:"100%"}},{default:s(()=>[(u(),V(ce,null,pe(Y,a=>t(A,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(X,{label:"内容",prop:"content"},{default:s(()=>[t(L,{type:"textarea",modelValue:_.content,"onUpdate:modelValue":e[12]||(e[12]=a=>_.content=a),rows:6,placeholder:"请详细描述您的反馈内容"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])])}}}),Pl=We(Fl,[["__scopeId","data-v-01e95467"]]);export{Pl as default};
