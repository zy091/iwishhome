import{d as Fe,J as oe,u as Me,k as $e,r,o as qe,l as y,a as l,e as n,K as Ie,w as s,b as i,c as $,P as Ne,M as b,g as Pe,a5 as Oe,f as u,y as ie,O as Ee,t as d,F as re,m as ue,q as L,A as Le,j as p,U as je,_ as Je}from"./index-BsBxzW2u.js";import{a as S}from"./assignmentService-SxpLkSHI.js";const Ke={class:"layout"},Qe={class:"layout-title"},Ge={class:"status-tabs"},He={class:"assignments-content"},We={class:"card-header"},Xe={class:"header-actions"},Ye={style:{"font-size":"14px",color:"#909399"}},Ze={class:"tooltip-content"},et={class:"text-truncate"},tt={key:0,class:"assignment-details"},lt={class:"details-header"},at={class:"detail-item"},st={class:"detail-item"},nt={class:"detail-item"},ot={class:"detail-item"},it={class:"content"},rt={key:0,class:"replies"},ut={class:"reply-time"},dt={key:1,class:"action-buttons"},pt=Fe({__name:"AdminAssignments",setup(ct){const de=oe([{name:"数据管理",path:"/system/data-management"},{name:"作业管理",path:"/system/assignments"}]),pe=Me(),ce=$e(()=>{const t=Number(pe.roleId);return t===0||t===1||t===11}),q=r(!1),I=r(!1),B=r("all");r("all");const N=r(""),g=r([]),R=r([]),j=r([]),U=r(!1),D=r(!1),T=r(!1),o=r(null),w=r([]),me=[{text:"最近一周",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近一个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近三个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],v=oe({page:1,pageSize:10,total:0}),ve={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}],assigned_to:[{required:!0,message:"请选择指定人员",trigger:"change"}]},_e={content:[{required:!0,message:"请输入回复内容",trigger:"blur"}]},_=r({title:"",content:"",assigned_to:void 0}),C=r({assignment_id:"",user_id:"",content:"",full_name:""}),P=r(),O=r(),x=async()=>{q.value=!0;try{const t=g.value&&g.value[0]?g.value[0].toISOString():void 0,e=g.value&&g.value[1]?g.value[1].toISOString():void 0,{data:c,total:A}=await S.getAssignments(v.page,v.pageSize,{query:N.value,startDate:t,endDate:e,status:"all"});B.value==="replied"?R.value=c.filter(f=>z(f).text==="已完成并已回复"):B.value==="pending"?R.value=c.filter(f=>{const V=z(f);return V.text==="待完成"||V.text==="已完成待回复"||V.text==="管理员已回复待完成"||V.text==="待回复"}):R.value=c,v.total=R.value.length}catch(t){console.error("获取作业列表失败:",t),b.error("获取作业列表失败")}finally{q.value=!1}},ge=async()=>{try{const t=await S.getOrganizationMembers();j.value=t}catch(t){console.error("获取组织成员失败:",t),b.error("获取组织成员失败")}},fe=()=>{U.value=!0,_.value={title:"",content:"",assigned_to:void 0}},ye=async()=>{P.value&&await P.value.validate(async t=>{if(t)try{await S.createAssignment(_.value),b.success("布置作业成功"),U.value=!1,x()}catch(e){console.error("布置作业失败:",e),b.error("布置作业失败")}})},be=t=>{o.value=t,C.value={assignment_id:t.id||"",user_id:"",content:"",full_name:""},D.value=!0},we=()=>{o.value&&(D.value=!0,C.value={assignment_id:o.value.id||"",user_id:"",content:"",full_name:""})},xe=async()=>{O.value&&await O.value.validate(async t=>{if(t)try{await S.addReply(C.value),b.success("回复成功"),D.value=!1,x(),T.value&&o.value&&J(o.value)}catch(e){console.error("回复失败:",e),b.error("回复失败")}})},J=async t=>{I.value=!0,o.value=t,T.value=!0;try{const e=await S.getAssignmentById(t.id||"");e&&(o.value=e)}catch(e){console.error("获取作业详情失败:",e)}finally{I.value=!1}},K=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",Ve=t=>{v.page=t.page,v.pageSize=t.pageSize,x()},he=t=>{v.page=1,x()},ke=()=>{v.page=1,x()},De=t=>{w.value=t},Ce=async()=>{if(w.value.length!==0)try{await je.confirm(`确定要删除选中的 ${w.value.length} 个作业吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=w.value.map(e=>e.id?S.deleteAssignment(e.id):Promise.resolve());await Promise.all(t),b.success(`成功删除 ${w.value.length} 个作业`),w.value=[],x()}catch(t){t!=="cancel"&&(console.error("批量删除作业失败:",t),b.error("批量删除失败"))}},z=t=>{if(!t||!t.replies||t.replies.length===0)return{type:"info",text:"待完成",hasAssigneeReply:!1};const e=t.replies.some(A=>A.user_id===t.assigned_to),c=t.replies.some(A=>A.user_id!==t.assigned_to);return e&&c?{type:"success",text:"已完成并已回复",hasAssigneeReply:!0}:e?{type:"warning",text:"已完成待回复",hasAssigneeReply:!0}:c?{type:"warning",text:"管理员已回复待完成",hasAssigneeReply:!1}:{type:"waring",text:"待回复",hasAssigneeReply:!1}};return qe(async()=>{await Promise.all([x(),ge()])}),(t,e)=>{const c=i("el-tab-pane"),A=i("el-tabs"),f=i("el-input"),V=i("el-date-picker"),m=i("el-button"),ze=i("el-space"),Q=i("el-card"),h=i("el-table-column"),Ae=i("el-tooltip"),G=i("el-tag"),Se=i("el-button-group"),H=i("el-empty"),Re=i("el-table"),F=i("el-form-item"),Ue=i("el-option"),Be=i("el-select"),W=i("el-form"),E=i("el-dialog"),Te=i("el-divider"),X=Ee("loading");return p(),y("div",Ke,[l(Ie,{breadbcrum:de},null,8,["breadbcrum"]),n("div",Qe,[e[12]||(e[12]=n("h1",{class:"title"},"作业管理",-1)),n("div",Ge,[l(A,{class:"demo-tabs",modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=a=>B.value=a),onTabChange:he},{default:s(()=>[l(c,{name:"all",label:"全部作业"}),l(c,{name:"replied",label:"已完成并已回复"}),l(c,{name:"pending",label:"待处理作业"})]),_:1},8,["modelValue"])])]),l(Q,{shadow:"always",style:{"margin-bottom":"20px"}},{default:s(()=>[l(ze,{wrap:"",alignment:"start",size:30},{default:s(()=>[l(f,{modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=a=>N.value=a),style:{width:"240px"},placeholder:"请输入作业标题或提交人","suffix-icon":Pe(Oe),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),l(V,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=a=>g.value=a),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:me,size:"large"},null,8,["modelValue"]),l(m,{type:"primary",size:"large",onClick:ke},{default:s(()=>e[13]||(e[13]=[u("搜索")])),_:1}),l(m,{type:"success",size:"large",onClick:fe},{default:s(()=>e[14]||(e[14]=[u("布置作业")])),_:1})]),_:1})]),_:1}),n("div",He,[ce.value?(p(),$(Q,{key:0,style:{"min-height":"400px"}},{header:s(()=>[n("div",We,[e[16]||(e[16]=u(" 作业列表 ")),n("div",Xe,[l(m,{type:"danger",disabled:!w.value.length,onClick:Ce},{default:s(()=>e[15]||(e[15]=[u(" 批量删除 ")])),_:1},8,["disabled"]),n("div",Ye,"共计"+d(v.total)+"条数据",1)])])]),default:s(()=>[ie((p(),$(Re,{data:R.value,onSelectionChange:De},{default:s(()=>[l(h,{type:"selection",width:"55"}),l(h,{prop:"title",label:"作业题目"},{default:s(({row:a})=>[l(Ae,{placement:"top","show-after":500,"max-width":300},{content:s(()=>[n("div",Ze,d(a.title),1)]),default:s(()=>[n("div",et,d(a.title),1)]),_:2},1024)]),_:1}),l(h,{prop:"creator_profile.full_name",label:"创建人"}),l(h,{prop:"assignee_profile.full_name",label:"指定人员"}),l(h,{label:"回复状态"},{default:s(({row:a})=>[l(G,{size:"large",style:{"font-size":"14px"},type:z(a).type},{default:s(()=>[u(d(z(a).text),1)]),_:2},1032,["type"])]),_:1}),l(h,{prop:"created_at",label:"创建时间"},{default:s(({row:a})=>[u(d(K(a.created_at)),1)]),_:1}),l(h,{label:"操作",width:"200",fixed:"right"},{default:s(({row:a})=>[l(Se,null,{default:s(()=>[l(m,{type:"primary",onClick:M=>be(a)},{default:s(()=>e[17]||(e[17]=[u("回复")])),_:2},1032,["onClick"]),l(m,{type:"info",onClick:M=>J(a)},{default:s(()=>e[18]||(e[18]=[u("查看详情")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),l(H,null,{description:s(()=>e[19]||(e[19]=[u(" 暂无作业记录 ")])),_:1})]),_:1},8,["data"])),[[X,q.value]])]),_:1})):(p(),$(H,{key:1,description:"您没有权限查看作业列表"})),l(Ne,{pagination:v,"onUpdate:pagination":Ve},null,8,["pagination"]),l(E,{modelValue:U.value,"onUpdate:modelValue":e[7]||(e[7]=a=>U.value=a),title:"布置作业",width:"600px"},{footer:s(()=>[l(m,{onClick:e[6]||(e[6]=a=>U.value=!1)},{default:s(()=>e[20]||(e[20]=[u("取消")])),_:1}),l(m,{type:"primary",onClick:ye},{default:s(()=>e[21]||(e[21]=[u("确定")])),_:1})]),default:s(()=>[l(W,{model:_.value,rules:ve,ref_key:"createForm",ref:P,"label-width":"80px"},{default:s(()=>[l(F,{label:"标题",prop:"title"},{default:s(()=>[l(f,{modelValue:_.value.title,"onUpdate:modelValue":e[3]||(e[3]=a=>_.value.title=a)},null,8,["modelValue"])]),_:1}),l(F,{label:"指定人员",prop:"assigned_to"},{default:s(()=>[l(Be,{modelValue:_.value.assigned_to,"onUpdate:modelValue":e[4]||(e[4]=a=>_.value.assigned_to=a),placeholder:"请选择"},{default:s(()=>[(p(!0),y(re,null,ue(j.value,a=>(p(),$(Ue,{key:a.user_id,label:a.full_name,value:a.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(F,{label:"内容",prop:"content"},{default:s(()=>[l(f,{modelValue:_.value.content,"onUpdate:modelValue":e[5]||(e[5]=a=>_.value.content=a),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(E,{modelValue:D.value,"onUpdate:modelValue":e[10]||(e[10]=a=>D.value=a),title:"回复作业",width:"600px"},{footer:s(()=>[l(m,{onClick:e[9]||(e[9]=a=>D.value=!1)},{default:s(()=>e[22]||(e[22]=[u("取消")])),_:1}),l(m,{type:"primary",onClick:xe},{default:s(()=>e[23]||(e[23]=[u("确定")])),_:1})]),default:s(()=>[l(W,{model:C.value,rules:_e,ref_key:"replyForm",ref:O,"label-width":"80px"},{default:s(()=>[l(F,{label:"回复内容",prop:"content"},{default:s(()=>[l(f,{modelValue:C.value.content,"onUpdate:modelValue":e[8]||(e[8]=a=>C.value.content=a),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(E,{modelValue:T.value,"onUpdate:modelValue":e[11]||(e[11]=a=>T.value=a),title:"作业详情",width:"700px"},{default:s(()=>{var a,M,Y,Z,ee,te,le,ae,se;return[ie((p(),y("div",null,[o.value?(p(),y("div",tt,[n("h3",null,d((a=o.value)==null?void 0:a.title),1),n("div",lt,[n("div",at,[e[24]||(e[24]=n("span",{class:"label"},"创建人：",-1)),n("span",null,d((Y=(M=o.value)==null?void 0:M.creator_profile)==null?void 0:Y.full_name),1)]),n("div",st,[e[25]||(e[25]=n("span",{class:"label"},"指定人员：",-1)),n("span",null,d((ee=(Z=o.value)==null?void 0:Z.assignee_profile)==null?void 0:ee.full_name),1)]),n("div",nt,[e[26]||(e[26]=n("span",{class:"label"},"创建时间：",-1)),n("span",null,d(K((te=o.value)==null?void 0:te.created_at)),1)]),n("div",ot,[e[27]||(e[27]=n("span",{class:"label"},"状态：",-1)),l(G,{size:"large",style:{"font-size":"14px"},type:z(o.value).type},{default:s(()=>[u(d(z(o.value).text),1)]),_:1},8,["type"])])]),l(Te),n("div",it,[e[28]||(e[28]=n("strong",null,"作业内容：",-1)),n("p",null,d((le=o.value)==null?void 0:le.content),1)]),(se=(ae=o.value)==null?void 0:ae.replies)!=null&&se.length?(p(),y("div",rt,[e[29]||(e[29]=n("h4",null,"回复列表",-1)),(p(!0),y(re,null,ue(o.value.replies,k=>{var ne;return p(),y("div",{key:k.id,class:Le(["reply-item",{"admin-reply":k.user_id!==o.value.assigned_to,"assignee-reply":k.user_id===o.value.assigned_to}])},[n("p",null,[n("strong",null,d((ne=k.profile)==null?void 0:ne.full_name)+"：",1)]),n("p",null,d(k.content),1),n("p",ut,d(k.created_at?new Date(k.created_at).toLocaleString():""),1)],2)}),128))])):L("",!0),o.value?(p(),y("div",dt,[l(m,{type:"primary",onClick:we},{default:s(()=>e[30]||(e[30]=[u("回复作业")])),_:1})])):L("",!0)])):L("",!0)])),[[X,I.value]])]}),_:1},8,["modelValue"])])])}}}),_t=Je(pt,[["__scopeId","data-v-b839494b"]]);export{_t as default};
