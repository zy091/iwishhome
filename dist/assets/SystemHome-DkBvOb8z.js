import{d as Te,r as h,u as be,k as A,o as Se,p as Pe,l as C,e as a,a as s,c as V,q as W,t as u,w as n,b as v,s as D,v as De,F as H,m as M,g as c,x as K,y as T,z as b,A as B,B as Z,C as O,D as $,E as J,f as p,T as Ne,G as Q,j as y,_ as xe}from"./index-w0Vcq8R-.js";import{t as Fe}from"./testResultService-29AeuPH3.js";import{a as Ae}from"./assignmentService-CNRluYtR.js";import{f as Ie}from"./feedbackService-CL8d-s9f.js";const Ue="/assets/banner-C5vi_D6D.png",ze="/assets/iwish-us-BEKIG9la.jpg",Ve={class:"layout"},Be={class:"dashboard-content"},Le={class:"welcome-section"},qe={class:"date"},Ee={class:"stat-icon"},He={class:"stat-info"},Me={class:"stat-value"},Oe={class:"stat-icon"},$e={class:"stat-info"},Ge={class:"stat-value"},Ye={class:"stat-icon"},je={class:"stat-info"},Re={class:"stat-value"},We={class:"stat-icon"},Ke={class:"stat-info"},Ze={class:"stat-value"},Je={class:"stat-icon"},Qe={class:"stat-info"},Xe={class:"stat-value"},et={class:"stat-icon"},tt={class:"stat-info"},st={class:"stat-value"},nt={class:"stat-icon"},at={class:"stat-info"},lt={class:"stat-value"},ot={class:"stat-icon"},rt={class:"stat-info"},ut={class:"stat-value"},it={class:"card-header"},dt={class:"task-title"},ct={key:0,style:{color:"#909399","font-size":"12px","margin-top":"10px"}},_t={key:1,style:{color:"#F56C6C","font-size":"12px","margin-top":"10px"}},ft={class:"quick-links"},vt={class:"quick-link-group"},mt={class:"quick-link-group"},pt={class:"notice-list fixed-notice-list"},yt=["onClick"],gt={class:"notice-title"},ht={class:"notice-time"},wt={class:"notice-dialog-header"},kt={class:"notice-dialog-title"},Ct={class:"notice-time"},Tt={class:"notice-dialog-content"},bt=["innerHTML"],St={class:"notice-dialog-footer"},X=5,Pt=Te({__name:"SystemHome",setup(Dt){const ee=h([Ue,ze]);h(null);const k=be(),te=A(()=>{var e;return((e=k.user)==null?void 0:e.email)||"用户"}),S=h([]),se=A(()=>new Date().toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"})),ne=A(()=>{var e,t,r;return((e=k.user)==null?void 0:e.role_id)===0||((t=k.user)==null?void 0:t.role_id)===1||((r=k.user)==null?void 0:r.role_id)===11}),l=h({activeUsers:0,userTrend:0,studyCount:0,studyPending:0,testCount:0,testPending:0,assignmentsCount:0,assignmentsPending:0,yourStudyCount:0,yourStudyPending:0,yourTestCount:0,yourTestPending:0,yourAssignmentsCount:0,yourAssignmentsPending:0,feedbackCount:0,feedbackTrend:0,myFeedbackCount:0,myFeedbackTrend:0}),ae=async()=>{try{const{data:e,error:t}=await D.from("user_profiles").select("*");if(t)throw t;const r=new Date,i=e==null?void 0:e.filter(w=>new Date(w.created_at).toDateString()===r.toDateString());l.value.activeUsers=(e==null?void 0:e.length)||0,l.value.userTrend=(i==null?void 0:i.length)||0}catch(e){console.error("获取用户失败:",e)}},le=async()=>{try{const{data:e,error:t}=await D.from("study_notes").select("*");if(t)throw t;l.value.studyCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.admin_reply===null);l.value.studyPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取学习记录失败:",e)}},oe=async()=>{try{const{data:e,error:t}=await D.from("test_results").select("*");if(t)throw t;l.value.testCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.feedback_text===null&&i.type==="case");l.value.testPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取测试结果失败:",e)}},re=async()=>{try{const{data:e,error:t}=await D.from("assignments").select("*");if(t)throw t;l.value.assignmentsCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.admin_reply===null);l.value.assignmentsPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取日常作业失败:",e)}},ue=async()=>{const e=await De.getNotes();l.value.yourStudyCount=(e==null?void 0:e.length)||0;const t=e==null?void 0:e.filter(r=>r.admin_reply===null);l.value.yourStudyPending=(t==null?void 0:t.length)||0,e||console.error("获取你的心得失败")},ie=async()=>{const{data:e,total:t}=await Fe.getUserTestResults({page:1,pageSize:1e3});l.value.yourTestCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(i=>i.feedback_text===null&&i.type==="case");l.value.yourTestPending=(r==null?void 0:r.length)||0,e||console.error("获取你的测试失败")},de=async()=>{try{const{data:e,total:t}=await Ae.getPersonalAssignments(1,1e3);l.value.yourAssignmentsCount=t||0}catch(e){console.error("获取你的作业失败:",e)}},ce=async()=>{var e;try{const{data:t}=await Ie.getPersonalFeedback();l.value.myFeedbackCount=(t==null?void 0:t.length)||0,l.value.myFeedbackTrend=((e=t==null?void 0:t.filter(r=>r.replied_at==null))==null?void 0:e.length)||0}catch(t){console.error("获取反馈失败:",t)}},L=h([]),_e=async()=>{var r;const{data:e,error:t}=await D.from("tasks").select("*").eq("assigned_to",(r=k.user)==null?void 0:r.user_id);if(t)throw t;L.value=e.filter(i=>i.status!=="completed").map(i=>{const w=new Date(i.due_date),d=new Date,_=w<d,f=Math.abs(w.getTime()-d.getTime()),m=Math.ceil(f/(1e3*60*60*24));return{...i,diffDays:m,isOverdue:_}}).sort((i,w)=>new Date(i.due_date).getTime()-new Date(w.due_date).getTime()),console.log(L.value)};function G(e){switch(e){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function fe(e){switch(e){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function ve(e){switch(e){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function me(e){switch(e){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}const pe=async()=>{try{const{data:e,error:t}=await D.from("announcements").select("*");if(t)throw t;S.value=e}catch(e){console.error("获取系统公告失败:",e)}},Y=e=>{switch(e){case"important":return"danger";case"normal":return"success";case"update":return"warning";default:return"info"}},j=e=>{switch(e){case"important":return"重要";case"normal":return"新";case"update":return"更新";default:return"其他"}},I=h(!1),ye=h(""),R=h(null),N=A(()=>S.value.find(e=>e.id===R.value)||null),ge=e=>{R.value=e,I.value=!0},U=h(0);let q=null;const he=A(()=>{const e=[],t=S.value.length;for(let r=0;r<X;r++)if(t===0)e.push({id:null,title:"",type:"",created_at:""});else{const i=(U.value+r)%t;e.push(S.value[i]||{id:null,title:"",type:"",created_at:""})}return e});return Se(()=>{Promise.all([ae(),le(),oe(),re(),ue(),ie(),de(),pe(),_e(),ce()]).catch(e=>{console.error("加载数据失败:",e)}),q=setInterval(()=>{S.value.length>X?U.value=(U.value+1)%S.value.length:U.value=0},3e3)}),Pe(()=>{q&&clearInterval(q)}),(e,t)=>{const r=v("el-image"),i=v("el-carousel-item"),w=v("el-carousel"),d=v("el-icon"),_=v("el-link"),f=v("el-card"),m=v("el-col"),E=v("el-row"),z=v("el-tag"),we=v("el-timeline-item"),ke=v("el-timeline"),x=v("el-button"),Ce=v("el-dialog");return y(),C("div",Ve,[a("div",Be,[a("div",Le,[a("h2",null,"欢迎回来，"+u(te.value),1),a("p",qe,u(se.value),1)]),s(w,{"indicator-position":"outside",height:"500px"},{default:n(()=>[(y(!0),C(H,null,M(ee.value,o=>(y(),V(i,{key:o},{default:n(()=>[s(r,{src:o},{placeholder:n(()=>t[2]||(t[2]=[a("div",{class:"image-slot"},[p("Loading"),a("span",{class:"dot"},"...")],-1)])),_:2},1032,["src"])]),_:2},1024))),128))]),_:1}),ne.value?(y(),V(E,{key:0,gutter:20,class:"stat-cards"},{default:n(()=>[s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/users"},{default:n(()=>[a("div",Ee,[s(d,null,{default:n(()=>[s(c(K))]),_:1})])]),_:1}),a("div",He,[t[3]||(t[3]=a("div",{class:"stat-title"},"系统用户",-1)),a("div",Me,u(l.value.activeUsers),1),T(a("div",{class:B(["stat-trend",{up:l.value.userTrend>0}])}," 新增： "+u(l.value.userTrend>0?"+":"")+u(l.value.userTrend),3),[[b,l.value.userTrend>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/admin-study-notes"},{default:n(()=>[a("div",Oe,[s(d,null,{default:n(()=>[s(c(Z))]),_:1})])]),_:1}),a("div",$e,[t[4]||(t[4]=a("div",{class:"stat-title"},"学习心得",-1)),a("div",Ge,u(l.value.studyCount),1),T(a("div",{class:"stat-trend"}," 待回复： "+u(l.value.studyPending),513),[[b,l.value.studyPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/admin-test-result"},{default:n(()=>[a("div",Ye,[s(d,null,{default:n(()=>[s(c(O))]),_:1})])]),_:1}),a("div",je,[t[5]||(t[5]=a("div",{class:"stat-title"},"测试结果",-1)),a("div",Re,u(l.value.testCount),1),T(a("div",{class:"stat-trend"}," 待批改： "+u(l.value.testPending),513),[[b,l.value.testPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/admin-assignments"},{default:n(()=>[a("div",We,[s(d,null,{default:n(()=>[s(c($))]),_:1})])]),_:1}),a("div",Ke,[t[6]||(t[6]=a("div",{class:"stat-title"},"日常作业",-1)),a("div",Ze,u(l.value.assignmentsCount),1),T(a("div",{class:"stat-trend"}," 待批改： "+u(l.value.assignmentsPending),513),[[b,l.value.assignmentsPending>0]])])]),_:1})]),_:1})]),_:1})):W("",!0),s(E,{gutter:20,class:"stat-cards"},{default:n(()=>[s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/personal-data/study-notes"},{default:n(()=>[a("div",Je,[s(d,null,{default:n(()=>[s(c(Z))]),_:1})])]),_:1}),a("div",Qe,[t[7]||(t[7]=a("div",{class:"stat-title"},"我的心得",-1)),a("div",Xe,u(l.value.yourStudyCount),1),T(a("div",{class:B(["stat-trend",{up:l.value.yourStudyPending>0}])}," 待回复： "+u(l.value.yourStudyPending>0?"+":"")+u(l.value.yourStudyPending),3),[[b,l.value.yourStudyPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/personal-data/test-result"},{default:n(()=>[a("div",et,[s(d,null,{default:n(()=>[s(c(O))]),_:1})])]),_:1}),a("div",tt,[t[8]||(t[8]=a("div",{class:"stat-title"},"我的测试",-1)),a("div",st,u(l.value.yourTestCount),1),T(a("div",{class:B(["stat-trend",{up:l.value.yourTestPending>0}])}," 待批改："+u(l.value.yourTestPending>0?"+":"")+u(l.value.yourTestPending),3),[[b,l.value.yourTestPending>0]])])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/personal-data/daily-assignments"},{default:n(()=>[a("div",nt,[s(d,null,{default:n(()=>[s(c($))]),_:1})])]),_:1}),a("div",at,[t[9]||(t[9]=a("div",{class:"stat-title"},"我的作业",-1)),a("div",lt,u(l.value.yourAssignmentsCount),1)])]),_:1})]),_:1}),s(m,{span:6},{default:n(()=>[s(f,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(_,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[a("div",ot,[s(d,null,{default:n(()=>[s(c(J))]),_:1})])]),_:1}),a("div",rt,[t[10]||(t[10]=a("div",{class:"stat-title"},"我的反馈",-1)),a("div",ut,u(l.value.myFeedbackCount),1),T(a("div",{class:B(["stat-trend",{up:l.value.myFeedbackTrend>0}])}," 待处理："+u(l.value.myFeedbackTrend>0?"+":"")+u(l.value.myFeedbackTrend),3),[[b,l.value.myFeedbackTrend>0]])])]),_:1})]),_:1})]),_:1}),s(E,{gutter:20,class:"main-content"},{default:n(()=>[s(m,{span:16},{default:n(()=>[s(f,{class:"task-card"},{header:n(()=>[a("div",it,[t[12]||(t[12]=a("span",null,"待办任务",-1)),s(_,{type:"primary",link:"",href:"/system/task-management"},{default:n(()=>t[11]||(t[11]=[p(" 查看全部 ")])),_:1})])]),default:n(()=>[s(ke,null,{default:n(()=>[(y(!0),C(H,null,M(L.value,(o,g)=>(y(),V(we,{key:g,type:G(o.priority),timestamp:o.due_date,placement:"top"},{default:n(()=>[s(f,{class:"task-item"},{default:n(()=>[a("div",dt,[a("h4",null,u(o.title),1),s(z,{class:"status-tag",type:ve(o.status)},{default:n(()=>[p(u(me(o.status)),1)]),_:2},1032,["type"]),t[13]||(t[13]=p()),s(z,{type:G(o.priority)},{default:n(()=>[p(u(fe(o.priority)),1)]),_:2},1032,["type"])]),a("p",null,u(o.description),1),o.isOverdue?(y(),C("p",_t,"已过期："+u(o.diffDays)+"天",1)):(y(),C("p",ct," 距离截止日期："+u(o.diffDays)+"天",1))]),_:2},1024)]),_:2},1032,["type","timestamp"]))),128))]),_:1})]),_:1})]),_:1}),s(m,{span:8},{default:n(()=>[s(f,{class:"quick-access"},{header:n(()=>t[14]||(t[14]=[a("div",{class:"card-header"},[a("span",null,"快捷入口")],-1)])),default:n(()=>{var o,g,P,F;return[a("div",ft,[a("div",vt,[s(_,{underline:!1,href:"/system/personal-data"},{default:n(()=>[s(x,{type:"primary",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(c(K))]),_:1}),t[15]||(t[15]=p(" 个人中心 "))]),_:1})]),_:1}),s(_,{underline:!1,href:`/system/training/study-material-folder?platform=${(g=(o=c(k).user)==null?void 0:o.role)==null?void 0:g.mark[0]}`},{default:n(()=>[s(x,{type:"success",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(c(O))]),_:1}),t[16]||(t[16]=p(" 学习资料 "))]),_:1})]),_:1},8,["href"])]),a("div",mt,[s(_,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[s(x,{type:"warning",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(c(J))]),_:1}),t[17]||(t[17]=p(" 反馈中心 "))]),_:1})]),_:1}),s(_,{underline:!1,href:`/system/daily-work/personal-assignments?platform=${(F=(P=c(k).user)==null?void 0:P.role)==null?void 0:F.mark[0]}`},{default:n(()=>[s(x,{type:"info",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(c($))]),_:1}),t[18]||(t[18]=p(" 日常作业 "))]),_:1})]),_:1},8,["href"])])])]}),_:1}),s(f,{class:"notice-card"},{header:n(()=>t[19]||(t[19]=[a("div",{class:"card-header"},[a("span",null,"系统公告")],-1)])),default:n(()=>[a("div",pt,[s(Ne,{name:"notice-fade",tag:"div"},{default:n(()=>[(y(!0),C(H,null,M(he.value,(o,g)=>(y(),C("div",{key:o.id?o.id:"empty-"+g,class:"notice-item",onClick:P=>o.id&&ge(o.id)},[o.id?(y(),V(z,{key:0,type:Y(o.type),size:"small"},{default:n(()=>[p(u(j(o.type)),1)]),_:2},1032,["type"])):W("",!0),a("span",gt,u(o.title||""),1),a("span",ht,u(o.created_at?c(Q)(o.created_at):""),1)],8,yt))),128))]),_:1})])]),_:1})]),_:1})]),_:1})]),s(Ce,{modelValue:I.value,"onUpdate:modelValue":t[1]||(t[1]=o=>I.value=o),title:ye.value,width:"40%",class:"notice-dialog","close-on-click-modal":!1},{header:n(()=>{var o,g,P;return[a("div",wt,[s(z,{type:Y(((o=N.value)==null?void 0:o.type)||""),size:"small",class:"notice-type-tag"},{default:n(()=>{var F;return[p(u(j(((F=N.value)==null?void 0:F.type)||"")),1)]}),_:1},8,["type"]),a("span",kt,u(((g=N.value)==null?void 0:g.title)||""),1),a("span",Ct,u(c(Q)(((P=N.value)==null?void 0:P.created_at)||"")),1)])]}),footer:n(()=>[a("div",St,[s(x,{type:"primary",onClick:t[0]||(t[0]=o=>I.value=!1)},{default:n(()=>t[20]||(t[20]=[p("关闭")])),_:1})])]),default:n(()=>{var o;return[a("div",Tt,[a("div",{innerHTML:(o=N.value)==null?void 0:o.content,class:"notice-content"},null,8,bt)])]}),_:1},8,["modelValue","title"])])}}}),It=xe(Pt,[["__scopeId","data-v-f370f810"]]);export{It as default};
