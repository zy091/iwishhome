import{E as v,o as Le,c as ne}from"./elementPlus-COdCHMXA.js";import{B as Se,s as V,e as re,b as De}from"./index-BTZmLT2e.js";import{x as Me,X as U,r as u,c as D,j as Be,w as Ee,y as b,P as t,A as p,H as a,ag as i,L as r,I as ue,aq as Ne,G as M,M as J,O as je,a6 as Pe,u as qe,J as T,z as d}from"./vendor-kUynFKsh.js";import"./supabase-Bu12BySZ.js";const Ie={class:"layout"},Re={style:{display:"flex","justify-content":"start","align-items":"center",gap:"20px"}},Oe={style:{display:"flex","justify-content":"start","align-items":"center",gap:"20px"}},Qe={key:1},Ge={class:"el-upload__tip"},He={key:0,style:{"margin-bottom":"5px"}},Je={class:"attachment-preview"},Te=["src"],We=["src"],Xe=["src"],Ke={key:3,class:"attachment-download"},Ye={class:"fullscreen-preview"},Ze=["src"],el=["src"],ll=Me({__name:"AdminAdsManagement",setup(tl){const ie=U([{name:"数据管理",path:""},{name:"广告内容管理",path:"/system/admin-ads-management"}]),P=u("formats"),h=U({formats:!1,courses:!1}),C=U({format:!1,course:!1}),g=U({formatVisible:!1,courseVisible:!1}),B=U({format:!1,course:!1}),y=U({page:1,pageSize:10,total:0}),w=U({page:1,pageSize:10,total:0}),E=u([]),k=u({}),A=u(""),de=D(()=>A.value?E.value.filter(l=>l.title&&l.title.toLowerCase().includes(A.value.toLowerCase())||l.adsform&&l.adsform.toLowerCase().includes(A.value.toLowerCase())):E.value),q=u([]),m=u({}),L=u(""),me=D(()=>L.value?q.value.filter(l=>l.label&&l.label.toLowerCase().includes(L.value.toLowerCase())||l.name&&l.name.toLowerCase().includes(L.value.toLowerCase())):q.value),I=u(),R=u([]),F=u(null),W=u(!1),pe=u(0),N=u(!1),O=u(!1),c=u(""),X=u(""),Q=l=>{var e;return l&&((e=l.split(".").pop())==null?void 0:e.toLowerCase())||""},G=D(()=>{const l=Q(c.value);return["jpg","jpeg","png","gif","bmp","webp"].includes(l)}),H=D(()=>Q(c.value)==="pdf"),K=D(()=>{const l=Q(c.value);return["doc","docx"].includes(l)}),ce=l=>{l.document_url&&(c.value=l.document_url,K.value&&(X.value=`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(c.value)}`),N.value=!0)},fe=()=>{c.value&&window.open(c.value,"_blank")},Y=()=>{O.value=!0},ve=l=>{if(!l)return"";try{const s=new URL(l).pathname.split("/");return decodeURIComponent(s[s.length-1])}catch{return l}},ge=l=>{y.page=l.page,y.pageSize=l.pageSize,S()},_e=l=>{w.page=l.page,w.pageSize=l.pageSize,$()},S=async()=>{h.formats=!0;try{const{data:l,count:e,error:s}=await V.from("ad_formats").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range((y.page-1)*y.pageSize,y.page*y.pageSize-1);if(s)throw s;E.value=l,y.total=e||0}catch(l){v.error("获取广告形式失败: "+l.message)}finally{h.formats=!1}},$=async()=>{h.courses=!0;try{const{data:l,count:e,error:s}=await V.from("ad_courses").select("*, ad_formats(title)",{count:"exact"}).order("created_at",{ascending:!1}).range((w.page-1)*w.pageSize,w.page*w.pageSize-1);if(s)throw s;q.value=l,w.total=e||0}catch(l){v.error("获取广告课程失败: "+l.message)}finally{h.courses=!1}},Z=(l=null)=>{B.format=!!l,k.value=l?{...l}:{title:"",adsform:""},g.formatVisible=!0},be=async()=>{C.format=!0;try{const{created_at:l,...e}=k.value,{error:s}=await V.from("ad_formats").upsert(e);if(s)throw s;v.success("广告形式保存成功"),g.formatVisible=!1,S()}catch(l){v.error("保存失败: "+l.message)}finally{C.format=!1}},ye=async l=>{try{await ne.confirm(`确定要删除广告形式 "${l.title}" 吗？其下的所有课程也将被删除。`,"警告",{type:"warning"});const{error:e}=await V.from("ad_formats").delete().eq("id",l.id);if(e)throw e;v.success("删除成功"),S(),$()}catch(e){e!=="cancel"&&v.error("删除失败: "+e.message)}},ee=(l=null)=>{B.course=!!l,m.value=l?{...l}:{label:"",name:"",ad_format_id:null,document_url:null},F.value=null,R.value=[],g.courseVisible=!0},we=l=>{l.raw&&(F.value=l.raw)},Ve=l=>{I.value.clearFiles();const e=l[0];I.value.handleStart(e)},Ce=async()=>{if(!F.value)return null;W.value=!0,pe.value=0;try{const l=F.value.name.split(".").pop(),s=`word-files/${`${Date.now()}-${Math.random().toString(36).substring(2)}.${l}`}`,{data:n,error:_}=await V.storage.from("documents").upload(s,F.value,{cacheControl:"3600",upsert:!1});if(_)throw _;const{data:f}=V.storage.from("documents").getPublicUrl(n.path);return f.publicUrl}catch(l){return v.error("文件上传失败: "+l.message),null}finally{W.value=!1}},ke=async()=>{C.course=!0;try{let l=m.value.document_url;if(F.value){const _=await Ce();if(_)l=_;else{C.course=!1;return}}const{ad_formats:e,...s}=m.value;s.document_url=l;const{error:n}=await V.from("ad_courses").upsert(s);if(n)throw n;v.success("课程保存成功"),g.courseVisible=!1,$()}catch(l){v.error("保存失败: "+l.message)}finally{C.course=!1}},xe=async l=>{try{await ne.confirm(`确定要删除课程 "${l.label}" 吗？`,"警告",{type:"warning"});const{error:e}=await V.from("ad_courses").delete().eq("id",l.id);if(e)throw e;v.success("删除成功"),$()}catch(e){e!=="cancel"&&v.error("删除失败: "+e.message)}};return Be(()=>{S(),$()}),Ee(P,l=>{l==="formats"?S():l==="courses"&&$()}),(l,e)=>{const s=i("el-input"),n=i("el-button"),_=i("el-card"),f=i("el-table-column"),le=i("el-button-group"),te=i("el-table"),ae=i("el-tab-pane"),Ue=i("el-tabs"),z=i("el-form-item"),oe=i("el-form"),j=i("el-dialog"),he=i("el-option"),Fe=i("el-select"),$e=i("el-icon"),ze=i("el-link"),Ae=i("el-upload"),se=Ne("loading");return d(),b("div",Ie,[t(Se,{breadcrumb:ie},null,8,["breadcrumb"]),e[37]||(e[37]=p("div",{class:"layout-title"},[p("h1",{class:"title"},"广告内容管理")],-1)),t(Ue,{modelValue:P.value,"onUpdate:modelValue":e[4]||(e[4]=o=>P.value=o),class:"tabs-container"},{default:a(()=>[t(ae,{label:"广告形式管理",name:"formats"},{default:a(()=>[t(_,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[p("div",Re,[t(s,{size:"large",modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=o=>A.value=o),placeholder:"按标题或标识符搜索(自动搜索)",style:{width:"300px"},clearable:""},null,8,["modelValue"]),t(n,{type:"primary",size:"large",onClick:e[1]||(e[1]=o=>Z())},{default:a(()=>e[17]||(e[17]=[r("新建广告形式")])),_:1})])]),_:1}),t(_,null,{header:a(()=>e[18]||(e[18]=[p("div",{class:"card-header"},"广告形式列表",-1)])),default:a(()=>[ue((d(),M(te,{data:de.value},{default:a(()=>[t(f,{prop:"title",label:"标题"}),t(f,{prop:"adsform",label:"标识符 (adsform)"}),t(f,{prop:"created_at",label:"创建时间"},{default:a(({row:o})=>[r(J(new Date(o.created_at).toLocaleString()),1)]),_:1}),t(f,{label:"操作",width:"180",fixed:"right"},{default:a(({row:o})=>[t(le,null,{default:a(()=>[t(n,{type:"primary",onClick:x=>Z(o)},{default:a(()=>e[19]||(e[19]=[r("编辑")])),_:2},1032,["onClick"]),t(n,{type:"danger",onClick:x=>ye(o)},{default:a(()=>e[20]||(e[20]=[r("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[se,h.formats]]),t(re,{pagination:y,"onUpdate:pagination":ge},null,8,["pagination"])]),_:1})]),_:1}),t(ae,{label:"广告课程管理",name:"courses"},{default:a(()=>[t(_,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[p("div",Oe,[t(s,{size:"large",modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=o=>L.value=o),placeholder:"按课程标题或标识搜索(自动搜索)",style:{width:"300px"},clearable:""},null,8,["modelValue"]),t(n,{type:"primary",size:"large",onClick:e[3]||(e[3]=o=>ee())},{default:a(()=>e[21]||(e[21]=[r("新建课程")])),_:1})])]),_:1}),t(_,null,{header:a(()=>e[22]||(e[22]=[p("div",{class:"card-header"},"广告课程列表",-1)])),default:a(()=>[ue((d(),M(te,{data:me.value},{default:a(()=>[t(f,{prop:"label",label:"课程标题 (label)"}),t(f,{prop:"name",label:"课程标识 (name)"}),t(f,{label:"所属广告形式"},{default:a(({row:o})=>{var x;return[r(J(((x=o.ad_formats)==null?void 0:x.title)||"N/A"),1)]}),_:1}),t(f,{label:"文件"},{default:a(({row:o})=>[o.document_url?(d(),M(n,{key:0,type:"primary",size:"small",onClick:x=>ce(o)},{default:a(()=>e[23]||(e[23]=[r("预览")])),_:2},1032,["onClick"])):(d(),b("span",Qe,"未上传"))]),_:1}),t(f,{label:"操作",width:"180",fixed:"right"},{default:a(({row:o})=>[t(le,null,{default:a(()=>[t(n,{type:"primary",onClick:x=>ee(o)},{default:a(()=>e[24]||(e[24]=[r("编辑")])),_:2},1032,["onClick"]),t(n,{type:"danger",onClick:x=>xe(o)},{default:a(()=>e[25]||(e[25]=[r("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[se,h.courses]]),t(re,{pagination:w,"onUpdate:pagination":_e},null,8,["pagination"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(j,{modelValue:g.formatVisible,"onUpdate:modelValue":e[8]||(e[8]=o=>g.formatVisible=o),title:B.format?"编辑广告形式":"新建广告形式",width:"500px"},{footer:a(()=>[t(n,{onClick:e[7]||(e[7]=o=>g.formatVisible=!1)},{default:a(()=>e[26]||(e[26]=[r("取消")])),_:1}),t(n,{type:"primary",onClick:be,loading:C.format},{default:a(()=>e[27]||(e[27]=[r("保存")])),_:1},8,["loading"])]),default:a(()=>[t(oe,{model:k.value,"label-width":"120px"},{default:a(()=>[t(z,{label:"标题"},{default:a(()=>[t(s,{modelValue:k.value.title,"onUpdate:modelValue":e[5]||(e[5]=o=>k.value.title=o),placeholder:"例如：搜索广告"},null,8,["modelValue"])]),_:1}),t(z,{label:"标识符"},{default:a(()=>[t(s,{modelValue:k.value.adsform,"onUpdate:modelValue":e[6]||(e[6]=o=>k.value.adsform=o),placeholder:"例如：google-search-ads"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(j,{modelValue:g.courseVisible,"onUpdate:modelValue":e[13]||(e[13]=o=>g.courseVisible=o),title:B.course?"编辑课程":"新建课程",width:"500px"},{footer:a(()=>[t(n,{onClick:e[12]||(e[12]=o=>g.courseVisible=!1)},{default:a(()=>e[31]||(e[31]=[r("取消")])),_:1}),t(n,{type:"primary",onClick:ke,loading:C.course},{default:a(()=>e[32]||(e[32]=[r("保存")])),_:1},8,["loading"])]),default:a(()=>[t(oe,{model:m.value,"label-width":"120px"},{default:a(()=>[t(z,{label:"课程标题"},{default:a(()=>[t(s,{modelValue:m.value.label,"onUpdate:modelValue":e[9]||(e[9]=o=>m.value.label=o),placeholder:"例如：搜索广告原理"},null,8,["modelValue"])]),_:1}),t(z,{label:"课程标识"},{default:a(()=>[t(s,{modelValue:m.value.name,"onUpdate:modelValue":e[10]||(e[10]=o=>m.value.name=o),placeholder:"例如：principle"},null,8,["modelValue"])]),_:1}),t(z,{label:"所属广告形式"},{default:a(()=>[t(Fe,{modelValue:m.value.ad_format_id,"onUpdate:modelValue":e[11]||(e[11]=o=>m.value.ad_format_id=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(d(!0),b(je,null,Pe(E.value,o=>(d(),M(he,{key:o.id,label:o.title,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(z,{label:"课程文件"},{default:a(()=>[t(Ae,{ref_key:"uploadRef",ref:I,drag:"",action:"#","auto-upload":!1,limit:1,"on-exceed":Ve,"on-change":we,"file-list":R.value},{tip:a(()=>[p("div",Ge,[!R.value.length&&m.value.document_url?(d(),b("div",He,[e[28]||(e[28]=r(" 当前文件: ")),t(ze,{href:m.value.document_url,type:"primary",target:"_blank"},{default:a(()=>[r(J(ve(m.value.document_url)),1)]),_:1},8,["href"])])):T("",!0),e[29]||(e[29]=p("span",null,"支持所有文本型、图片、视频等文件, 且不超过100MB",-1))])]),default:a(()=>[t($e,{class:"el-icon--upload"},{default:a(()=>[t(qe(Le))]),_:1}),e[30]||(e[30]=p("div",{class:"el-upload__text"},[r(" 将文件拖到此处，或"),p("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(j,{modelValue:N.value,"onUpdate:modelValue":e[15]||(e[15]=o=>N.value=o),title:"附件预览",width:"80%","destroy-on-close":""},{footer:a(()=>[t(n,{onClick:e[14]||(e[14]=o=>N.value=!1)},{default:a(()=>e[35]||(e[35]=[r("关闭")])),_:1}),G.value||H.value?(d(),M(n,{key:0,type:"primary",onClick:Y},{default:a(()=>e[36]||(e[36]=[r(" 全屏查看 ")])),_:1})):T("",!0)]),default:a(()=>[p("div",Je,[G.value?(d(),b("img",{key:0,src:c.value,class:"attachment-image",onClick:Y},null,8,Te)):H.value?(d(),b("iframe",{key:1,src:c.value,class:"attachment-frame"},null,8,We)):K.value?(d(),b("iframe",{key:2,src:X.value,class:"word-preview-frame"},null,8,Xe)):(d(),b("div",Ke,[e[34]||(e[34]=p("p",null,"无法预览此类型的文件，请下载后查看",-1)),t(n,{type:"primary",onClick:fe},{default:a(()=>e[33]||(e[33]=[r("下载附件")])),_:1})]))])]),_:1},8,["modelValue"]),t(j,{modelValue:O.value,"onUpdate:modelValue":e[16]||(e[16]=o=>O.value=o),title:"全屏预览",width:"100%",top:"0","show-close":!0,"destroy-on-close":"",class:"fullscreen-dialog"},{default:a(()=>[p("div",Ye,[G.value?(d(),b("img",{key:0,src:c.value,class:"fullscreen-image"},null,8,Ze)):H.value?(d(),b("iframe",{key:1,src:c.value,class:"fullscreen-frame"},null,8,el)):T("",!0)])]),_:1},8,["modelValue"])])}}}),rl=De(ll,[["__scopeId","data-v-bc2d784e"]]);export{rl as default};
