import{E as k,s as Te,c as se}from"./elementPlus-Be5V1zcU.js";import{t as L}from"./testResultService-DcwpN3WV.js";import{u as qe,h as ze,B as Se,e as Be,s as F,b as Re}from"./index-C9Sfkt3t.js";import{x as Ue,X as ne,c as Ee,r as v,j as Ae,y as m,P as t,A as l,H as o,ag as _,G as U,u as Le,L as u,I as oe,aq as Ne,M as c,J as b,O as re,a6 as $e,z as i}from"./vendor-CcmhhHhJ.js";import"./supabase-fOlwtt9p.js";const Ge={class:"layout"},Me={class:"layout-title"},Pe={class:"status-tabs"},je={class:"training-content"},Ie={class:"card-header"},Fe={class:"header-actions"},Oe={style:{"font-size":"14px",color:"#909399"}},Qe={key:0},He={key:1},Je={class:"details-header"},Xe={class:"detail-item"},Ke={class:"detail-item"},We={class:"detail-item"},Ye={class:"detail-item"},Ze={key:0,class:"detail-item"},et={key:1,class:"detail-item"},tt={class:"answer-list"},at={class:"question-header"},lt={class:"question-number"},st={class:"question-type"},nt={key:0,class:"answer-result"},ot={class:"question-content"},rt={class:"content"},it={class:"answer-content"},dt={class:"content"},ut={key:0,class:"answer-content"},ct={class:"content"},vt={key:0,class:"feedback-section"},_t={class:"grading-section"},pt={class:"grading-section"},gt={key:1,class:"grading-actions"},mt={key:2,class:"grading-actions"},ft=Ue({__name:"AdminTestResult",setup(yt){const ie=ne([{name:"数据管理",path:"/system/admin-test-result"},{name:"测试记录",path:"/system/admin-test-result"}]),N=qe(),de=Ee(()=>ze(Number(N.roleId))),$=v(""),G=v(!1),M=v(!1),O=v([]),P=v(""),w=v([]),ue=[{text:"Last week",value:()=>{const a=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,a]}},{text:"Last month",value:()=>{const a=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,a]}},{text:"Last 3 months",value:()=>{const a=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,a]}}],f=ne({page:1,pageSize:10,total:0}),ce=a=>{f.page=a.page,f.pageSize=a.pageSize,D()},j=v(!1),n=v(null),E=v([]),A=v({}),z=v(!1),S=v(!1),I=v("all"),x=v([]),y=v(""),B=v(""),D=async()=>{G.value=!0;const a=w.value!=null&&w.value[0]!=null?w.value[0].toDateString():"",e=w.value!=null&&w.value[1]!=null?w.value[1].toDateString():"",r={all:void 0,graded:!0,ungraded:!1};try{const p=await L.searchTestResultsUsingView(P.value,{startDate:a,endDate:e,page:f.page,pageSize:f.pageSize,type:$.value,is_graded:r[I.value]});O.value=p.data,f.total=p.total}catch(p){console.error("加载测试结果失败:",p),k.error("加载测试结果失败，请稍后重试")}finally{G.value=!1}},ve=async a=>{M.value=!0,n.value=a,j.value=!0,A.value={},z.value=!1,S.value=!a.is_graded,B.value=a.feedback_text||"",y.value=a.grade_level||"A";try{const e=await L.getTestResultDetails(a.id);E.value=e.answerDetails,e.answerDetails.forEach((r,p)=>{r.question_type==="reading"&&(A.value[p]=r.score||0)})}catch(e){console.error("加载测试详情失败:",e),k.error("加载测试详情失败，请稍后重试")}finally{M.value=!1}},Q=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",H=(a,e,r,p)=>{if(a===null)return"info";if(e=="comprehensive")return r?"success":"warning";if(e=="case")switch(p){case"A":return"success";case"B":return"success";case"C":return"warning";case"D":return"danger";default:return"info"}return a>=80?"success":a>=60?"warning":"danger"},_e=a=>{switch(a){case"select":return"选择题";case"judge":return"判断题";case"fill":return"填空题";case"question":return"简答题";case"reading":return"案例题";default:return"未知类型"}},J=(a,e,r,p)=>e==="case"?r?`评级: ${p||"-"}`:"待批改":e==="comprehensive"?r?`${a}分`:"待批改":`${a}分`,pe=async a=>{try{await se.confirm("确定要删除这条测试记录吗？此操作不可恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await L.deleteTestResult(a.id),k.success("删除成功"),D()}catch(e){e!=="cancel"&&(console.error("删除测试记录失败:",e),k.error("删除失败，请稍后重试"))}},X=()=>{S.value=!0,z.value=!0},ge=async()=>{var a,e;if(n.value)try{if(n.value.type==="case"){const{error:r}=await F.from("test_results").update({is_graded:!0,grader_id:(a=N.user)==null?void 0:a.user_id,feedback_text:B.value,grade_level:y.value,score:K(y.value),is_passed:y.value!=="D"}).eq("id",n.value.id);if(r)throw r}else{let r=0;n.value.type==="comprehensive"&&E.value.forEach(g=>{g.question_type==="select"&&g.is_correct&&(r+=5)}),r+=Object.values(A.value).reduce((g,T)=>g+T,0);const{error:p}=await F.from("test_results").update({score:r,is_passed:r>=60,is_graded:!0,grader_id:(e=N.user)==null?void 0:e.user_id}).eq("id",n.value.id);if(p)throw p;for(const[g,T]of Object.entries(A.value)){const{error:R}=await F.from("test_answer_details").update({is_correct:!0,score:T}).eq("test_result_id",n.value.id).eq("question_type","reading").eq("id",E.value[Number(g)].id);if(R)throw R}}k.success("批改结果保存成功"),z.value=!1,S.value=!1,n.value.type==="case"&&(n.value={...n.value,is_graded:!0,feedback_text:B.value,grade_level:y.value,score:K(y.value),is_passed:y.value!=="D"}),await D()}catch(r){console.error("保存批改结果失败:",r),k.error("保存批改结果失败，请稍后重试")}},K=a=>{switch(a){case"A":return 90;case"B":return 80;case"C":return 70;case"D":return 50;default:return 0}},me=a=>{f.page=1,D()},fe=()=>{f.page=1,D()},ye=a=>{x.value=a},be=async()=>{if(x.value.length!==0)try{await se.confirm(`确定要删除选中的 ${x.value.length} 条测试记录吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=x.value.map(e=>L.deleteTestResult(e.id));await Promise.all(a),k.success(`成功删除 ${x.value.length} 条测试记录`),x.value=[],D()}catch(a){a!=="cancel"&&(console.error("批量删除测试记录失败:",a),k.error("批量删除失败"))}},we=()=>{z.value=!0};return Ae(async()=>{await D()}),(a,e)=>{const r=_("el-tab-pane"),p=_("el-tabs"),g=_("el-option"),T=_("el-select"),R=_("el-input"),he=_("el-date-picker"),V=_("el-button"),ke=_("el-space"),W=_("el-card"),h=_("el-table-column"),q=_("el-tag"),xe=_("el-button-group"),Y=_("el-empty"),De=_("el-table"),Z=_("el-divider"),Ve=_("el-dialog"),ee=Ne("loading");return i(),m("div",Ge,[t(Se,{breadbcrum:ie},null,8,["breadbcrum"]),l("div",Me,[e[7]||(e[7]=l("h1",{class:"title"},"测试记录",-1)),l("div",Pe,[t(p,{class:"demo-tabs",modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=s=>I.value=s),onTabChange:me},{default:o(()=>[t(r,{name:"all",label:"全部测试"}),t(r,{name:"graded",label:"已批改"}),t(r,{name:"ungraded",label:"待批改"})]),_:1},8,["modelValue"])])]),t(W,{shadow:"always",style:{"margin-bottom":"20px"}},{default:o(()=>[t(ke,{wrap:"",alignment:"start",size:30},{default:o(()=>[t(T,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=s=>$.value=s),placeholder:"选择测试类型",size:"large",style:{width:"240px"}},{default:o(()=>[t(g,{label:"全部类型",value:""}),t(g,{label:"基础测试",value:"select"}),t(g,{label:"案例分析",value:"case"}),t(g,{label:"综合测验",value:"comprehensive"})]),_:1},8,["modelValue"]),t(R,{modelValue:P.value,"onUpdate:modelValue":e[2]||(e[2]=s=>P.value=s),style:{width:"240px"},placeholder:"请输入提交人或测试标题","suffix-icon":Le(Te),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),t(he,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=s=>w.value=s),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:ue,size:"large"},null,8,["modelValue"]),t(V,{type:"primary",size:"large",onClick:fe},{default:o(()=>e[8]||(e[8]=[u("搜索")])),_:1})]),_:1})]),_:1}),l("div",je,[de.value?(i(),U(W,{key:0,style:{"min-height":"400px"}},{header:o(()=>[l("div",Ie,[e[10]||(e[10]=u(" 测试记录管理 ")),l("div",Fe,[t(V,{type:"danger",disabled:!x.value.length,onClick:be},{default:o(()=>e[9]||(e[9]=[u(" 批量删除 ")])),_:1},8,["disabled"]),l("div",Oe,"共计"+c(f.total)+"条数据",1)])])]),default:o(()=>[oe((i(),U(De,{data:O.value,onSelectionChange:ye},{default:o(()=>[t(h,{type:"selection",width:"55"}),t(h,{prop:"profile.full_name",label:"提交人"},{default:o(s=>{var C;return[u(c(((C=s.row.profile)==null?void 0:C.full_name)||"未知用户"),1)]}),_:1}),t(h,{prop:"test_title",label:"测试标题"}),t(h,{prop:"score",label:"分数"},{default:o(s=>[t(q,{size:"large",style:{"font-size":"14px"},type:H(s.row.score,s.row.type,s.row.is_graded,s.row.grade_level)},{default:o(()=>[u(c(J(s.row.score,s.row.type,s.row.is_graded,s.row.grade_level)),1)]),_:2},1032,["type"])]),_:1}),t(h,{prop:"is_graded",label:"批改状态"},{default:o(s=>[t(q,{style:{"font-size":"14px"},size:"large",type:s.row.is_graded?"success":"warning"},{default:o(()=>[u(c(s.row.is_graded?"已批改":"待批改"),1)]),_:2},1032,["type"])]),_:1}),t(h,{prop:"grader.full_name",label:"批改人"},{default:o(s=>[s.row.is_graded?(i(),m("span",Qe,c(s.row.type=="select"?"自动批改":s.row.grader_full_name||"未知"),1)):(i(),m("span",He,"-"))]),_:1}),t(h,{prop:"submitted_at",label:"提交时间",width:"200"},{default:o(s=>[u(c(Q(s.row.submitted_at)),1)]),_:1}),t(h,{label:"操作",width:"200",fixed:"right"},{default:o(s=>[t(xe,null,{default:o(()=>[t(V,{type:"primary",onClick:C=>ve(s.row)},{default:o(()=>e[11]||(e[11]=[u(" 查看 ")])),_:2},1032,["onClick"]),t(V,{type:"danger",onClick:C=>pe(s.row)},{default:o(()=>e[12]||(e[12]=[u(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),t(Y,null,{description:o(()=>e[13]||(e[13]=[u(" 暂无测试记录 ")])),_:1})]),_:1},8,["data"])),[[ee,G.value]])]),_:1})):(i(),U(Y,{key:1,description:"您没有权限查看所有测试记录"})),t(Be,{pagination:f,"onUpdate:pagination":ce},null,8,["pagination"]),t(Ve,{modelValue:j.value,"onUpdate:modelValue":e[6]||(e[6]=s=>j.value=s),title:"测试详情",width:"700px"},{default:o(()=>{var s,C,te,ae,le;return[oe((i(),m("div",null,[n.value?(i(),m(re,{key:0},[l("div",Je,[l("div",Xe,[e[14]||(e[14]=l("span",{class:"label"},"提交人:",-1)),l("span",null,c(n.value.full_name||"未知用户"),1)]),l("div",Ke,[e[15]||(e[15]=l("span",{class:"label"},"测试标题:",-1)),l("span",null,c(n.value.test_title||"无标题"),1)]),e[20]||(e[20]=l("div",{class:"detail-item"},[l("span",{class:"label"},"满分:100"),l("span")],-1)),l("div",We,[e[16]||(e[16]=l("span",{class:"label"},"得分:",-1)),t(q,{size:"large",style:{"font-size":"14px"},type:H(n.value.score,n.value.type,n.value.is_graded,n.value.grade_level||"")},{default:o(()=>[u(c(J(n.value.score,n.value.type,n.value.is_graded,n.value.grade_level||"")),1)]),_:1},8,["type"])]),l("div",Ye,[e[17]||(e[17]=l("span",{class:"label"},"提交时间:",-1)),l("span",null,c(Q(n.value.submitted_at)),1)]),n.value.is_graded?(i(),m("div",Ze,[e[18]||(e[18]=l("span",{class:"label"},"批改人:",-1)),l("span",null,c(n.value.grader_full_name||"系统"),1)])):b("",!0),n.value.type!="select"&&n.value.is_graded?(i(),m("div",et,[t(V,{type:"warning",onClick:X},{default:o(()=>e[19]||(e[19]=[u("重新批改")])),_:1})])):b("",!0)]),t(Z),l("div",tt,[(i(!0),m(re,null,$e(E.value,(d,Ce)=>(i(),m("div",{key:d.id,class:"answer-item"},[l("div",at,[l("div",lt,"问题 "+c(Ce+1),1),l("div",st,[t(q,null,{default:o(()=>[u(c(_e(d.question_type)),1)]),_:2},1024)]),d.is_correct!==null?(i(),m("div",nt,[d.question_type==="select"?(i(),U(q,{key:0,type:d.is_correct?"success":"danger"},{default:o(()=>[u(c(d.is_correct?"正确":"错误"),1)]),_:2},1032,["type"])):b("",!0),d.question_type==="reading"?(i(),U(q,{key:1,type:d.score!=0?"success":"danger"},{default:o(()=>[u(c(d.score!=0?"已批改":"待批改"),1)]),_:2},1032,["type"])):b("",!0)])):b("",!0)]),l("div",ot,[e[21]||(e[21]=l("div",{class:"label"},"题目:",-1)),l("div",rt,c(d.question_text),1)]),l("div",it,[e[22]||(e[22]=l("div",{class:"label"},"答案:",-1)),l("div",dt,c(d.answer),1)]),d.question_type==="reading"&&d.score==0?b("",!0):(i(),m("div",ut,[e[23]||(e[23]=l("div",{class:"label"},"得分:",-1)),l("div",ct,c(d.score),1)]))]))),128))]),((s=n.value)==null?void 0:s.type)==="case"?(i(),m("div",vt,[t(Z,{"content-position":"left"},{default:o(()=>e[24]||(e[24]=[u("评价反馈")])),_:1}),l("div",_t,[e[25]||(e[25]=l("div",{class:"label"},"评级:",-1)),t(T,{modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=d=>y.value=d),placeholder:"请选择评级",disabled:((C=n.value)==null?void 0:C.is_graded)&&!S.value},{default:o(()=>[t(g,{label:"A (优秀)",value:"A"}),t(g,{label:"B (良好)",value:"B"}),t(g,{label:"C (一般)",value:"C"}),t(g,{label:"D (不及格)",value:"D"})]),_:1},8,["modelValue","disabled"])]),l("div",pt,[e[26]||(e[26]=l("div",{class:"label"},"反馈:",-1)),t(R,{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=d=>B.value=d),type:"textarea",rows:4,placeholder:"请输入您的反馈意见",disabled:((te=n.value)==null?void 0:te.is_graded)&&!S.value,onInput:we},null,8,["modelValue","disabled"])])])):b("",!0),z.value?(i(),m("div",gt,[t(V,{type:"primary",onClick:ge},{default:o(()=>e[27]||(e[27]=[u("保存批改结果")])),_:1})])):(ae=n.value)!=null&&ae.is_graded&&((le=n.value)==null?void 0:le.type)!="select"?(i(),m("div",mt,[t(V,{type:"warning",onClick:X},{default:o(()=>e[28]||(e[28]=[u("重新批改")])),_:1})])):b("",!0)],64)):b("",!0)])),[[ee,M.value]])]}),_:1},8,["modelValue"])])])}}}),Dt=Re(ft,[["__scopeId","data-v-15d419af"]]);export{Dt as default};
