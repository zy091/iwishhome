import{x as I,r as m,j as P,W as z,y as p,A as r,G as T,J as g,ag as j,u as _,H as L,L as N,M as D,D as k,P as G,O as J,a6 as Y,ay as K,n as Q,z as h}from"./vendor-kUynFKsh.js";import{m as $,f as X,F as Z,E as w,D as ee}from"./elementPlus-COdCHMXA.js";import{m as A}from"./index-B0r6nX_L.js";import{b as te}from"./index-BTZmLT2e.js";const ne={class:"word-viewer-container"},se={class:"viewer-header"},oe={class:"header-left"},le={class:"file-title"},ae={class:"header-right"},re={class:"viewer-content"},ie={class:"sidebar-header"},ce={key:0},de={class:"sidebar-actions"},ue={key:0,class:"sidebar-content"},he={class:"toc-tree"},fe=["onClick"],me={class:"main-content"},pe={class:"content-wrapper"},ve={class:"view-mode"},ye=["innerHTML"],ge=I({__name:"WordDocumentViewer",props:{documentUrl:{},title:{default:"文档查看器"},showBackButton:{type:Boolean,default:!0},showDownloadButton:{type:Boolean,default:!0}},setup(q){const v=q,V=K(),l=m(),C=m(""),f=m(!1),b=m(""),y=m([]),W=()=>{l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=ee.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),setTimeout(()=>{l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=null},1e4)},E=m(),M=async()=>{W();try{console.log("开始加载Word文档:",v.documentUrl);const t=await fetch(v.documentUrl);if(!t.ok)throw new Error("文件下载失败");const e=await t.arrayBuffer(),i=await A.convertToHtml({arrayBuffer:e,convertImage:A.images.imgElement(function(s){return s.read("base64").then(function(n){return{src:"data:"+s.contentType+";base64,"+n}})}),styleMap:["p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='Heading 4'] => h4:fresh","p[style-name='Heading 5'] => h5:fresh","p[style-name='Heading 6'] => h6:fresh","p[style-name='Title'] => h1.title:fresh","p[style-name='Subtitle'] => h2.subtitle:fresh","p[style-name='标题 1'] => h1:fresh","p[style-name='标题 2'] => h2:fresh","p[style-name='标题 3'] => h3:fresh","p[style-name='标题 4'] => h4:fresh","p[style-name='标题 5'] => h5:fresh","p[style-name='标题 6'] => h6:fresh","p[style-name='标题1'] => h1:fresh","p[style-name='标题2'] => h2:fresh","p[style-name='标题3'] => h3:fresh","p[style-name='标题4'] => h4:fresh","p[style-name='标题5'] => h5:fresh","p[style-name='标题6'] => h6:fresh","r[style-name='Strong'] => strong","r[style-name='Emphasis'] => em","r[style-name='Hyperlink'] => a","r[style-name='加粗'] => strong","r[style-name='倾斜'] => em","r[style-name='超链接'] => a","table => table.table:fresh","tr => tr:fresh","td => td:fresh","th => th:fresh"],transformDocument:function(s){return s.children.forEach(function(n){n.children&&n.children.forEach(function(c){c.type==="hyperlink"&&(c.type="hyperlink")})}),s}});C.value=i.value,await Q(),setTimeout(()=>{U()},500),w.success("文档加载成功")}catch(t){console.error("加载文档失败:",t),w.error("加载文档失败")}finally{l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=null}},U=()=>{const t=E.value;if(!t){console.log("wordContentRef.value 为空，无法生成目录");return}const e=[];t.querySelectorAll('a[id^="heading_"]').forEach((s,n)=>{var d,u;const c=s.getAttribute("id")||`heading-${n}`;let a=s.nextElementSibling,o="";if(a&&a.tagName.toLowerCase()==="strong")o=((d=a.textContent)==null?void 0:d.trim())||"";else{const H=s.parentElement;if(H){const S=H.querySelector("strong");S&&(o=((u=S.textContent)==null?void 0:u.trim())||"")}}o||(o=`标题 ${n+1}`),o&&o.length>0&&e.push({id:c,title:o,level:1,element:s})}),e.length===0&&t.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((n,c)=>{var d;const a=B(n),o=((d=n.textContent)==null?void 0:d.trim())||"";if(o&&o.length>0){const u=`heading-${c}`;n.id=u,e.push({id:u,title:o,level:a,element:n})}}),e.length===0&&t.querySelectorAll('h1, h2, h3, h4, h5, h6, .title, .subtitle, p[style*="heading"], p[style*="title"], p[style*="Heading"]').forEach((n,c)=>{var d;const a=B(n),o=((d=n.textContent)==null?void 0:d.trim())||"";if(o&&o.length>0){const u=`heading-${c}`;n.id=u,e.push({id:u,title:o,level:a,element:n})}}),e.length===0&&t.querySelectorAll("p").forEach((n,c)=>{var o;const a=((o=n.textContent)==null?void 0:o.trim())||"";if(a.match(/^[一二三四五六七八九十]+[、．.]/)||a.match(/^\d+[、．.]/)||a.includes("了解")||a.includes("申请")||a.includes("培训")){const d=`heading-${c}`;n.id=d,e.push({id:d,title:a,level:1,element:n})}}),y.value=e,e.length===0?y.value=[{id:"test-1",title:"文档开始",level:1},{id:"test-2",title:"主要内容",level:2}]:console.log("目录生成成功，共",e.length,"个条目")},B=t=>{const e=t.tagName.toLowerCase();if(e.startsWith("h"))return parseInt(e.charAt(1));const i=t.className;if(i.includes("title"))return 1;if(i.includes("subtitle"))return 2;const s=t.textContent||"";return s.length<20&&t.tagName==="P"?2:s.length<50&&t.tagName==="P"?3:4},O=t=>{let e=document.getElementById(t);e||(e=document.querySelector(`a[id="${t}"]`)),e||(e=document.querySelector(`[id="${t}"]`)),e?(e.scrollIntoView({behavior:"smooth",block:"start"}),e.style.backgroundColor="#fff3cd",setTimeout(()=>{e.style.backgroundColor=""},2e3),b.value=t):w.warning("未找到对应的标题位置")},R=()=>{const t=document.createElement("a");t.href=v.documentUrl,t.download=v.title+".docx",document.body.appendChild(t),t.click(),document.body.removeChild(t),w.success("开始下载文档")},F=()=>{V.go(-1)},x=()=>{const t=window.pageYOffset||document.documentElement.scrollTop,e=y.value;for(let i=e.length-1;i>=0;i--){const s=e[i],n=document.getElementById(s.id);if(n&&n.offsetTop<=t+100){b.value=s.id;break}}};return P(()=>{M(),window.addEventListener("scroll",x)}),z(()=>{window.removeEventListener("scroll",x),l.value&&typeof l.value.close=="function"&&l.value.close(),l.value=null}),(t,e)=>{const i=j("el-button");return h(),p("div",ne,[r("div",se,[r("div",oe,[t.showBackButton?(h(),T(i,{key:0,onClick:F,icon:_($)},{default:L(()=>e[1]||(e[1]=[N("返回")])),_:1},8,["icon"])):g("",!0),r("span",le,D(t.title),1)]),r("div",ae,[t.showDownloadButton?(h(),T(i,{key:0,type:"success",onClick:R,icon:_(X)},{default:L(()=>e[2]||(e[2]=[N(" 下载文档 ")])),_:1},8,["icon"])):g("",!0)])]),r("div",re,[r("div",{class:k(["sidebar",{collapsed:f.value}])},[r("div",ie,[f.value?g("",!0):(h(),p("span",ce,"目录")),r("div",de,[G(i,{class:"sidebar-toggle-btn",onClick:e[0]||(e[0]=s=>f.value=!f.value),icon:f.value?_(Z):_($)},null,8,["icon"])])]),f.value?g("",!0):(h(),p("div",ue,[r("div",he,[(h(!0),p(J,null,Y(y.value,(s,n)=>(h(),p("div",{key:n,class:k(["toc-item",{active:b.value===s.id}]),onClick:c=>O(s.id)},[r("span",{class:k(["toc-level",`level-${s.level}`])},D(s.title),3)],10,fe))),128))])]))],2),r("div",me,[r("div",pe,[r("div",ve,[r("div",{class:"word-content",innerHTML:C.value,ref_key:"wordContentRef",ref:E},null,8,ye)])])])])])}}}),Ce=te(ge,[["__scopeId","data-v-304d7b4f"]]);export{Ce as W};
