import{x as Ce,r as w,c as U,j as be,W as De,y as T,A as a,P as s,G as M,J,M as i,H as n,ag as m,O as q,a6 as E,u as f,I as C,Q as b,D as V,L as p,am as Se,z as y}from"./vendor-COQJj1AX.js";import{u as K,f as Q,r as Y,h as R,j as Z}from"./elementPlus-Dv7g5dxn.js";import{u as Pe,s as x,a as xe,f as X,_ as Ne}from"./index-02dAV7KX.js";import{t as Fe}from"./testResultService-CV4QQR0c.js";import{a as Ae}from"./assignmentService-C-SQa9sH.js";import{f as Ie}from"./feedbackService-DEUqkYGO.js";import"./supabase-BNvKcJjS.js";const Ue=""+new URL("banner-C5vi_D6D.png",import.meta.url).href,Le=""+new URL("iwish-us-BEKIG9la.jpg",import.meta.url).href,ze={class:"layout"},Me={class:"dashboard-content"},Ve={class:"welcome-section"},Oe={class:"date"},Be={class:"stat-icon"},He={class:"stat-info"},qe={class:"stat-value"},Ee={class:"stat-icon"},Ye={class:"stat-info"},Re={class:"stat-value"},$e={class:"stat-icon"},je={class:"stat-info"},Ge={class:"stat-value"},We={class:"stat-icon"},Je={class:"stat-info"},Ke={class:"stat-value"},Qe={class:"stat-icon"},Ze={class:"stat-info"},Xe={class:"stat-value"},et={class:"stat-icon"},tt={class:"stat-info"},st={class:"stat-value"},nt={class:"stat-icon"},at={class:"stat-info"},lt={class:"stat-value"},ot={class:"stat-icon"},rt={class:"stat-info"},it={class:"stat-value"},ut={class:"card-header"},dt={class:"task-title"},ct={key:0,style:{color:"#E6A23C","font-size":"12px","margin-top":"10px","font-weight":"bold"}},_t={key:1,style:{color:"#909399","font-size":"12px","margin-top":"10px"}},ft={key:2,style:{color:"#F56C6C","font-size":"12px","margin-top":"10px"}},mt={class:"quick-links"},vt={class:"quick-link-group"},pt={class:"quick-link-group"},yt={class:"notice-list fixed-notice-list"},gt=["onClick"],ht={class:"notice-title"},wt={class:"notice-time"},Tt={class:"notice-dialog-header"},kt={class:"notice-dialog-title"},Ct={class:"notice-time"},bt={class:"notice-dialog-content"},Dt=["innerHTML"],St={class:"notice-dialog-footer"},ee=5,Pt=Ce({__name:"SystemHome",setup(xt){const te=w([Ue,Le]);w(null);const k=Pe(),se=U(()=>{var e;return((e=k.user)==null?void 0:e.full_name)||"用户"}),D=w([]),ne=U(()=>new Date().toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"})),ae=U(()=>{var e,t,r;return((e=k.user)==null?void 0:e.role_id)===0||((t=k.user)==null?void 0:t.role_id)===1||((r=k.user)==null?void 0:r.role_id)===11}),l=w({activeUsers:0,userTrend:0,studyCount:0,studyPending:0,testCount:0,testPending:0,assignmentsCount:0,assignmentsPending:0,yourStudyCount:0,yourStudyPending:0,yourTestCount:0,yourTestPending:0,yourAssignmentsCount:0,yourAssignmentsPending:0,feedbackCount:0,feedbackTrend:0,myFeedbackCount:0,myFeedbackTrend:0}),le=async()=>{try{const{data:e,error:t}=await x.from("user_profiles").select("*");if(t)throw t;const r=new Date,u=e==null?void 0:e.filter(g=>new Date(g.created_at).toDateString()===r.toDateString());l.value.activeUsers=(e==null?void 0:e.length)||0,l.value.userTrend=(u==null?void 0:u.length)||0}catch(e){console.error("获取用户失败:",e)}},oe=async()=>{try{const{data:e,error:t}=await x.from("study_notes").select("*");if(t)throw t;l.value.studyCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.admin_reply===null);l.value.studyPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取学习记录失败:",e)}},re=async()=>{try{const{data:e,error:t}=await x.from("test_results").select("*");if(t)throw t;l.value.testCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.feedback_text===null&&u.type==="case");l.value.testPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取测试结果失败:",e)}},ie=async()=>{try{const{data:e,error:t}=await x.from("assignments").select("*");if(t)throw t;l.value.assignmentsCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.admin_reply===null);l.value.assignmentsPending=(r==null?void 0:r.length)||0}catch(e){console.error("获取日常作业失败:",e)}},ue=async()=>{const e=await xe.getNotes();l.value.yourStudyCount=(e==null?void 0:e.length)||0;const t=e==null?void 0:e.filter(r=>r.admin_reply===null);l.value.yourStudyPending=(t==null?void 0:t.length)||0,e||console.error("获取你的心得失败")},de=async()=>{const{data:e,total:t}=await Fe.getUserTestResults({page:1,pageSize:1e3});l.value.yourTestCount=(e==null?void 0:e.length)||0;const r=e==null?void 0:e.filter(u=>u.feedback_text===null&&u.type==="case");l.value.yourTestPending=(r==null?void 0:r.length)||0,e||console.error("获取你的测试失败")},ce=async()=>{try{const{data:e,total:t}=await Ae.getPersonalAssignments(1,1e3);l.value.yourAssignmentsCount=t||0}catch(e){console.error("获取你的作业失败:",e)}},_e=async()=>{var e;try{const{data:t}=await Ie.getPersonalFeedback();l.value.myFeedbackCount=(t==null?void 0:t.length)||0,l.value.myFeedbackTrend=((e=t==null?void 0:t.filter(r=>r.replied_at==null))==null?void 0:e.length)||0}catch(t){console.error("获取反馈失败:",t)}},O=w([]),fe=async()=>{var r;const{data:e,error:t}=await x.from("tasks").select("*").eq("assigned_to",(r=k.user)==null?void 0:r.user_id);if(t)throw t;O.value=e.filter(u=>u.status!=="completed").map(u=>{const g=new Date(u.due_date),d=new Date,c=new Date(g.getFullYear(),g.getMonth(),g.getDate()),_=new Date(d.getFullYear(),d.getMonth(),d.getDate()),v=c<_,F=Math.abs(c.getTime()-_.getTime()),S=Math.ceil(F/(1e3*60*60*24)),H=c.getTime()===_.getTime();return{...u,diffDays:S,isOverdue:v,isToday:H}}).sort((u,g)=>new Date(u.due_date).getTime()-new Date(g.due_date).getTime()),console.log(O.value)};function $(e){switch(e){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function me(e){switch(e){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function ve(e){switch(e){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function pe(e){switch(e){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}const ye=async()=>{try{const{data:e,error:t}=await x.from("announcements").select("*");if(t)throw t;D.value=e}catch(e){console.error("获取系统公告失败:",e)}},j=e=>{switch(e){case"important":return"danger";case"normal":return"success";case"update":return"warning";default:return"info"}},G=e=>{switch(e){case"important":return"重要";case"normal":return"新";case"update":return"更新";default:return"其他"}},L=w(!1),ge=w(""),W=w(null),N=U(()=>D.value.find(e=>e.id===W.value)||null),he=e=>{W.value=e,L.value=!0},z=w(0);let B=null;const we=U(()=>{const e=[],t=D.value.length;for(let r=0;r<ee;r++)if(t===0)e.push({id:null,title:"",type:"",created_at:""});else{const u=(z.value+r)%t;e.push(D.value[u]||{id:null,title:"",type:"",created_at:""})}return e});return be(()=>{Promise.all([le(),oe(),re(),ie(),ue(),de(),ce(),ye(),fe(),_e()]).catch(e=>{console.error("加载数据失败:",e)}),B=setInterval(()=>{D.value.length>ee?z.value=(z.value+1)%D.value.length:z.value=0},3e3)}),De(()=>{B&&clearInterval(B)}),(e,t)=>{const r=m("el-image"),u=m("el-carousel-item"),g=m("el-carousel"),d=m("el-icon"),c=m("el-link"),_=m("el-card"),v=m("el-col"),F=m("el-row"),S=m("el-tag"),H=m("el-timeline-item"),Te=m("el-timeline"),A=m("el-button"),ke=m("el-dialog");return y(),T("div",ze,[a("div",Me,[a("div",Ve,[a("h2",null,"欢迎回来，"+i(se.value),1),a("p",Oe,i(ne.value),1)]),s(g,{"indicator-position":"outside",height:"500px"},{default:n(()=>[(y(!0),T(q,null,E(te.value,o=>(y(),M(u,{key:o},{default:n(()=>[s(r,{src:o},{placeholder:n(()=>t[2]||(t[2]=[a("div",{class:"image-slot"},[p("Loading"),a("span",{class:"dot"},"...")],-1)])),_:2},1032,["src"])]),_:2},1024))),128))]),_:1}),ae.value?(y(),M(F,{key:0,gutter:20,class:"stat-cards"},{default:n(()=>[s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/users"},{default:n(()=>[a("div",Be,[s(d,null,{default:n(()=>[s(f(K))]),_:1})])]),_:1}),a("div",He,[t[3]||(t[3]=a("div",{class:"stat-title"},"系统用户",-1)),a("div",qe,i(l.value.activeUsers),1),C(a("div",{class:V(["stat-trend",{up:l.value.userTrend>0}])}," 新增： "+i(l.value.userTrend>0?"+":"")+i(l.value.userTrend),3),[[b,l.value.userTrend>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-study-notes"},{default:n(()=>[a("div",Ee,[s(d,null,{default:n(()=>[s(f(Q))]),_:1})])]),_:1}),a("div",Ye,[t[4]||(t[4]=a("div",{class:"stat-title"},"学习心得",-1)),a("div",Re,i(l.value.studyCount),1),C(a("div",{class:"stat-trend"}," 待回复： "+i(l.value.studyPending),513),[[b,l.value.studyPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-test-result"},{default:n(()=>[a("div",$e,[s(d,null,{default:n(()=>[s(f(Y))]),_:1})])]),_:1}),a("div",je,[t[5]||(t[5]=a("div",{class:"stat-title"},"测试结果",-1)),a("div",Ge,i(l.value.testCount),1),C(a("div",{class:"stat-trend"}," 待批改： "+i(l.value.testPending),513),[[b,l.value.testPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/admin-assignments"},{default:n(()=>[a("div",We,[s(d,null,{default:n(()=>[s(f(R))]),_:1})])]),_:1}),a("div",Je,[t[6]||(t[6]=a("div",{class:"stat-title"},"日常作业",-1)),a("div",Ke,i(l.value.assignmentsCount),1),C(a("div",{class:"stat-trend"}," 待批改： "+i(l.value.assignmentsPending),513),[[b,l.value.assignmentsPending>0]])])]),_:1})]),_:1})]),_:1})):J("",!0),s(F,{gutter:20,class:"stat-cards"},{default:n(()=>[s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/study-notes"},{default:n(()=>[a("div",Qe,[s(d,null,{default:n(()=>[s(f(Q))]),_:1})])]),_:1}),a("div",Ze,[t[7]||(t[7]=a("div",{class:"stat-title"},"我的心得",-1)),a("div",Xe,i(l.value.yourStudyCount),1),C(a("div",{class:V(["stat-trend",{up:l.value.yourStudyPending>0}])}," 待回复： "+i(l.value.yourStudyPending>0?"+":"")+i(l.value.yourStudyPending),3),[[b,l.value.yourStudyPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/test-result"},{default:n(()=>[a("div",et,[s(d,null,{default:n(()=>[s(f(Y))]),_:1})])]),_:1}),a("div",tt,[t[8]||(t[8]=a("div",{class:"stat-title"},"我的测试",-1)),a("div",st,i(l.value.yourTestCount),1),C(a("div",{class:V(["stat-trend",{up:l.value.yourTestPending>0}])}," 待批改："+i(l.value.yourTestPending>0?"+":"")+i(l.value.yourTestPending),3),[[b,l.value.yourTestPending>0]])])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/personal-data/daily-assignments"},{default:n(()=>[a("div",nt,[s(d,null,{default:n(()=>[s(f(R))]),_:1})])]),_:1}),a("div",at,[t[9]||(t[9]=a("div",{class:"stat-title"},"我的作业",-1)),a("div",lt,i(l.value.yourAssignmentsCount),1)])]),_:1})]),_:1}),s(v,{span:6},{default:n(()=>[s(_,{shadow:"hover",class:"stat-card"},{default:n(()=>[s(c,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[a("div",ot,[s(d,null,{default:n(()=>[s(f(Z))]),_:1})])]),_:1}),a("div",rt,[t[10]||(t[10]=a("div",{class:"stat-title"},"我的反馈",-1)),a("div",it,i(l.value.myFeedbackCount),1),C(a("div",{class:V(["stat-trend",{up:l.value.myFeedbackTrend>0}])}," 待处理："+i(l.value.myFeedbackTrend>0?"+":"")+i(l.value.myFeedbackTrend),3),[[b,l.value.myFeedbackTrend>0]])])]),_:1})]),_:1})]),_:1}),s(F,{gutter:20,class:"main-content"},{default:n(()=>[s(v,{span:16},{default:n(()=>[s(_,{class:"task-card",style:{"min-height":"200px"}},{header:n(()=>[a("div",ut,[t[12]||(t[12]=a("span",null,"待办任务",-1)),s(c,{type:"primary",link:"",href:"/system/task-management"},{default:n(()=>t[11]||(t[11]=[p(" 查看全部 ")])),_:1})])]),default:n(()=>[s(Te,null,{default:n(()=>[(y(!0),T(q,null,E(O.value,(o,h)=>(y(),M(H,{key:h,type:$(o.priority),timestamp:o.due_date,placement:"top"},{default:n(()=>[s(_,{class:"task-item"},{default:n(()=>[a("div",dt,[a("h4",null,i(o.title),1),s(S,{class:"status-tag",type:ve(o.status)},{default:n(()=>[p(i(pe(o.status)),1)]),_:2},1032,["type"]),t[13]||(t[13]=p()),s(S,{type:$(o.priority)},{default:n(()=>[p(i(me(o.priority)),1)]),_:2},1032,["type"])]),a("p",null,i(o.description),1),o.isToday?(y(),T("p",ct," 今天到期 ")):o.isOverdue?(y(),T("p",ft," 已过期："+i(o.diffDays)+"天 ",1)):(y(),T("p",_t," 距离截止日期："+i(o.diffDays)+"天 ",1))]),_:2},1024)]),_:2},1032,["type","timestamp"]))),128))]),_:1})]),_:1})]),_:1}),s(v,{span:8},{default:n(()=>[s(_,{class:"quick-access"},{header:n(()=>t[14]||(t[14]=[a("div",{class:"card-header"},[a("span",null,"快捷入口")],-1)])),default:n(()=>{var o,h,P,I;return[a("div",mt,[a("div",vt,[s(c,{underline:!1,href:"/system/personal-data"},{default:n(()=>[s(A,{type:"primary",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f(K))]),_:1}),t[15]||(t[15]=p(" 个人中心 "))]),_:1})]),_:1}),s(c,{underline:!1,href:`/system/training/study-material-folder?platform=${(h=(o=f(k).user)==null?void 0:o.role)==null?void 0:h.mark[0]}`},{default:n(()=>[s(A,{type:"success",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f(Y))]),_:1}),t[16]||(t[16]=p(" 学习资料 "))]),_:1})]),_:1},8,["href"])]),a("div",pt,[s(c,{underline:!1,href:"/system/feedback-center"},{default:n(()=>[s(A,{type:"warning",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f(Z))]),_:1}),t[17]||(t[17]=p(" 反馈中心 "))]),_:1})]),_:1}),s(c,{underline:!1,href:`/system/daily-work/personal-assignments?platform=${(I=(P=f(k).user)==null?void 0:P.role)==null?void 0:I.mark[0]}`},{default:n(()=>[s(A,{type:"info",plain:""},{default:n(()=>[s(d,null,{default:n(()=>[s(f(R))]),_:1}),t[18]||(t[18]=p(" 日常作业 "))]),_:1})]),_:1},8,["href"])])])]}),_:1}),s(_,{class:"notice-card"},{header:n(()=>t[19]||(t[19]=[a("div",{class:"card-header"},[a("span",null,"系统公告")],-1)])),default:n(()=>[a("div",yt,[s(Se,{name:"notice-fade",tag:"div"},{default:n(()=>[(y(!0),T(q,null,E(we.value,(o,h)=>(y(),T("div",{key:o.id?o.id:"empty-"+h,class:"notice-item",onClick:P=>o.id&&he(o.id)},[o.id?(y(),M(S,{key:0,type:j(o.type),size:"small"},{default:n(()=>[p(i(G(o.type)),1)]),_:2},1032,["type"])):J("",!0),a("span",ht,i(o.title||""),1),a("span",wt,i(o.created_at?f(X)(o.created_at):""),1)],8,gt))),128))]),_:1})])]),_:1})]),_:1})]),_:1})]),s(ke,{modelValue:L.value,"onUpdate:modelValue":t[1]||(t[1]=o=>L.value=o),title:ge.value,width:"40%",class:"notice-dialog","close-on-click-modal":!1},{header:n(()=>{var o,h,P;return[a("div",Tt,[s(S,{type:j(((o=N.value)==null?void 0:o.type)||""),size:"small",class:"notice-type-tag"},{default:n(()=>{var I;return[p(i(G(((I=N.value)==null?void 0:I.type)||"")),1)]}),_:1},8,["type"]),a("span",kt,i(((h=N.value)==null?void 0:h.title)||""),1),a("span",Ct,i(f(X)(((P=N.value)==null?void 0:P.created_at)||"")),1)])]}),footer:n(()=>[a("div",St,[s(A,{type:"primary",onClick:t[0]||(t[0]=o=>L.value=!1)},{default:n(()=>t[20]||(t[20]=[p("关闭")])),_:1})])]),default:n(()=>{var o;return[a("div",bt,[a("div",{innerHTML:(o=N.value)==null?void 0:o.content,class:"notice-content"},null,8,Dt)])]}),_:1},8,["modelValue","title"])])}}}),Mt=Ne(Pt,[["__scopeId","data-v-47cd16eb"]]);export{Mt as default};
