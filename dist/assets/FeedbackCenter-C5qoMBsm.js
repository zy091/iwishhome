import{E as f,s as Le,u as qe,z as Ne,N as Ee,O as Ie,c as pe}from"./elementPlus-7n3J9xVR.js";import{h as Oe,f as k}from"./feedbackService-C4tKgl-5.js";import{u as Qe,B as je,e as He,b as Je}from"./index-BKDCXq68.js";import{x as Xe,X as K,c as me,r as u,j as Ke,y as V,P as t,A as o,H as s,ag as n,G as _,J as p,u as T,O as W,a6 as Y,L as i,I as We,aq as Ye,M as c,z as r}from"./vendor-kUynFKsh.js";import"./supabase-Dk90AXsH.js";const Ze={class:"layout"},et={class:"layout-title"},tt={class:"status-tabs"},lt={class:"feedback-content"},at={class:"card-header"},st={key:0,class:"header-actions"},ot={style:{"font-size":"14px",color:"#909399"}},nt={key:1,style:{color:"#909399"}},rt={class:"dialog-content"},ut={class:"feedback-details"},it={class:"feedback-header"},dt={class:"feedback-title"},ct={class:"feedback-meta"},pt={class:"meta-item"},mt={class:"meta-item"},vt={class:"meta-item"},ft={class:"meta-item"},_t={class:"feedback-section"},gt={class:"feedback-content",style:{padding:"10px"}},bt={key:0,class:"feedback-section"},yt={class:"section-title"},kt={class:"replies-list"},ht={class:"reply-header"},wt={class:"reply-author"},Vt={class:"reply-time"},xt={class:"reply-content"},St={key:1,class:"feedback-section"},Ct={class:"status-selector",style:{"margin-top":"15px"}},Dt={class:"status-selector",style:{"margin-top":"15px"}},zt={class:"dialog-footer"},Ft={class:"dialog-footer"},Ut=Xe({__name:"FeedbackCenter",setup(Bt){const ve=K([{name:"FAQ中心",path:"/system/feedback-center"}]),Z=Qe(),ee=me(()=>{var l;return((l=Z.user)==null?void 0:l.user_id)||""}),d=me(()=>Oe(Number(Z.roleId)));console.log(d,"hasAdminPerm");const I=u(!1),O=u([]),P=u(!1),U=u(!1),m=u(null),A=u(""),x=u([]),D=u(""),R=u("resolved"),M=u(!0),Q=u(!1),j=u(!1),z=u("all"),F=u(""),C=u([]),H=u(),$=u(""),B=u([]),te=u(!1),g=K({title:"",content:"",platform:""}),fe={title:[{required:!0,message:"请输入反馈标题",trigger:"blur"},{min:2,max:100,message:"标题长度应在2到100个字符之间",trigger:"blur"}],platform:[{required:!0,message:"请选择平台",trigger:"change"}],content:[{required:!0,message:"请输入反馈内容",trigger:"blur"},{min:4,max:2e3,message:"内容长度应在4到2000个字符之间",trigger:"blur"}]},le=[{label:"Google",value:"google"},{label:"Meta",value:"meta"},{label:"Criteo",value:"criteo"},{label:"Bing",value:"bing"},{label:"GMC",value:"gmc"},{label:"GA4",value:"ga4"},{label:"插件应用",value:"plugin"},{label:"Shopify后台",value:"shopify"},{label:"系统反馈",value:"system"},{label:"其他",value:"other"}],b=K({page:1,pageSize:10,total:0}),_e=[{text:"最近一周",value:()=>{const l=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,l]}},{text:"最近一个月",value:()=>{const l=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,l]}},{text:"最近三个月",value:()=>{const l=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,l]}}],ge=l=>{switch(l){case"google":return"success";case"meta":return"info";case"criteo":return"warning";case"bing":return"primary";case"gmc":return"danger";case"ga4":return"success";case"plugin":return"warning";case"shopify":return"info";case"system":return"primary";case"other":return"info";default:return"info"}},ae=l=>{switch(l){case"google":return"Google";case"meta":return"Meta";case"criteo":return"Criteo";case"bing":return"Bing";case"gmc":return"GMC";case"ga4":return"GA4";case"plugin":return"插件应用";case"shopify":return"Shopify后台";case"system":return"系统反馈";case"other":return"其他";default:return l||"未知"}},be=l=>{switch(l){case"pending":return"info";case"in_progress":return"warning";case"resolved":return"success";default:return"info"}},ye=l=>{switch(l){case"pending":return"待处理";case"in_progress":return"处理中";case"resolved":return"已解决";default:return l||"未知"}},ke=l=>{b.page=l.page,b.pageSize=l.pageSize,S()},S=async()=>{I.value=!0;const l=x.value!=null&&x.value[0]!=null?x.value[0].toDateString():"",e=x.value!=null&&x.value[1]!=null?x.value[1].toDateString():"";try{let v;d.value?v=await k.getAllFeedback({query:A.value,startDate:l,endDate:e,page:b.page,pageSize:b.pageSize,replyStatus:z.value,platform:F.value!==""?F.value:void 0,showStatus:$.value!==""?$.value:void 0}):v=await k.getAllFeedback({query:A.value,startDate:l,endDate:e,page:b.page,pageSize:b.pageSize,platform:F.value!==""?F.value:void 0}),O.value=v.data,b.total=v.total}catch(v){f.error("搜索反馈失败"),console.error("搜索反馈失败:",v)}finally{I.value=!1}},he=async l=>{P.value=!0,m.value=l,D.value="",R.value=l.status||"resolved",M.value=l.is_show,te.value=!0;try{B.value=await k.getFeedbackReplies(l.id)}catch(e){console.error("获取回复失败:",e),f.error("获取回复失败")}finally{te.value=!1}},we=()=>{U.value=!0,Object.assign(g,{title:"",content:"",platform:""})},Ve=l=>{C.value=l},xe=async()=>{H.value&&await H.value.validate(async l=>{if(l){j.value=!0;try{await k.createFeedback({title:g.title,content:g.content,platform:g.platform}),f.success("反馈已提交"),U.value=!1,S()}catch(e){f.error("创建反馈失败"),console.error("创建反馈失败:",e)}finally{j.value=!1}}})},Se=async()=>{if(!(!m.value||!d.value)){if(!D.value.trim()){f.warning("请输入回复内容");return}Q.value=!0;try{await k.submitReply(m.value.id,{content:D.value.trim(),status:R.value,is_show:M.value}),f.success("回复提交成功"),B.value=await k.getFeedbackReplies(m.value.id),D.value="",S()}catch(l){f.error("提交失败"),console.error("提交失败:",l)}finally{Q.value=!1}}},Ce=async l=>{try{await pe.confirm(`确定要删除 "${l.title}" 这条反馈吗？`,"提示",{type:"warning"}),d.value?await k.deleteFeedback(l.id):l.reply_count>0?f.error("反馈已有回复，不能删除"):await k.hideFeedback(l.id),f.success("删除成功"),z.value==="my_feedback"?se():S()}catch(e){e!=="cancel"&&(f.error("删除失败"),console.error("删除失败:",e))}},De=async()=>{if(C.value.length!==0)try{await pe.confirm(`确定要删除选中的 ${C.value.length} 条反馈吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const l=C.value.map(e=>k.deleteFeedback(e.id));await Promise.all(l),f.success(`成功删除 ${C.value.length} 条反馈`),C.value=[],S()}catch(l){l!=="cancel"&&(console.error("批量删除反馈失败:",l),f.error("批量删除失败"))}},se=async()=>{let l=await k.getPersonalFeedback();console.log(l,"result"),O.value=l.data,b.total=l.total},ze=l=>{z.value=l,b.page=1,l==="my_feedback"?se():S()};return Ke(()=>{S()}),(l,e)=>{const v=n("el-tab-pane"),Fe=n("el-tabs"),G=n("el-input"),L=n("el-option"),J=n("el-select"),Ue=n("el-date-picker"),h=n("el-button"),Be=n("el-space"),oe=n("el-card"),w=n("el-table-column"),q=n("el-tag"),Te=n("el-button-group"),Pe=n("el-empty"),Ae=n("el-table"),N=n("el-icon"),ne=n("el-radio"),Re=n("el-radio-group"),Me=n("el-switch"),re=n("el-dialog"),X=n("el-form-item"),$e=n("el-form"),Ge=Ye("loading");return r(),V("div",Ze,[t(je,{breadcrumb:ve},null,8,["breadcrumb"]),o("div",et,[e[15]||(e[15]=o("h1",{class:"title"},"FAQ中心",-1)),o("div",tt,[t(Fe,{class:"demo-tabs",modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=a=>z.value=a),onTabChange:ze},{default:s(()=>[t(v,{name:"all",label:"全部反馈"}),d.value?(r(),_(v,{key:0,name:"replied",label:"已解决"})):p("",!0),d.value?(r(),_(v,{key:1,name:"in_progress",label:"处理中"})):p("",!0),d.value?(r(),_(v,{key:2,name:"pending",label:"待处理"})):p("",!0),t(v,{name:"my_feedback",label:"我的反馈"})]),_:1},8,["modelValue"])])]),t(oe,{shadow:"always",style:{"margin-bottom":"20px"}},{default:s(()=>[t(Be,{wrap:"",alignment:"start",size:30},{default:s(()=>[t(G,{modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=a=>A.value=a),style:{width:"240px"},placeholder:"请输入提交人或标题","suffix-icon":T(Le),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),t(J,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=a=>F.value=a),placeholder:"选择平台",style:{width:"160px"},size:"large",clearable:""},{default:s(()=>[(r(),V(W,null,Y(le,a=>t(L,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),d.value?(r(),_(J,{key:0,modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=a=>$.value=a),placeholder:"选择展示状态",style:{width:"160px"},size:"large",clearable:""},{default:s(()=>[t(L,{label:"显示",value:"true"}),t(L,{label:"隐藏",value:"false"})]),_:1},8,["modelValue"])):p("",!0),t(Ue,{modelValue:x.value,"onUpdate:modelValue":e[4]||(e[4]=a=>x.value=a),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:_e,size:"large"},null,8,["modelValue"]),t(h,{type:"primary",size:"large",onClick:S},{default:s(()=>e[16]||(e[16]=[i("搜索")])),_:1}),t(h,{type:"success",size:"large",onClick:we},{default:s(()=>e[17]||(e[17]=[i("添加反馈")])),_:1})]),_:1})]),_:1}),o("div",lt,[t(oe,{style:{"min-height":"400px"}},{header:s(()=>[o("div",at,[e[19]||(e[19]=i(" 反馈列表 ")),d.value?(r(),V("div",st,[t(h,{type:"danger",disabled:!C.value.length,onClick:De},{default:s(()=>e[18]||(e[18]=[i(" 批量删除 ")])),_:1},8,["disabled"]),o("div",ot,"共计"+c(b.total)+"条数据",1)])):p("",!0)])]),default:s(()=>[We((r(),_(Ae,{data:O.value,onSelectionChange:Ve},{default:s(()=>[d.value?(r(),_(w,{key:0,type:"selection",width:"55"})):p("",!0),t(w,{prop:"title",label:"标题","min-width":"200"}),t(w,{prop:"platform",label:"平台",width:"130"},{default:s(({row:a})=>[t(q,{type:ge(a.platform),size:"large"},{default:s(()=>[i(c(ae(a.platform)),1)]),_:2},1032,["type"])]),_:1}),d.value?(r(),_(w,{key:1,prop:"full_name",label:"提交人",width:"120"})):p("",!0),t(w,{prop:"status",label:"状态",width:"100"},{default:s(({row:a})=>[t(q,{style:{"font-size":"14px"},type:be(a.status),size:"large"},{default:s(()=>[i(c(ye(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(w,{prop:"reply_count",label:"回复数",width:"80"},{default:s(({row:a})=>[a.reply_count>0?(r(),_(q,{key:0,type:"info",size:"small"},{default:s(()=>[i(c(a.reply_count),1)]),_:2},1024)):(r(),V("span",nt,"0"))]),_:1}),d.value?(r(),_(w,{key:2,prop:"is_show",label:"展示状态",width:"100"},{default:s(({row:a})=>[t(q,{type:a.is_show?"success":"danger",size:"large"},{default:s(()=>[i(c(a.is_show?"显示":"隐藏"),1)]),_:2},1032,["type"])]),_:1})):p("",!0),t(w,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:a})=>[i(c(new Date(a.created_at).toLocaleString()),1)]),_:1}),t(w,{label:"操作",width:"150",fixed:"right"},{default:s(({row:a})=>[t(Te,null,{default:s(()=>[t(h,{type:"primary",onClick:E=>he(a)},{default:s(()=>e[20]||(e[20]=[i("查看")])),_:2},1032,["onClick"]),d.value||a.user_id===ee.value&&z.value==="my_feedback"?(r(),_(h,{key:0,type:"danger",onClick:E=>Ce(a),disabled:!d.value&&a.user_id==ee.value&&a.reply_count>0},{default:s(()=>e[21]||(e[21]=[i("删除")])),_:2},1032,["onClick","disabled"])):p("",!0)]),_:2},1024)]),_:1}),t(Pe,null,{description:s(()=>e[22]||(e[22]=[i(" 暂无反馈数据 ")])),_:1})]),_:1},8,["data"])),[[Ge,I.value]])]),_:1}),t(He,{pagination:b,"onUpdate:pagination":ke},null,8,["pagination"]),t(re,{title:"反馈详情",modelValue:P.value,"onUpdate:modelValue":e[9]||(e[9]=a=>P.value=a),width:"60%","close-on-click-modal":!1,top:"5vh",class:"feedback-detail-dialog"},{footer:s(()=>[o("span",zt,[t(h,{onClick:e[8]||(e[8]=a=>P.value=!1)},{default:s(()=>e[29]||(e[29]=[i("关闭")])),_:1}),d.value?(r(),_(h,{key:0,type:"primary",onClick:Se,loading:Q.value},{default:s(()=>e[30]||(e[30]=[i(" 提交回复 ")])),_:1},8,["loading"])):p("",!0)])]),default:s(()=>{var a,E,ue,ie,de,ce;return[o("div",rt,[o("div",ut,[o("div",it,[o("h2",dt,c(((a=m.value)==null?void 0:a.title)||"无标题"),1),o("div",ct,[o("span",pt,[t(N,null,{default:s(()=>[t(T(qe))]),_:1}),o("span",null,c(((E=m.value)==null?void 0:E.full_name)||"未知用户"),1)]),o("span",mt,[t(N,null,{default:s(()=>[t(T(Ne))]),_:1}),o("span",null,c(((ue=m.value)==null?void 0:ue.email)||"无邮箱"),1)]),o("span",vt,[t(N,null,{default:s(()=>[t(T(Ee))]),_:1}),o("span",null,c(m.value?new Date((ie=m.value)==null?void 0:ie.created_at).toLocaleString():"未知时间"),1)]),o("span",ft,[t(N,null,{default:s(()=>[t(T(Ie))]),_:1}),o("span",null,c(ae(((de=m.value)==null?void 0:de.platform)||"")),1)])])]),o("div",_t,[e[23]||(e[23]=o("div",{class:"section-title"},"内容",-1)),o("div",gt,c(((ce=m.value)==null?void 0:ce.content)||"无内容"),1)]),B.value.length>0?(r(),V("div",bt,[o("div",yt,"回复历史 ("+c(B.value.length)+"条)",1),o("div",kt,[(r(!0),V(W,null,Y(B.value,y=>(r(),V("div",{key:y.id,class:"reply-item"},[o("div",ht,[o("span",wt,c(y.full_name),1),o("span",Vt,c(new Date(y.created_at).toLocaleString()),1)]),o("div",xt,c(y.content),1)]))),128))])])):p("",!0),d.value?(r(),V("div",St,[e[28]||(e[28]=o("div",{class:"section-title"},"添加回复",-1)),t(G,{type:"textarea",modelValue:D.value,"onUpdate:modelValue":e[5]||(e[5]=y=>D.value=y),rows:4,placeholder:"请输入您的回复内容...",class:"reply-input"},null,8,["modelValue"]),o("div",Ct,[e[26]||(e[26]=o("span",{class:"status-label"},"状态：",-1)),t(Re,{modelValue:R.value,"onUpdate:modelValue":e[6]||(e[6]=y=>R.value=y)},{default:s(()=>[t(ne,{label:"in_progress"},{default:s(()=>e[24]||(e[24]=[i("处理中")])),_:1}),t(ne,{label:"resolved"},{default:s(()=>e[25]||(e[25]=[i("已解决")])),_:1})]),_:1},8,["modelValue"])]),o("div",Dt,[e[27]||(e[27]=o("span",{class:"status-label"},"是否显示：",-1)),m.value?(r(),_(Me,{key:0,modelValue:M.value,"onUpdate:modelValue":e[7]||(e[7]=y=>M.value=y),"active-text":"显示","inactive-text":"隐藏"},null,8,["modelValue"])):p("",!0)])])):p("",!0)])])]}),_:1},8,["modelValue"]),t(re,{title:"创建反馈",modelValue:U.value,"onUpdate:modelValue":e[14]||(e[14]=a=>U.value=a),width:"40%","close-on-click-modal":!1},{footer:s(()=>[o("span",Ft,[t(h,{onClick:e[13]||(e[13]=a=>U.value=!1)},{default:s(()=>e[31]||(e[31]=[i("取消")])),_:1}),t(h,{type:"primary",onClick:xe,loading:j.value},{default:s(()=>e[32]||(e[32]=[i("创建")])),_:1},8,["loading"])])]),default:s(()=>[t($e,{model:g,rules:fe,ref_key:"feedbackForm",ref:H,"label-width":"80px"},{default:s(()=>[t(X,{label:"标题",prop:"title"},{default:s(()=>[t(G,{modelValue:g.title,"onUpdate:modelValue":e[10]||(e[10]=a=>g.title=a),placeholder:"请输入反馈标题"},null,8,["modelValue"])]),_:1}),t(X,{label:"平台",prop:"platform"},{default:s(()=>[t(J,{modelValue:g.platform,"onUpdate:modelValue":e[11]||(e[11]=a=>g.platform=a),placeholder:"选择平台",style:{width:"100%"}},{default:s(()=>[(r(),V(W,null,Y(le,a=>t(L,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(X,{label:"内容",prop:"content"},{default:s(()=>[t(G,{type:"textarea",modelValue:g.content,"onUpdate:modelValue":e[12]||(e[12]=a=>g.content=a),rows:6,placeholder:"请详细描述您的反馈内容"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])])}}}),$t=Je(Ut,[["__scopeId","data-v-b0265d43"]]);export{$t as default};
