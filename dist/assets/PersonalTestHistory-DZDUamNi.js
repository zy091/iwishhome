import{aw as R,r as b,x as $,w as N,j as G,y as U,I as H,P as f,aq as M,G as q,ag as p,H as u,L as T,M as h,J as E,O as A,A as m,z as x}from"./vendor-CcmhhHhJ.js";import{s as v,b as F}from"./index-UMOi9Opk.js";import{t as L}from"./testResultService-BT_tK6YZ.js";import{E as Q}from"./elementPlus-Be5V1zcU.js";const z=R("test",()=>{const a=b(!1),n=b(null);return{loading:a,error:n,getTests:async e=>{a.value=!0,n.value=null;try{let s=v.from("tests").select("*",{count:"exact"});if(e!=null&&e.searchQuery&&(s=s.ilike("title",`%${e.searchQuery}%`)),e!=null&&e.testType&&(s=s.eq("type",e.testType)),e!=null&&e.platform&&(s=s.eq("platform",e.platform)),e!=null&&e.page&&(e!=null&&e.pageSize)){const c=(e.page-1)*e.pageSize,r=c+e.pageSize-1;s=s.range(c,r)}s=s.order("created_at",{ascending:!1});const{data:i,error:d,count:_}=await s;if(d)throw d;return{data:i,total:_||0}}catch(s){return n.value=s.message,{data:[],total:0}}finally{a.value=!1}},getTestById:async e=>{a.value=!0,n.value=null;try{const{data:s,error:i}=await v.from("tests").select("*").eq("id",e).single();if(i)throw i;return s}catch(s){return n.value=s.message,null}finally{a.value=!1}},getUserTestStatus:async e=>{var s;a.value=!0,n.value=null;try{const{data:i,error:d}=await v.auth.getUser();if(d)throw d;const _=(s=i.user)==null?void 0:s.id;if(!_)throw new Error("用户未登录");const{data:c,error:r}=await v.from("user_tests").select("*").eq("user_id",_).eq("test_id",e).single();if(r&&r.code!=="PGRST116")throw r;return c||null}catch(i){return n.value=i.message,null}finally{a.value=!1}},updateUserTestStatus:async(e,s)=>{var i;a.value=!0,n.value=null;try{const{data:d,error:_}=await v.auth.getUser();if(_)throw _;const c=(i=d.user)==null?void 0:i.id;if(!c)throw new Error("用户未登录");const{data:r,error:t}=await v.from("user_tests").select("*").eq("user_id",c).eq("test_id",e).single();let l;if(t&&t.code==="PGRST116"){const{data:y,error:g}=await v.from("user_tests").insert({user_id:c,test_id:e,...s}).select().single();if(g)throw g;l=y}else{const{data:y,error:g}=await v.from("user_tests").update(s).eq("user_id",c).eq("test_id",e).select().single();if(g)throw g;l=y}return l}catch(d){return n.value=d.message,null}finally{a.value=!1}}}}),re={getTests:a=>z().getTests(a),getTestById:a=>z().getTestById(a),getUserTestStatus:a=>z().getUserTestStatus(a),updateUserTestStatus:(a,n)=>z().updateUserTestStatus(a,n)},j={class:"personal-test-history"},J={class:"feedback-header"},O={class:"feedback-item"},K={class:"feedback-item"},W={class:"feedback-content"},X=$({__name:"PersonalTestHistory",props:{testId:{}},setup(a){const n=a,S=b(!1),D=b([]),k=b(!1),w=b(null),e=async()=>{S.value=!0;try{const{data:r}=await L.getUserTestResults({page:1,pageSize:100});D.value=r.filter(t=>t.test_id===n.testId).sort((t,l)=>new Date(l.submitted_at).getTime()-new Date(t.submitted_at).getTime())}catch(r){console.error("加载测试历史记录失败:",r),Q.error("加载测试历史记录失败，请稍后重试")}finally{S.value=!1}};N(()=>n.testId,()=>{e()});const s=r=>r?new Date(r).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",i=(r,t,l)=>r===null?"info":t=="case"||t=="comprehensive"?l?"success":"warning":r>=80?"success":r>=60?"warning":"danger",d=r=>{const{score:t,type:l,is_graded:y,grade_level:g}=r;return y?l==="case"?g?`评级: ${g}`:`${t}分`:l==="comprehensive"?`${t}分`:`${t}分`:"待批改"},_=r=>{switch(r){case"A":return"success";case"B":return"success";case"C":return"warning";case"D":return"danger";default:return"info"}},c=r=>{w.value=r,k.value=!0};return G(()=>{e()}),(r,t)=>{const l=p("el-table-column"),y=p("el-tag"),g=p("el-button"),B=p("el-empty"),I=p("el-table"),C=p("el-divider"),V=p("el-dialog"),P=M("loading");return x(),U("div",j,[H((x(),q(I,{data:D.value},{default:u(()=>[f(l,{prop:"test_title",label:"测试标题"}),f(l,{prop:"score",label:"分数/评级",width:"120"},{default:u(o=>[f(y,{size:"large",style:{"font-size":"14px"},type:i(o.row.score,o.row.type,o.row.is_graded)},{default:u(()=>[T(h(d(o.row)),1)]),_:2},1032,["type"])]),_:1}),f(l,{prop:"submitted_at",label:"提交时间",width:"180"},{default:u(o=>[T(h(s(o.row.submitted_at)),1)]),_:1}),f(l,{label:"批改状态",width:"100"},{default:u(o=>[f(y,{style:{"font-size":"14px"},size:"large",type:o.row.is_graded?"success":"warning"},{default:u(()=>[T(h(o.row.is_graded?"已批改":"待批改"),1)]),_:2},1032,["type"])]),_:1}),f(l,{label:"操作",width:"100"},{default:u(o=>[o.row.is_graded&&o.row.type==="case"?(x(),q(g,{key:0,size:"small",type:"primary",onClick:Y=>c(o.row)},{default:u(()=>t[1]||(t[1]=[T("查看反馈")])),_:2},1032,["onClick"])):E("",!0)]),_:1}),f(B,null,{description:u(()=>t[2]||(t[2]=[T(" 暂无测试记录 ")])),_:1})]),_:1},8,["data"])),[[P,S.value]]),f(V,{modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=o=>k.value=o),title:"评价反馈",width:"600px"},{default:u(()=>[w.value?(x(),U(A,{key:0},[m("div",J,[m("div",O,[t[3]||(t[3]=m("span",{class:"label"},"评级:",-1)),f(y,{size:"large",style:{"font-size":"16px"},type:_(w.value.grade_level)},{default:u(()=>[T(h(w.value.grade_level||"-"),1)]),_:1},8,["type"])]),m("div",K,[t[4]||(t[4]=m("span",{class:"label"},"提交时间:",-1)),m("span",null,h(s(w.value.submitted_at)),1)])]),f(C,{"content-position":"left"},{default:u(()=>t[5]||(t[5]=[T("评价内容")])),_:1}),m("div",W,h(w.value.feedback_text||"老师暂未留下具体评价。"),1)],64)):E("",!0)]),_:1},8,["modelValue"])])}}}),ae=F(X,[["__scopeId","data-v-17136486"]]);export{ae as P,re as t};
