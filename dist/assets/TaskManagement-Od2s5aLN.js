import{E as g,s as he,c as Se}from"./elementPlus-Dv7g5dxn.js";import{u as De,B as xe,b as Ue,s as h,_ as Ce}from"./index-o-d80rdM.js";import{x as qe,c as R,r as d,j as ze,y as E,P as t,A as m,H as r,ag as p,G as C,J as N,u as Me,L as i,I as Te,aq as Le,M as V,O as K,a6 as W,z as b}from"./vendor-COQJj1AX.js";import"./supabase-Bqqw4QDB.js";const Ye={class:"layout"},$e={class:"task-content"},Ie={class:"card-header"},Be={class:"header-actions"},Fe={style:{"font-size":"14px",color:"#909399"}},Oe={class:"dialog-footer"},Ae={class:"dialog-footer"},Re=qe({__name:"TaskManagement",setup(Ee){var H;const X=[{name:"任务管理",path:"/system/task-management"}],q=De(),S=(H=q.user)==null?void 0:H.user_id,k=R(()=>{var a,e,o;return((a=q.user)==null?void 0:a.role_id)===0||((e=q.user)==null?void 0:e.role_id)===1||((o=q.user)==null?void 0:o.role_id)===11}),Z=R(()=>{var a;return s.value.creator&&s.value.creator.full_name?s.value.creator.full_name:((a=q.user)==null?void 0:a.full_name)||""}),$=d(!1),D=d(!1),I=d([]),L=d(""),Y=d(""),x=d(null),U=d(!1),B=d(""),F=d(null),z=d(!1),O=d(null),A=d([]),_=d({page:1,pageSize:10,total:0}),s=d({title:"",description:"",priority:"medium",status:"pending",due_date:"",assigned_to:null}),n=d({title:"",description:"",priority:"medium",due_date:"",assigned_to:[]}),ee={title:[{required:!0,message:"请输入任务名称",trigger:"blur"}],description:[{required:!0,message:"请输入任务描述",trigger:"blur"}],priority:[{required:!0,message:"请选择任务优先级",trigger:"change"}],status:[{required:!0,message:"请选择任务状态",trigger:"change"}],due_date:[{required:!0,message:"请选择截止日期",trigger:"change"}]},te={title:[{required:!0,message:"请输入任务名称",trigger:"blur"}],description:[{required:!0,message:"请输入任务描述",trigger:"blur"}],priority:[{required:!0,message:"请选择任务优先级",trigger:"change"}],due_date:[{required:!0,message:"请选择截止日期",trigger:"change"}],assigned_to:[{required:!0,message:"请选择要指派的用户",trigger:"change"}]},P=d([]),le=R(()=>{const a=(_.value.page-1)*_.value.pageSize,e=a+_.value.pageSize;return I.value.slice(a,e)}),M=async()=>{$.value=!0;try{let a=h.from("tasks").select(`
                *,
                assignee:user_profiles!tasks_assigned_to_fkey(
                    user_id,
                    full_name
                ),
                creator:user_profiles!tasks_user_id_fkey(
                    user_id,
                    full_name
                )
            `).order("created_at",{ascending:!1});k.value||(a=a.eq("assigned_to",S));const{data:e,error:o}=await a;if(o)throw o;I.value=e||[],P.value=e||[],_.value.total=(e==null?void 0:e.length)||0}catch(a){console.error("获取任务列表失败:",a),g.error("获取任务列表失败")}finally{$.value=!1}},ae=async()=>{if(k.value)try{const{data:a,error:e}=await h.from("user_profiles").select("user_id, full_name").order("full_name");if(e)throw e;A.value=a||[]}catch(a){console.error("获取用户列表失败:",a),g.error("获取用户列表失败")}},re=a=>{_.value.page=a.page,_.value.pageSize=a.pageSize},oe=()=>{_.value.page=1;let a=[...P.value];if(L.value&&(a=a.filter(e=>e.title.toLowerCase().includes(L.value.toLowerCase()))),Y.value&&(a=a.filter(e=>e.status===Y.value)),x.value&&x.value[0]&&x.value[1]){const[e,o]=x.value;a=a.filter(u=>{const v=new Date(u.due_date).toISOString().split("T")[0];return v>=e&&v<=o})}I.value=a,_.value.total=a.length},se=()=>{B.value="添加任务",s.value={title:"",description:"",priority:"medium",status:"pending",due_date:"",assigned_to:k.value?null:S},U.value=!0},ue=a=>{B.value="编辑任务",s.value={...a},U.value=!0},ne=async a=>{const e=a.status==="pending"?"in_progress":"completed";try{const{error:o}=await h.from("tasks").update({status:e,updated_at:new Date().toISOString()}).eq("id",a.id);if(o)throw o;g.success("更新状态成功"),M()}catch(o){console.error("更新状态失败:",o),g.error("更新状态失败")}},ie=async a=>{try{await Se.confirm("确定要删除该任务吗？此操作不可恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const{error:e}=await h.from("tasks").delete().eq("id",a.id);if(e)throw e;g.success("删除成功"),M()}catch(e){e!=="cancel"&&(console.error("删除任务失败:",e),g.error("删除失败"))}},de=async()=>{F.value&&await F.value.validate(async a=>{if(a){D.value=!0;try{if(!k.value)s.value.assigned_to=S,s.value.user_id=S;else if(s.value.assigned_to)s.value.user_id=S;else{g.warning("请选择要指派的用户");return}const e={...s.value};if(delete e.assignee,delete e.creator,s.value.id){const{error:o}=await h.from("tasks").update({...e,updated_at:new Date().toISOString()}).eq("id",s.value.id);if(o)throw o;g.success("更新成功")}else{const{error:o}=await h.from("tasks").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(o)throw o;g.success("创建成功")}U.value=!1,M()}catch(e){console.error(s.value.id?"更新失败:":"创建失败:",e),g.error(s.value.id?"更新失败":"创建失败")}finally{D.value=!1}}})},pe=async()=>{O.value&&await O.value.validate(async a=>{if(a){D.value=!0;try{const e=n.value.assigned_to.map(u=>({title:n.value.title,description:n.value.description,priority:n.value.priority,status:"pending",due_date:n.value.due_date,assigned_to:u,user_id:S,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),{error:o}=await h.from("tasks").insert(e);if(o)throw o;g.success(`成功指派任务给 ${e.length} 位用户`),z.value=!1,M(),n.value={title:"",description:"",priority:"medium",due_date:"",assigned_to:[]}}catch(e){console.error("批量指派失败:",e),g.error("批量指派失败")}finally{D.value=!1}}})};function me(a){return a?new Date(a).toISOString().split("T")[0]:"-"}function fe(a){if(!a)return"-";const e=new Date(a),o=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),v=String(e.getDate()).padStart(2,"0"),T=String(e.getHours()).padStart(2,"0"),f=String(e.getMinutes()).padStart(2,"0");return`${o}-${u}-${v} ${T}:${f}`}function ce(a){switch(a){case"low":return"info";case"medium":return"success";case"high":return"warning";case"urgent":return"danger";default:return"info"}}function ge(a){switch(a){case"low":return"低";case"medium":return"中";case"high":return"高";case"urgent":return"紧急";default:return"未知"}}function ve(a){switch(a){case"pending":return"info";case"in_progress":return"warning";case"completed":return"success";default:return"info"}}function _e(a){switch(a){case"pending":return"待完成";case"in_progress":return"进行中";case"completed":return"已完成";default:return"未知"}}function ye(a){switch(a){case"pending":return"开始";case"in_progress":return"完成";case"completed":return"已完成";default:return"更新"}}return ze(async()=>{await Promise.all([M(),ae()])}),(a,e)=>{const o=p("el-input"),u=p("el-option"),v=p("el-select"),T=p("el-date-picker"),f=p("el-button"),be=p("el-space"),j=p("el-card"),y=p("el-table-column"),G=p("el-tag"),we=p("el-button-group"),Ve=p("el-table"),c=p("el-form-item"),J=p("el-form"),Q=p("el-dialog"),ke=Le("loading");return b(),E("div",Ye,[t(xe,{breadbcrum:X}),e[34]||(e[34]=m("div",{class:"layout-title"},[m("h1",{class:"title"},"任务管理")],-1)),t(j,{shadow:"always",style:{"margin-bottom":"20px"}},{default:r(()=>[t(be,{wrap:"",alignment:"start",size:30},{default:r(()=>[t(o,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=l=>L.value=l),style:{width:"240px"},placeholder:"请输入任务名称","suffix-icon":Me(he),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),t(v,{modelValue:Y.value,"onUpdate:modelValue":e[1]||(e[1]=l=>Y.value=l),placeholder:"状态",clearable:"",style:{width:"150px"},size:"large"},{default:r(()=>[t(u,{label:"待完成",value:"pending"}),t(u,{label:"进行中",value:"in_progress"}),t(u,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"]),t(T,{modelValue:x.value,"onUpdate:modelValue":e[2]||(e[2]=l=>x.value=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"300px"},size:"large"},null,8,["modelValue"]),t(f,{type:"primary",size:"large",onClick:oe},{default:r(()=>e[19]||(e[19]=[i("搜索")])),_:1}),t(f,{type:"success",size:"large",onClick:se},{default:r(()=>e[20]||(e[20]=[i("添加任务")])),_:1}),k.value?(b(),C(f,{key:0,type:"info",size:"large",onClick:e[3]||(e[3]=l=>z.value=!0)},{default:r(()=>e[21]||(e[21]=[i("批量指派任务")])),_:1})):N("",!0)]),_:1})]),_:1}),m("div",$e,[t(j,{shadow:"always"},{header:r(()=>[m("div",Ie,[e[22]||(e[22]=i(" 任务列表 ")),m("div",Be,[m("div",Fe,"共计"+V(_.value.total)+"条数据",1)])])]),default:r(()=>[Te((b(),C(Ve,{data:le.value,"row-key":"id",stripe:"",height:"400px"},{default:r(()=>[t(y,{prop:"id",label:"ID",width:"80"}),t(y,{prop:"title",label:"任务名称",width:"200"}),t(y,{prop:"description",label:"任务描述","show-overflow-tooltip":""}),t(y,{prop:"priority",label:"优先级",width:"100"},{default:r(({row:l})=>[t(G,{type:ce(l.priority)},{default:r(()=>[i(V(ge(l.priority)),1)]),_:2},1032,["type"])]),_:1}),t(y,{prop:"status",label:"状态",width:"100"},{default:r(({row:l})=>[t(G,{type:ve(l.status)},{default:r(()=>[i(V(_e(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(y,{prop:"due_date",label:"截止日期",width:"120"},{default:r(({row:l})=>[i(V(me(l.due_date)),1)]),_:1}),k.value?(b(),C(y,{key:0,prop:"assigned_to",label:"指派给",width:"150"},{default:r(({row:l})=>{var w;return[i(V(((w=l.assignee)==null?void 0:w.full_name)||"未指派"),1)]}),_:1})):N("",!0),t(y,{prop:"user_id",label:"创建人",width:"150"},{default:r(({row:l})=>{var w;return[i(V(((w=l.creator)==null?void 0:w.full_name)||"未知"),1)]}),_:1}),t(y,{prop:"created_at",label:"创建时间",width:"170"},{default:r(({row:l})=>[i(V(fe(l.created_at)),1)]),_:1}),t(y,{label:"操作",width:"220",fixed:"right"},{default:r(({row:l})=>[t(we,null,{default:r(()=>[t(f,{type:"primary",onClick:w=>ue(l)},{default:r(()=>e[23]||(e[23]=[i(" 编辑 ")])),_:2},1032,["onClick"]),t(f,{type:"success",onClick:w=>ne(l),disabled:l.status==="completed"},{default:r(()=>[i(V(ye(l.status)),1)]),_:2},1032,["onClick","disabled"]),t(f,{type:"danger",onClick:w=>ie(l)},{default:r(()=>e[24]||(e[24]=[i(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ke,$.value]])]),_:1}),t(Ue,{pagination:_.value,"onUpdate:pagination":re},null,8,["pagination"]),t(Q,{title:B.value,modelValue:U.value,"onUpdate:modelValue":e[11]||(e[11]=l=>U.value=l),width:"40%","close-on-click-modal":!1},{footer:r(()=>[m("span",Oe,[t(f,{onClick:e[10]||(e[10]=l=>U.value=!1)},{default:r(()=>e[27]||(e[27]=[i("取消")])),_:1}),t(f,{type:"primary",onClick:de,loading:D.value},{default:r(()=>e[28]||(e[28]=[i("确定")])),_:1},8,["loading"])])]),default:r(()=>[t(J,{model:s.value,rules:ee,ref_key:"taskFormRef",ref:F,"label-width":"80px"},{default:r(()=>[t(c,{label:"任务名称",prop:"title"},{default:r(()=>[t(o,{modelValue:s.value.title,"onUpdate:modelValue":e[4]||(e[4]=l=>s.value.title=l),placeholder:"请输入任务名称"},null,8,["modelValue"]),e[25]||(e[25]=m("div",{class:"form-tip"},"请简要描述任务的主要内容",-1))]),_:1}),t(c,{label:"任务描述",prop:"description"},{default:r(()=>[t(o,{modelValue:s.value.description,"onUpdate:modelValue":e[5]||(e[5]=l=>s.value.description=l),type:"textarea",rows:6,placeholder:"请详细描述任务的具体要求、步骤和注意事项"},null,8,["modelValue"]),e[26]||(e[26]=m("div",{class:"form-tip"},"详细描述任务的具体要求、执行步骤和相关注意事项",-1))]),_:1}),t(c,{label:"优先级",prop:"priority"},{default:r(()=>[t(v,{modelValue:s.value.priority,"onUpdate:modelValue":e[6]||(e[6]=l=>s.value.priority=l),placeholder:"请选择任务优先级",style:{width:"100%"}},{default:r(()=>[t(u,{label:"低",value:"low"}),t(u,{label:"中",value:"medium"}),t(u,{label:"高",value:"high"}),t(u,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"状态",prop:"status"},{default:r(()=>[t(v,{modelValue:s.value.status,"onUpdate:modelValue":e[7]||(e[7]=l=>s.value.status=l),placeholder:"请选择任务状态",style:{width:"100%"}},{default:r(()=>[t(u,{label:"待完成",value:"pending"}),t(u,{label:"进行中",value:"in_progress"}),t(u,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"截止日期",prop:"due_date"},{default:r(()=>[t(T,{modelValue:s.value.due_date,"onUpdate:modelValue":e[8]||(e[8]=l=>s.value.due_date=l),type:"date",placeholder:"选择截止日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),k.value?(b(),C(c,{key:0,label:"指派给",prop:"assigned_to"},{default:r(()=>[t(v,{modelValue:s.value.assigned_to,"onUpdate:modelValue":e[9]||(e[9]=l=>s.value.assigned_to=l),placeholder:"请选择用户(支持模糊搜索)",filterable:"",style:{width:"100%"}},{default:r(()=>[(b(!0),E(K,null,W(A.value,l=>(b(),C(u,{filterable:"",key:l.user_id,label:l.full_name,value:l.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):N("",!0),t(c,{label:"创建人"},{default:r(()=>[t(o,{"model-value":Z.value,disabled:""},null,8,["model-value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),t(Q,{title:"批量指派任务",modelValue:z.value,"onUpdate:modelValue":e[18]||(e[18]=l=>z.value=l),width:"40%","close-on-click-modal":!1},{footer:r(()=>[m("span",Ae,[t(f,{onClick:e[17]||(e[17]=l=>z.value=!1)},{default:r(()=>e[32]||(e[32]=[i("取消")])),_:1}),t(f,{type:"primary",onClick:pe,loading:D.value},{default:r(()=>e[33]||(e[33]=[i("确定")])),_:1},8,["loading"])])]),default:r(()=>[t(J,{model:n.value,rules:te,ref_key:"assignFormRef",ref:O,"label-width":"80px"},{default:r(()=>[t(c,{label:"任务名称",prop:"title"},{default:r(()=>[t(o,{modelValue:n.value.title,"onUpdate:modelValue":e[12]||(e[12]=l=>n.value.title=l),placeholder:"请输入任务名称"},null,8,["modelValue"]),e[29]||(e[29]=m("div",{class:"form-tip"},"请简要描述任务的主要内容",-1))]),_:1}),t(c,{label:"任务描述",prop:"description"},{default:r(()=>[t(o,{modelValue:n.value.description,"onUpdate:modelValue":e[13]||(e[13]=l=>n.value.description=l),type:"textarea",rows:6,placeholder:"请详细描述任务的具体要求、步骤和注意事项"},null,8,["modelValue"]),e[30]||(e[30]=m("div",{class:"form-tip"},"详细描述任务的具体要求、执行步骤和相关注意事项",-1))]),_:1}),t(c,{label:"优先级",prop:"priority"},{default:r(()=>[t(v,{modelValue:n.value.priority,"onUpdate:modelValue":e[14]||(e[14]=l=>n.value.priority=l),placeholder:"请选择任务优先级",style:{width:"100%"}},{default:r(()=>[t(u,{label:"低",value:"low"}),t(u,{label:"中",value:"medium"}),t(u,{label:"高",value:"high"}),t(u,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"截止日期",prop:"due_date"},{default:r(()=>[t(T,{modelValue:n.value.due_date,"onUpdate:modelValue":e[15]||(e[15]=l=>n.value.due_date=l),type:"date",placeholder:"选择截止日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(c,{label:"指派给",prop:"assigned_to"},{default:r(()=>[t(v,{modelValue:n.value.assigned_to,"onUpdate:modelValue":e[16]||(e[16]=l=>n.value.assigned_to=l),placeholder:"请选择用户(支持模糊搜索)",filterable:"",multiple:"",style:{width:"100%"}},{default:r(()=>[(b(!0),E(K,null,W(A.value,l=>(b(),C(u,{filterable:"",key:l.user_id,label:l.full_name,value:l.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[31]||(e[31]=m("div",{class:"form-tip"},"可以选择多个用户进行批量指派",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])])}}}),Ge=Ce(Re,[["__scopeId","data-v-f86be89a"]]);export{Ge as default};
