import{E as b,s as Ce,c as le}from"./elementPlus-Dv7g5dxn.js";import{u as Ne,h as ze,B as Ue,b as Ee,a as C,s as Ie,_ as Ae}from"./index-BlOdscL-.js";import{x as Be,X as se,c as N,r as d,j as Te,y as m,P as s,A as l,H as o,ag as c,G as k,u as $e,L as r,I as Pe,aq as Le,M as u,J as V,z as i}from"./vendor-COQJj1AX.js";import"./supabase-Bqqw4QDB.js";const Re={class:"layout"},Me={class:"layout-title"},We={class:"status-tabs"},Fe={class:"training-content"},Oe={class:"card-header"},je={class:"header-actions"},qe={style:{"font-size":"14px",color:"#909399"}},Ge={class:"dialog-content"},He={class:"note-details"},Je={class:"note-header"},Qe={class:"note-title"},Xe={class:"note-meta"},Ke={class:"meta-item"},Ye={class:"meta-item"},Ze={class:"meta-item"},et={class:"note-section"},tt={class:"note-content"},at={key:0,class:"note-section"},lt={class:"attachment-box"},st={class:"attachment-name"},nt={key:1,class:"note-section"},ot={class:"previous-reply"},it={class:"reply-header"},rt={class:"reply-author"},ut={class:"admin-reply-content"},dt={key:0,class:"reply-timestamp"},ct={class:"reply-actions"},pt={key:2,class:"note-section"},mt={class:"section-title"},vt={class:"dialog-footer"},_t={class:"attachment-preview"},ft=["src"],yt=["src"],gt=["src"],ht={key:3,class:"attachment-download"},wt={class:"fullscreen-preview"},bt=["src"],kt=["src"],Vt=Be({__name:"AdminStudyNotes",setup(xt){const ne=se([{name:"数据管理",path:"/system/data"},{name:"学习心得",path:"/system/admin-study-notes"}]),M=Ne(),oe=N(()=>ze(Number(M.roleId))),ie=N(()=>Number(M.roleId)===0),A=d(!1),W=d([]),S=d(!1),a=d(null),B=d(""),_=d([]),g=d(""),T=d(!1),z=d(!1),U=d("all"),x=d(!1),$=d(!1),F=d(""),re=[{text:"Last week",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"Last month",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"Last 3 months",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],y=se({page:1,pageSize:10,total:0}),ue=t=>{y.page=t.page,y.pageSize=t.pageSize,h()},h=async()=>{A.value=!0,console.log(_.value);const t=_.value!=null&&_.value[0]!=null?_.value[0].toDateString():"",e=_.value!=null&&_.value[1]!=null?_.value[1].toDateString():"";try{const f=await C.searchNotesUsingView(B.value,{startDate:t,endDate:e,page:y.page,pageSize:y.pageSize,replyStatus:U.value});W.value=f.data,y.total=f.total}catch{b.error("搜索笔记失败")}finally{A.value=!1}},de=t=>{S.value=!0,a.value=t,g.value="",x.value=!1},ce=()=>{var t;x.value=!0,g.value=((t=a.value)==null?void 0:t.admin_reply)||""},pe=()=>{S.value=!1,x.value=!1,g.value=""},me=async t=>{var e;try{await le.confirm(`确定要删除用户 ${((e=t.profile)==null?void 0:e.full_name)||"未知用户"} 的这条笔记吗？`,"提示",{type:"warning"}),await C.deleteNote(t.note_id),b.success("删除成功"),h()}catch(f){f!=="cancel"&&b.error("删除失败")}},w=d([]),ve=t=>{w.value=t},_e=async()=>{if(w.value.length!==0)try{await le.confirm(`确定要删除选中的 ${w.value.length} 条学习心得吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=w.value.map(e=>C.deleteNote(e.note_id));await Promise.all(t),b.success(`成功删除 ${w.value.length} 条学习心得`),w.value=[],h()}catch(t){t!=="cancel"&&(console.error("批量删除学习心得失败:",t),b.error("批量删除失败"))}},E=N(()=>{var t;return(t=a.value)!=null&&t.attachment_type?a.value.attachment_type.startsWith("image/"):!1}),I=N(()=>{var t;return(t=a.value)!=null&&t.attachment_type?a.value.attachment_type==="application/pdf":!1}),P=N(()=>{var t;return(t=a.value)!=null&&t.attachment_type?a.value.attachment_type==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||a.value.attachment_type==="application/msword":!1}),fe=()=>{var t;(t=a.value)!=null&&t.attachment_url&&(P.value&&(F.value=`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(a.value.attachment_url)}`),z.value=!0)},ye=()=>{var t;(t=a.value)!=null&&t.attachment_url&&window.open(a.value.attachment_url,"_blank")},O=()=>{$.value=!0},ge=async()=>{if(a.value){T.value=!0;try{const{data:t}=await Ie.auth.getUser();if(!t.user)throw new Error("用户未登录");if(console.log("正在更新笔记，ID:",a.value.note_id),!await C.checkNoteExists(a.value.note_id))throw new Error(`笔记不存在: ${a.value.note_id}`);await C.updateNoteWithReply(a.value.note_id,{admin_reply:g.value,admin_id:t.user.id,replied_at:new Date().toISOString()}),b.success("回复已提交"),a.value&&(a.value.admin_reply=g.value,a.value.admin_id=t.user.id,a.value.replied_at=new Date().toISOString()),h(),S.value=!1,x.value=!1}catch(t){console.error("提交回复失败:",t),b.error("提交回复失败: "+(t instanceof Error?t.message:"未知错误"))}finally{T.value=!1}}},he=t=>{U.value=t,y.page=1,h()};return Te(()=>{h()}),(t,e)=>{const f=c("el-tab-pane"),we=c("el-tabs"),j=c("el-input"),be=c("el-date-picker"),p=c("el-button"),ke=c("el-space"),q=c("el-card"),L=c("el-tag"),G=c("el-tooltip"),D=c("el-table-column"),Ve=c("el-button-group"),H=c("el-empty"),xe=c("el-table"),R=c("el-dialog"),De=Le("loading");return i(),m("div",Re,[s(Ue,{breadbcrum:ne},null,8,["breadbcrum"]),l("div",Me,[e[8]||(e[8]=l("h1",{class:"title"},"学习心得",-1)),l("div",We,[s(we,{class:"demo-tabs",modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=n=>U.value=n),onTabChange:he},{default:o(()=>[s(f,{name:"all",label:"全部心得"}),s(f,{name:"replied",label:"已回复"}),s(f,{name:"pending",label:"待回复"})]),_:1},8,["modelValue"])])]),s(q,{shadow:"always",style:{"margin-bottom":"20px"}},{default:o(()=>[s(ke,{alignment:"start",size:30},{default:o(()=>[s(j,{modelValue:B.value,"onUpdate:modelValue":e[1]||(e[1]=n=>B.value=n),style:{width:"240px"},placeholder:"请输入提交人或标题","suffix-icon":$e(Ce),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),s(be,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=n=>_.value=n),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:re,size:"large"},null,8,["modelValue"]),s(p,{type:"primary",size:"large",onClick:h},{default:o(()=>e[9]||(e[9]=[r("搜索")])),_:1})]),_:1})]),_:1}),l("div",Fe,[oe.value?(i(),k(q,{key:0,style:{"min-height":"400px"}},{header:o(()=>[l("div",Oe,[l("div",null,[e[12]||(e[12]=l("span",null,"学习心得管理",-1)),ie.value?(i(),k(G,{key:0,content:"您可以查看所有学习心得",placement:"right"},{default:o(()=>[s(L,{type:"success",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[10]||(e[10]=[r("全部")])),_:1})]),_:1})):(i(),k(G,{key:1,content:"您只能查看本组织的学习心得",placement:"right"},{default:o(()=>[s(L,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:o(()=>e[11]||(e[11]=[r("本组织")])),_:1})]),_:1}))]),l("div",je,[s(p,{type:"danger",disabled:!w.value.length,onClick:_e},{default:o(()=>e[13]||(e[13]=[r(" 批量删除 ")])),_:1},8,["disabled"]),l("div",qe,"共计"+u(y.total)+"条数据",1)])])]),default:o(()=>[Pe((i(),k(xe,{data:W.value,onSelectionChange:ve},{default:o(()=>[s(D,{type:"selection",width:"55"}),s(D,{prop:"profile.full_name",label:"提交人"}),s(D,{prop:"title",label:"标题"}),s(D,{prop:"admin_reply",label:"状态"},{default:o(({row:n})=>[s(L,{style:{"font-size":"14px"},type:n.admin_reply?"success":"warning",size:"large"},{default:o(()=>[r(u(n.admin_reply?"已回复":"待回复"),1)]),_:2},1032,["type"])]),_:1}),s(D,{prop:"note_created_at",label:"创建时间"},{default:o(({row:n})=>[r(u(new Date(n.note_created_at).toLocaleString()),1)]),_:1}),s(D,{label:"操作",width:"150",fixed:"right"},{default:o(({row:n})=>[s(Ve,null,{default:o(()=>[s(p,{type:"primary",onClick:v=>de(n)},{default:o(()=>e[14]||(e[14]=[r("查看")])),_:2},1032,["onClick"]),s(p,{type:"danger",onClick:v=>me(n)},{default:o(()=>e[15]||(e[15]=[r("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),s(H,null,{description:o(()=>e[16]||(e[16]=[r(" 暂无学习心得 ")])),_:1})]),_:1},8,["data"])),[[De,A.value]])]),_:1})):(i(),k(H,{key:1,description:"您没有权限查看所有笔记"})),s(Ee,{pagination:y,"onUpdate:pagination":ue},null,8,["pagination"]),s(R,{title:"学习心得详情",modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=n=>S.value=n),width:"60%","close-on-click-modal":!1,top:"5vh",class:"note-detail-dialog"},{footer:o(()=>[l("span",vt,[s(p,{onClick:pe},{default:o(()=>e[24]||(e[24]=[r("取消")])),_:1}),s(p,{type:"primary",onClick:ge,loading:T.value},{default:o(()=>{var n;return[r(u((n=a.value)!=null&&n.admin_reply?"更新回复":"提交回复"),1)]}),_:1},8,["loading"])])]),default:o(()=>{var n,v,J,Q,X,K,Y,Z,ee,te,ae;return[l("div",Ge,[l("div",He,[l("div",Je,[l("h2",Qe,u(((n=a.value)==null?void 0:n.title)||"无标题"),1),l("div",Xe,[l("span",Ke,[e[17]||(e[17]=l("i",{class:"el-icon-user"},null,-1)),l("span",null,u(((J=(v=a.value)==null?void 0:v.profile)==null?void 0:J.full_name)||"未知用户"),1)]),l("span",Ye,[e[18]||(e[18]=l("i",{class:"el-icon-message"},null,-1)),l("span",null,u(((X=(Q=a.value)==null?void 0:Q.profile)==null?void 0:X.email)||"无邮箱"),1)]),l("span",Ze,[e[19]||(e[19]=l("i",{class:"el-icon-time"},null,-1)),l("span",null,u(a.value?new Date((K=a.value)==null?void 0:K.note_created_at).toLocaleString():"未知时间"),1)])])]),l("div",et,[e[20]||(e[20]=l("div",{class:"section-title"},"内容",-1)),l("div",tt,u(((Y=a.value)==null?void 0:Y.content)||"无内容"),1)]),(Z=a.value)!=null&&Z.attachment_url?(i(),m("div",at,[e[21]||(e[21]=l("div",{class:"section-title"},"附件",-1)),l("div",lt,[l("span",st,u(a.value.attachment_name),1),s(p,{type:"primary",size:"small",onClick:fe},{default:o(()=>[r(u(E.value?"预览图片":I.value?"预览PDF":P.value?"预览Word":"查看附件"),1)]),_:1})])])):V("",!0),(ee=a.value)!=null&&ee.admin_reply?(i(),m("div",nt,[e[23]||(e[23]=l("div",{class:"section-title"},"历史回复",-1)),l("div",ot,[l("div",it,[l("span",rt,u(a.value.admin_name||"未知")+":",1)]),l("div",ut,u(a.value.admin_reply),1),a.value.replied_at?(i(),m("div",dt,u(new Date(a.value.replied_at).toLocaleString()),1)):V("",!0),l("div",ct,[x.value?V("",!0):(i(),k(p,{key:0,type:"primary",size:"small",onClick:ce},{default:o(()=>e[22]||(e[22]=[r(" 修改回复 ")])),_:1}))])])])):V("",!0),!((te=a.value)!=null&&te.admin_reply)||x.value?(i(),m("div",pt,[l("div",mt,u((ae=a.value)!=null&&ae.admin_reply?"修改回复":"添加回复"),1),s(j,{type:"textarea",modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=Se=>g.value=Se),rows:4,placeholder:"请输入您的回复内容...",class:"reply-input"},null,8,["modelValue"])])):V("",!0)])])]}),_:1},8,["modelValue"]),s(R,{modelValue:z.value,"onUpdate:modelValue":e[6]||(e[6]=n=>z.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{footer:o(()=>[s(p,{onClick:e[5]||(e[5]=n=>z.value=!1)},{default:o(()=>e[27]||(e[27]=[r("关闭")])),_:1}),E.value||I.value?(i(),k(p,{key:0,type:"primary",onClick:O},{default:o(()=>e[28]||(e[28]=[r(" 全屏查看 ")])),_:1})):V("",!0)]),default:o(()=>{var n,v;return[l("div",_t,[E.value?(i(),m("img",{key:0,src:(n=a.value)==null?void 0:n.attachment_url,class:"attachment-image",onClick:O},null,8,ft)):I.value?(i(),m("iframe",{key:1,src:(v=a.value)==null?void 0:v.attachment_url,class:"attachment-frame"},null,8,yt)):P.value?(i(),m("iframe",{key:2,src:F.value,class:"word-preview-frame"},null,8,gt)):(i(),m("div",ht,[e[26]||(e[26]=l("p",null,"无法预览此类型的文件，请下载后查看",-1)),s(p,{type:"primary",onClick:ye},{default:o(()=>e[25]||(e[25]=[r("下载附件")])),_:1})]))])]}),_:1},8,["modelValue"]),s(R,{modelValue:$.value,"onUpdate:modelValue":e[7]||(e[7]=n=>$.value=n),title:"全屏预览",width:"100%",top:"0","show-close":!0,"destroy-on-close":"",class:"fullscreen-dialog"},{default:o(()=>{var n,v;return[l("div",wt,[E.value?(i(),m("img",{key:0,src:(n=a.value)==null?void 0:n.attachment_url,class:"fullscreen-image"},null,8,bt)):I.value?(i(),m("iframe",{key:1,src:(v=a.value)==null?void 0:v.attachment_url,class:"fullscreen-frame"},null,8,kt)):V("",!0)])]}),_:1},8,["modelValue"])])])}}}),zt=Ae(Vt,[["__scopeId","data-v-52df9d5b"]]);export{zt as default};
