import{x as le,r as g,c as ne,j as se,y as j,A as n,P as l,H as a,ag as c,u as m,L as r,I as re,G as U,J as O,aq as ie,M as p,V as $,aA as de,z as F}from"./vendor-CcmhhHhJ.js";import{E as u,M as ue,J as ce,s as pe,f as fe,H as me,I as ge,C as _e,t as ve,c as we}from"./elementPlus-Be5V1zcU.js";import{s as _,b as he}from"./index-Dg6Dv2jL.js";import"./supabase-fOlwtt9p.js";const ye={class:"word-file-manager"},be={class:"toolbar"},Ce={class:"toolbar-left"},xe={class:"toolbar-right"},ke={class:"card-header"},ze={class:"file-name"},Fe={class:"name-text"},De={class:"upload-content"},Me={key:0,class:"file-info"},$e=le({__name:"WordFileManager",setup(Ee){const R=de(),v=g(!1),D=g(!1),w=g(!1),C=g(""),x=g([]),E=g([]),i=g(null),M=ne(()=>C.value?x.value.filter(o=>o.name.toLowerCase().includes(C.value.toLowerCase())):x.value),q={年:"nian",月:"yue",日:"ri",培训:"peixun",流程:"liucheng",手册:"shouce",文档:"wendang",资料:"ziliao",教程:"jiaocheng",指南:"zhinan",说明:"shuoming",报告:"baogao",总结:"zongjie",计划:"jihua",方案:"fangan",优化:"youhua",师:"shi",Google:"google",百度:"baidu",腾讯:"tencent",阿里:"ali",测试:"ceshi",开发:"kaifa",设计:"sheji",产品:"chanpin",运营:"yunying",市场:"shichang",销售:"xiaoshou",客服:"kefu",技术:"jishu",管理:"guanli",财务:"caiwu",人事:"renshi",行政:"xingzheng"},G={年:"year",月:"month",日:"day",培训:"training",流程:"process",手册:"manual",文档:"document",资料:"material",教程:"tutorial",指南:"guide",说明:"instruction",报告:"report",总结:"summary",计划:"plan",方案:"solution",优化:"optimization",师:"specialist",Google:"google",百度:"baidu",腾讯:"tencent",阿里:"alibaba",测试:"test",开发:"development",设计:"design",产品:"product",运营:"operation",市场:"market",销售:"sales",客服:"customer_service",技术:"technology",管理:"management",财务:"finance",人事:"hr",行政:"administration"},I=o=>{if(!o)return"untitled";let e=o;for(const[t,d]of Object.entries(G))e=e.replace(new RegExp(t,"g"),d);for(const[t,d]of Object.entries(q))e=e.replace(new RegExp(t,"g"),d);return e=e.replace(/[\u4e00-\u9fff]/g,t=>`char_${t.charCodeAt(0)}`),e},P=o=>{if(!o)return"untitled";let t=I(o).replace(/[^\w\s\-_.]/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"").toLowerCase().substring(0,100);return(!t||t.trim()==="")&&(t="untitled"),t},S=o=>o?o.includes("wordprocessingml")?"DOCX":o.includes("msword")?"DOC":o.includes("pdf")?"PDF":o.includes("text")?"TXT":o.toUpperCase():"UNKNOWN",A=o=>{const e=["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(o.type),t=o.size/1024/1024<50;return e?t?!0:(u.error("文件大小不能超过 50MB！"),!1):(u.error("只支持 Word 文档格式！"),!1)},K=o=>{o.raw&&(i.value=o.raw)},H=async()=>{if(!i.value){u.warning("请先选择要上传的文件");return}D.value=!0;try{const o=Date.now(),e=i.value.name,t=e.split(".").pop(),d=P(e.replace(/\.[^/.]+$/,"")),h=`${o}-${d}.${t}`;console.log("原始文件名:",e),console.log("转译后文件名:",d),console.log("最终存储文件名:",h);const{data:y,error:b}=await _.storage.from("documents").upload(`word-files/${h}`,i.value);if(b)throw b;const{data:f}=_.storage.from("documents").getPublicUrl(y.path),{data:L,error:z}=await _.from("word_files").insert({name:e,original_name:e,file_path:y.path,public_url:f.publicUrl,file_size:i.value.size,file_type:i.value.type,mime_type:i.value.type}).select().single();if(z)throw z;e!==d+"."+t?u.success("文件上传成功！文件名已转译"):u.success("文件上传成功！"),w.value=!1,i.value=null,E.value=[],await k()}catch(o){console.error("上传失败:",o),u.error(`上传失败: ${o.message}`)}finally{D.value=!1}},k=async()=>{v.value=!0;try{const{data:o,error:e}=await _.from("word_files").select("*").order("created_at",{ascending:!1});if(e)throw e;console.log("加载的文件列表:",o),x.value=o||[],console.log("设置的文件列表:",x.value)}catch(o){console.error("加载文件列表失败:",o),u.error("加载文件列表失败")}finally{v.value=!1}},V=o=>{R.push({name:"word-viewer",params:{id:o.id},query:{url:o.public_url,name:o.name}})},J=o=>{V(o)},T=async o=>{try{const e=document.createElement("a");e.href=o.public_url,e.download=o.name,document.body.appendChild(e),e.click(),document.body.removeChild(e),u.success("文件下载开始")}catch(e){console.error("下载失败:",e),u.error("下载失败")}},X=async o=>{try{await we.confirm(`确定要删除文件 "${o.name}" 吗？`,"警告",{type:"warning"});const{error:e}=await _.storage.from("documents").remove([o.file_path]);e&&console.warn("删除存储文件失败:",e);const{error:t}=await _.from("word_files").delete().eq("id",o.id);if(t)throw t;u.success("文件删除成功"),await k()}catch(e){e!=="cancel"&&(console.error("删除失败:",e),u.error("删除失败"))}},Q=()=>{},Y=async()=>{await k()},B=o=>{if(o===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],d=Math.floor(Math.log(o)/Math.log(e));return parseFloat((o/Math.pow(e,d)).toFixed(2))+" "+t[d]},N=o=>o?new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",Z=async()=>{try{console.log("测试数据库连接...");const{data:o,error:e}=await _.from("word_files").select("count").limit(1);e?(console.error("数据库连接测试失败:",e),u.error(`数据库连接失败: ${e.message}`)):console.log("数据库连接成功")}catch(o){console.error("数据库连接测试异常:",o)}};return se(()=>{Z(),k()}),(o,e)=>{const t=c("el-button"),d=c("el-input"),h=c("el-card"),y=c("el-tag"),b=c("el-icon"),f=c("el-table-column"),L=c("el-button-group"),z=c("el-table"),ee=c("el-empty"),oe=c("el-upload"),te=c("el-dialog"),ae=ie("loading");return F(),j("div",ye,[e[18]||(e[18]=n("div",{class:"page-header"},[n("h1",{class:"page-title"},"Word文件管理"),n("p",{class:"page-subtitle"},"上传和管理Word文档，支持在线查看和编辑")],-1)),l(h,{class:"toolbar-card",shadow:"always"},{default:a(()=>[n("div",be,[n("div",Ce,[l(t,{type:"primary",onClick:e[0]||(e[0]=s=>w.value=!0),icon:m(ue)},{default:a(()=>e[4]||(e[4]=[r(" 上传Word文件 ")])),_:1},8,["icon"]),l(t,{onClick:Y,icon:m(ce),loading:v.value},{default:a(()=>e[5]||(e[5]=[r(" 刷新列表 ")])),_:1},8,["icon","loading"])]),n("div",xe,[l(d,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=s=>C.value=s),placeholder:"搜索文件名...","prefix-icon":m(pe),clearable:"",style:{width:"300px"},onInput:Q},null,8,["modelValue","prefix-icon"])])])]),_:1}),l(h,{class:"file-list-card",shadow:"always"},{header:a(()=>[n("div",ke,[e[6]||(e[6]=n("span",null,"文件列表",-1)),l(y,{type:"info"},{default:a(()=>[r(p(M.value.length)+" 个文件",1)]),_:1})])]),default:a(()=>[re((F(),U(z,{data:M.value,style:{width:"100%"},onRowClick:J,"row-class-name":"file-row"},{default:a(()=>[l(f,{label:"",width:"60"},{default:a(({row:s})=>[l(b,{size:24,color:"#1890ff"},{default:a(()=>[l(m(fe))]),_:1})]),_:1}),l(f,{prop:"name",label:"文件名","min-width":"200"},{default:a(({row:s})=>[n("div",ze,[n("span",Fe,p(s.name),1),l(y,{size:"small",type:"success"},{default:a(()=>[r(p(S(s.file_type)),1)]),_:2},1024)])]),_:1}),l(f,{prop:"file_size",label:"文件大小",width:"120"},{default:a(({row:s})=>[r(p(B(s.file_size)),1)]),_:1}),l(f,{prop:"created_at",label:"上传时间",width:"180"},{default:a(({row:s})=>[r(p(N(s.created_at)),1)]),_:1}),l(f,{prop:"updated_at",label:"最后修改",width:"180"},{default:a(({row:s})=>[r(p(N(s.updated_at)),1)]),_:1}),l(f,{label:"操作",width:"200",fixed:"right"},{default:a(({row:s})=>[l(L,null,{default:a(()=>[l(t,{type:"primary",size:"small",onClick:$(W=>V(s),["stop"]),icon:m(me)},{default:a(()=>e[7]||(e[7]=[r(" 打开 ")])),_:2},1032,["onClick","icon"]),l(t,{type:"success",size:"small",onClick:$(W=>T(s),["stop"]),icon:m(ge)},{default:a(()=>e[8]||(e[8]=[r(" 下载 ")])),_:2},1032,["onClick","icon"]),l(t,{type:"danger",size:"small",onClick:$(W=>X(s),["stop"]),icon:m(_e)},{default:a(()=>e[9]||(e[9]=[r(" 删除 ")])),_:2},1032,["onClick","icon"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ae,v.value]]),!v.value&&M.value.length===0?(F(),U(ee,{key:0,description:"暂无文件"})):O("",!0)]),_:1}),l(te,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=s=>w.value=s),title:"上传Word文件",width:"600px","close-on-click-modal":!1},{footer:a(()=>[l(t,{onClick:e[2]||(e[2]=s=>w.value=!1)},{default:a(()=>e[16]||(e[16]=[r("取消")])),_:1}),l(t,{type:"primary",onClick:H,loading:D.value,disabled:!i.value},{default:a(()=>e[17]||(e[17]=[r(" 上传文件 ")])),_:1},8,["loading","disabled"])]),default:a(()=>[n("div",De,[l(oe,{class:"upload-dragger",drag:"","auto-upload":!1,"on-change":K,"file-list":E.value,limit:1,accept:".doc,.docx","before-upload":A},{tip:a(()=>e[10]||(e[10]=[n("div",{class:"el-upload__tip"}," 支持 .doc 和 .docx 格式，文件大小不超过 50MB ",-1)])),default:a(()=>[l(b,{class:"el-icon--upload"},{default:a(()=>[l(m(ve))]),_:1}),e[11]||(e[11]=n("div",{class:"el-upload__text"},[r(" 将Word文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"]),i.value?(F(),j("div",Me,[e[15]||(e[15]=n("h4",null,"文件信息",-1)),n("p",null,[e[12]||(e[12]=n("strong",null,"文件名:",-1)),r(" "+p(i.value.name),1)]),n("p",null,[e[13]||(e[13]=n("strong",null,"文件大小:",-1)),r(" "+p(B(i.value.size)),1)]),n("p",null,[e[14]||(e[14]=n("strong",null,"文件类型:",-1)),r(" "+p(i.value.type),1)])])):O("",!0)])]),_:1},8,["modelValue"])])}}}),We=he($e,[["__scopeId","data-v-ff394309"]]);export{We as default};
