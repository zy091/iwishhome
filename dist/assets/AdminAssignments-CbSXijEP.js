import{E as g,s as dt,F as se,t as ze,o as Ae,c as Ce}from"./elementPlus-Be5V1zcU.js";import{a as $}from"./assignmentService-IqRFsYqw.js";import{u as ct,B as mt,e as pt,s as Q,b as vt}from"./index-C9Sfkt3t.js";import{x as ft,X as Re,c as X,r as d,j as _t,y,P as l,A as s,H as a,ag as p,G as V,u as E,L as c,I as Ue,aq as gt,M as _,O as Se,a6 as Fe,J as W,D as yt,z as m}from"./vendor-CcmhhHhJ.js";import"./supabase-fOlwtt9p.js";const ht={class:"layout"},bt={class:"layout-title"},wt={class:"status-tabs"},xt={class:"assignments-content"},kt={class:"card-header"},Vt={class:"header-actions"},Dt={style:{"font-size":"14px",color:"#909399"}},zt={class:"tooltip-content"},At={class:"text-truncate"},Ct={key:1},Rt={class:"form-tip"},Ut={key:0,class:"assignment-details"},St={class:"details-header"},Ft={class:"detail-item"},$t={class:"detail-item"},Bt={class:"detail-item"},It={class:"detail-item"},Mt={class:"content"},Et={key:0,class:"attachment-section"},Pt={class:"attachment-box"},Tt={class:"attachment-name"},Nt={key:1,class:"replies"},qt={key:0,class:"reply-attachment"},Lt={class:"attachment-name"},Ot={class:"reply-time"},jt={key:2,class:"action-buttons"},Wt={class:"attachment-preview"},Gt=["src"],Ht=["src"],Jt={key:2,class:"attachment-download"},Qt=ft({__name:"AdminAssignments",setup(Xt){const $e=Re([{name:"数据管理",path:"/system/data-management"},{name:"作业管理",path:"/system/assignments"}]),ne=ct(),Be=X(()=>{const t=Number(ne.roleId);return t===0||t===1||t===11||t===15}),oe=X(()=>Number(ne.roleId)===0),K=d(!1),Y=d(!1),G=d("all");d("all");const Z=d(""),D=d([]),P=d([]),ie=d([]),T=d(!1),N=d(!1),H=d(!1),q=d(!1),r=d(null),R=d([]),U=d(""),S=d(""),re=d([]),F=d(null),ee=d([]),z=d(null),Ie=[{text:"最近一周",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近一个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近三个月",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3*24*90),[e,t]}}],w=Re({page:1,pageSize:10,total:0}),Me={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}],assigned_to:[{required:!0,message:"请选择指定人员",trigger:"change"}]},Ee={content:[{required:!0,message:"请输入回复内容",trigger:"blur"}]},x=d({title:"",content:"",assigned_to:void 0}),L=d({assignment_id:"",user_id:"",content:"",full_name:""}),te=d(),le=d(),Pe=X(()=>S.value?S.value.startsWith("image/"):!1),Te=X(()=>S.value?S.value==="application/pdf":!1),ue=t=>t.size/1024/1024<10?!0:(g.error("文件大小不能超过 10MB!"),!1),Ne=async t=>{const{file:e,onSuccess:u,onError:o}=t;if(!e){o==null||o(new Error("文件不存在"));return}const v=Ae.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const i=e,f=i.name.split(".").pop(),I=`assignments/${`${Math.random().toString(36).substring(2,15)}_${Date.now()}.${f}`}`,{data:C,error:k}=await Q.storage.from("attachments").upload(I,i,{cacheControl:"3600",upsert:!1});if(k)throw k;const{data:{publicUrl:h}}=Q.storage.from("attachments").getPublicUrl(C.path);F.value={url:h,name:i.name,type:i.type},u==null||u(F.value),g.success("文件上传成功")}catch(i){console.error("文件上传错误:",i),o==null||o(new Error(i instanceof Error?i.message:"上传失败")),g.error("文件上传失败，请重试")}finally{v.close()}},qe=()=>{F.value=null},Le=t=>{t.attachment_url&&(U.value=t.attachment_url,S.value=t.attachment_type||"",q.value=!0)},Oe=async t=>{const{file:e,onSuccess:u,onError:o}=t;if(!e){o==null||o(new Error("文件不存在"));return}const v=Ae.service({text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"});try{const i=e,f=i.name.split(".").pop(),I=`assignments/replies/${`reply_${Math.random().toString(36).substring(2,15)}_${Date.now()}.${f}`}`,{data:C,error:k}=await Q.storage.from("attachments").upload(I,i,{cacheControl:"3600",upsert:!1});if(k)throw k;const{data:{publicUrl:h}}=Q.storage.from("attachments").getPublicUrl(C.path);z.value={url:h,name:i.name,type:i.type},u==null||u(z.value),g.success("文件上传成功")}catch(i){console.error("文件上传错误:",i),o==null||o(new Error(i instanceof Error?i.message:"上传失败")),g.error("文件上传失败，请重试")}finally{v.close()}},je=()=>{z.value=null},We=t=>{t.attachment_url&&(U.value=t.attachment_url,S.value=t.attachment_type||"",q.value=!0)},Ge=()=>{var t;(t=r.value)!=null&&t.attachment_url&&(U.value=r.value.attachment_url,S.value=r.value.attachment_type||"",q.value=!0)},He=()=>{U.value&&window.open(U.value,"_blank")},A=async()=>{K.value=!0;try{const t=D.value&&D.value[0]?D.value[0].toISOString():void 0,e=D.value&&D.value[1]?D.value[1].toISOString():void 0,{data:u,total:o}=await $.getAssignments(w.page,w.pageSize,{query:Z.value,startDate:t,endDate:e,status:"all"});G.value==="replied"?P.value=u.filter(v=>B(v).text==="已完成并已回复"):G.value==="pending"?P.value=u.filter(v=>{const i=B(v);return i.text==="待完成"||i.text==="已完成待回复"||i.text==="管理员已回复待完成"||i.text==="待回复"}):P.value=u,w.total=P.value.length}catch(t){console.error("获取作业列表失败:",t),g.error("获取作业列表失败")}finally{K.value=!1}},Je=async()=>{try{const t=await $.getOrganizationMembers();ie.value=t}catch(t){console.error("获取组织成员失败:",t),g.error("获取组织成员失败")}},Qe=()=>{T.value=!0,x.value={title:"",content:"",assigned_to:void 0},re.value=[],F.value=null},Xe=async()=>{te.value&&await te.value.validate(async t=>{var e,u,o;if(t)try{const v={...x.value,attachment_url:(e=F.value)==null?void 0:e.url,attachment_name:(u=F.value)==null?void 0:u.name,attachment_type:(o=F.value)==null?void 0:o.type};await $.createAssignment(v),g.success("布置作业成功"),T.value=!1,A()}catch(v){console.error("布置作业失败:",v),g.error("布置作业失败")}})},Ke=()=>{r.value&&(L.value={assignment_id:r.value.id||"",user_id:"",content:"",full_name:""},ee.value=[],z.value=null,N.value=!0)},Ye=async()=>{le.value&&await le.value.validate(async t=>{var e,u,o;if(t)try{const v={...L.value,attachment_url:((e=z.value)==null?void 0:e.url)||void 0,attachment_name:((u=z.value)==null?void 0:u.name)||void 0,attachment_type:((o=z.value)==null?void 0:o.type)||void 0};await $.addReply(v),g.success("回复成功"),N.value=!1,ee.value=[],z.value=null,A(),H.value&&r.value&&de(r.value)}catch(v){console.error("回复失败:",v),g.error("回复失败")}})},de=async t=>{Y.value=!0,r.value=t,H.value=!0;try{const e=await $.getAssignmentById(t.id||"");e&&(r.value=e)}catch(e){console.error("获取作业详情失败:",e)}finally{Y.value=!1}},ce=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",Ze=t=>{w.page=t.page,w.pageSize=t.pageSize,A()},et=t=>{w.page=1,A()},tt=()=>{w.page=1,A()},lt=t=>{R.value=t},at=async t=>{try{if(await Ce.confirm("确定要删除该作业吗？此操作不可恢复。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),!t.id)throw new Error("作业ID不存在");await $.deleteAssignment(t.id),g.success("删除成功"),A()}catch(e){e!=="cancel"&&(console.error("删除作业失败:",e),g.error("删除失败"))}},st=async()=>{if(R.value.length!==0)try{await Ce.confirm(`确定要删除选中的 ${R.value.length} 个作业吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=R.value.map(e=>e.id?$.deleteAssignment(e.id):Promise.resolve());await Promise.all(t),g.success(`成功删除 ${R.value.length} 个作业`),R.value=[],A()}catch(t){t!=="cancel"&&(console.error("批量删除作业失败:",t),g.error("批量删除失败"))}},B=t=>{if(!t||!t.replies||t.replies.length===0)return{type:"info",text:"待完成",hasAssigneeReply:!1};const e=t.replies.some(o=>o.user_id===t.assigned_to),u=t.replies.some(o=>o.user_id!==t.assigned_to);return e&&u?{type:"success",text:"已完成并已回复",hasAssigneeReply:!0}:e?{type:"warning",text:"已完成待回复",hasAssigneeReply:!0}:u?{type:"warning",text:"管理员已回复待完成",hasAssigneeReply:!1}:{type:"waring",text:"待回复",hasAssigneeReply:!1}};return _t(async()=>{await Promise.all([A(),Je()])}),(t,e)=>{const u=p("el-tab-pane"),o=p("el-tabs"),v=p("el-input"),i=p("el-date-picker"),f=p("el-button"),ae=p("el-space"),I=p("el-card"),C=p("el-tag"),k=p("el-tooltip"),h=p("el-table-column"),O=p("el-icon"),nt=p("el-button-group"),me=p("el-empty"),ot=p("el-table"),M=p("el-form-item"),it=p("el-option"),rt=p("el-select"),pe=p("el-text"),ve=p("el-upload"),fe=p("el-form"),J=p("el-dialog"),ut=p("el-divider"),_e=gt("loading");return m(),y("div",ht,[l(mt,{breadbcrum:$e},null,8,["breadbcrum"]),s("div",bt,[e[13]||(e[13]=s("h1",{class:"title"},"作业管理",-1)),s("div",wt,[l(o,{class:"demo-tabs",modelValue:G.value,"onUpdate:modelValue":e[0]||(e[0]=n=>G.value=n),onTabChange:et},{default:a(()=>[l(u,{name:"all",label:"全部作业"}),l(u,{name:"replied",label:"已完成并已回复"}),l(u,{name:"pending",label:"待处理作业"})]),_:1},8,["modelValue"])])]),l(I,{shadow:"always",style:{"margin-bottom":"20px"}},{default:a(()=>[l(ae,{wrap:"",alignment:"start",size:30},{default:a(()=>[l(v,{modelValue:Z.value,"onUpdate:modelValue":e[1]||(e[1]=n=>Z.value=n),style:{width:"240px"},placeholder:"请输入作业标题或提交人","suffix-icon":E(dt),size:"large",clearable:""},null,8,["modelValue","suffix-icon"]),l(i,{modelValue:D.value,"onUpdate:modelValue":e[2]||(e[2]=n=>D.value=n),type:"daterange","unlink-panels":"","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",shortcuts:Ie,size:"large"},null,8,["modelValue"]),l(f,{type:"primary",size:"large",onClick:tt},{default:a(()=>e[14]||(e[14]=[c("搜索")])),_:1}),l(f,{type:"success",size:"large",onClick:Qe},{default:a(()=>e[15]||(e[15]=[c("布置作业")])),_:1})]),_:1})]),_:1}),s("div",xt,[Be.value?(m(),V(I,{key:0,style:{"min-height":"400px"}},{header:a(()=>[s("div",kt,[s("div",null,[e[18]||(e[18]=s("span",null,"作业列表",-1)),oe.value?(m(),V(k,{key:0,content:"您可以查看所有作业",placement:"right"},{default:a(()=>[l(C,{type:"success",size:"small",style:{"margin-left":"8px"}},{default:a(()=>e[16]||(e[16]=[c("全部")])),_:1})]),_:1})):(m(),V(k,{key:1,content:"您只能查看本组织的作业",placement:"right"},{default:a(()=>[l(C,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:a(()=>e[17]||(e[17]=[c("本组织")])),_:1})]),_:1}))]),s("div",Vt,[l(f,{type:"danger",disabled:!R.value.length,onClick:st},{default:a(()=>e[19]||(e[19]=[c(" 批量删除 ")])),_:1},8,["disabled"]),s("div",Dt,"共计"+_(w.total)+"条数据",1)])])]),default:a(()=>[Ue((m(),V(ot,{data:P.value,onSelectionChange:lt},{default:a(()=>[l(h,{type:"selection",width:"55"}),l(h,{prop:"title",label:"作业题目"},{default:a(({row:n})=>[l(k,{placement:"top","show-after":500,"max-width":300},{content:a(()=>[s("div",zt,_(n.title),1)]),default:a(()=>[s("div",At,_(n.title),1)]),_:2},1024)]),_:1}),l(h,{prop:"creator_profile.full_name",label:"创建人"}),l(h,{prop:"assignee_profile.full_name",label:"指定人员"}),l(h,{label:"附件",width:"80"},{default:a(({row:n})=>[n.attachment_url?(m(),V(f,{key:0,type:"primary",link:"",onClick:j=>We(n)},{default:a(()=>[l(O,{color:"#409EFF",size:"18"},{default:a(()=>[l(E(se))]),_:1})]),_:2},1032,["onClick"])):(m(),y("span",Ct,"-"))]),_:1}),l(h,{label:"回复状态"},{default:a(({row:n})=>[l(C,{size:"large",style:{"font-size":"14px"},type:B(n).type},{default:a(()=>[c(_(B(n).text),1)]),_:2},1032,["type"])]),_:1}),l(h,{prop:"created_at",label:"创建时间"},{default:a(({row:n})=>[c(_(ce(n.created_at)),1)]),_:1}),l(h,{label:"操作",width:"180",fixed:"right"},{default:a(({row:n})=>[l(nt,null,{default:a(()=>[l(f,{type:"primary",onClick:j=>de(n)},{default:a(()=>e[20]||(e[20]=[c("查看详情")])),_:2},1032,["onClick"]),l(f,{type:"danger",onClick:j=>at(n)},{default:a(()=>e[21]||(e[21]=[c("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),l(me,null,{description:a(()=>e[22]||(e[22]=[c(" 暂无作业记录 ")])),_:1})]),_:1},8,["data"])),[[_e,K.value]])]),_:1})):(m(),V(me,{key:1,description:"您没有权限查看作业列表"})),l(pt,{pagination:w,"onUpdate:pagination":Ze},null,8,["pagination"]),l(J,{modelValue:T.value,"onUpdate:modelValue":e[7]||(e[7]=n=>T.value=n),title:"布置作业",width:"600px"},{footer:a(()=>[l(f,{onClick:e[6]||(e[6]=n=>T.value=!1)},{default:a(()=>e[27]||(e[27]=[c("取消")])),_:1}),l(f,{type:"primary",onClick:Xe},{default:a(()=>e[28]||(e[28]=[c("确定")])),_:1})]),default:a(()=>[l(fe,{model:x.value,rules:Me,ref_key:"createForm",ref:te,"label-width":"80px"},{default:a(()=>[l(M,{label:"标题",prop:"title"},{default:a(()=>[l(v,{modelValue:x.value.title,"onUpdate:modelValue":e[3]||(e[3]=n=>x.value.title=n)},null,8,["modelValue"])]),_:1}),l(M,{label:"指定人员",prop:"assigned_to"},{default:a(()=>[l(rt,{modelValue:x.value.assigned_to,"onUpdate:modelValue":e[4]||(e[4]=n=>x.value.assigned_to=n),placeholder:"请选择"},{default:a(()=>[(m(!0),y(Se,null,Fe(ie.value,n=>(m(),V(it,{key:n.user_id,label:n.full_name,value:n.user_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s("div",Rt,[oe.value?(m(),V(pe,{key:0,type:"info",size:"small"},{default:a(()=>e[23]||(e[23]=[c("可选择所有用户")])),_:1})):(m(),V(pe,{key:1,type:"info",size:"small"},{default:a(()=>e[24]||(e[24]=[c("只显示本组织成员")])),_:1}))])]),_:1}),l(M,{label:"内容",prop:"content"},{default:a(()=>[l(v,{modelValue:x.value.content,"onUpdate:modelValue":e[5]||(e[5]=n=>x.value.content=n),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1}),l(M,{label:"附件"},{default:a(()=>[l(ve,{class:"upload-container",drag:"","auto-upload":!0,"http-request":Ne,"on-remove":qe,"before-upload":ue,limit:1,"file-list":re.value},{tip:a(()=>e[25]||(e[25]=[s("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[l(O,{class:"el-icon--upload"},{default:a(()=>[l(E(ze))]),_:1}),e[26]||(e[26]=s("div",{class:"el-upload__text"},[c(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(J,{modelValue:N.value,"onUpdate:modelValue":e[10]||(e[10]=n=>N.value=n),title:"回复作业",width:"600px"},{footer:a(()=>[l(f,{onClick:e[9]||(e[9]=n=>N.value=!1)},{default:a(()=>e[31]||(e[31]=[c("取消")])),_:1}),l(f,{type:"primary",onClick:Ye},{default:a(()=>e[32]||(e[32]=[c("确定")])),_:1})]),default:a(()=>[l(fe,{model:L.value,rules:Ee,ref_key:"replyForm",ref:le,"label-width":"80px"},{default:a(()=>[l(M,{label:"回复内容",prop:"content"},{default:a(()=>[l(v,{modelValue:L.value.content,"onUpdate:modelValue":e[8]||(e[8]=n=>L.value.content=n),type:"textarea",autosize:{minRows:10,maxRows:15}},null,8,["modelValue"])]),_:1}),l(M,{label:"附件"},{default:a(()=>[l(ve,{class:"upload-container",drag:"","auto-upload":!0,"http-request":Oe,"on-remove":je,"before-upload":ue,limit:1,"file-list":ee.value},{tip:a(()=>e[29]||(e[29]=[s("div",{class:"el-upload__tip"}," 支持 PDF、Word、Excel、图片等类型文件，大小不超过10MB ",-1)])),default:a(()=>[l(O,{class:"el-icon--upload"},{default:a(()=>[l(E(ze))]),_:1}),e[30]||(e[30]=s("div",{class:"el-upload__text"},[c(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(J,{modelValue:H.value,"onUpdate:modelValue":e[11]||(e[11]=n=>H.value=n),title:"作业详情",width:"700px"},{default:a(()=>{var n,j,ge,ye,he,be,we,xe,ke,Ve;return[Ue((m(),y("div",null,[r.value?(m(),y("div",Ut,[s("h3",null,_((n=r.value)==null?void 0:n.title),1),s("div",St,[s("div",Ft,[e[33]||(e[33]=s("span",{class:"label"},"创建人：",-1)),s("span",null,_((ge=(j=r.value)==null?void 0:j.creator_profile)==null?void 0:ge.full_name),1)]),s("div",$t,[e[34]||(e[34]=s("span",{class:"label"},"指定人员：",-1)),s("span",null,_((he=(ye=r.value)==null?void 0:ye.assignee_profile)==null?void 0:he.full_name),1)]),s("div",Bt,[e[35]||(e[35]=s("span",{class:"label"},"创建时间：",-1)),s("span",null,_(ce((be=r.value)==null?void 0:be.created_at)),1)]),s("div",It,[e[36]||(e[36]=s("span",{class:"label"},"状态：",-1)),l(C,{size:"large",style:{"font-size":"14px"},type:B(r.value).type},{default:a(()=>[c(_(B(r.value).text),1)]),_:1},8,["type"])])]),l(ut),s("div",Mt,[e[37]||(e[37]=s("strong",null,"作业内容：",-1)),s("p",null,_((we=r.value)==null?void 0:we.content),1)]),(xe=r.value)!=null&&xe.attachment_url?(m(),y("div",Et,[e[39]||(e[39]=s("div",{class:"section-title"},"附件",-1)),s("div",Pt,[l(O,{color:"#409EFF",size:"16"},{default:a(()=>[l(E(se))]),_:1}),s("span",Tt,_(r.value.attachment_name),1),l(f,{type:"primary",size:"small",onClick:Ge},{default:a(()=>e[38]||(e[38]=[c("查看附件")])),_:1})])])):W("",!0),(Ve=(ke=r.value)==null?void 0:ke.replies)!=null&&Ve.length?(m(),y("div",Nt,[e[41]||(e[41]=s("h4",null,"回复列表",-1)),(m(!0),y(Se,null,Fe(r.value.replies,b=>{var De;return m(),y("div",{key:b.id,class:yt(["reply-item",{"admin-reply":b.user_id!==r.value.assigned_to,"assignee-reply":b.user_id===r.value.assigned_to}])},[s("p",null,[s("strong",null,_((De=b.profile)==null?void 0:De.full_name)+"：",1)]),s("p",null,_(b.content),1),b.attachment_url?(m(),y("div",qt,[l(O,{color:"#409EFF",size:"14"},{default:a(()=>[l(E(se))]),_:1}),s("span",Lt,_(b.attachment_name),1),l(f,{type:"primary",link:"",size:"small",onClick:Kt=>Le(b)},{default:a(()=>e[40]||(e[40]=[c("查看")])),_:2},1032,["onClick"])])):W("",!0),s("p",Ot,_(b.created_at?new Date(b.created_at).toLocaleString():""),1)],2)}),128))])):W("",!0),r.value?(m(),y("div",jt,[l(f,{type:"primary",onClick:Ke},{default:a(()=>e[42]||(e[42]=[c("回复作业")])),_:1})])):W("",!0)])):W("",!0)])),[[_e,Y.value]])]}),_:1},8,["modelValue"]),l(J,{modelValue:q.value,"onUpdate:modelValue":e[12]||(e[12]=n=>q.value=n),title:"附件预览",width:"80%","destroy-on-close":""},{default:a(()=>[s("div",Wt,[Pe.value?(m(),y("img",{key:0,src:U.value,class:"attachment-image"},null,8,Gt)):Te.value?(m(),y("iframe",{key:1,src:U.value,class:"attachment-frame"},null,8,Ht)):(m(),y("div",Jt,[e[44]||(e[44]=s("p",null,"无法预览此类型的文件，请下载后查看",-1)),l(f,{type:"primary",onClick:He},{default:a(()=>e[43]||(e[43]=[c("下载附件")])),_:1})]))])]),_:1},8,["modelValue"])])])}}}),al=vt(Qt,[["__scopeId","data-v-f74cd8ba"]]);export{al as default};
